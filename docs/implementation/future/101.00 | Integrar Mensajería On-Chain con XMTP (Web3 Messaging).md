# ✅ Paso 101: Integrar Mensajería On-Chain con XMTP (Web3 Messaging)

Ahora agregaremos XMTP (Extensible Message Transport Protocol), permitiendo que los miembros de la DAO envíen mensajes privados on-chain utilizando sus wallets.
✅ Mensajes Encriptados → Comunicación privada usando claves de la wallet del usuario.
✅ Persistencia Descentralizada → Los mensajes se almacenan de forma segura en la red XMTP.
✅ Web3.js + Stimulus.js → Para que los usuarios envíen y reciban mensajes desde la UI.
✅ Soporte para ENS y Wallets → Los mensajes pueden enviarse a direcciones ETH o nombres ENS.
📌 Commit 101.1: Configurar XMTP para Mensajería Web3 en la DAO
🔹 Mensaje de commit:
feat(xmtp-messaging): configura XMTP para comunicación descentralizada entre miembros de la DAO
🔹 Contenido del commit:
1️⃣ Registrar la DAO en XMTP
    Generar una identidad XMTP vinculada a la DAO.
    Habilitar mensajería entre wallets y ENS.
2️⃣ Añadir Configuración en config/xmtp.yml
xmtp:
  dao_wallet: "0xYourDAOAddress"
  messaging_enabled: true
  encryption: "AES-256"
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(xmtp-messaging): configura XMTP para comunicación descentralizada entre miembros de la DAO"
📌 Commit 101.2: Implementar Mensajería con XMTP en la DAO
🔹 Mensaje de commit:
feat(xmtp-messaging-contract): agrega integración con XMTP para enviar mensajes en la DAO
🔹 Contenido del commit:
Modificar app/javascript/controllers/xmtp_controller.js
import { Controller } from "@hotwired/stimulus";
import { Client } from "@xmtp/xmtp-js";
import Web3 from "web3";
export default class extends Controller {
  static targets = ["recipient", "message", "conversation"];
  async sendMessage() {
    if (!window.ethereum) {
      alert("Por favor instala MetaMask");
      return;
    }
    const web3 = new Web3(window.ethereum);
    await window.ethereum.request({ method: "eth_requestAccounts" });
    const recipient = this.recipientTarget.value;
    const message = this.messageTarget.value;
    const xmtp = await Client.create(window.ethereum);
    const conversation = await xmtp.conversations.newConversation(recipient);
    await conversation.send(message);
    alert("Mensaje enviado con éxito a " + recipient);
  }
  async loadMessages() {
    if (!window.ethereum) {
      alert("Por favor instala MetaMask");
      return;
    }
    const xmtp = await Client.create(window.ethereum);
    const messages = await xmtp.conversations.list();
    let displayMessages = messages.map(msg => `${msg.sender}: ${msg.content}`).join("\n");
    this.conversationTarget.innerText = displayMessages || "No hay mensajes";
  }
}
Modificar app/views/xmtp/index.html.erb
<h2>Mensajería Web3 con XMTP</h2>
<label>Enviar a (Wallet o ENS):</label>
<input type="text" data-xmtp-target="recipient">
<label>Mensaje:</label>
<input type="text" data-xmtp-target="message">
<button data-controller="xmtp" data-action="click->xmtp#sendMessage">
  Enviar Mensaje
</button>
<br><br>
<h2>Mensajes Recibidos</h2>
<button data-controller="xmtp" data-action="click->xmtp#loadMessages">
  Cargar Mensajes
</button>
<pre data-xmtp-target="conversation">No hay mensajes</pre>
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(xmtp-messaging-ui): agrega UI para mensajería Web3 con XMTP en la DAO"
📌 Commit 101.3: Implementar Verificación de Identidad en Mensajes XMTP
🔹 Mensaje de commit:
feat(xmtp-verification): agrega verificación de identidad en la mensajería XMTP de la DAO
🔹 Contenido del commit:
Modificar app/javascript/controllers/xmtp_controller.js
async verifyIdentity() {
  const recipient = this.recipientTarget.value;
  const xmtp = await Client.create(window.ethereum);
  const canMessage = await xmtp.canMessage(recipient);
  if (canMessage) {
    alert("El destinatario tiene XMTP habilitado.");
  } else {
    alert("El destinatario no puede recibir mensajes.");
  }
}
Modificar app/views/xmtp/index.html.erb
<button data-controller="xmtp" data-action="click->xmtp#verifyIdentity">
  Verificar Identidad
</button>
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(xmtp-verification): agrega verificación de identidad en la mensajería XMTP de la DAO"
📝 Explicación y Código Generado
Ejemplo de Enviar Mensaje en API
curl -X POST "http://localhost:3000/xmtp/send" \
  -H "Content-Type: application/json" \
  -d '{ "recipient": "0xUserWallet", "message": "Hola desde la DAO!" }'
✅ El mensaje se envía on-chain a la wallet o ENS del destinatario.
Ejemplo de Cargar Mensajes en API
curl -X GET "http://localhost:3000/xmtp/messages"
✅ Muestra el historial de mensajes Web3.
Ejemplo de Verificación de Identidad en API
curl -X GET "http://localhost:3000/xmtp/verify?recipient=0xUserWallet"
✅ Verifica si el destinatario tiene XMTP habilitado.
Ejemplo de Panel de Mensajería Web3 en XMTP
https://xmtp.chat/
✅ Los usuarios pueden ver y gestionar sus mensajes Web3.
