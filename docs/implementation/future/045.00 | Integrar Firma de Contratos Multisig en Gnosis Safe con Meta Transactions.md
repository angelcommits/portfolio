# ✅ Paso 45: Integrar Firma de Contratos Multisig en Gnosis Safe con Meta Transactions

Ahora agregaremos firma de contratos multisig en Gnosis Safe con Meta Transactions, permitiendo que los usuarios firmen sin pagar gas usando un relayer.
✅ Meta Transactions (Gasless) → Los firmantes no pagan gas, se usa un relayer.
✅ Gnosis Safe API → Para consultar y confirmar transacciones multisig.
✅ Biconomy / Gelato Relay → Manejo de transacciones sin gas.
✅ Web3.js + Stimulus.js → Firma de contratos directamente en la UI Rails.
📌 Commit 45.1: Integrar Meta Transactions con Biconomy
🔹 Mensaje de commit:
feat(gasless): integra Biconomy para firma de contratos en Gnosis Safe sin gas
🔹 Contenido del commit:
Instalar SDK de Biconomy en app/javascript/packs/biconomy.js
import { Biconomy } from "@biconomy/mexa";
import Web3 from "web3";
const provider = new Web3.providers.HttpProvider("https://polygon-mumbai.infura.io/v3/YOUR_INFURA_KEY");
const biconomy = new Biconomy(provider, { apiKey: "YOUR_BICONOMY_API_KEY", debug: true });
const web3 = new Web3(biconomy);
biconomy.onEvent(biconomy.READY, () => {
  console.log("Biconomy listo para transacciones sin gas.");
}).onEvent(biconomy.ERROR, (error) => {
  console.error("Error en Biconomy:", error);
});
export { web3, biconomy };
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(gasless): integra Biconomy para firma de contratos en Gnosis Safe sin gas"
📌 Commit 45.2: Modificar Web3.js para Firmar Contratos Sin Gas
🔹 Mensaje de commit:
feat(gasless): agrega Web3.js para firmar contratos en Gnosis Safe sin gas usando Meta Transactions
🔹 Contenido del commit:
Modificar app/javascript/controllers/gnosis_safe_controller.js
import { Controller } from "@hotwired/stimulus";
import { web3, biconomy } from "../packs/biconomy";
export default class extends Controller {
  connect() {
    console.log("Stimulus conectado con Biconomy para firma sin gas.");
  }
  async sign(event) {
    const contractHash = event.target.dataset.contractHash;
    const accounts = await web3.eth.getAccounts();
    const userAddress = accounts[0];
    const txParams = {
      from: userAddress,
      to: "0xContractAddress",
      data: web3.eth.abi.encodeFunctionCall({
        name: "signContract",
        type: "function",
        inputs: [{ type: "bytes32", name: "contractHash" }]
      }, [contractHash]),
      signatureType: biconomy.EIP712_SIGN
    };
    biconomy.sendTransaction(txParams)
      .then(tx => alert(`Contrato firmado sin gas: ${tx.transactionHash}`))
      .catch(error => console.error("Error enviando meta transaction:", error));
  }
}
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(gasless): agrega Web3.js para firmar contratos en Gnosis Safe sin gas usando Meta Transactions"
📌 Commit 45.3: Agregar Endpoint para Verificar Meta Transactions
🔹 Mensaje de commit:
feat(gasless): agrega endpoint para verificar contratos firmados en Gnosis Safe sin gas
🔹 Contenido del commit:
Modificar ContractsController para Verificación Multisig Sin Gas
class ContractsController < ApplicationController
  def verify_multisig_gasless
    contract_hash = params[:contract_hash]
    exists = SmartContractService.verify_multisig_contract(contract_hash)
    if exists
      render json: { message: "Contrato firmado sin gas en Gnosis Safe" }, status: :ok
    else
      render json: { error: "Contrato aún no tiene suficientes firmas" }, status: :unprocessable_entity
    end
  end
end
Agregar Ruta en config/routes.rb
Rails.application.routes.draw do
  get "/contracts/verify_multisig_gasless", to: "contracts#verify_multisig_gasless"
end
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(gasless): agrega endpoint para verificar contratos firmados en Gnosis Safe sin gas"
📝 Explicación y Código Generado
Ejemplo de Firma de Contrato Sin Gas en Gnosis Safe
    El usuario abre el Dashboard en Rails.
    Turbo Streams actualiza la lista de contratos pendientes en tiempo real.
    El usuario firma un contrato con Web3.js y Biconomy.
    La transacción se envía a Gnosis Safe sin pagar gas.
    Cuando se alcanzan las firmas necesarias, el contrato se ejecuta en Blockchain.
Ejemplo de Firma de Contrato en Web3.js
signContractGasless("0xSafeTxHash");
✅ La transacción se firma sin pagar gas y se envía a Gnosis Safe.
Ejemplo de Verificación de Firma en la Blockchain
curl -X GET "http://localhost:3000/contracts/verify_multisig_gasless?contract_hash=0xContratoHash"
✅ Si el contrato está firmado por suficientes personas:
{ "message": "Contrato firmado sin gas en Gnosis Safe" }
❌ Si faltan firmas:
{ "error": "Contrato aún no tiene suficientes firmas" }
