# âœ… Paso 50: Agregar Confirmaciones de Firma VÃ­a SMS y WhatsApp con Twilio

Ahora agregaremos notificaciones vÃ­a SMS y WhatsApp con Twilio, permitiendo que los firmantes reciban alertas en su telÃ©fono cuando un contrato sea ejecutado en Gnosis Safe.
âœ… Twilio SMS API â†’ Para enviar notificaciones por mensaje de texto.
âœ… Twilio WhatsApp API â†’ Para enviar alertas vÃ­a WhatsApp.
âœ… Background Jobs (Sidekiq) â†’ Para procesar las notificaciones sin bloquear la app.
âœ… Turbo Streams + Stimulus.js â†’ Para actualizar la UI en tiempo real.
ðŸ“Œ Commit 50.1: Configurar Twilio para EnvÃ­o de SMS y WhatsApp
ðŸ”¹ Mensaje de commit:
feat(notifications): configura Twilio para enviar notificaciones vÃ­a SMS y WhatsApp
ðŸ”¹ Contenido del commit:
Agregar Credenciales de Twilio en config/credentials.yml.enc
twilio:
  account_sid: "YOUR_TWILIO_ACCOUNT_SID"
  auth_token: "YOUR_TWILIO_AUTH_TOKEN"
  phone_number: "+YOUR_TWILIO_PHONE_NUMBER"
  whatsapp_number: "whatsapp:+14155238886"  # NÃºmero oficial de Twilio para WhatsApp
ðŸ”¹ AÃ±adir archivos al commit:
git add .
git commit -m "feat(notifications): configura Twilio para enviar notificaciones vÃ­a SMS y WhatsApp"
ðŸ“Œ Commit 50.2: Crear Servicio para Enviar SMS con Twilio
ðŸ”¹ Mensaje de commit:
feat(notifications): agrega servicio para enviar notificaciones por SMS con Twilio
ðŸ”¹ Contenido del commit:
Definir TwilioSmsService en app/services/twilio_sms_service.rb
require "twilio-ruby"
class TwilioSmsService
  def self.send_sms(phone_number, message)
    client = Twilio::REST::Client.new(
      Rails.application.credentials.dig(:twilio, :account_sid),
      Rails.application.credentials.dig(:twilio, :auth_token)
    )
    client.messages.create(
      from: Rails.application.credentials.dig(:twilio, :phone_number),
      to: phone_number,
      body: message
    )
  end
end
ðŸ”¹ AÃ±adir archivos al commit:
git add .
git commit -m "feat(notifications): agrega servicio para enviar notificaciones por SMS con Twilio"
ðŸ“Œ Commit 50.3: Crear Servicio para Enviar Mensajes de WhatsApp con Twilio
ðŸ”¹ Mensaje de commit:
feat(notifications): agrega servicio para enviar notificaciones por WhatsApp con Twilio
ðŸ”¹ Contenido del commit:
Definir TwilioWhatsappService en app/services/twilio_whatsapp_service.rb
require "twilio-ruby"
class TwilioWhatsappService
  def self.send_whatsapp(phone_number, message)
    client = Twilio::REST::Client.new(
      Rails.application.credentials.dig(:twilio, :account_sid),
      Rails.application.credentials.dig(:twilio, :auth_token)
    )
    client.messages.create(
      from: Rails.application.credentials.dig(:twilio, :whatsapp_number),
      to: "whatsapp:#{phone_number}",
      body: message
    )
  end
end
ðŸ”¹ AÃ±adir archivos al commit:
git add .
git commit -m "feat(notifications): agrega servicio para enviar notificaciones por WhatsApp con Twilio"
ðŸ“Œ Commit 50.4: Crear Job para Enviar SMS y WhatsApp AutomÃ¡ticamente
ðŸ”¹ Mensaje de commit:
feat(notifications): agrega job para enviar notificaciones por SMS y WhatsApp
ðŸ”¹ Contenido del commit:
Crear Job SendContractTwilioJob
rails g job send_contract_twilio
Modificar app/jobs/send_contract_twilio_job.rb
class SendContractTwilioJob < ApplicationJob
  queue_as :default
  def perform(phone_number, contract_hash)
    message = "âœ… Contrato #{contract_hash} ejecutado en Gnosis Safe. Revisa la transacciÃ³n en la Blockchain."
    TwilioSmsService.send_sms(phone_number, message)
    TwilioWhatsappService.send_whatsapp(phone_number, message)
  end
end
ðŸ”¹ AÃ±adir archivos al commit:
git add .
git commit -m "feat(notifications): agrega job para enviar notificaciones por SMS y WhatsApp"
ðŸ“Œ Commit 50.5: Integrar EnvÃ­o de SMS y WhatsApp en Webhooks de Gnosis Safe
ðŸ”¹ Mensaje de commit:
feat(notifications): dispara notificaciÃ³n por SMS y WhatsApp cuando un contrato es ejecutado en Gnosis Safe
ðŸ”¹ Contenido del commit:
Modificar GnosisSafeWebhooksController para Incluir Twilio
class GnosisSafeWebhooksController < ApplicationController
  skip_before_action :verify_authenticity_token
  def receive
    payload = JSON.parse(request.body.read)
    if payload["event"] == "MULTISIG_TRANSACTION_EXECUTED"
      contract_hash = payload["safeTxHash"]
      notify_contract_executed(contract_hash)
    end
    render json: { status: "ok" }
  end
  private
  def notify_contract_executed(contract_hash)
    # Obtener firmantes y sus telÃ©fonos
    firmantes = get_contract_signers(contract_hash)
    firmantes.each do |firmante|
      SendContractTwilioJob.perform_later(firmante[:phone_number], contract_hash)
    end
    # Notificar en Telegram, Discord y UI
    message = "âœ… *Contrato Ejecutado en Gnosis Safe*\n" \
              "ðŸ“œ Hash: #{contract_hash}\n" \
              "ðŸš€ TransacciÃ³n enviada a la Blockchain"
    TelegramNotifierService.send_message(message)
    DiscordNotifierService.send_message(message)
    ActionCable.server.broadcast("gnosis_safe_notifications", {
      contract_hash: contract_hash,
      status: "Ejecutado"
    })
  end
  def get_contract_signers(contract_hash)
    # SimulaciÃ³n: obtener emails y telÃ©fonos de firmantes desde la BD
    [
      { email: "user1@example.com", phone_number: "+1234567890" },
      { email: "user2@example.com", phone_number: "+0987654321" }
    ]
  end
end
ðŸ”¹ AÃ±adir archivos al commit:
git add .
git commit -m "feat(notifications): dispara notificaciÃ³n por SMS y WhatsApp cuando un contrato es ejecutado en Gnosis Safe"
ðŸ“ ExplicaciÃ³n y CÃ³digo Generado
Ejemplo de NotificaciÃ³n por SMS y WhatsApp en Rails Console
SendContractTwilioJob.perform_now("+1234567890", "0x123456...")
âœ… El usuario recibe un mensaje en su telÃ©fono:
âœ… Contrato 0x123456... ejecutado en Gnosis Safe. Revisa la transacciÃ³n en la Blockchain.
Ejemplo de Disparo de NotificaciÃ³n AutomÃ¡tica
curl -X POST "https://your-rails-app.com/webhooks/gnosis_safe"
âœ… Todos los firmantes reciben una notificaciÃ³n por SMS y WhatsApp.
