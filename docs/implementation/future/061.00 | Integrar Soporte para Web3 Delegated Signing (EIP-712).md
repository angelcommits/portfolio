# ✅ Paso 61: Integrar Soporte para Web3 Delegated Signing (EIP-712)

Ahora agregaremos EIP-712 Delegated Signing, permitiendo que las firmas sean verificadas en smart contracts en lugar de en el backend. Esto es útil para permitir que los usuarios firmen transacciones fuera de la cadena y que estas sean validadas en la blockchain sin depender de una verificación centralizada.
✅ EIP-712 Typed Data Signing → Firmas estructuradas para mejorar seguridad y evitar ataques de phishing.
✅ Web3.js + Stimulus.js → Para manejar la firma en el frontend.
✅ Validación en Smart Contracts → Para permitir autenticación descentralizada.
✅ Compatibilidad con Gnosis Safe, Argent y WalletConnect → Para firmar desde cualquier wallet.
📌 Commit 61.1: Agregar Soporte para Firmas Delegadas con EIP-712 en Web3AuthController
🔹 Mensaje de commit:
feat(web3-signing): agrega soporte para firmas delegadas con EIP-712
🔹 Contenido del commit:
Modificar Web3AuthController para Soporte de Firmas Delegadas
class Web3AuthController < ApplicationController
  skip_before_action :verify_authenticity_token
  def eip712_nonce
    session[:web3_nonce] = SecureRandom.hex(16)
    render json: { nonce: session[:web3_nonce] }
  end
  def eip712_login
    wallet = params[:wallet_address]
    signature = params[:signature]
    nonce = session[:web3_nonce]
    return render json: { error: "Nonce inválido" }, status: :unauthorized unless nonce
    # Verificar firma de Ethereum con EIP-712
    signer = Ethereum::EIP712.verify_signature(nonce, wallet, signature)
    if signer.downcase == wallet.downcase
      user = User.find_or_create_by(wallet_address: wallet)
      rodauth = RodauthMain.new(account_id: user.id, scope: self)
      token = rodauth.create_jwt
      render json: { message: "Autenticación exitosa", user: user, token: token }
    else
      render json: { error: "Firma inválida" }, status: :unauthorized
    end
  end
end
Agregar Rutas en config/routes.rb
Rails.application.routes.draw do
  post "/auth/eip712_nonce", to: "web3_auth#eip712_nonce"
  post "/auth/eip712_login", to: "web3_auth#eip712_login"
end
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(web3-signing): agrega soporte para firmas delegadas con EIP-712"
📌 Commit 61.2: Implementar Firma EIP-712 en el Frontend con Web3.js y Stimulus
🔹 Mensaje de commit:
feat(web3-signing): integra EIP-712 Typed Data Signing en el frontend con Web3.js
🔹 Contenido del commit:
Modificar app/javascript/controllers/web3_auth_controller.js
import { Controller } from "@hotwired/stimulus";
import Web3 from "web3";
export default class extends Controller {
  async loginWithEIP712() {
    if (window.ethereum) {
      const web3 = new Web3(window.ethereum);
      await window.ethereum.request({ method: "eth_requestAccounts" });
      this.walletAddress = (await web3.eth.getAccounts())[0];
      // Obtener nonce del servidor
      const nonceResponse = await fetch("/auth/eip712_nonce");
      const { nonce } = await nonceResponse.json();
      const domain = {
        name: "Web3 Auth",
        version: "1",
        chainId: await web3.eth.getChainId(),
        verifyingContract: "0xYourContractAddress"
      };
      const types = {
        Login: [
          { name: "wallet", type: "address" },
          { name: "nonce", type: "string" }
        ]
      };
      const message = {
        wallet: this.walletAddress,
        nonce: nonce
      };
      const signature = await web3.eth.personal.sign(JSON.stringify({ domain, types, message }), this.walletAddress);
      const loginResponse = await fetch("/auth/eip712_login", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ wallet_address: this.walletAddress, signature })
      });
      if (loginResponse.ok) {
        alert("Autenticación exitosa");
        window.location.reload();
      } else {
        alert("Error en la autenticación");
      }
    } else {
      alert("Por favor instala MetaMask");
    }
  }
}
Modificar app/views/sessions/new.html.erb
<h2>Iniciar sesión con Firma EIP-712</h2>
<button data-controller="web3-auth" data-action="click->web3-auth#loginWithEIP712">
  Conectar con Web3 (EIP-712)
</button>
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(web3-signing): integra EIP-712 Typed Data Signing en el frontend con Web3.js"
📌 Commit 61.3: Implementar Verificación de Firma en Smart Contracts
🔹 Mensaje de commit:
feat(web3-signing): agrega verificación de firmas en Smart Contracts con EIP-712
🔹 Contenido del commit:
Contrato Solidity para Verificación de Firma EIP-712
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.0;
contract EIP712Verifier {
    bytes32 public constant LOGIN_TYPEHASH = keccak256("Login(address wallet,string nonce)");
    bytes32 public DOMAIN_SEPARATOR;
    constructor() {
        DOMAIN_SEPARATOR = keccak256(
            abi.encode(
                keccak256("EIP712Domain(string name,string version,uint256 chainId,address verifyingContract)"),
                keccak256(bytes("Web3 Auth")),
                keccak256(bytes("1")),
                block.chainid,
                address(this)
            )
        );
    }
    function verify(address wallet, string memory nonce, uint8 v, bytes32 r, bytes32 s) public view returns (bool) {
        bytes32 structHash = keccak256(abi.encode(LOGIN_TYPEHASH, wallet, keccak256(bytes(nonce))));
        bytes32 digest = keccak256(abi.encodePacked("\x19\x01", DOMAIN_SEPARATOR, structHash));
        return ecrecover(digest, v, r, s) == wallet;
    }
}
Desplegar Contrato en la Blockchain
npx hardhat run scripts/deploy.js --network goerli
✅ Guarda la dirección del contrato para usar en el backend.
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(web3-signing): agrega verificación de firmas en Smart Contracts con EIP-712"
📝 Explicación y Código Generado
Ejemplo de Firma en API
curl -X POST "http://localhost:3000/auth/eip712_login" \
  -H "Content-Type: application/json" \
  -d '{ "wallet_address": "0xUserWallet", "signature": "0xFirmaEIP712" }'
✅ Si la firma es válida:
{ "message": "Autenticación exitosa", "user": { "id": 1, "wallet_address": "0xUserWallet" }, "token": "eyJhbGciOiJIUzI1NiIsInR..." }
Ejemplo de Firma en Smart Contract
EIP712Verifier.verify("0xUserWallet", "nonce_value", v, r, s);
✅ Retorna true si la firma es válida.
