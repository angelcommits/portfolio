# ‚úÖ Paso 43: Implementar Notificaciones para Firmas Pendientes en Gnosis Safe

Ahora agregaremos notificaciones autom√°ticas para alertar a los firmantes cuando haya contratos pendientes en Gnosis Safe, usando WebSockets y Push Protocol (EPNS).
‚úÖ Gnosis Safe API ‚Üí Para monitorear contratos pendientes en multisig.
‚úÖ WebSockets con Turbo Streams ‚Üí Para notificaciones en tiempo real.
‚úÖ EPNS (Ethereum Push Notification Service) ‚Üí Para enviar alertas Web3 a MetaMask.
‚úÖ Soporte para MetaMask, WalletConnect y Hardware Wallets ‚Üí Alertas en cualquier dispositivo.
üìå Commit 43.1: Integrar WebSockets para Notificaciones en Tiempo Real
üîπ Mensaje de commit:
feat(notifications): agrega WebSockets con Turbo Streams para notificaciones de firmas en Gnosis Safe
üîπ Contenido del commit:
Definir GnosisSafeNotificationsChannel en app/channels/gnosis_safe_notifications_channel.rb
class GnosisSafeNotificationsChannel < ApplicationCable::Channel
  def subscribed
    stream_from "gnosis_safe_notifications"
  end
end
Modificar ContractsController para Enviar Notificaciones WebSockets
class ContractsController < ApplicationController
  def notify_pending_signatures
    pending_contracts = GnosisSafeService.pending_signatures
    pending_contracts.each do |contract|
      ActionCable.server.broadcast("gnosis_safe_notifications", {
        contract_hash: contract[:hash],
        required_signatures: contract[:required_signatures],
        current_signatures: contract[:current_signatures]
      })
    end
    render json: { message: "Notificaciones enviadas a firmantes." }
  end
end
Agregar Rutas en config/routes.rb
Rails.application.routes.draw do
  get "/contracts/notify_pending_signatures", to: "contracts#notify_pending_signatures"
end
üîπ A√±adir archivos al commit:
git add .
git commit -m "feat(notifications): agrega WebSockets con Turbo Streams para notificaciones de firmas en Gnosis Safe"
üìå Commit 43.2: Crear Servicio para Consultar Firmas Pendientes en Gnosis Safe
üîπ Mensaje de commit:
feat(gnosis): agrega servicio para obtener contratos pendientes de firma en Gnosis Safe
üîπ Contenido del commit:
Definir GnosisSafeService en app/services/gnosis_safe_service.rb
require "httparty"
class GnosisSafeService
  GNOSIS_SAFE_API = "https://safe-transaction.gnosis.io/api/v1"
  def self.pending_signatures
    safe_address = Rails.application.credentials.dig(:gnosis, :safe_address)
    response = HTTParty.get("#{GNOSIS_SAFE_API}/safes/#{safe_address}/multisig-transactions/")
    pending_transactions = response["results"].select { |tx| !tx["isExecuted"] }
    pending_transactions.map do |tx|
      {
        hash: tx["safeTxHash"],
        required_signatures: tx["confirmationsRequired"],
        current_signatures: tx["confirmations"].count
      }
    end
  end
end
üîπ A√±adir archivos al commit:
git add .
git commit -m "feat(gnosis): agrega servicio para obtener contratos pendientes de firma en Gnosis Safe"
üìå Commit 43.3: Agregar Notificaciones Web3 con EPNS (Ethereum Push Notification Service)
üîπ Mensaje de commit:
feat(notifications): integra EPNS para enviar alertas Web3 a firmantes de Gnosis Safe
üîπ Contenido del commit:
Definir Web3NotifierService en app/services/web3_notifier_service.rb
require "epns"
class Web3NotifierService
  EPNS_CHANNEL_ADDRESS = Rails.application.credentials.dig(:web3, :epns_channel_address)
  EPNS_PRIVATE_KEY = Rails.application.credentials.dig(:web3, :epns_private_key)
  def self.send_push_notification(wallet_address, message)
    epns_client = EPNS::Client.new(EPNS_CHANNEL_ADDRESS, EPNS_PRIVATE_KEY)
    epns_client.send_notification(wallet_address, message, "Firma de Contrato en Gnosis Safe")
  end
end
Modificar ContractsController para Integrar EPNS
class ContractsController < ApplicationController
  def notify_pending_signatures
    pending_contracts = GnosisSafeService.pending_signatures
    pending_contracts.each do |contract|
      contract[:signers].each do |signer|
        Web3NotifierService.send_push_notification(signer, "Tienes un contrato pendiente de firma: #{contract[:hash]}")
      end
    end
    render json: { message: "Notificaciones enviadas a firmantes." }
  end
end
üîπ A√±adir archivos al commit:
git add .
git commit -m "feat(notifications): integra EPNS para enviar alertas Web3 a firmantes de Gnosis Safe"
üìå Commit 43.4: Agregar Notificaciones en el Frontend con WebSockets
üîπ Mensaje de commit:
feat(notifications): agrega notificaciones en tiempo real para firmas en Gnosis Safe
üîπ Contenido del commit:
Modificar app/javascript/packs/gnosis_notifications.js
document.addEventListener("DOMContentLoaded", () => {
  const notificationsContainer = document.getElementById("gnosis_notifications");
  if (notificationsContainer) {
    const socket = new WebSocket("ws://localhost:3000/cable");
    socket.onmessage = function(event) {
      const data = JSON.parse(event.data);
      const notification = document.createElement("div");
      notification.className = "notification";
      notification.innerHTML = `
        <p>Contrato pendiente de firma: ${data.contract_hash}</p>
        <p>Firmas requeridas: ${data.required_signatures}</p>
        <p>Firmas actuales: ${data.current_signatures}</p>
      `;
      notificationsContainer.appendChild(notification);
    };
  }
});
üîπ A√±adir archivos al commit:
git add .
git commit -m "feat(notifications): agrega notificaciones en tiempo real para firmas en Gnosis Safe"
üìù Explicaci√≥n y C√≥digo Generado
Ejemplo de Env√≠o de Notificaci√≥n para Firmas Pendientes en Gnosis Safe
curl -X GET "http://localhost:3000/contracts/notify_pending_signatures"
‚úÖ Salida esperada:
{ "message": "Notificaciones enviadas a firmantes." }
Ejemplo de Recepci√≥n de Notificaci√≥n en Web3 (EPNS)
    Un usuario intenta firmar un contrato en Gnosis Safe.
    El sistema detecta que a√∫n faltan firmas.
    Se env√≠a una alerta Web3 a MetaMask de los firmantes pendientes.
    Los usuarios reciben una notificaci√≥n en su wallet con el link para firmar.
Ejemplo de Notificaci√≥n en el Frontend (Turbo Streams)
// Notificaci√≥n en la UI cuando hay un contrato pendiente
{
  contract_hash: "0xabc123...",
  required_signatures: 3,
  current_signatures: 1
}
‚úÖ El usuario ve en su dashboard la lista de contratos pendientes de firma.
