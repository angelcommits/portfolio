# ✅ Paso 49: Integrar Notificaciones por Email para Firmantes de Gnosis Safe

Ahora agregaremos notificaciones por email para alertar a los firmantes cuando se complete la firma de un contrato y se ejecute en la Blockchain.
✅ Action Mailer en Rails → Para enviar correos desde la aplicación.
✅ Sidekiq para Procesamiento Asíncrono → Para evitar bloqueos en la ejecución.
✅ Turbo Streams para Actualizar la UI → Para mostrar el estado en tiempo real.
✅ Integración con SendGrid / Postmark / SMTP → Para el envío confiable de emails.
📌 Commit 49.1: Configurar Action Mailer para Envío de Emails
🔹 Mensaje de commit:
feat(email): configura Action Mailer con SMTP para enviar notificaciones a firmantes
🔹 Contenido del commit:
Modificar config/environments/production.rb
config.action_mailer.delivery_method = :smtp
config.action_mailer.smtp_settings = {
  address: "smtp.sendgrid.net",
  port: 587,
  domain: "yourdomain.com",
  user_name: Rails.application.credentials.dig(:email, :username),
  password: Rails.application.credentials.dig(:email, :password),
  authentication: "plain",
  enable_starttls_auto: true
}
Configurar Credenciales en config/credentials.yml.enc
email:
  username: "apikey"
  password: "YOUR_SENDGRID_API_KEY"
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(email): configura Action Mailer con SMTP para enviar notificaciones a firmantes"
📌 Commit 49.2: Crear Mailer para Notificar a los Firmantes
🔹 Mensaje de commit:
feat(email): agrega mailer para notificar a los firmantes cuando un contrato es ejecutado
🔹 Contenido del commit:
Generar Mailer
rails g mailer ContractMailer
Modificar app/mailers/contract_mailer.rb
class ContractMailer < ApplicationMailer
  default from: "notificaciones@yourdomain.com"
  def contract_executed(user_email, contract_hash)
    @contract_hash = contract_hash
    mail(to: user_email, subject: "✅ Contrato #{contract_hash} ejecutado en Gnosis Safe")
  end
end
Crear app/views/contract_mailer/contract_executed.html.erb
<h1>Contrato Ejecutado ✅</h1>
<p>El contrato con hash <strong><%= @contract_hash %></strong> ha sido firmado y ejecutado en Gnosis Safe.</p>
<p>Puedes revisar la transacción en la blockchain.</p>
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(email): agrega mailer para notificar a los firmantes cuando un contrato es ejecutado"
📌 Commit 49.3: Agregar Background Job para Enviar Notificación por Email
🔹 Mensaje de commit:
feat(email): agrega job para enviar notificaciones por email a firmantes
🔹 Contenido del commit:
Crear Job SendContractEmailJob
rails g job send_contract_email
Modificar app/jobs/send_contract_email_job.rb
class SendContractEmailJob < ApplicationJob
  queue_as :default
  def perform(user_email, contract_hash)
    ContractMailer.contract_executed(user_email, contract_hash).deliver_later
  end
end
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(email): agrega job para enviar notificaciones por email a firmantes"
📌 Commit 49.4: Integrar Envío de Email en Webhooks de Gnosis Safe
🔹 Mensaje de commit:
feat(email): dispara notificación por email cuando un contrato es ejecutado en Gnosis Safe
🔹 Contenido del commit:
Modificar GnosisSafeWebhooksController para Enviar Emails
class GnosisSafeWebhooksController < ApplicationController
  skip_before_action :verify_authenticity_token
  def receive
    payload = JSON.parse(request.body.read)
    if payload["event"] == "MULTISIG_TRANSACTION_EXECUTED"
      contract_hash = payload["safeTxHash"]
      notify_contract_executed(contract_hash)
    end
    render json: { status: "ok" }
  end
  private
  def notify_contract_executed(contract_hash)
    # Enviar email a los firmantes
    firmantes = get_contract_signers(contract_hash)
    firmantes.each do |user_email|
      SendContractEmailJob.perform_later(user_email, contract_hash)
    end
    # Notificar en Telegram, Discord y UI
    message = "✅ *Contrato Ejecutado en Gnosis Safe*\n" \
              "📜 Hash: #{contract_hash}\n" \
              "🚀 Transacción enviada a la Blockchain"
    TelegramNotifierService.send_message(message)
    DiscordNotifierService.send_message(message)
    ActionCable.server.broadcast("gnosis_safe_notifications", {
      contract_hash: contract_hash,
      status: "Ejecutado"
    })
  end
  def get_contract_signers(contract_hash)
    # Simulación: obtener emails de firmantes desde la BD
    ["user1@example.com", "user2@example.com"]
  end
end
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(email): dispara notificación por email cuando un contrato es ejecutado en Gnosis Safe"
📝 Explicación y Código Generado
Ejemplo de Notificación por Email en Rails Console
ContractMailer.contract_executed("user@example.com", "0x123456...").deliver_now
✅ El usuario recibe un email:
Asunto: ✅ Contrato 0x123456... ejecutado en Gnosis Safe
El contrato con hash 0x123456... ha sido firmado y ejecutado en Gnosis Safe.
Puedes revisar la transacción en la blockchain.
Ejemplo de Disparo de Email Automático cuando un Contrato es Ejecutado
curl -X POST "https://your-rails-app.com/webhooks/gnosis_safe"
✅ Todos los firmantes reciben el email de confirmación.
