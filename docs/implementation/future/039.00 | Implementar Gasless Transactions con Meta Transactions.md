# ✅ Paso 39: Implementar Gasless Transactions con Meta Transactions

Ahora agregaremos transacciones sin gas (Gasless Transactions) usando meta transactions con Biconomy o Gelato Relay.
✅ Meta Transactions → Permiten que los usuarios firmen transacciones sin pagar gas.
✅ Biconomy / Gelato Relay → Redes que subsidian el gas mediante smart contracts relayers.
✅ EIP-2771 (Forwarder) → Estándar para transacciones patrocinadas.
✅ Optimización para UX → Mejora la experiencia eliminando fricción en los pagos de gas.
📌 Commit 39.1: Integrar Biconomy para Gasless Transactions
🔹 Mensaje de commit:
feat(gasless): integra Biconomy para permitir transacciones sin gas
🔹 Contenido del commit:
Instalar SDK de Biconomy en app/javascript/packs/biconomy.js
import { Biconomy } from "@biconomy/mexa";
import Web3 from "web3";
const provider = new Web3.providers.HttpProvider("https://polygon-mumbai.infura.io/v3/YOUR_INFURA_KEY");
const biconomy = new Biconomy(provider, { apiKey: "YOUR_BICONOMY_API_KEY", debug: true });
const web3 = new Web3(biconomy);
biconomy.onEvent(biconomy.READY, () => {
  console.log("Biconomy listo para transacciones sin gas.");
}).onEvent(biconomy.ERROR, (error) => {
  console.error("Error en Biconomy:", error);
});
export { web3, biconomy };
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(gasless): integra Biconomy para permitir transacciones sin gas"
📌 Commit 39.2: Modificar Smart Contract para Soporte de Meta Transactions
🔹 Mensaje de commit:
feat(gasless): modifica Smart Contract para soportar meta transactions (EIP-2771)
🔹 Contenido del commit:
Modificar contracts/DocumentSigner.sol para Soporte de Meta Transactions
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.0;
import "@openzeppelin/contracts/metatx/ERC2771Context.sol";
contract DocumentSigner is ERC2771Context {
    mapping(bytes32 => bool) public signedContracts;
    event ContractSigned(address indexed signer, bytes32 contractHash);
    constructor(address trustedForwarder) ERC2771Context(trustedForwarder) {}
    function signContract(bytes32 contractHash) public {
        address signer = _msgSender();
        require(!signedContracts[contractHash], "Contrato ya firmado.");
        signedContracts[contractHash] = true;
        emit ContractSigned(signer, contractHash);
    }
    function verifyContract(bytes32 contractHash) public view returns (bool) {
        return signedContracts[contractHash];
    }
}
✅ Esto permite que el contrato reconozca transacciones enviadas por un relayer.
Desplegar Smart Contract en Testnet
npx hardhat compile
npx hardhat run scripts/deploy.js --network polygon_mumbai
✅ Guardar la dirección del contrato en config/credentials.yml.enc.
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(gasless): modifica Smart Contract para soportar meta transactions (EIP-2771)"
📌 Commit 39.3: Modificar Web3.js para Firmar y Enviar Meta Transactions
🔹 Mensaje de commit:
feat(gasless): agrega lógica para enviar meta transactions usando Biconomy
🔹 Contenido del commit:
Modificar app/javascript/packs/smart_contract.js
import { web3, biconomy } from "./biconomy";
async function signContractGasless(contractAddress, userAddress, contractHash) {
  const contractAbi = [ /* ABI del contrato */ ];
  const contract = new web3.eth.Contract(contractAbi, contractAddress);
  const data = contract.methods.signContract(contractHash).encodeABI();
  const txParams = {
    from: userAddress,
    to: contractAddress,
    data: data,
    signatureType: biconomy.EIP712_SIGN,
  };
  biconomy.sendTransaction(txParams)
    .then((tx) => alert(`Transacción enviada sin gas: ${tx.transactionHash}`))
    .catch((error) => console.error("Error enviando meta transaction:", error));
}
document.addEventListener("DOMContentLoaded", () => {
  document.querySelectorAll(".sign-contract-gasless").forEach(button => {
    button.addEventListener("click", async (event) => {
      const contractHash = event.target.dataset.contractHash;
      const accounts = await web3.eth.getAccounts();
      signContractGasless("0xContractAddress", accounts[0], contractHash);
    });
  });
});
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(gasless): agrega lógica para enviar meta transactions usando Biconomy"
📌 Commit 39.4: Crear Endpoint para Verificar Meta Transactions
🔹 Mensaje de commit:
feat(gasless): agrega endpoint para verificar meta transactions en blockchain
🔹 Contenido del commit:
Modificar ContractsController para Verificar Firmas Gasless
class ContractsController < ApplicationController
  def verify_gasless
    contract_hash = params[:contract_hash]
    exists = SmartContractService.verify_contract(contract_hash)
    if exists
      render json: { message: "Contrato firmado en Blockchain sin gas" }, status: :ok
    else
      render json: { error: "Contrato no registrado en Blockchain" }, status: :not_found
    end
  end
end
Agregar Ruta en config/routes.rb
Rails.application.routes.draw do
  get "/contracts/verify_gasless", to: "contracts#verify_gasless"
end
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(gasless): agrega endpoint para verificar meta transactions en blockchain"
📝 Explicación y Código Generado
Ejemplo de Firma de Contrato Sin Gas
    Usuario hace clic en "Firmar Contrato Sin Gas".
    MetaMask firma el mensaje EIP-712.
    Biconomy envía la transacción sin gas.
    El backend verifica la firma en la Blockchain.
Ejemplo de Firma de Contrato en Rails Console
SmartContractService.sign_contract("0xUserWallet", "0xContratoHash", "0xFirmaDigital")
Ejemplo de Verificación de Contrato Sin Gas
curl -X GET "http://localhost:3000/contracts/verify_gasless?contract_hash=0xContratoHash"
✅ Si el contrato está firmado:
{ "message": "Contrato firmado en Blockchain sin gas" }
❌ Si el contrato no existe:
{ "error": "Contrato no registrado en Blockchain" }
Ejemplo de Transacción Sin Gas en MetaMask
signContractGasless("0xContractAddress", "0xUserWallet", "0xContratoHash");
✅ Transacción se envía sin pagar gas.
