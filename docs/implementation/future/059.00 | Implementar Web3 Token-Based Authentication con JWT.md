# âœ… Paso 59: Implementar Web3 Token-Based Authentication con JWT

Ahora agregaremos soporte para autenticaciÃ³n basada en tokens JWT (JSON Web Token), permitiendo que los usuarios inicien sesiÃ³n con Web3 Sign-In (Ethereum) y reciban un token JWT para acceder a APIs protegidas.
âœ… Rodauth JWT Authentication â†’ ProtecciÃ³n segura de APIs.
âœ… Web3 Sign-In con Ethereum â†’ Firmar mensajes para autenticarse sin contraseÃ±a.
âœ… JWT para AutorizaciÃ³n â†’ Tokens reutilizables para acceso a APIs protegidas.
âœ… Redis para Token Revocation â†’ Para invalidar tokens en caso de logout.
ðŸ“Œ Commit 59.1: Instalar Dependencias para JWT en Rodauth
ðŸ”¹ Mensaje de commit:
feat(auth-jwt): instala soporte para autenticaciÃ³n con JWT en Rodauth
ðŸ”¹ Contenido del commit:
Instalar la gema rodauth-jwt
bundle add rodauth-jwt
Configurar Credenciales en config/credentials.yml.enc
jwt:
  secret: "YOUR_SECRET_KEY"
ðŸ”¹ AÃ±adir archivos al commit:
git add .
git commit -m "feat(auth-jwt): instala soporte para autenticaciÃ³n con JWT en Rodauth"
ðŸ“Œ Commit 59.2: Configurar Rodauth para Soporte JWT
ðŸ”¹ Mensaje de commit:
feat(auth-jwt): configura Rodauth para manejar autenticaciÃ³n con JWT
ðŸ”¹ Contenido del commit:
Modificar config/initializers/rodauth.rb
RodauthMain.configure do
  enable :jwt
  jwt_secret { Rails.application.credentials.dig(:jwt, :secret) }
  jwt_session_key "Authorization"
  jwt_algorithm "HS256"
  jwt_expiration 86400 # 24 horas
  before_jwt_response do
    response["Access-Control-Allow-Origin"] = "*"
    response["Access-Control-Allow-Methods"] = "POST, GET, OPTIONS, DELETE"
  end
end
ðŸ”¹ AÃ±adir archivos al commit:
git add .
git commit -m "feat(auth-jwt): configura Rodauth para manejar autenticaciÃ³n con JWT"
ðŸ“Œ Commit 59.3: Agregar API para AutenticaciÃ³n con Web3 + JWT
ðŸ”¹ Mensaje de commit:
feat(auth-jwt): agrega API JSON para autenticaciÃ³n con Web3 y JWT
ðŸ”¹ Contenido del commit:
Modificar Web3AuthController para Incluir JWT
class Web3AuthController < ApplicationController
  skip_before_action :verify_authenticity_token
  def login
    wallet = params[:wallet_address]
    signature = params[:signature]
    nonce = session[:web3_nonce]
    return render json: { error: "Nonce invÃ¡lido" }, status: :unauthorized unless nonce
    # Verificar firma de Ethereum
    signer = Ethereum::Message.verify_signature("Nonce: #{nonce}", signature)
    if signer.downcase == wallet.downcase
      user = User.find_or_create_by(wallet_address: wallet)
      rodauth = RodauthMain.new(account_id: user.id, scope: self)
      token = rodauth.create_jwt
      render json: { message: "AutenticaciÃ³n exitosa", user: user, token: token }
    else
      render json: { error: "Firma invÃ¡lida" }, status: :unauthorized
    end
  end
end
Agregar Rutas en config/routes.rb
Rails.application.routes.draw do
  post "/auth/web3_login", to: "web3_auth#login"
end
ðŸ”¹ AÃ±adir archivos al commit:
git add .
git commit -m "feat(auth-jwt): agrega API JSON para autenticaciÃ³n con Web3 y JWT"
ðŸ“Œ Commit 59.4: Proteger Rutas con JWT en Rodauth
ðŸ”¹ Mensaje de commit:
feat(auth-jwt): protege rutas de la API usando autenticaciÃ³n con JWT
ðŸ”¹ Contenido del commit:
Modificar ApplicationController para Requerir JWT
class ApplicationController < ActionController::API
  before_action :require_authentication
  def require_authentication
    rodauth = RodauthMain.new(scope: self)
    unless rodauth.authenticated?
      render json: { error: "Acceso no autorizado" }, status: :unauthorized
    end
  end
end
Ejemplo de Rutas Protegidas en config/routes.rb
Rails.application.routes.draw do
  namespace :api do
    resources :transactions, only: [:index, :create]
  end
end
Ejemplo de TransactionsController Protegido con JWT
class Api::TransactionsController < ApplicationController
  def index
    render json: { message: "Lista de transacciones", transactions: [] }
  end
end
ðŸ”¹ AÃ±adir archivos al commit:
git add .
git commit -m "feat(auth-jwt): protege rutas de la API usando autenticaciÃ³n con JWT"
ðŸ“Œ Commit 59.5: Agregar Logout y RevocaciÃ³n de Tokens
ðŸ”¹ Mensaje de commit:
feat(auth-jwt): agrega logout y revocaciÃ³n de JWT en Rodauth
ðŸ”¹ Contenido del commit:
Modificar Web3AuthController para Logout
def logout
  rodauth = RodauthMain.new(scope: self)
  rodauth.logout
  render json: { message: "SesiÃ³n cerrada exitosamente" }
end
Agregar Ruta para Logout en config/routes.rb
delete "/auth/logout", to: "web3_auth#logout"
ðŸ”¹ AÃ±adir archivos al commit:
git add .
git commit -m "feat(auth-jwt): agrega logout y revocaciÃ³n de JWT en Rodauth"
ðŸ“ ExplicaciÃ³n y CÃ³digo Generado
Ejemplo de Login con Web3 + JWT en API
curl -X POST "http://localhost:3000/auth/web3_login" \
  -H "Content-Type: application/json" \
  -d '{ "wallet_address": "0xUserWallet", "signature": "0xFirmaDigital" }'
âœ… Si la firma es vÃ¡lida:
{ "message": "AutenticaciÃ³n exitosa", "user": { "id": 1, "wallet_address": "0xUserWallet" }, "token": "eyJhbGciOiJIUzI1NiIsInR..." }
Ejemplo de Acceso a Rutas Protegidas con JWT
curl -X GET "http://localhost:3000/api/transactions" \
  -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR..."
âœ… Si el token es vÃ¡lido:
{ "message": "Lista de transacciones", "transactions": [] }
âŒ Si el token es invÃ¡lido:
{ "error": "Acceso no autorizado" }
Ejemplo de Logout y RevocaciÃ³n de Token
curl -X DELETE "http://localhost:3000/auth/logout" \
  -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR..."
âœ… Si el logout es exitoso:
{ "message": "SesiÃ³n cerrada exitosamente" }
