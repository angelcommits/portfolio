# ✅ Paso 59: Implementar Web3 Token-Based Authentication con JWT

Ahora agregaremos soporte para autenticación basada en tokens JWT (JSON Web Token), permitiendo que los usuarios inicien sesión con Web3 Sign-In (Ethereum) y reciban un token JWT para acceder a APIs protegidas.
✅ Rodauth JWT Authentication → Protección segura de APIs.
✅ Web3 Sign-In con Ethereum → Firmar mensajes para autenticarse sin contraseña.
✅ JWT para Autorización → Tokens reutilizables para acceso a APIs protegidas.
✅ Redis para Token Revocation → Para invalidar tokens en caso de logout.
📌 Commit 59.1: Instalar Dependencias para JWT en Rodauth
🔹 Mensaje de commit:
feat(auth-jwt): instala soporte para autenticación con JWT en Rodauth
🔹 Contenido del commit:
Instalar la gema rodauth-jwt
bundle add rodauth-jwt
Configurar Credenciales en config/credentials.yml.enc
jwt:
  secret: "YOUR_SECRET_KEY"
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(auth-jwt): instala soporte para autenticación con JWT en Rodauth"
📌 Commit 59.2: Configurar Rodauth para Soporte JWT
🔹 Mensaje de commit:
feat(auth-jwt): configura Rodauth para manejar autenticación con JWT
🔹 Contenido del commit:
Modificar config/initializers/rodauth.rb
RodauthMain.configure do
  enable :jwt
  jwt_secret { Rails.application.credentials.dig(:jwt, :secret) }
  jwt_session_key "Authorization"
  jwt_algorithm "HS256"
  jwt_expiration 86400 # 24 horas
  before_jwt_response do
    response["Access-Control-Allow-Origin"] = "*"
    response["Access-Control-Allow-Methods"] = "POST, GET, OPTIONS, DELETE"
  end
end
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(auth-jwt): configura Rodauth para manejar autenticación con JWT"
📌 Commit 59.3: Agregar API para Autenticación con Web3 + JWT
🔹 Mensaje de commit:
feat(auth-jwt): agrega API JSON para autenticación con Web3 y JWT
🔹 Contenido del commit:
Modificar Web3AuthController para Incluir JWT
class Web3AuthController < ApplicationController
  skip_before_action :verify_authenticity_token
  def login
    wallet = params[:wallet_address]
    signature = params[:signature]
    nonce = session[:web3_nonce]
    return render json: { error: "Nonce inválido" }, status: :unauthorized unless nonce
    # Verificar firma de Ethereum
    signer = Ethereum::Message.verify_signature("Nonce: #{nonce}", signature)
    if signer.downcase == wallet.downcase
      user = User.find_or_create_by(wallet_address: wallet)
      rodauth = RodauthMain.new(account_id: user.id, scope: self)
      token = rodauth.create_jwt
      render json: { message: "Autenticación exitosa", user: user, token: token }
    else
      render json: { error: "Firma inválida" }, status: :unauthorized
    end
  end
end
Agregar Rutas en config/routes.rb
Rails.application.routes.draw do
  post "/auth/web3_login", to: "web3_auth#login"
end
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(auth-jwt): agrega API JSON para autenticación con Web3 y JWT"
📌 Commit 59.4: Proteger Rutas con JWT en Rodauth
🔹 Mensaje de commit:
feat(auth-jwt): protege rutas de la API usando autenticación con JWT
🔹 Contenido del commit:
Modificar ApplicationController para Requerir JWT
class ApplicationController < ActionController::API
  before_action :require_authentication
  def require_authentication
    rodauth = RodauthMain.new(scope: self)
    unless rodauth.authenticated?
      render json: { error: "Acceso no autorizado" }, status: :unauthorized
    end
  end
end
Ejemplo de Rutas Protegidas en config/routes.rb
Rails.application.routes.draw do
  namespace :api do
    resources :transactions, only: [:index, :create]
  end
end
Ejemplo de TransactionsController Protegido con JWT
class Api::TransactionsController < ApplicationController
  def index
    render json: { message: "Lista de transacciones", transactions: [] }
  end
end
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(auth-jwt): protege rutas de la API usando autenticación con JWT"
📌 Commit 59.5: Agregar Logout y Revocación de Tokens
🔹 Mensaje de commit:
feat(auth-jwt): agrega logout y revocación de JWT en Rodauth
🔹 Contenido del commit:
Modificar Web3AuthController para Logout
def logout
  rodauth = RodauthMain.new(scope: self)
  rodauth.logout
  render json: { message: "Sesión cerrada exitosamente" }
end
Agregar Ruta para Logout en config/routes.rb
delete "/auth/logout", to: "web3_auth#logout"
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(auth-jwt): agrega logout y revocación de JWT en Rodauth"
📝 Explicación y Código Generado
Ejemplo de Login con Web3 + JWT en API
curl -X POST "http://localhost:3000/auth/web3_login" \
  -H "Content-Type: application/json" \
  -d '{ "wallet_address": "0xUserWallet", "signature": "0xFirmaDigital" }'
✅ Si la firma es válida:
{ "message": "Autenticación exitosa", "user": { "id": 1, "wallet_address": "0xUserWallet" }, "token": "eyJhbGciOiJIUzI1NiIsInR..." }
Ejemplo de Acceso a Rutas Protegidas con JWT
curl -X GET "http://localhost:3000/api/transactions" \
  -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR..."
✅ Si el token es válido:
{ "message": "Lista de transacciones", "transactions": [] }
❌ Si el token es inválido:
{ "error": "Acceso no autorizado" }
Ejemplo de Logout y Revocación de Token
curl -X DELETE "http://localhost:3000/auth/logout" \
  -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR..."
✅ Si el logout es exitoso:
{ "message": "Sesión cerrada exitosamente" }
