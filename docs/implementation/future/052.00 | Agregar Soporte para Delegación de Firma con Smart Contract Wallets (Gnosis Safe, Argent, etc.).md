# âœ… Paso 52: Agregar Soporte para DelegaciÃ³n de Firma con Smart Contract Wallets (Gnosis Safe, Argent, etc.)

Ahora agregaremos soporte para delegaciÃ³n de firma con Smart Contract Wallets, permitiendo que los usuarios autentiquen con contratos inteligentes en lugar de wallets EOAs (Externally Owned Accounts).
âœ… Soporte para Gnosis Safe, Argent, Ambire Wallet â†’ Firmas delegadas.
âœ… EIP-1271: Signature Validation for Contracts â†’ ValidaciÃ³n de firmas en contratos.
âœ… SIWE (Sign-In with Ethereum) â†’ Compatible con autenticaciÃ³n Web3.
âœ… Web3.js + Stimulus.js â†’ Para manejar la autenticaciÃ³n en la UI.
âœ… VerificaciÃ³n On-Chain con Web3.eth.call â†’ Para validar firmas sin backend.
ğŸ“Œ Commit 52.1: Modificar AutenticaciÃ³n Web3 para Soportar Smart Contract Wallets
ğŸ”¹ Mensaje de commit:
feat(web3id): agrega soporte para autenticaciÃ³n con Smart Contract Wallets (Gnosis Safe, Argent)
ğŸ”¹ Contenido del commit:
Modificar config/initializers/devise.rb para Verificar Firmas en Smart Contracts
require "ethereum"
Warden::Strategies.add(:web3_auth) do
  def valid?
    params["wallet_address"].present? && params["signature"].present?
  end
  def authenticate!
    wallet_address = params["wallet_address"]
    signature = params["signature"]
    nonce = session[:web3_nonce]
    message = "Bienvenido a nuestra plataforma. Nonce: #{nonce}"
    # Intentar verificar firma como EOA (Externally Owned Account)
    signer_address = Ethereum::Message.verify_signature(message, signature)
    if signer_address.downcase == wallet_address.downcase
      user = User.find_or_create_by(wallet_address: wallet_address)
      success!(user)
      return
    end
    # Si la firma no es vÃ¡lida, verificar como Smart Contract Wallet (EIP-1271)
    if SmartContractWalletService.verify_signature(wallet_address, message, signature)
      user = User.find_or_create_by(wallet_address: wallet_address)
      success!(user)
    else
      fail!("Firma invÃ¡lida")
    end
  end
end
ğŸ”¹ AÃ±adir archivos al commit:
git add .
git commit -m "feat(web3id): agrega soporte para autenticaciÃ³n con Smart Contract Wallets (Gnosis Safe, Argent)"
ğŸ“Œ Commit 52.2: Crear Servicio para Validar Firmas en Smart Contracts (EIP-1271)
ğŸ”¹ Mensaje de commit:
feat(web3id): agrega validaciÃ³n de firmas en Smart Contract Wallets usando EIP-1271
ğŸ”¹ Contenido del commit:
Definir SmartContractWalletService en app/services/smart_contract_wallet_service.rb
require "web3"
class SmartContractWalletService
  INFURA_URL = Rails.application.credentials.dig(:ethereum, :infura_url)
  def self.verify_signature(contract_address, message, signature)
    web3 = Web3::Eth::Rpc.new(host: INFURA_URL, port: 443, connect_options: { use_ssl: true })
    signature_valid = web3.eth.call({
      to: contract_address,
      data: encode_validation_call(message, signature)
    })
    return signature_valid == "0x1626ba7e" # Magic value de EIP-1271 para firmas vÃ¡lidas
  end
  private
  def self.encode_validation_call(message, signature)
    method_signature = "0x1626ba7e" # Magic value de EIP-1271
    message_hash = Web3::Utils.keccak256(message)
    encoded_data = Web3::Utils.solidity_encode(["bytes32", "bytes"], [message_hash, signature])
    method_signature + encoded_data
  end
end
ğŸ”¹ AÃ±adir archivos al commit:
git add .
git commit -m "feat(web3id): agrega validaciÃ³n de firmas en Smart Contract Wallets usando EIP-1271"
ğŸ“Œ Commit 52.3: Modificar UI para Permitir AutenticaciÃ³n con Smart Contract Wallets
ğŸ”¹ Mensaje de commit:
feat(web3id): agrega autenticaciÃ³n con Smart Contract Wallets en la UI con Web3.js
ğŸ”¹ Contenido del commit:
Modificar app/javascript/controllers/web3_auth_controller.js
import { Controller } from "@hotwired/stimulus";
import Web3 from "web3";
export default class extends Controller {
  async connectWallet() {
    if (window.ethereum) {
      const web3 = new Web3(window.ethereum);
      await window.ethereum.request({ method: "eth_requestAccounts" });
      this.walletAddress = (await web3.eth.getAccounts())[0];
      // Verificar si es una Smart Contract Wallet
      const code = await web3.eth.getCode(this.walletAddress);
      const isSmartContractWallet = code !== "0x";
      const nonceResponse = await fetch("/users/web3_nonce");
      const { nonce } = await nonceResponse.json();
      let signature;
      if (isSmartContractWallet) {
        // Firmar con EIP-1271 en Gnosis Safe / Argent
        signature = await web3.eth.sign(nonce, this.walletAddress);
      } else {
        // Firmar con cuenta normal (EOA)
        signature = await web3.eth.personal.sign(nonce, this.walletAddress);
      }
      const loginResponse = await fetch("/users/web3_sign_in", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ wallet_address: this.walletAddress, signature })
      });
      if (loginResponse.ok) {
        alert("AutenticaciÃ³n exitosa");
        window.location.reload();
      } else {
        alert("Error al autenticar");
      }
    } else {
      alert("MetaMask no estÃ¡ instalado");
    }
  }
}
ğŸ”¹ AÃ±adir archivos al commit:
git add .
git commit -m "feat(web3id): agrega autenticaciÃ³n con Smart Contract Wallets en la UI con Web3.js"
ğŸ“ ExplicaciÃ³n y CÃ³digo Generado
Ejemplo de VerificaciÃ³n de Firma en una Smart Contract Wallet
SmartContractWalletService.verify_signature("0xGnosisSafeAddress", "Bienvenido a la app", "0xFirmaDigital")
âœ… Devuelve true si la firma es vÃ¡lida, false si no lo es.
Ejemplo de Inicio de SesiÃ³n con Smart Contract Wallet en API
curl -X POST "http://localhost:3000/users/web3_sign_in" \
  -H "Content-Type: application/json" \
  -d '{ "wallet_address": "0xGnosisSafeAddress", "signature": "0xFirmaDigital" }'
âœ… Si la firma es vÃ¡lida:
{ "message": "AutenticaciÃ³n exitosa", "user": { "id": 1, "wallet_address": "0xGnosisSafeAddress" } }
âŒ Si la firma es invÃ¡lida:
{ "error": "Firma invÃ¡lida" }
Ejemplo de Inicio de SesiÃ³n con MetaMask o Gnosis Safe
document.querySelector("button").click();
âœ… El usuario firma un mensaje y se autentica sin contraseÃ±a.
