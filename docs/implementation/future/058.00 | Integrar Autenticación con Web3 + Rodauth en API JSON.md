# âœ… Paso 58: Integrar AutenticaciÃ³n con Web3 + Rodauth en API JSON

Ahora agregaremos una API JSON para autenticaciÃ³n con Web3 ID + Rodauth, permitiendo que clientes mÃ³viles, aplicaciones frontend externas y dApps se autentiquen de manera segura.
âœ… Rodauth JSON API â†’ Manejo completo de autenticaciÃ³n sin vistas HTML.
âœ… Web3 Sign-In con Ethereum (SIWE) â†’ Permite autenticaciÃ³n sin contraseÃ±as.
âœ… Passkeys (WebAuthn) + Smart Contract Wallets â†’ MÃ©todos alternativos de autenticaciÃ³n.
âœ… MFA con TOTP y SMS â†’ Seguridad adicional para cuentas crÃ­ticas.
âœ… Rails API Mode + Turbo Streams â†’ UI fluida sin recargas.
ğŸ“Œ Commit 58.1: Activar Rodauth en Modo JSON API
ğŸ”¹ Mensaje de commit:
feat(auth-api): habilita API JSON para autenticaciÃ³n con Rodauth en Rails
ğŸ”¹ Contenido del commit:
Modificar config/initializers/rodauth.rb
RodauthMain.configure do
  enable :json
  json_response_content_type "application/json"
  before_json_response do
    response["Access-Control-Allow-Origin"] = "*"
    response["Access-Control-Allow-Methods"] = "POST, GET, OPTIONS, DELETE"
  end
end
ğŸ”¹ AÃ±adir archivos al commit:
git add .
git commit -m "feat(auth-api): habilita API JSON para autenticaciÃ³n con Rodauth en Rails"
ğŸ“Œ Commit 58.2: Agregar Endpoint para Web3 Sign-In API
ğŸ”¹ Mensaje de commit:
feat(auth-api): agrega soporte para autenticaciÃ³n con Web3 ID en la API JSON
ğŸ”¹ Contenido del commit:
Definir Web3AuthController en app/controllers/web3_auth_controller.rb
class Web3AuthController < ApplicationController
  skip_before_action :verify_authenticity_token
  def nonce
    session[:web3_nonce] = SecureRandom.hex(16)
    render json: { nonce: session[:web3_nonce] }
  end
  def login
    wallet = params[:wallet_address]
    signature = params[:signature]
    nonce = session[:web3_nonce]
    return render json: { error: "Nonce invÃ¡lido" }, status: :unauthorized unless nonce
    # Verificar firma de Ethereum
    signer = Ethereum::Message.verify_signature("Nonce: #{nonce}", signature)
    if signer.downcase == wallet.downcase
      user = User.find_or_create_by(wallet_address: wallet)
      session[:account_id] = user.id
      render json: { message: "AutenticaciÃ³n exitosa", user: user }
    else
      render json: { error: "Firma invÃ¡lida" }, status: :unauthorized
    end
  end
end
Agregar Rutas en config/routes.rb
Rails.application.routes.draw do
  post "/auth/web3_nonce", to: "web3_auth#nonce"
  post "/auth/web3_login", to: "web3_auth#login"
end
ğŸ”¹ AÃ±adir archivos al commit:
git add .
git commit -m "feat(auth-api): agrega soporte para autenticaciÃ³n con Web3 ID en la API JSON"
ğŸ“Œ Commit 58.3: Agregar API para Registro y Login con Passkeys (WebAuthn)
ğŸ”¹ Mensaje de commit:
feat(auth-api): agrega soporte para autenticaciÃ³n con Passkeys en API JSON
ğŸ”¹ Contenido del commit:
Modificar Web3AuthController para Soporte WebAuthn
def webauthn_options
  options = WebAuthn::Credential.options_for_registration
  session[:webauthn_challenge] = options.challenge
  render json: options
end
def register_webauthn
  user = User.find_or_create_by(wallet_address: params[:wallet_address])
  credential = WebAuthn::Credential.from_create(params[:credential])
  credential.verify(session[:webauthn_challenge])
  user.web_authn_credentials.create!(
    credential_id: credential.id,
    public_key: credential.public_key,
    sign_count: credential.sign_count
  )
  render json: { message: "Passkey registrada con Ã©xito" }
end
Agregar Rutas en config/routes.rb
post "/auth/webauthn_options", to: "web3_auth#webauthn_options"
post "/auth/register_webauthn", to: "web3_auth#register_webauthn"
ğŸ”¹ AÃ±adir archivos al commit:
git add .
git commit -m "feat(auth-api): agrega soporte para autenticaciÃ³n con Passkeys en API JSON"
ğŸ“Œ Commit 58.4: Integrar API de MFA (TOTP + SMS)
ğŸ”¹ Mensaje de commit:
feat(auth-api): agrega API para Multi-Factor Authentication (MFA) con TOTP y SMS
ğŸ”¹ Contenido del commit:
Modificar Web3AuthController para Soporte MFA
def enable_totp
  user = User.find_by(wallet_address: params[:wallet_address])
  return render json: { error: "Usuario no encontrado" }, status: :not_found unless user
  uri = user.rodauth.otp_provisioning_uri
  render json: { qr_code_url: uri }
end
def verify_totp
  user = User.find_by(wallet_address: params[:wallet_address])
  return render json: { error: "Usuario no encontrado" }, status: :not_found unless user
  if user.rodauth.otp_authenticate(params[:otp])
    render json: { message: "MFA activado con Ã©xito" }
  else
    render json: { error: "CÃ³digo OTP invÃ¡lido" }, status: :unauthorized
  end
end
Agregar Rutas en config/routes.rb
post "/auth/enable_totp", to: "web3_auth#enable_totp"
post "/auth/verify_totp", to: "web3_auth#verify_totp"
ğŸ”¹ AÃ±adir archivos al commit:
git add .
git commit -m "feat(auth-api): agrega API para Multi-Factor Authentication (MFA) con TOTP y SMS"
ğŸ“ ExplicaciÃ³n y CÃ³digo Generado
Ejemplo de GeneraciÃ³n de Nonce para Web3 Login
curl -X POST "http://localhost:3000/auth/web3_nonce"
âœ… Respuesta esperada:
{ "nonce": "a1b2c3d4e5f6g7h8" }
Ejemplo de Login con Web3 (Firma Digital)
curl -X POST "http://localhost:3000/auth/web3_login" \
  -H "Content-Type: application/json" \
  -d '{ "wallet_address": "0xUserWallet", "signature": "0xFirmaDigital" }'
âœ… Si la firma es vÃ¡lida:
{ "message": "AutenticaciÃ³n exitosa", "user": { "id": 1, "wallet_address": "0xUserWallet" } }
Ejemplo de Registro con Passkey en API
curl -X POST "http://localhost:3000/auth/register_webauthn" \
  -H "Content-Type: application/json" \
  -d '{ "wallet_address": "0xUserWallet", "credential": { "id": "credential_id", "public_key": "key_data" } }'
âœ… Si la Passkey es vÃ¡lida:
{ "message": "Passkey registrada con Ã©xito" }
Ejemplo de ActivaciÃ³n de MFA con Google Authenticator
curl -X POST "http://localhost:3000/auth/enable_totp" \
  -H "Content-Type: application/json" \
  -d '{ "wallet_address": "0xUserWallet" }'
âœ… Devuelve la URL del cÃ³digo QR para escanear en Google Authenticator.
