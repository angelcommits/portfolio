# ✅ Paso 58: Integrar Autenticación con Web3 + Rodauth en API JSON

Ahora agregaremos una API JSON para autenticación con Web3 ID + Rodauth, permitiendo que clientes móviles, aplicaciones frontend externas y dApps se autentiquen de manera segura.
✅ Rodauth JSON API → Manejo completo de autenticación sin vistas HTML.
✅ Web3 Sign-In con Ethereum (SIWE) → Permite autenticación sin contraseñas.
✅ Passkeys (WebAuthn) + Smart Contract Wallets → Métodos alternativos de autenticación.
✅ MFA con TOTP y SMS → Seguridad adicional para cuentas críticas.
✅ Rails API Mode + Turbo Streams → UI fluida sin recargas.
📌 Commit 58.1: Activar Rodauth en Modo JSON API
🔹 Mensaje de commit:
feat(auth-api): habilita API JSON para autenticación con Rodauth en Rails
🔹 Contenido del commit:
Modificar config/initializers/rodauth.rb
RodauthMain.configure do
  enable :json
  json_response_content_type "application/json"
  before_json_response do
    response["Access-Control-Allow-Origin"] = "*"
    response["Access-Control-Allow-Methods"] = "POST, GET, OPTIONS, DELETE"
  end
end
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(auth-api): habilita API JSON para autenticación con Rodauth en Rails"
📌 Commit 58.2: Agregar Endpoint para Web3 Sign-In API
🔹 Mensaje de commit:
feat(auth-api): agrega soporte para autenticación con Web3 ID en la API JSON
🔹 Contenido del commit:
Definir Web3AuthController en app/controllers/web3_auth_controller.rb
class Web3AuthController < ApplicationController
  skip_before_action :verify_authenticity_token
  def nonce
    session[:web3_nonce] = SecureRandom.hex(16)
    render json: { nonce: session[:web3_nonce] }
  end
  def login
    wallet = params[:wallet_address]
    signature = params[:signature]
    nonce = session[:web3_nonce]
    return render json: { error: "Nonce inválido" }, status: :unauthorized unless nonce
    # Verificar firma de Ethereum
    signer = Ethereum::Message.verify_signature("Nonce: #{nonce}", signature)
    if signer.downcase == wallet.downcase
      user = User.find_or_create_by(wallet_address: wallet)
      session[:account_id] = user.id
      render json: { message: "Autenticación exitosa", user: user }
    else
      render json: { error: "Firma inválida" }, status: :unauthorized
    end
  end
end
Agregar Rutas en config/routes.rb
Rails.application.routes.draw do
  post "/auth/web3_nonce", to: "web3_auth#nonce"
  post "/auth/web3_login", to: "web3_auth#login"
end
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(auth-api): agrega soporte para autenticación con Web3 ID en la API JSON"
📌 Commit 58.3: Agregar API para Registro y Login con Passkeys (WebAuthn)
🔹 Mensaje de commit:
feat(auth-api): agrega soporte para autenticación con Passkeys en API JSON
🔹 Contenido del commit:
Modificar Web3AuthController para Soporte WebAuthn
def webauthn_options
  options = WebAuthn::Credential.options_for_registration
  session[:webauthn_challenge] = options.challenge
  render json: options
end
def register_webauthn
  user = User.find_or_create_by(wallet_address: params[:wallet_address])
  credential = WebAuthn::Credential.from_create(params[:credential])
  credential.verify(session[:webauthn_challenge])
  user.web_authn_credentials.create!(
    credential_id: credential.id,
    public_key: credential.public_key,
    sign_count: credential.sign_count
  )
  render json: { message: "Passkey registrada con éxito" }
end
Agregar Rutas en config/routes.rb
post "/auth/webauthn_options", to: "web3_auth#webauthn_options"
post "/auth/register_webauthn", to: "web3_auth#register_webauthn"
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(auth-api): agrega soporte para autenticación con Passkeys en API JSON"
📌 Commit 58.4: Integrar API de MFA (TOTP + SMS)
🔹 Mensaje de commit:
feat(auth-api): agrega API para Multi-Factor Authentication (MFA) con TOTP y SMS
🔹 Contenido del commit:
Modificar Web3AuthController para Soporte MFA
def enable_totp
  user = User.find_by(wallet_address: params[:wallet_address])
  return render json: { error: "Usuario no encontrado" }, status: :not_found unless user
  uri = user.rodauth.otp_provisioning_uri
  render json: { qr_code_url: uri }
end
def verify_totp
  user = User.find_by(wallet_address: params[:wallet_address])
  return render json: { error: "Usuario no encontrado" }, status: :not_found unless user
  if user.rodauth.otp_authenticate(params[:otp])
    render json: { message: "MFA activado con éxito" }
  else
    render json: { error: "Código OTP inválido" }, status: :unauthorized
  end
end
Agregar Rutas en config/routes.rb
post "/auth/enable_totp", to: "web3_auth#enable_totp"
post "/auth/verify_totp", to: "web3_auth#verify_totp"
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(auth-api): agrega API para Multi-Factor Authentication (MFA) con TOTP y SMS"
📝 Explicación y Código Generado
Ejemplo de Generación de Nonce para Web3 Login
curl -X POST "http://localhost:3000/auth/web3_nonce"
✅ Respuesta esperada:
{ "nonce": "a1b2c3d4e5f6g7h8" }
Ejemplo de Login con Web3 (Firma Digital)
curl -X POST "http://localhost:3000/auth/web3_login" \
  -H "Content-Type: application/json" \
  -d '{ "wallet_address": "0xUserWallet", "signature": "0xFirmaDigital" }'
✅ Si la firma es válida:
{ "message": "Autenticación exitosa", "user": { "id": 1, "wallet_address": "0xUserWallet" } }
Ejemplo de Registro con Passkey en API
curl -X POST "http://localhost:3000/auth/register_webauthn" \
  -H "Content-Type: application/json" \
  -d '{ "wallet_address": "0xUserWallet", "credential": { "id": "credential_id", "public_key": "key_data" } }'
✅ Si la Passkey es válida:
{ "message": "Passkey registrada con éxito" }
Ejemplo de Activación de MFA con Google Authenticator
curl -X POST "http://localhost:3000/auth/enable_totp" \
  -H "Content-Type: application/json" \
  -d '{ "wallet_address": "0xUserWallet" }'
✅ Devuelve la URL del código QR para escanear en Google Authenticator.
