# ‚úÖ Paso 114: Integrar Tesorer√≠a Multi-Sig con Safe (antes Gnosis Safe)

Ahora agregaremos Safe (antes Gnosis Safe), permitiendo que la DAO gestione su tesorer√≠a con firmas m√∫ltiples y permisos avanzados.
‚úÖ Seguridad con Multi-Sig ‚Üí Requiere varias firmas para aprobar transacciones.
‚úÖ Gobernanza Descentralizada ‚Üí Control compartido de los fondos de la DAO.
‚úÖ Compatibilidad con EVM ‚Üí Funciona en Ethereum, Polygon, Arbitrum y m√°s.
‚úÖ Web3.js + Stimulus.js ‚Üí Para gestionar transacciones multi-sig desde la UI.
‚úÖ Safe API + Smart Contracts ‚Üí Para ejecutar pagos, distribuir fondos y auditar transacciones.
üìå Commit 114.1: Configurar Safe para la Tesorer√≠a de la DAO
üîπ Mensaje de commit:
feat(safe-config): configura Safe para la gesti√≥n segura de la tesorer√≠a de la DAO
üîπ Contenido del commit:
1Ô∏è‚É£ Registrar la DAO en Safe
    Crear un Safe Wallet y definir firmantes.
    Configurar m√≥dulos y roles (ej. Finanzas, Gobernanza).
2Ô∏è‚É£ A√±adir Configuraci√≥n en config/safe.yml
safe:
  enabled: true
  safe_address: "0xYourSafeAddress"
  owners:
    - "0xOwner1"
    - "0xOwner2"
    - "0xOwner3"
  threshold: 2 # Requiere al menos 2 firmas para ejecutar transacciones
  networks:
    ethereum: true
    polygon: true
    arbitrum: false
üîπ A√±adir archivos al commit:
git add .
git commit -m "feat(safe-config): configura Safe para la gesti√≥n segura de la tesorer√≠a de la DAO"
üìå Commit 114.2: Implementar Servicio de Firma y Aprobaci√≥n Multi-Sig
üîπ Mensaje de commit:
feat(safe-multisig-service): agrega servicio para firmar y aprobar transacciones multi-sig en la DAO con Safe
üîπ Contenido del commit:
Definir SafeMultisigService.rb en app/services/safe_multisig_service.rb
require "httparty"
class SafeMultisigService
  SAFE_API_URL = "https://safe-transaction-mainnet.safe.global/api/v1"
  SAFE_ADDRESS = ENV["SAFE_ADDRESS"]
  def self.create_transaction(to, value, data)
    payload = {
      to: to,
      value: value.to_s,
      data: data,
      safeTxGas: 0
    }
    response = HTTParty.post("#{SAFE_API_URL}/safes/#{SAFE_ADDRESS}/multisig-transactions/",
                             headers: { "Content-Type" => "application/json" },
                             body: payload.to_json)
    return JSON.parse(response.body) if response.success?
    nil
  end
  def self.approve_transaction(tx_hash)
    response = HTTParty.post("#{SAFE_API_URL}/transactions/#{tx_hash}/confirmations/")
    response.success?
  end
end
üîπ A√±adir archivos al commit:
git add .
git commit -m "feat(safe-multisig-service): agrega servicio para firmar y aprobar transacciones multi-sig en la DAO con Safe"
üìå Commit 114.3: Integrar UI para Gesti√≥n de Tesorer√≠a Multi-Sig
üîπ Mensaje de commit:
feat(safe-ui): agrega UI para gestionar transacciones multi-sig de la DAO con Safe
üîπ Contenido del commit:
Modificar app/javascript/controllers/safe_controller.js
import { Controller } from "@hotwired/stimulus";
export default class extends Controller {
  static targets = ["recipient", "amount", "data", "txHash"];
  async createTransaction() {
    const response = await fetch("/safe/create_transaction", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        to: this.recipientTarget.value,
        value: this.amountTarget.value,
        data: this.dataTarget.value
      })
    });
    const data = await response.json();
    this.txHashTarget.value = data.safeTxHash || "Error al crear transacci√≥n";
  }
  async approveTransaction() {
    const response = await fetch("/safe/approve_transaction", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ tx_hash: this.txHashTarget.value })
    });
    alert(response.ok ? "Transacci√≥n aprobada" : "Error al aprobar transacci√≥n");
  }
}
Modificar app/views/safe/index.html.erb
<h2>Gesti√≥n de Tesorer√≠a Multi-Sig con Safe</h2>
<h3>Crear Transacci√≥n</h3>
<label>Destinatario:</label>
<input type="text" data-safe-target="recipient">
<label>Monto (ETH):</label>
<input type="text" data-safe-target="amount">
<label>Datos (Opcional):</label>
<input type="text" data-safe-target="data">
<button data-controller="safe" data-action="click->safe#createTransaction">
  Crear Transacci√≥n
</button>
<h3>Aprobar Transacci√≥n</h3>
<label>Hash de Transacci√≥n:</label>
<input type="text" data-safe-target="txHash">
<button data-controller="safe" data-action="click->safe#approveTransaction">
  Aprobar Transacci√≥n
</button>
üîπ A√±adir archivos al commit:
git add .
git commit -m "feat(safe-ui): agrega UI para gestionar transacciones multi-sig de la DAO con Safe"
üìù Explicaci√≥n y C√≥digo Generado
Ejemplo de Creaci√≥n de Transacci√≥n Multi-Sig en API
curl -X POST "http://localhost:3000/safe/create_transaction" \
  -H "Content-Type: application/json" \
  -d '{ "to": "0xRecipient", "value": 1, "data": "0x" }'
‚úÖ Crea una transacci√≥n multi-sig en la DAO.
Ejemplo de Aprobaci√≥n de Transacci√≥n en API
curl -X POST "http://localhost:3000/safe/approve_transaction" \
  -H "Content-Type: application/json" \
  -d '{ "tx_hash": "0xTransactionHash" }'
‚úÖ Aprueba una transacci√≥n en la DAO con Safe Multi-Sig.
Ejemplo de Panel de Tesorer√≠a Multi-Sig en Safe
https://app.safe.global/
‚úÖ Los miembros de la DAO pueden gestionar la tesorer√≠a de forma segura.
