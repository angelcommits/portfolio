# ✅ Paso 53: Integrar Recuperación de Cuenta usando Passkeys (WebAuthn)

Ahora agregaremos soporte para recuperación de cuenta con Passkeys/WebAuthn, permitiendo que los usuarios recuperen acceso a su cuenta Web3 sin necesidad de claves privadas.
✅ Passkeys (WebAuthn) → Autenticación sin contraseñas con Face ID, Touch ID y llaves de seguridad FIDO.
✅ Devise + WebAuthn Rails → Para manejar credenciales seguras en la app.
✅ Backup Web3 Recovery → Para recuperar cuentas en caso de pérdida de acceso a la wallet.
✅ Turbo Streams + Stimulus.js → Para una experiencia de usuario fluida.
📌 Commit 53.1: Instalar Gema webauthn-ruby para Soporte de Passkeys
🔹 Mensaje de commit:
feat(webauthn): instala la gema webauthn-ruby para autenticación con Passkeys
🔹 Contenido del commit:
Instalar la gema webauthn-ruby
bundle add webauthn
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(webauthn): instala la gema webauthn-ruby para autenticación con Passkeys"
📌 Commit 53.2: Configurar WebAuthn en Devise para Recuperación de Cuenta
🔹 Mensaje de commit:
feat(webauthn): configura Devise para permitir autenticación con Passkeys
🔹 Contenido del commit:
Modificar config/initializers/webauthn.rb
WebAuthn.configure do |config|
  config.origin = "https://your-rails-app.com"
  config.rp_name = "My Web3 App"
  config.credential_options_timeout = 120_000
end
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(webauthn): configura Devise para permitir autenticación con Passkeys"
📌 Commit 53.3: Crear Modelo WebAuthnCredential para Guardar Passkeys
🔹 Mensaje de commit:
feat(webauthn): agrega modelo WebAuthnCredential para almacenar claves Passkeys
🔹 Contenido del commit:
Generar Modelo y Migración
rails g model WebAuthnCredential user:references credential_id:string public_key:string sign_count:integer
rails db:migrate
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(webauthn): agrega modelo WebAuthnCredential para almacenar claves Passkeys"
📌 Commit 53.4: Agregar Endpoints para Registro y Autenticación con Passkeys
🔹 Mensaje de commit:
feat(webauthn): agrega endpoints para registrar y autenticar usuarios con Passkeys
🔹 Contenido del commit:
Modificar RegistrationsController para Registrar Passkeys
class RegistrationsController < Devise::RegistrationsController
  def webauthn_options
    user = User.find_by(wallet_address: params[:wallet_address])
    if user
      options = WebAuthn::Credential.options_for_registration
      session[:webauthn_challenge] = options.challenge
      render json: options
    else
      render json: { error: "Usuario no encontrado" }, status: :not_found
    end
  end
  def register_webauthn
    user = User.find_by(wallet_address: params[:wallet_address])
    return render json: { error: "Usuario no encontrado" }, status: :not_found unless user
    begin
      credential = WebAuthn::Credential.from_create(params[:credential])
      credential.verify(session[:webauthn_challenge])
      user.web_authn_credentials.create!(
        credential_id: credential.id,
        public_key: credential.public_key,
        sign_count: credential.sign_count
      )
      render json: { message: "Passkey registrada con éxito" }
    rescue WebAuthn::Error
      render json: { error: "Error en la verificación de Passkey" }, status: :unprocessable_entity
    end
  end
end
Agregar Rutas en config/routes.rb
Rails.application.routes.draw do
  devise_scope :user do
    get "/users/webauthn_options", to: "registrations#webauthn_options"
    post "/users/register_webauthn", to: "registrations#register_webauthn"
  end
end
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(webauthn): agrega endpoints para registrar y autenticar usuarios con Passkeys"
📌 Commit 53.5: Integrar WebAuthn en la UI con JavaScript y Stimulus.js
🔹 Mensaje de commit:
feat(webauthn): integra WebAuthn en la UI con JavaScript y Stimulus.js
🔹 Contenido del commit:
Crear app/javascript/controllers/webauthn_controller.js
import { Controller } from "@hotwired/stimulus";
export default class extends Controller {
  async registerPasskey() {
    const walletAddress = prompt("Ingresa tu dirección de wallet Web3:");
    const optionsResponse = await fetch(`/users/webauthn_options?wallet_address=${walletAddress}`);
    const options = await optionsResponse.json();
    const credential = await navigator.credentials.create({
      publicKey: options
    });
    const credentialJSON = {
      id: credential.id,
      rawId: btoa(String.fromCharCode(...new Uint8Array(credential.rawId))),
      type: credential.type,
      response: {
        attestationObject: btoa(String.fromCharCode(...new Uint8Array(credential.response.attestationObject))),
        clientDataJSON: btoa(String.fromCharCode(...new Uint8Array(credential.response.clientDataJSON)))
      }
    };
    const registerResponse = await fetch("/users/register_webauthn", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ wallet_address: walletAddress, credential: credentialJSON })
    });
    if (registerResponse.ok) {
      alert("Passkey registrada exitosamente");
    } else {
      alert("Error al registrar la Passkey");
    }
  }
}
Modificar app/views/devise/registrations/new.html.erb
<h2>Registrar Passkey</h2>
<button data-controller="webauthn" data-action="click->webauthn#registerPasskey">
  Registrar Passkey
</button>
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(webauthn): integra WebAuthn en la UI con JavaScript y Stimulus.js"
📝 Explicación y Código Generado
Ejemplo de Registro de Passkey en API
curl -X POST "http://localhost:3000/users/register_webauthn" \
  -H "Content-Type: application/json" \
  -d '{ "wallet_address": "0xUserWallet", "credential": { "id": "credential_id", "public_key": "key_data" } }'
✅ Si la Passkey es válida:
{ "message": "Passkey registrada con éxito" }
❌ Si la verificación falla:
{ "error": "Error en la verificación de Passkey" }
Ejemplo de Registro en la UI
document.querySelector("button").click();
✅ El usuario escanea Face ID / Touch ID y registra su Passkey.
