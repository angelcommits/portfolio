# âœ… Paso 47: Agregar Soporte para Notificaciones en Telegram y Discord

Ahora agregaremos soporte para enviar alertas de contratos pendientes a Telegram y Discord, permitiendo que los usuarios reciban notificaciones en tiempo real sobre contratos que necesitan su firma en Gnosis Safe.
âœ… Telegram Bot API â†’ Para enviar mensajes a canales/grupos de Telegram.
âœ… Discord Webhooks â†’ Para enviar alertas a servidores de Discord.
âœ… Turbo Streams + Stimulus.js â†’ Para notificaciones en la UI.
âœ… Rails Background Jobs â†’ Para procesar las notificaciones en segundo plano.
ðŸ“Œ Commit 47.1: Configurar Webhooks de Telegram y Discord
ðŸ”¹ Mensaje de commit:
feat(notifications): configura webhooks para enviar notificaciones a Telegram y Discord
ðŸ”¹ Contenido del commit:
AÃ±adir ConfiguraciÃ³n de Webhooks en config/credentials.yml.enc
telegram:
  bot_token: "YOUR_TELEGRAM_BOT_TOKEN"
  chat_id: "YOUR_TELEGRAM_CHAT_ID"
discord:
  webhook_url: "YOUR_DISCORD_WEBHOOK_URL"
ðŸ”¹ AÃ±adir archivos al commit:
git add .
git commit -m "feat(notifications): configura webhooks para enviar notificaciones a Telegram y Discord"
ðŸ“Œ Commit 47.2: Crear Servicio para Enviar Notificaciones a Telegram
ðŸ”¹ Mensaje de commit:
feat(notifications): agrega servicio para enviar alertas a Telegram
ðŸ”¹ Contenido del commit:
Definir TelegramNotifierService en app/services/telegram_notifier_service.rb
require "httparty"
class TelegramNotifierService
  TELEGRAM_API_URL = "https://api.telegram.org/bot"
  def self.send_message(message)
    bot_token = Rails.application.credentials.dig(:telegram, :bot_token)
    chat_id = Rails.application.credentials.dig(:telegram, :chat_id)
    url = "#{TELEGRAM_API_URL}#{bot_token}/sendMessage"
    payload = { chat_id: chat_id, text: message, parse_mode: "Markdown" }
    HTTParty.post(url, body: payload)
  end
end
ðŸ”¹ AÃ±adir archivos al commit:
git add .
git commit -m "feat(notifications): agrega servicio para enviar alertas a Telegram"
ðŸ“Œ Commit 47.3: Crear Servicio para Enviar Notificaciones a Discord
ðŸ”¹ Mensaje de commit:
feat(notifications): agrega servicio para enviar alertas a Discord
ðŸ”¹ Contenido del commit:
Definir DiscordNotifierService en app/services/discord_notifier_service.rb
require "httparty"
class DiscordNotifierService
  def self.send_message(message)
    webhook_url = Rails.application.credentials.dig(:discord, :webhook_url)
    payload = { content: message }
    HTTParty.post(webhook_url, body: payload.to_json, headers: { "Content-Type" => "application/json" })
  end
end
ðŸ”¹ AÃ±adir archivos al commit:
git add .
git commit -m "feat(notifications): agrega servicio para enviar alertas a Discord"
ðŸ“Œ Commit 47.4: Integrar Notificaciones en Background Jobs
ðŸ”¹ Mensaje de commit:
feat(notifications): integra Telegram y Discord en los procesos de notificaciÃ³n en background
ðŸ”¹ Contenido del commit:
Crear Job SendContractNotificationJob
rails g job send_contract_notification
Modificar app/jobs/send_contract_notification_job.rb
class SendContractNotificationJob < ApplicationJob
  queue_as :default
  def perform(contract)
    message = "ðŸ”” *Contrato Pendiente en Gnosis Safe*\n" \
              "ðŸ“œ Hash: #{contract[:hash]}\n" \
              "ðŸ”‘ Firmas requeridas: #{contract[:required_signatures]}\n" \
              "âœï¸ Firmas actuales: #{contract[:current_signatures]}\n"
    TelegramNotifierService.send_message(message)
    DiscordNotifierService.send_message(message)
  end
end
ðŸ”¹ AÃ±adir archivos al commit:
git add .
git commit -m "feat(notifications): integra Telegram y Discord en los procesos de notificaciÃ³n en background"
ðŸ“Œ Commit 47.5: Enviar Notificaciones Cuando un Contrato Necesite Firmas
ðŸ”¹ Mensaje de commit:
feat(notifications): dispara notificaciones en Telegram y Discord cuando un contrato requiera firmas
ðŸ”¹ Contenido del commit:
Modificar ContractsController para Enviar Notificaciones
class ContractsController < ApplicationController
  def notify_pending_signatures
    pending_contracts = GnosisSafeService.pending_signatures
    pending_contracts.each do |contract|
      SendContractNotificationJob.perform_later(contract)
      ActionCable.server.broadcast("gnosis_safe_notifications", render_to_string(
        turbo_stream: turbo_stream.append("gnosis_notifications", partial: "contracts/contract", locals: { contract: contract })
      ))
    end
    render json: { message: "Notificaciones enviadas a firmantes." }
  end
end
ðŸ”¹ AÃ±adir archivos al commit:
git add .
git commit -m "feat(notifications): dispara notificaciones en Telegram y Discord cuando un contrato requiera firmas"
ðŸ“ ExplicaciÃ³n y CÃ³digo Generado
Ejemplo de EnvÃ­o de NotificaciÃ³n Manual a Telegram y Discord
SendContractNotificationJob.perform_now({
  hash: "0x123456...",
  required_signatures: 3,
  current_signatures: 1
})
âœ… El usuario recibe un mensaje en Telegram y Discord:
ðŸ”” Contrato Pendiente en Gnosis Safe
ðŸ“œ Hash: 0x123456...
ðŸ”‘ Firmas requeridas: 3
âœï¸ Firmas actuales: 1
Ejemplo de NotificaciÃ³n en Rails Console
TelegramNotifierService.send_message("Test de notificaciÃ³n en Telegram.")
DiscordNotifierService.send_message("Test de notificaciÃ³n en Discord.")
âœ… Los mensajes aparecen en los respectivos canales.
Ejemplo de EnvÃ­o AutomÃ¡tico de NotificaciÃ³n cuando un Contrato se Necesita Firmar
curl -X GET "http://localhost:3000/contracts/notify_pending_signatures"
âœ… Todos los firmantes reciben la alerta en Telegram y Discord.
