# ✅ Paso 47: Agregar Soporte para Notificaciones en Telegram y Discord

Ahora agregaremos soporte para enviar alertas de contratos pendientes a Telegram y Discord, permitiendo que los usuarios reciban notificaciones en tiempo real sobre contratos que necesitan su firma en Gnosis Safe.
✅ Telegram Bot API → Para enviar mensajes a canales/grupos de Telegram.
✅ Discord Webhooks → Para enviar alertas a servidores de Discord.
✅ Turbo Streams + Stimulus.js → Para notificaciones en la UI.
✅ Rails Background Jobs → Para procesar las notificaciones en segundo plano.
📌 Commit 47.1: Configurar Webhooks de Telegram y Discord
🔹 Mensaje de commit:
feat(notifications): configura webhooks para enviar notificaciones a Telegram y Discord
🔹 Contenido del commit:
Añadir Configuración de Webhooks en config/credentials.yml.enc
telegram:
  bot_token: "YOUR_TELEGRAM_BOT_TOKEN"
  chat_id: "YOUR_TELEGRAM_CHAT_ID"
discord:
  webhook_url: "YOUR_DISCORD_WEBHOOK_URL"
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(notifications): configura webhooks para enviar notificaciones a Telegram y Discord"
📌 Commit 47.2: Crear Servicio para Enviar Notificaciones a Telegram
🔹 Mensaje de commit:
feat(notifications): agrega servicio para enviar alertas a Telegram
🔹 Contenido del commit:
Definir TelegramNotifierService en app/services/telegram_notifier_service.rb
require "httparty"
class TelegramNotifierService
  TELEGRAM_API_URL = "https://api.telegram.org/bot"
  def self.send_message(message)
    bot_token = Rails.application.credentials.dig(:telegram, :bot_token)
    chat_id = Rails.application.credentials.dig(:telegram, :chat_id)
    url = "#{TELEGRAM_API_URL}#{bot_token}/sendMessage"
    payload = { chat_id: chat_id, text: message, parse_mode: "Markdown" }
    HTTParty.post(url, body: payload)
  end
end
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(notifications): agrega servicio para enviar alertas a Telegram"
📌 Commit 47.3: Crear Servicio para Enviar Notificaciones a Discord
🔹 Mensaje de commit:
feat(notifications): agrega servicio para enviar alertas a Discord
🔹 Contenido del commit:
Definir DiscordNotifierService en app/services/discord_notifier_service.rb
require "httparty"
class DiscordNotifierService
  def self.send_message(message)
    webhook_url = Rails.application.credentials.dig(:discord, :webhook_url)
    payload = { content: message }
    HTTParty.post(webhook_url, body: payload.to_json, headers: { "Content-Type" => "application/json" })
  end
end
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(notifications): agrega servicio para enviar alertas a Discord"
📌 Commit 47.4: Integrar Notificaciones en Background Jobs
🔹 Mensaje de commit:
feat(notifications): integra Telegram y Discord en los procesos de notificación en background
🔹 Contenido del commit:
Crear Job SendContractNotificationJob
rails g job send_contract_notification
Modificar app/jobs/send_contract_notification_job.rb
class SendContractNotificationJob < ApplicationJob
  queue_as :default
  def perform(contract)
    message = "🔔 *Contrato Pendiente en Gnosis Safe*\n" \
              "📜 Hash: #{contract[:hash]}\n" \
              "🔑 Firmas requeridas: #{contract[:required_signatures]}\n" \
              "✍️ Firmas actuales: #{contract[:current_signatures]}\n"
    TelegramNotifierService.send_message(message)
    DiscordNotifierService.send_message(message)
  end
end
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(notifications): integra Telegram y Discord en los procesos de notificación en background"
📌 Commit 47.5: Enviar Notificaciones Cuando un Contrato Necesite Firmas
🔹 Mensaje de commit:
feat(notifications): dispara notificaciones en Telegram y Discord cuando un contrato requiera firmas
🔹 Contenido del commit:
Modificar ContractsController para Enviar Notificaciones
class ContractsController < ApplicationController
  def notify_pending_signatures
    pending_contracts = GnosisSafeService.pending_signatures
    pending_contracts.each do |contract|
      SendContractNotificationJob.perform_later(contract)
      ActionCable.server.broadcast("gnosis_safe_notifications", render_to_string(
        turbo_stream: turbo_stream.append("gnosis_notifications", partial: "contracts/contract", locals: { contract: contract })
      ))
    end
    render json: { message: "Notificaciones enviadas a firmantes." }
  end
end
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(notifications): dispara notificaciones en Telegram y Discord cuando un contrato requiera firmas"
📝 Explicación y Código Generado
Ejemplo de Envío de Notificación Manual a Telegram y Discord
SendContractNotificationJob.perform_now({
  hash: "0x123456...",
  required_signatures: 3,
  current_signatures: 1
})
✅ El usuario recibe un mensaje en Telegram y Discord:
🔔 Contrato Pendiente en Gnosis Safe
📜 Hash: 0x123456...
🔑 Firmas requeridas: 3
✍️ Firmas actuales: 1
Ejemplo de Notificación en Rails Console
TelegramNotifierService.send_message("Test de notificación en Telegram.")
DiscordNotifierService.send_message("Test de notificación en Discord.")
✅ Los mensajes aparecen en los respectivos canales.
Ejemplo de Envío Automático de Notificación cuando un Contrato se Necesita Firmar
curl -X GET "http://localhost:3000/contracts/notify_pending_signatures"
✅ Todos los firmantes reciben la alerta en Telegram y Discord.
