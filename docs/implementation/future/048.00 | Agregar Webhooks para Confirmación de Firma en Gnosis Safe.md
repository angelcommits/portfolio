# ✅ Paso 48: Agregar Webhooks para Confirmación de Firma en Gnosis Safe

Ahora agregaremos webhooks que notifiquen cuando un contrato ha sido completamente firmado, enviando alertas a los firmantes y ejecutando la transacción en la blockchain automáticamente.
✅ Gnosis Safe Webhooks → Para detectar cuando un contrato ha sido firmado completamente.
✅ Ejecución Automática en Blockchain → Envía la transacción cuando se cumplen las firmas.
✅ Notificaciones en Telegram y Discord → Alerta a los firmantes cuando la transacción se ejecuta.
✅ Turbo Streams → Para actualizar la UI en tiempo real.
📌 Commit 48.1: Crear Endpoint para Recibir Webhooks de Gnosis Safe
🔹 Mensaje de commit:
feat(webhooks): agrega endpoint para recibir notificaciones de firma completada en Gnosis Safe
🔹 Contenido del commit:
Definir GnosisSafeWebhooksController en app/controllers/gnosis_safe_webhooks_controller.rb
class GnosisSafeWebhooksController < ApplicationController
  skip_before_action :verify_authenticity_token
  def receive
    payload = JSON.parse(request.body.read)
    if payload["event"] == "MULTISIG_TRANSACTION_EXECUTED"
      contract_hash = payload["safeTxHash"]
      notify_contract_executed(contract_hash)
    end
    render json: { status: "ok" }
  end
  private
  def notify_contract_executed(contract_hash)
    message = "✅ *Contrato Ejecutado en Gnosis Safe*\n" \
              "📜 Hash: #{contract_hash}\n" \
              "🚀 Transacción enviada a la Blockchain"
    TelegramNotifierService.send_message(message)
    DiscordNotifierService.send_message(message)
    ActionCable.server.broadcast("gnosis_safe_notifications", {
      contract_hash: contract_hash,
      status: "Ejecutado"
    })
  end
end
Agregar Rutas en config/routes.rb
Rails.application.routes.draw do
  post "/webhooks/gnosis_safe", to: "gnosis_safe_webhooks#receive"
end
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(webhooks): agrega endpoint para recibir notificaciones de firma completada en Gnosis Safe"
📌 Commit 48.2: Configurar Webhook en Gnosis Safe API
🔹 Mensaje de commit:
feat(webhooks): registra el webhook de Rails en Gnosis Safe API
🔹 Contenido del commit:
Registrar Webhook en Gnosis Safe
curl -X POST "https://safe-transaction.gnosis.io/api/v1/safes/YOUR_SAFE_ADDRESS/hooks/" \
     -H "Content-Type: application/json" \
     -d '{
           "url": "https://your-rails-app.com/webhooks/gnosis_safe",
           "event_types": ["MULTISIG_TRANSACTION_EXECUTED"]
         }'
✅ Ahora Gnosis Safe notificará a nuestra API cuando una transacción sea ejecutada.
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(webhooks): registra el webhook de Rails en Gnosis Safe API"
📌 Commit 48.3: Agregar Notificación en la UI con Turbo Streams
🔹 Mensaje de commit:
feat(webhooks): actualiza la UI en tiempo real cuando una transacción es ejecutada en Gnosis Safe
🔹 Contenido del commit:
Modificar app/views/contracts/index.html.erb para Escuchar WebSockets
<h1 class="text-2xl font-bold">Contratos en Gnosis Safe</h1>
<div id="gnosis_notifications">
  <%= turbo_stream_from "gnosis_safe_notifications" %>
</div>
<table class="table-auto w-full">
  <thead>
    <tr>
      <th>Hash</th>
      <th>Estado</th>
    </tr>
  </thead>
  <tbody id="contracts_list">
    <% @pending_contracts.each do |contract| %>
      <tr id="contract_<%= contract[:hash] %>">
        <td><%= contract[:hash] %></td>
        <td class="status">Pendiente</td>
      </tr>
    <% end %>
  </tbody>
</table>
Modificar GnosisSafeWebhooksController para Turbo Streams
def notify_contract_executed(contract_hash)
  message = "✅ *Contrato Ejecutado en Gnosis Safe*\n" \
            "📜 Hash: #{contract_hash}\n" \
            "🚀 Transacción enviada a la Blockchain"
  TelegramNotifierService.send_message(message)
  DiscordNotifierService.send_message(message)
  ActionCable.server.broadcast("gnosis_safe_notifications", render_to_string(
    turbo_stream: turbo_stream.replace("contract_#{contract_hash}", partial: "contracts/contract_executed", locals: { contract_hash: contract_hash })
  ))
end
Crear Partial app/views/contracts/_contract_executed.html.erb
<tr id="contract_<%= contract_hash %>">
  <td><%= contract_hash %></td>
  <td class="text-green-500 font-bold">Ejecutado ✅</td>
</tr>
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(webhooks): actualiza la UI en tiempo real cuando una transacción es ejecutada en Gnosis Safe"
📌 Commit 48.4: Agregar Background Job para Confirmar Ejecución en Blockchain
🔹 Mensaje de commit:
feat(webhooks): agrega job para confirmar ejecución de transacción en la Blockchain
🔹 Contenido del commit:
Crear Job ConfirmTransactionJob
rails g job confirm_transaction
Modificar app/jobs/confirm_transaction_job.rb
class ConfirmTransactionJob < ApplicationJob
  queue_as :default
  def perform(contract_hash)
    confirmed = BlockchainService.confirm_transaction(contract_hash)
    if confirmed
      message = "✅ *Transacción Confirmada en Blockchain*\n📜 Hash: #{contract_hash}"
      TelegramNotifierService.send_message(message)
      DiscordNotifierService.send_message(message)
    else
      retry_job wait: 5.minutes, queue: :low_priority
    end
  end
end
Ejecutar Job cuando una transacción sea ejecutada
def notify_contract_executed(contract_hash)
  ConfirmTransactionJob.perform_later(contract_hash)
  ActionCable.server.broadcast("gnosis_safe_notifications", render_to_string(
    turbo_stream: turbo_stream.replace("contract_#{contract_hash}", partial: "contracts/contract_executed", locals: { contract_hash: contract_hash })
  ))
end
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(webhooks): agrega job para confirmar ejecución de transacción en la Blockchain"
📝 Explicación y Código Generado
Ejemplo de Notificación de Ejecución en Rails Console
GnosisSafeWebhooksController.new.notify_contract_executed("0x123456...")
✅ El usuario recibe un mensaje en Telegram y Discord:
✅ Contrato Ejecutado en Gnosis Safe
📜 Hash: 0x123456...
🚀 Transacción enviada a la Blockchain
Ejemplo de Verificación Automática en la Blockchain
curl -X POST "https://your-rails-app.com/webhooks/gnosis_safe"
✅ Si el contrato es ejecutado, la UI se actualiza en tiempo real.
