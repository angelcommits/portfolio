# âœ… Paso 48: Agregar Webhooks para ConfirmaciÃ³n de Firma en Gnosis Safe

Ahora agregaremos webhooks que notifiquen cuando un contrato ha sido completamente firmado, enviando alertas a los firmantes y ejecutando la transacciÃ³n en la blockchain automÃ¡ticamente.
âœ… Gnosis Safe Webhooks â†’ Para detectar cuando un contrato ha sido firmado completamente.
âœ… EjecuciÃ³n AutomÃ¡tica en Blockchain â†’ EnvÃ­a la transacciÃ³n cuando se cumplen las firmas.
âœ… Notificaciones en Telegram y Discord â†’ Alerta a los firmantes cuando la transacciÃ³n se ejecuta.
âœ… Turbo Streams â†’ Para actualizar la UI en tiempo real.
ðŸ“Œ Commit 48.1: Crear Endpoint para Recibir Webhooks de Gnosis Safe
ðŸ”¹ Mensaje de commit:
feat(webhooks): agrega endpoint para recibir notificaciones de firma completada en Gnosis Safe
ðŸ”¹ Contenido del commit:
Definir GnosisSafeWebhooksController en app/controllers/gnosis_safe_webhooks_controller.rb
class GnosisSafeWebhooksController < ApplicationController
  skip_before_action :verify_authenticity_token
  def receive
    payload = JSON.parse(request.body.read)
    if payload["event"] == "MULTISIG_TRANSACTION_EXECUTED"
      contract_hash = payload["safeTxHash"]
      notify_contract_executed(contract_hash)
    end
    render json: { status: "ok" }
  end
  private
  def notify_contract_executed(contract_hash)
    message = "âœ… *Contrato Ejecutado en Gnosis Safe*\n" \
              "ðŸ“œ Hash: #{contract_hash}\n" \
              "ðŸš€ TransacciÃ³n enviada a la Blockchain"
    TelegramNotifierService.send_message(message)
    DiscordNotifierService.send_message(message)
    ActionCable.server.broadcast("gnosis_safe_notifications", {
      contract_hash: contract_hash,
      status: "Ejecutado"
    })
  end
end
Agregar Rutas en config/routes.rb
Rails.application.routes.draw do
  post "/webhooks/gnosis_safe", to: "gnosis_safe_webhooks#receive"
end
ðŸ”¹ AÃ±adir archivos al commit:
git add .
git commit -m "feat(webhooks): agrega endpoint para recibir notificaciones de firma completada en Gnosis Safe"
ðŸ“Œ Commit 48.2: Configurar Webhook en Gnosis Safe API
ðŸ”¹ Mensaje de commit:
feat(webhooks): registra el webhook de Rails en Gnosis Safe API
ðŸ”¹ Contenido del commit:
Registrar Webhook en Gnosis Safe
curl -X POST "https://safe-transaction.gnosis.io/api/v1/safes/YOUR_SAFE_ADDRESS/hooks/" \
     -H "Content-Type: application/json" \
     -d '{
           "url": "https://your-rails-app.com/webhooks/gnosis_safe",
           "event_types": ["MULTISIG_TRANSACTION_EXECUTED"]
         }'
âœ… Ahora Gnosis Safe notificarÃ¡ a nuestra API cuando una transacciÃ³n sea ejecutada.
ðŸ”¹ AÃ±adir archivos al commit:
git add .
git commit -m "feat(webhooks): registra el webhook de Rails en Gnosis Safe API"
ðŸ“Œ Commit 48.3: Agregar NotificaciÃ³n en la UI con Turbo Streams
ðŸ”¹ Mensaje de commit:
feat(webhooks): actualiza la UI en tiempo real cuando una transacciÃ³n es ejecutada en Gnosis Safe
ðŸ”¹ Contenido del commit:
Modificar app/views/contracts/index.html.erb para Escuchar WebSockets
<h1 class="text-2xl font-bold">Contratos en Gnosis Safe</h1>
<div id="gnosis_notifications">
  <%= turbo_stream_from "gnosis_safe_notifications" %>
</div>
<table class="table-auto w-full">
  <thead>
    <tr>
      <th>Hash</th>
      <th>Estado</th>
    </tr>
  </thead>
  <tbody id="contracts_list">
    <% @pending_contracts.each do |contract| %>
      <tr id="contract_<%= contract[:hash] %>">
        <td><%= contract[:hash] %></td>
        <td class="status">Pendiente</td>
      </tr>
    <% end %>
  </tbody>
</table>
Modificar GnosisSafeWebhooksController para Turbo Streams
def notify_contract_executed(contract_hash)
  message = "âœ… *Contrato Ejecutado en Gnosis Safe*\n" \
            "ðŸ“œ Hash: #{contract_hash}\n" \
            "ðŸš€ TransacciÃ³n enviada a la Blockchain"
  TelegramNotifierService.send_message(message)
  DiscordNotifierService.send_message(message)
  ActionCable.server.broadcast("gnosis_safe_notifications", render_to_string(
    turbo_stream: turbo_stream.replace("contract_#{contract_hash}", partial: "contracts/contract_executed", locals: { contract_hash: contract_hash })
  ))
end
Crear Partial app/views/contracts/_contract_executed.html.erb
<tr id="contract_<%= contract_hash %>">
  <td><%= contract_hash %></td>
  <td class="text-green-500 font-bold">Ejecutado âœ…</td>
</tr>
ðŸ”¹ AÃ±adir archivos al commit:
git add .
git commit -m "feat(webhooks): actualiza la UI en tiempo real cuando una transacciÃ³n es ejecutada en Gnosis Safe"
ðŸ“Œ Commit 48.4: Agregar Background Job para Confirmar EjecuciÃ³n en Blockchain
ðŸ”¹ Mensaje de commit:
feat(webhooks): agrega job para confirmar ejecuciÃ³n de transacciÃ³n en la Blockchain
ðŸ”¹ Contenido del commit:
Crear Job ConfirmTransactionJob
rails g job confirm_transaction
Modificar app/jobs/confirm_transaction_job.rb
class ConfirmTransactionJob < ApplicationJob
  queue_as :default
  def perform(contract_hash)
    confirmed = BlockchainService.confirm_transaction(contract_hash)
    if confirmed
      message = "âœ… *TransacciÃ³n Confirmada en Blockchain*\nðŸ“œ Hash: #{contract_hash}"
      TelegramNotifierService.send_message(message)
      DiscordNotifierService.send_message(message)
    else
      retry_job wait: 5.minutes, queue: :low_priority
    end
  end
end
Ejecutar Job cuando una transacciÃ³n sea ejecutada
def notify_contract_executed(contract_hash)
  ConfirmTransactionJob.perform_later(contract_hash)
  ActionCable.server.broadcast("gnosis_safe_notifications", render_to_string(
    turbo_stream: turbo_stream.replace("contract_#{contract_hash}", partial: "contracts/contract_executed", locals: { contract_hash: contract_hash })
  ))
end
ðŸ”¹ AÃ±adir archivos al commit:
git add .
git commit -m "feat(webhooks): agrega job para confirmar ejecuciÃ³n de transacciÃ³n en la Blockchain"
ðŸ“ ExplicaciÃ³n y CÃ³digo Generado
Ejemplo de NotificaciÃ³n de EjecuciÃ³n en Rails Console
GnosisSafeWebhooksController.new.notify_contract_executed("0x123456...")
âœ… El usuario recibe un mensaje en Telegram y Discord:
âœ… Contrato Ejecutado en Gnosis Safe
ðŸ“œ Hash: 0x123456...
ðŸš€ TransacciÃ³n enviada a la Blockchain
Ejemplo de VerificaciÃ³n AutomÃ¡tica en la Blockchain
curl -X POST "https://your-rails-app.com/webhooks/gnosis_safe"
âœ… Si el contrato es ejecutado, la UI se actualiza en tiempo real.
