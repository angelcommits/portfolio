# ✅ Paso 37: Implementar Interfaz de Notificaciones Web3 en el Frontend

Ahora agregaremos una interfaz en el frontend para que los usuarios puedan ver sus notificaciones Web3 en tiempo real dentro de la plataforma.
✅ Conexión con MetaMask y WalletConnect → Para recibir notificaciones Web3.
✅ Hotwire + Turbo Streams → Para actualizar la UI en tiempo real.
✅ Soporte para EPNS (Push Protocol) → Para recibir alertas descentralizadas.
📌 Commit 37.1: Agregar Turbo Streams para Notificaciones Web3
🔹 Mensaje de commit:
feat(web3-notifications): agrega Turbo Streams para recibir notificaciones Web3 en tiempo real
🔹 Contenido del commit:
Definir Web3NotificationsController en app/controllers/web3_notifications_controller.rb
class Web3NotificationsController < ApplicationController
  def index
    @notifications = Web3Notification.order(created_at: :desc).limit(10)
  end
end
Crear Vista app/views/web3_notifications/index.html.erb
<h1 class="text-2xl font-bold mb-4">Notificaciones Web3</h1>
<div id="web3_notifications">
  <%= turbo_stream_from "web3_notifications" %>
  <ul class="list-disc">
    <%= render @notifications %>
  </ul>
</div>
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(web3-notifications): agrega Turbo Streams para recibir notificaciones Web3 en tiempo real"
📌 Commit 37.2: Modificar Web3NotifierService para Transmitir Notificaciones en Turbo Streams
🔹 Mensaje de commit:
feat(web3-notifications): transmite notificaciones Web3 en Turbo Streams
🔹 Contenido del commit:
Modificar Web3NotifierService
class Web3NotifierService
  EPNS_CHANNEL_ADDRESS = Rails.application.credentials.dig(:web3, :epns_channel_address)
  EPNS_PRIVATE_KEY = Rails.application.credentials.dig(:web3, :epns_private_key)
  def self.send_push_notification(wallet_address, message)
    epns_client = EPNS::Client.new(EPNS_CHANNEL_ADDRESS, EPNS_PRIVATE_KEY)
    epns_client.send_notification(wallet_address, message, "Firma de Documento")
    # Guardar en BD
    notification = Web3Notification.create!(wallet_address: wallet_address, message: message)
    # Transmitir en Turbo Streams
    Turbo::StreamsChannel.broadcast_append_to("web3_notifications", partial: "web3_notifications/notification", locals: { notification: notification })
  end
end
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(web3-notifications): transmite notificaciones Web3 en Turbo Streams"
📌 Commit 37.3: Crear Modelo Web3Notification para Persistencia
🔹 Mensaje de commit:
feat(web3-notifications): agrega modelo Web3Notification para almacenar alertas
🔹 Contenido del commit:
# Generar modelo para almacenar notificaciones Web3
rails g model Web3Notification wallet_address:string message:text read:boolean default:false
# Ejecutar migración
rails db:migrate
Definir Modelo Web3Notification en app/models/web3_notification.rb
class Web3Notification < ApplicationRecord
  validates :wallet_address, :message, presence: true
end
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(web3-notifications): agrega modelo Web3Notification para almacenar alertas"
📌 Commit 37.4: Integrar MetaMask y WalletConnect en el Frontend
🔹 Mensaje de commit:
feat(web3-notifications): agrega integración con MetaMask y WalletConnect en el frontend
🔹 Contenido del commit:
Agregar JavaScript para Conexión con MetaMask en app/javascript/packs/web3_notifications.js
document.addEventListener("DOMContentLoaded", async () => {
  if (window.ethereum) {
    const accounts = await ethereum.request({ method: "eth_requestAccounts" });
    const userWallet = accounts[0];
    // Escuchar eventos desde el backend
    const eventSource = new EventSource("/web3_notifications");
    eventSource.onmessage = function(event) {
      const data = JSON.parse(event.data);
      if (data.wallet_address.toLowerCase() === userWallet.toLowerCase()) {
        alert(`🔔 Nueva notificación Web3: ${data.message}`);
      }
    };
  } else {
    console.log("MetaMask no detectado.");
  }
});
Incluir JavaScript en la Vista
<%= javascript_pack_tag "web3_notifications" %>
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(web3-notifications): agrega integración con MetaMask y WalletConnect en el frontend"
📝 Explicación y Código Generado
Ejemplo de Recepción de Notificación Web3 en MetaMask
    Usuario firma un documento en Blockchain.
    Se emite un evento DocumentSigned.
    El backend detecta el evento y lo guarda en la BD.
    Turbo Streams actualiza la UI en tiempo real.
    Si el usuario tiene MetaMask conectado, recibe una alerta en su navegador.
Ejemplo de Simulación de Notificación en Rails Console
Web3NotifierService.send_push_notification("0xUserWalletAddress", "Tu documento ha sido firmado en Blockchain.")
✅ El usuario verá la notificación en el frontend.
