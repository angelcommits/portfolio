# âœ… Paso 56: Integrar Passkeys (WebAuthn) con Rodauth

Ahora agregaremos Passkeys (WebAuthn) con Rodauth, permitiendo autenticaciÃ³n sin contraseÃ±as con Face ID, Touch ID y llaves FIDO.
âœ… Rodauth WebAuthn Support â†’ Compatible con Passkeys y llaves de seguridad FIDO.
âœ… AutenticaciÃ³n Passwordless â†’ Eliminamos la necesidad de contraseÃ±as.
âœ… IntegraciÃ³n con Web3 ID â†’ RecuperaciÃ³n de cuenta usando wallets Web3.
âœ… Turbo Streams + Stimulus.js â†’ UI fluida sin recargas.
ğŸ“Œ Commit 56.1: Instalar Dependencias de WebAuthn para Rodauth
ğŸ”¹ Mensaje de commit:
feat(webauthn): instala dependencia de WebAuthn en Rodauth para autenticaciÃ³n sin contraseÃ±a
ğŸ”¹ Contenido del commit:
Instalar Gema rodauth-webauthn
bundle add rodauth-webauthn
ğŸ”¹ AÃ±adir archivos al commit:
git add .
git commit -m "feat(webauthn): instala dependencia de WebAuthn en Rodauth para autenticaciÃ³n sin contraseÃ±a"
ğŸ“Œ Commit 56.2: Configurar Rodauth con WebAuthn (Passkeys)
ğŸ”¹ Mensaje de commit:
feat(webauthn): configura Rodauth para permitir autenticaciÃ³n con Passkeys y WebAuthn
ğŸ”¹ Contenido del commit:
Modificar config/initializers/rodauth.rb para Soporte WebAuthn
RodauthMain.configure do
  enable :webauthn_login, :webauthn_setup
  webauthn_rp_id "your-rails-app.com"
  webauthn_origin "https://your-rails-app.com"
  webauthn_user_verification "preferred"
  webauthn_login_label "Iniciar sesiÃ³n con Passkey"
end
ğŸ”¹ AÃ±adir archivos al commit:
git add .
git commit -m "feat(webauthn): configura Rodauth para permitir autenticaciÃ³n con Passkeys y WebAuthn"
ğŸ“Œ Commit 56.3: Crear Migraciones para WebAuthn en Rodauth
ğŸ”¹ Mensaje de commit:
feat(webauthn): agrega migraciones para almacenar credenciales de Passkeys en Rodauth
ğŸ”¹ Contenido del commit:
Generar Migraciones
rails generate rodauth:migration webauthn
rails db:migrate
ğŸ”¹ AÃ±adir archivos al commit:
git add .
git commit -m "feat(webauthn): agrega migraciones para almacenar credenciales de Passkeys en Rodauth"
ğŸ“Œ Commit 56.4: Agregar UI para Registro de Passkeys en Rodauth
ğŸ”¹ Mensaje de commit:
feat(webauthn): agrega UI para registro de Passkeys en Rodauth con WebAuthn
ğŸ”¹ Contenido del commit:
Modificar app/views/sessions/new.html.erb
<h2>Iniciar sesiÃ³n con Passkey</h2>
<button data-controller="webauthn" data-action="click->webauthn#registerPasskey">
  Registrar Passkey
</button>
Crear app/javascript/controllers/webauthn_controller.js
import { Controller } from "@hotwired/stimulus";
export default class extends Controller {
  async registerPasskey() {
    const optionsResponse = await fetch("/webauthn/setup-options");
    const options = await optionsResponse.json();
    const credential = await navigator.credentials.create({
      publicKey: options
    });
    const credentialJSON = {
      id: credential.id,
      rawId: btoa(String.fromCharCode(...new Uint8Array(credential.rawId))),
      type: credential.type,
      response: {
        attestationObject: btoa(String.fromCharCode(...new Uint8Array(credential.response.attestationObject))),
        clientDataJSON: btoa(String.fromCharCode(...new Uint8Array(credential.response.clientDataJSON)))
      }
    };
    const registerResponse = await fetch("/webauthn/setup", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(credentialJSON)
    });
    if (registerResponse.ok) {
      alert("Passkey registrada exitosamente");
    } else {
      alert("Error al registrar la Passkey");
    }
  }
}
ğŸ”¹ AÃ±adir archivos al commit:
git add .
git commit -m "feat(webauthn): agrega UI para registro de Passkeys en Rodauth con WebAuthn"
ğŸ“Œ Commit 56.5: Agregar Soporte para Inicio de SesiÃ³n con Passkeys
ğŸ”¹ Mensaje de commit:
feat(webauthn): agrega autenticaciÃ³n con Passkeys en Rodauth usando WebAuthn
ğŸ”¹ Contenido del commit:
Modificar app/views/sessions/new.html.erb
<h2>Iniciar sesiÃ³n con Passkey</h2>
<button data-controller="webauthn" data-action="click->webauthn#loginWithPasskey">
  Iniciar sesiÃ³n con Passkey
</button>
Modificar app/javascript/controllers/webauthn_controller.js
async loginWithPasskey() {
  const optionsResponse = await fetch("/webauthn/login-options");
  const options = await optionsResponse.json();
  const credential = await navigator.credentials.get({ publicKey: options });
  const credentialJSON = {
    id: credential.id,
    rawId: btoa(String.fromCharCode(...new Uint8Array(credential.rawId))),
    type: credential.type,
    response: {
      authenticatorData: btoa(String.fromCharCode(...new Uint8Array(credential.response.authenticatorData))),
      clientDataJSON: btoa(String.fromCharCode(...new Uint8Array(credential.response.clientDataJSON))),
      signature: btoa(String.fromCharCode(...new Uint8Array(credential.response.signature))),
      userHandle: credential.response.userHandle ? btoa(String.fromCharCode(...new Uint8Array(credential.response.userHandle))) : null
    }
  };
  const loginResponse = await fetch("/webauthn/login", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(credentialJSON)
  });
  if (loginResponse.ok) {
    alert("AutenticaciÃ³n exitosa con Passkey");
    window.location.reload();
  } else {
    alert("Error en la autenticaciÃ³n");
  }
}
ğŸ”¹ AÃ±adir archivos al commit:
git add .
git commit -m "feat(webauthn): agrega autenticaciÃ³n con Passkeys en Rodauth usando WebAuthn"
ğŸ“ ExplicaciÃ³n y CÃ³digo Generado
Ejemplo de Registro de Passkey en API
curl -X POST "http://localhost:3000/webauthn/setup" \
  -H "Content-Type: application/json" \
  -d '{ "id": "credential_id", "public_key": "key_data" }'
âœ… Si la Passkey es vÃ¡lida:
{ "message": "Passkey registrada con Ã©xito" }
âŒ Si la verificaciÃ³n falla:
{ "error": "Error en la verificaciÃ³n de Passkey" }
Ejemplo de Inicio de SesiÃ³n con Passkey en API
curl -X POST "http://localhost:3000/webauthn/login" \
  -H "Content-Type: application/json" \
  -d '{ "id": "credential_id", "signature": "signature_data" }'
âœ… Si la firma es vÃ¡lida:
{ "message": "AutenticaciÃ³n exitosa" }
Ejemplo de Inicio de SesiÃ³n en la UI
document.querySelector("button").click();
âœ… El usuario escanea Face ID / Touch ID y se autentica sin contraseÃ±a.
