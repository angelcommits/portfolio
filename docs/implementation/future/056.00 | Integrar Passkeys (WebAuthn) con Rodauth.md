# ✅ Paso 56: Integrar Passkeys (WebAuthn) con Rodauth

Ahora agregaremos Passkeys (WebAuthn) con Rodauth, permitiendo autenticación sin contraseñas con Face ID, Touch ID y llaves FIDO.
✅ Rodauth WebAuthn Support → Compatible con Passkeys y llaves de seguridad FIDO.
✅ Autenticación Passwordless → Eliminamos la necesidad de contraseñas.
✅ Integración con Web3 ID → Recuperación de cuenta usando wallets Web3.
✅ Turbo Streams + Stimulus.js → UI fluida sin recargas.
📌 Commit 56.1: Instalar Dependencias de WebAuthn para Rodauth
🔹 Mensaje de commit:
feat(webauthn): instala dependencia de WebAuthn en Rodauth para autenticación sin contraseña
🔹 Contenido del commit:
Instalar Gema rodauth-webauthn
bundle add rodauth-webauthn
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(webauthn): instala dependencia de WebAuthn en Rodauth para autenticación sin contraseña"
📌 Commit 56.2: Configurar Rodauth con WebAuthn (Passkeys)
🔹 Mensaje de commit:
feat(webauthn): configura Rodauth para permitir autenticación con Passkeys y WebAuthn
🔹 Contenido del commit:
Modificar config/initializers/rodauth.rb para Soporte WebAuthn
RodauthMain.configure do
  enable :webauthn_login, :webauthn_setup
  webauthn_rp_id "your-rails-app.com"
  webauthn_origin "https://your-rails-app.com"
  webauthn_user_verification "preferred"
  webauthn_login_label "Iniciar sesión con Passkey"
end
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(webauthn): configura Rodauth para permitir autenticación con Passkeys y WebAuthn"
📌 Commit 56.3: Crear Migraciones para WebAuthn en Rodauth
🔹 Mensaje de commit:
feat(webauthn): agrega migraciones para almacenar credenciales de Passkeys en Rodauth
🔹 Contenido del commit:
Generar Migraciones
rails generate rodauth:migration webauthn
rails db:migrate
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(webauthn): agrega migraciones para almacenar credenciales de Passkeys en Rodauth"
📌 Commit 56.4: Agregar UI para Registro de Passkeys en Rodauth
🔹 Mensaje de commit:
feat(webauthn): agrega UI para registro de Passkeys en Rodauth con WebAuthn
🔹 Contenido del commit:
Modificar app/views/sessions/new.html.erb
<h2>Iniciar sesión con Passkey</h2>
<button data-controller="webauthn" data-action="click->webauthn#registerPasskey">
  Registrar Passkey
</button>
Crear app/javascript/controllers/webauthn_controller.js
import { Controller } from "@hotwired/stimulus";
export default class extends Controller {
  async registerPasskey() {
    const optionsResponse = await fetch("/webauthn/setup-options");
    const options = await optionsResponse.json();
    const credential = await navigator.credentials.create({
      publicKey: options
    });
    const credentialJSON = {
      id: credential.id,
      rawId: btoa(String.fromCharCode(...new Uint8Array(credential.rawId))),
      type: credential.type,
      response: {
        attestationObject: btoa(String.fromCharCode(...new Uint8Array(credential.response.attestationObject))),
        clientDataJSON: btoa(String.fromCharCode(...new Uint8Array(credential.response.clientDataJSON)))
      }
    };
    const registerResponse = await fetch("/webauthn/setup", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(credentialJSON)
    });
    if (registerResponse.ok) {
      alert("Passkey registrada exitosamente");
    } else {
      alert("Error al registrar la Passkey");
    }
  }
}
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(webauthn): agrega UI para registro de Passkeys en Rodauth con WebAuthn"
📌 Commit 56.5: Agregar Soporte para Inicio de Sesión con Passkeys
🔹 Mensaje de commit:
feat(webauthn): agrega autenticación con Passkeys en Rodauth usando WebAuthn
🔹 Contenido del commit:
Modificar app/views/sessions/new.html.erb
<h2>Iniciar sesión con Passkey</h2>
<button data-controller="webauthn" data-action="click->webauthn#loginWithPasskey">
  Iniciar sesión con Passkey
</button>
Modificar app/javascript/controllers/webauthn_controller.js
async loginWithPasskey() {
  const optionsResponse = await fetch("/webauthn/login-options");
  const options = await optionsResponse.json();
  const credential = await navigator.credentials.get({ publicKey: options });
  const credentialJSON = {
    id: credential.id,
    rawId: btoa(String.fromCharCode(...new Uint8Array(credential.rawId))),
    type: credential.type,
    response: {
      authenticatorData: btoa(String.fromCharCode(...new Uint8Array(credential.response.authenticatorData))),
      clientDataJSON: btoa(String.fromCharCode(...new Uint8Array(credential.response.clientDataJSON))),
      signature: btoa(String.fromCharCode(...new Uint8Array(credential.response.signature))),
      userHandle: credential.response.userHandle ? btoa(String.fromCharCode(...new Uint8Array(credential.response.userHandle))) : null
    }
  };
  const loginResponse = await fetch("/webauthn/login", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(credentialJSON)
  });
  if (loginResponse.ok) {
    alert("Autenticación exitosa con Passkey");
    window.location.reload();
  } else {
    alert("Error en la autenticación");
  }
}
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(webauthn): agrega autenticación con Passkeys en Rodauth usando WebAuthn"
📝 Explicación y Código Generado
Ejemplo de Registro de Passkey en API
curl -X POST "http://localhost:3000/webauthn/setup" \
  -H "Content-Type: application/json" \
  -d '{ "id": "credential_id", "public_key": "key_data" }'
✅ Si la Passkey es válida:
{ "message": "Passkey registrada con éxito" }
❌ Si la verificación falla:
{ "error": "Error en la verificación de Passkey" }
Ejemplo de Inicio de Sesión con Passkey en API
curl -X POST "http://localhost:3000/webauthn/login" \
  -H "Content-Type: application/json" \
  -d '{ "id": "credential_id", "signature": "signature_data" }'
✅ Si la firma es válida:
{ "message": "Autenticación exitosa" }
Ejemplo de Inicio de Sesión en la UI
document.querySelector("button").click();
✅ El usuario escanea Face ID / Touch ID y se autentica sin contraseña.
