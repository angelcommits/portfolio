# ✅ Paso 104: Integrar DeFi Farming para DAO Treasury con Yearn & Convex

Ahora agregaremos Yearn y Convex, permitiendo que la DAO genere rendimientos pasivos con sus fondos en DeFi usando estrategias automatizadas.
✅ Yearn Vaults → Optimización de rendimientos con estrategias automatizadas.
✅ Convex Finance → Maximización de recompensas en Curve sin bloquear CRV.
✅ Web3.js + Stimulus.js → Para que la DAO gestione inversiones desde la UI.
✅ Smart Contracts en Solidity → Para administrar depósitos y rendimientos de la DAO.
📌 Commit 104.1: Configurar Yearn & Convex para Tesorería de la DAO
🔹 Mensaje de commit:
feat(defi-farming): configura Yearn y Convex para generar rendimientos en la tesorería de la DAO
🔹 Contenido del commit:
1️⃣ Registrar la DAO en Yearn Finance
    Depositar fondos en un Vault de Yearn (por ejemplo, yDAI o yUSDC).
2️⃣ Añadir Configuración en config/defi_farming.yml
defi_farming:
  yearn_vault: "0xYearnVaultAddress"
  convex_pool: "0xConvexPoolAddress"
  treasury_wallet: "0xDAO_Treasury"
  strategies:
    - "Yearn Vaults"
    - "Convex Staking"
  allocation:
    yearn: 70
    convex: 30
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(defi-farming): configura Yearn y Convex para generar rendimientos en la tesorería de la DAO"
📌 Commit 104.2: Implementar Smart Contract para Farming en Yearn y Convex
🔹 Mensaje de commit:
feat(defi-smartcontract): agrega smart contract para invertir fondos en Yearn y Convex desde la DAO
🔹 Contenido del commit:
Definir DefiTreasury.sol en contracts/DefiTreasury.sol
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.0;
import "@openzeppelin/contracts/access/Ownable.sol";
import "@openzeppelin/contracts/token/ERC20/IERC20.sol";
import "./IYearnVault.sol";
import "./IConvexPool.sol";
contract DefiTreasury is Ownable {
    IYearnVault public yearnVault;
    IConvexPool public convexPool;
    IERC20 public dai;
    event FundsInvested(address indexed strategy, uint256 amount);
    event FundsWithdrawn(address indexed strategy, uint256 amount);
    constructor(IYearnVault _yearnVault, IConvexPool _convexPool, IERC20 _dai) {
        yearnVault = _yearnVault;
        convexPool = _convexPool;
        dai = _dai;
    }
    function investInYearn(uint256 amount) external onlyOwner {
        dai.transferFrom(msg.sender, address(this), amount);
        dai.approve(address(yearnVault), amount);
        yearnVault.deposit(amount);
        emit FundsInvested(address(yearnVault), amount);
    }
    function investInConvex(uint256 amount) external onlyOwner {
        dai.transferFrom(msg.sender, address(this), amount);
        dai.approve(address(convexPool), amount);
        convexPool.stake(amount);
        emit FundsInvested(address(convexPool), amount);
    }
    function withdrawFromYearn(uint256 shares) external onlyOwner {
        uint256 amount = yearnVault.withdraw(shares);
        dai.transfer(msg.sender, amount);
        emit FundsWithdrawn(address(yearnVault), amount);
    }
    function withdrawFromConvex(uint256 amount) external onlyOwner {
        convexPool.withdraw(amount);
        dai.transfer(msg.sender, amount);
        emit FundsWithdrawn(address(convexPool), amount);
    }
}
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(defi-smartcontract): agrega smart contract para invertir fondos en Yearn y Convex desde la DAO"
📌 Commit 104.3: Integrar UI para Gestionar Inversiones DeFi
🔹 Mensaje de commit:
feat(defi-ui): agrega UI para gestionar inversiones de la DAO en Yearn y Convex
🔹 Contenido del commit:
Modificar app/javascript/controllers/defi_controller.js
import { Controller } from "@hotwired/stimulus";
import Web3 from "web3";
export default class extends Controller {
  static targets = ["amount"];
  async investInYearn() {
    if (!window.ethereum) {
      alert("Por favor instala MetaMask");
      return;
    }
    const web3 = new Web3(window.ethereum);
    await window.ethereum.request({ method: "eth_requestAccounts" });
    const amount = Web3.utils.toWei(this.amountTarget.value, "ether");
    const contract = new web3.eth.Contract(
      [{ name: "investInYearn", type: "function", inputs: [{ name: "amount", type: "uint256" }] }],
      "0xYourDefiTreasuryContractAddress"
    );
    await contract.methods.investInYearn(amount).send({ from: window.ethereum.selectedAddress });
    alert("Fondos invertidos en Yearn");
  }
  async investInConvex() {
    if (!window.ethereum) {
      alert("Por favor instala MetaMask");
      return;
    }
    const web3 = new Web3(window.ethereum);
    await window.ethereum.request({ method: "eth_requestAccounts" });
    const amount = Web3.utils.toWei(this.amountTarget.value, "ether");
    const contract = new web3.eth.Contract(
      [{ name: "investInConvex", type: "function", inputs: [{ name: "amount", type: "uint256" }] }],
      "0xYourDefiTreasuryContractAddress"
    );
    await contract.methods.investInConvex(amount).send({ from: window.ethereum.selectedAddress });
    alert("Fondos invertidos en Convex");
  }
}
Modificar app/views/defi/index.html.erb
<h2>Gestionar Inversiones DeFi</h2>
<label>Monto en DAI:</label>
<input type="text" data-defi-target="amount">
<button data-controller="defi" data-action="click->defi#investInYearn">
  Invertir en Yearn
</button>
<button data-controller="defi" data-action="click->defi#investInConvex">
  Invertir en Convex
</button>
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(defi-ui): agrega UI para gestionar inversiones de la DAO en Yearn y Convex"
📝 Explicación y Código Generado
Ejemplo de Inversión en Yearn en API
curl -X POST "http://localhost:3000/defi/invest_yearn" \
  -H "Content-Type: application/json" \
  -d '{ "amount": 500 }'
✅ La DAO invierte 500 DAI en Yearn Vaults.
Ejemplo de Inversión en Convex en API
curl -X POST "http://localhost:3000/defi/invest_convex" \
  -H "Content-Type: application/json" \
  -d '{ "amount": 300 }'
✅ La DAO invierte 300 DAI en Convex Staking.
Ejemplo de Panel de Yearn y Convex en Web
https://yearn.finance/
https://convexfinance.com/
✅ Los miembros de la DAO pueden ver y gestionar los fondos en DeFi.
