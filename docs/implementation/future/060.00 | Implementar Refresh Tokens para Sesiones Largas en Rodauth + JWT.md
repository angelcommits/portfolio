# ✅ Paso 60: Implementar Refresh Tokens para Sesiones Largas en Rodauth + JWT

Ahora agregaremos soporte para Refresh Tokens, permitiendo que los usuarios renueven su sesión sin volver a iniciar sesión manualmente.
✅ Rodauth JWT Refresh Token Support → Permite mantener sesiones activas sin volver a firmar.
✅ Expiración y Revocación de Tokens → Control total sobre la seguridad.
✅ Almacenamiento en Redis → Tokens seguros y revocables.
✅ Protección contra Reutilización → Previene ataques de replay en Refresh Tokens.
📌 Commit 60.1: Configurar Rodauth para Soporte de Refresh Tokens
🔹 Mensaje de commit:
feat(auth-refresh): agrega soporte para Refresh Tokens en Rodauth
🔹 Contenido del commit:
Modificar config/initializers/rodauth.rb para Soporte de Refresh Tokens
RodauthMain.configure do
  enable :jwt_refresh
  jwt_refresh_secret { Rails.application.credentials.dig(:jwt, :secret) }
  jwt_refresh_token_table :refresh_tokens
  jwt_refresh_token_expiration 604800 # 7 días
  jwt_refresh_reuse "rotate" # Rotación de refresh tokens
  before_jwt_response do
    response["Access-Control-Allow-Origin"] = "*"
    response["Access-Control-Allow-Methods"] = "POST, GET, OPTIONS, DELETE"
  end
end
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(auth-refresh): agrega soporte para Refresh Tokens en Rodauth"
📌 Commit 60.2: Crear Migración para Almacenar Refresh Tokens en la Base de Datos
🔹 Mensaje de commit:
feat(auth-refresh): agrega migración para almacenar Refresh Tokens en la base de datos
🔹 Contenido del commit:
Generar Migración
rails generate migration create_refresh_tokens
Modificar Migración en db/migrate/TIMESTAMP_create_refresh_tokens.rb
class CreateRefreshTokens < ActiveRecord::Migration[6.1]
  def change
    create_table :refresh_tokens do |t|
      t.integer :account_id, null: false
      t.string :token, null: false, unique: true
      t.datetime :expires_at, null: false
      t.timestamps
    end
  end
end
Ejecutar Migración
rails db:migrate
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(auth-refresh): agrega migración para almacenar Refresh Tokens en la base de datos"
📌 Commit 60.3: Agregar API para Generar y Renovar Tokens JWT
🔹 Mensaje de commit:
feat(auth-refresh): agrega API para generar y renovar tokens JWT con Refresh Tokens
🔹 Contenido del commit:
Modificar Web3AuthController para Incluir Refresh Tokens
class Web3AuthController < ApplicationController
  skip_before_action :verify_authenticity_token
  def login
    wallet = params[:wallet_address]
    signature = params[:signature]
    nonce = session[:web3_nonce]
    return render json: { error: "Nonce inválido" }, status: :unauthorized unless nonce
    # Verificar firma de Ethereum
    signer = Ethereum::Message.verify_signature("Nonce: #{nonce}", signature)
    if signer.downcase == wallet.downcase
      user = User.find_or_create_by(wallet_address: wallet)
      rodauth = RodauthMain.new(account_id: user.id, scope: self)
      token = rodauth.create_jwt
      refresh_token = rodauth.create_jwt_refresh_token
      render json: { message: "Autenticación exitosa", user: user, token: token, refresh_token: refresh_token }
    else
      render json: { error: "Firma inválida" }, status: :unauthorized
    end
  end
  def refresh
    rodauth = RodauthMain.new(scope: self)
    if rodauth.valid_jwt_refresh_token?(params[:refresh_token])
      token = rodauth.create_jwt
      refresh_token = rodauth.create_jwt_refresh_token
      render json: { message: "Token renovado", token: token, refresh_token: refresh_token }
    else
      render json: { error: "Refresh token inválido" }, status: :unauthorized
    end
  end
end
Agregar Rutas en config/routes.rb
Rails.application.routes.draw do
  post "/auth/web3_login", to: "web3_auth#login"
  post "/auth/refresh", to: "web3_auth#refresh"
end
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(auth-refresh): agrega API para generar y renovar tokens JWT con Refresh Tokens"
📌 Commit 60.4: Agregar Protección Contra Reutilización de Refresh Tokens
🔹 Mensaje de commit:
feat(auth-refresh): protege contra reutilización de Refresh Tokens en Rodauth
🔹 Contenido del commit:
Modificar Web3AuthController para Rotación de Refresh Tokens
def refresh
  rodauth = RodauthMain.new(scope: self)
  if rodauth.valid_jwt_refresh_token?(params[:refresh_token])
    rodauth.revoke_jwt_refresh_token(params[:refresh_token]) # Revocar el token viejo
    token = rodauth.create_jwt
    refresh_token = rodauth.create_jwt_refresh_token
    render json: { message: "Token renovado", token: token, refresh_token: refresh_token }
  else
    render json: { error: "Refresh token inválido" }, status: :unauthorized
  end
end
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(auth-refresh): protege contra reutilización de Refresh Tokens en Rodauth"
📌 Commit 60.5: Agregar Logout y Revocación de Refresh Tokens
🔹 Mensaje de commit:
feat(auth-refresh): implementa revocación de Refresh Tokens en logout
🔹 Contenido del commit:
Modificar Web3AuthController para Logout
def logout
  rodauth = RodauthMain.new(scope: self)
  rodauth.logout
  # Revocar Refresh Token asociado
  rodauth.revoke_jwt_refresh_token(params[:refresh_token]) if params[:refresh_token]
  render json: { message: "Sesión cerrada exitosamente" }
end
Agregar Ruta de Logout en config/routes.rb
delete "/auth/logout", to: "web3_auth#logout"
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(auth-refresh): implementa revocación de Refresh Tokens en logout"
📝 Explicación y Código Generado
Ejemplo de Login con Web3 + JWT + Refresh Token
curl -X POST "http://localhost:3000/auth/web3_login" \
  -H "Content-Type: application/json" \
  -d '{ "wallet_address": "0xUserWallet", "signature": "0xFirmaDigital" }'
✅ Respuesta esperada:
{ "message": "Autenticación exitosa", "user": { "id": 1 }, "token": "eyJhbGciOiJIUzI1NiIsInR...", "refresh_token": "eyJhbGciOiJIUzI1NiIsInR..." }
Ejemplo de Renovación de Token con Refresh Token
curl -X POST "http://localhost:3000/auth/refresh" \
  -H "Content-Type: application/json" \
  -d '{ "refresh_token": "eyJhbGciOiJIUzI1NiIsInR..." }'
✅ Devuelve un nuevo Access Token y un nuevo Refresh Token.
Ejemplo de Logout con Revocación de Tokens
curl -X DELETE "http://localhost:3000/auth/logout" \
  -H "Content-Type: application/json" \
  -d '{ "refresh_token": "eyJhbGciOiJIUzI1NiIsInR..." }'
✅ Invalida la sesión y el Refresh Token.
