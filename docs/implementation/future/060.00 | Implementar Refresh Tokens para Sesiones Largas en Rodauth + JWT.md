# âœ… Paso 60: Implementar Refresh Tokens para Sesiones Largas en Rodauth + JWT

Ahora agregaremos soporte para Refresh Tokens, permitiendo que los usuarios renueven su sesiÃ³n sin volver a iniciar sesiÃ³n manualmente.
âœ… Rodauth JWT Refresh Token Support â†’ Permite mantener sesiones activas sin volver a firmar.
âœ… ExpiraciÃ³n y RevocaciÃ³n de Tokens â†’ Control total sobre la seguridad.
âœ… Almacenamiento en Redis â†’ Tokens seguros y revocables.
âœ… ProtecciÃ³n contra ReutilizaciÃ³n â†’ Previene ataques de replay en Refresh Tokens.
ğŸ“Œ Commit 60.1: Configurar Rodauth para Soporte de Refresh Tokens
ğŸ”¹ Mensaje de commit:
feat(auth-refresh): agrega soporte para Refresh Tokens en Rodauth
ğŸ”¹ Contenido del commit:
Modificar config/initializers/rodauth.rb para Soporte de Refresh Tokens
RodauthMain.configure do
  enable :jwt_refresh
  jwt_refresh_secret { Rails.application.credentials.dig(:jwt, :secret) }
  jwt_refresh_token_table :refresh_tokens
  jwt_refresh_token_expiration 604800 # 7 dÃ­as
  jwt_refresh_reuse "rotate" # RotaciÃ³n de refresh tokens
  before_jwt_response do
    response["Access-Control-Allow-Origin"] = "*"
    response["Access-Control-Allow-Methods"] = "POST, GET, OPTIONS, DELETE"
  end
end
ğŸ”¹ AÃ±adir archivos al commit:
git add .
git commit -m "feat(auth-refresh): agrega soporte para Refresh Tokens en Rodauth"
ğŸ“Œ Commit 60.2: Crear MigraciÃ³n para Almacenar Refresh Tokens en la Base de Datos
ğŸ”¹ Mensaje de commit:
feat(auth-refresh): agrega migraciÃ³n para almacenar Refresh Tokens en la base de datos
ğŸ”¹ Contenido del commit:
Generar MigraciÃ³n
rails generate migration create_refresh_tokens
Modificar MigraciÃ³n en db/migrate/TIMESTAMP_create_refresh_tokens.rb
class CreateRefreshTokens < ActiveRecord::Migration[6.1]
  def change
    create_table :refresh_tokens do |t|
      t.integer :account_id, null: false
      t.string :token, null: false, unique: true
      t.datetime :expires_at, null: false
      t.timestamps
    end
  end
end
Ejecutar MigraciÃ³n
rails db:migrate
ğŸ”¹ AÃ±adir archivos al commit:
git add .
git commit -m "feat(auth-refresh): agrega migraciÃ³n para almacenar Refresh Tokens en la base de datos"
ğŸ“Œ Commit 60.3: Agregar API para Generar y Renovar Tokens JWT
ğŸ”¹ Mensaje de commit:
feat(auth-refresh): agrega API para generar y renovar tokens JWT con Refresh Tokens
ğŸ”¹ Contenido del commit:
Modificar Web3AuthController para Incluir Refresh Tokens
class Web3AuthController < ApplicationController
  skip_before_action :verify_authenticity_token
  def login
    wallet = params[:wallet_address]
    signature = params[:signature]
    nonce = session[:web3_nonce]
    return render json: { error: "Nonce invÃ¡lido" }, status: :unauthorized unless nonce
    # Verificar firma de Ethereum
    signer = Ethereum::Message.verify_signature("Nonce: #{nonce}", signature)
    if signer.downcase == wallet.downcase
      user = User.find_or_create_by(wallet_address: wallet)
      rodauth = RodauthMain.new(account_id: user.id, scope: self)
      token = rodauth.create_jwt
      refresh_token = rodauth.create_jwt_refresh_token
      render json: { message: "AutenticaciÃ³n exitosa", user: user, token: token, refresh_token: refresh_token }
    else
      render json: { error: "Firma invÃ¡lida" }, status: :unauthorized
    end
  end
  def refresh
    rodauth = RodauthMain.new(scope: self)
    if rodauth.valid_jwt_refresh_token?(params[:refresh_token])
      token = rodauth.create_jwt
      refresh_token = rodauth.create_jwt_refresh_token
      render json: { message: "Token renovado", token: token, refresh_token: refresh_token }
    else
      render json: { error: "Refresh token invÃ¡lido" }, status: :unauthorized
    end
  end
end
Agregar Rutas en config/routes.rb
Rails.application.routes.draw do
  post "/auth/web3_login", to: "web3_auth#login"
  post "/auth/refresh", to: "web3_auth#refresh"
end
ğŸ”¹ AÃ±adir archivos al commit:
git add .
git commit -m "feat(auth-refresh): agrega API para generar y renovar tokens JWT con Refresh Tokens"
ğŸ“Œ Commit 60.4: Agregar ProtecciÃ³n Contra ReutilizaciÃ³n de Refresh Tokens
ğŸ”¹ Mensaje de commit:
feat(auth-refresh): protege contra reutilizaciÃ³n de Refresh Tokens en Rodauth
ğŸ”¹ Contenido del commit:
Modificar Web3AuthController para RotaciÃ³n de Refresh Tokens
def refresh
  rodauth = RodauthMain.new(scope: self)
  if rodauth.valid_jwt_refresh_token?(params[:refresh_token])
    rodauth.revoke_jwt_refresh_token(params[:refresh_token]) # Revocar el token viejo
    token = rodauth.create_jwt
    refresh_token = rodauth.create_jwt_refresh_token
    render json: { message: "Token renovado", token: token, refresh_token: refresh_token }
  else
    render json: { error: "Refresh token invÃ¡lido" }, status: :unauthorized
  end
end
ğŸ”¹ AÃ±adir archivos al commit:
git add .
git commit -m "feat(auth-refresh): protege contra reutilizaciÃ³n de Refresh Tokens en Rodauth"
ğŸ“Œ Commit 60.5: Agregar Logout y RevocaciÃ³n de Refresh Tokens
ğŸ”¹ Mensaje de commit:
feat(auth-refresh): implementa revocaciÃ³n de Refresh Tokens en logout
ğŸ”¹ Contenido del commit:
Modificar Web3AuthController para Logout
def logout
  rodauth = RodauthMain.new(scope: self)
  rodauth.logout
  # Revocar Refresh Token asociado
  rodauth.revoke_jwt_refresh_token(params[:refresh_token]) if params[:refresh_token]
  render json: { message: "SesiÃ³n cerrada exitosamente" }
end
Agregar Ruta de Logout en config/routes.rb
delete "/auth/logout", to: "web3_auth#logout"
ğŸ”¹ AÃ±adir archivos al commit:
git add .
git commit -m "feat(auth-refresh): implementa revocaciÃ³n de Refresh Tokens en logout"
ğŸ“ ExplicaciÃ³n y CÃ³digo Generado
Ejemplo de Login con Web3 + JWT + Refresh Token
curl -X POST "http://localhost:3000/auth/web3_login" \
  -H "Content-Type: application/json" \
  -d '{ "wallet_address": "0xUserWallet", "signature": "0xFirmaDigital" }'
âœ… Respuesta esperada:
{ "message": "AutenticaciÃ³n exitosa", "user": { "id": 1 }, "token": "eyJhbGciOiJIUzI1NiIsInR...", "refresh_token": "eyJhbGciOiJIUzI1NiIsInR..." }
Ejemplo de RenovaciÃ³n de Token con Refresh Token
curl -X POST "http://localhost:3000/auth/refresh" \
  -H "Content-Type: application/json" \
  -d '{ "refresh_token": "eyJhbGciOiJIUzI1NiIsInR..." }'
âœ… Devuelve un nuevo Access Token y un nuevo Refresh Token.
Ejemplo de Logout con RevocaciÃ³n de Tokens
curl -X DELETE "http://localhost:3000/auth/logout" \
  -H "Content-Type: application/json" \
  -d '{ "refresh_token": "eyJhbGciOiJIUzI1NiIsInR..." }'
âœ… Invalida la sesiÃ³n y el Refresh Token.
