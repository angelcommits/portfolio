# âœ… Paso 54: Agregar RecuperaciÃ³n de Cuenta con Social Login (Google, Twitter, Discord)

Ahora agregaremos soporte para recuperar cuentas con Social Login (Google, Twitter, Discord), permitiendo que los usuarios inicien sesiÃ³n en caso de perder acceso a su wallet Web3 o Passkey.
âœ… OmniAuth â†’ Para manejar autenticaciÃ³n con Google, Twitter y Discord.
âœ… Web3 Recovery Flow â†’ Asociar redes sociales a cuentas Web3.
âœ… Background Jobs (Sidekiq) â†’ Para procesar autenticaciones asÃ­ncronas.
âœ… Turbo Streams + Stimulus.js â†’ Para notificaciones en la UI.
ğŸ“Œ Commit 54.1: Instalar OmniAuth para AutenticaciÃ³n con Redes Sociales
ğŸ”¹ Mensaje de commit:
feat(social-login): instala OmniAuth para autenticaciÃ³n con Google, Twitter y Discord
ğŸ”¹ Contenido del commit:
Instalar OmniAuth y los Providers
bundle add omniauth-google-oauth2 omniauth-twitter omniauth-discord
Agregar Credenciales en config/credentials.yml.enc
omniauth:
  google:
    client_id: "YOUR_GOOGLE_CLIENT_ID"
    client_secret: "YOUR_GOOGLE_CLIENT_SECRET"
  twitter:
    api_key: "YOUR_TWITTER_API_KEY"
    api_secret: "YOUR_TWITTER_API_SECRET"
  discord:
    client_id: "YOUR_DISCORD_CLIENT_ID"
    client_secret: "YOUR_DISCORD_CLIENT_SECRET"
ğŸ”¹ AÃ±adir archivos al commit:
git add .
git commit -m "feat(social-login): instala OmniAuth para autenticaciÃ³n con Google, Twitter y Discord"
ğŸ“Œ Commit 54.2: Configurar OmniAuth en Rails
ğŸ”¹ Mensaje de commit:
feat(social-login): configura OmniAuth en Rails para manejar autenticaciÃ³n social
ğŸ”¹ Contenido del commit:
Modificar config/initializers/omniauth.rb
Rails.application.config.middleware.use OmniAuth::Builder do
  provider :google_oauth2,
           Rails.application.credentials.dig(:omniauth, :google, :client_id),
           Rails.application.credentials.dig(:omniauth, :google, :client_secret)
  provider :twitter,
           Rails.application.credentials.dig(:omniauth, :twitter, :api_key),
           Rails.application.credentials.dig(:omniauth, :twitter, :api_secret)
  provider :discord,
           Rails.application.credentials.dig(:omniauth, :discord, :client_id),
           Rails.application.credentials.dig(:omniauth, :discord, :client_secret)
end
ğŸ”¹ AÃ±adir archivos al commit:
git add .
git commit -m "feat(social-login): configura OmniAuth en Rails para manejar autenticaciÃ³n social"
ğŸ“Œ Commit 54.3: Crear Modelo Identity para Asociar Redes Sociales a Usuarios
ğŸ”¹ Mensaje de commit:
feat(social-login): agrega modelo Identity para vincular redes sociales a cuentas Web3
ğŸ”¹ Contenido del commit:
Generar Modelo y MigraciÃ³n
rails g model Identity user:references provider:string uid:string
rails db:migrate
Modificar app/models/identity.rb
class Identity < ApplicationRecord
  belongs_to :user
  validates :provider, :uid, presence: true, uniqueness: { scope: :provider }
end
ğŸ”¹ AÃ±adir archivos al commit:
git add .
git commit -m "feat(social-login): agrega modelo Identity para vincular redes sociales a cuentas Web3"
ğŸ“Œ Commit 54.4: Crear Controlador para Manejo de AutenticaciÃ³n Social
ğŸ”¹ Mensaje de commit:
feat(social-login): agrega controlador para manejar autenticaciÃ³n con Google, Twitter y Discord
ğŸ”¹ Contenido del commit:
Crear SocialLoginsController en app/controllers/social_logins_controller.rb
class SocialLoginsController < ApplicationController
  def callback
    auth = request.env["omniauth.auth"]
    identity = Identity.find_or_create_by(provider: auth.provider, uid: auth.uid) do |idn|
      idn.user = User.find_or_create_by(email: auth.info.email) do |user|
        user.wallet_address = SecureRandom.hex(20) # Wallet temporal
      end
    end
    sign_in identity.user
    redirect_to root_path, notice: "AutenticaciÃ³n exitosa con #{auth.provider.capitalize}"
  end
end
Agregar Rutas en config/routes.rb
Rails.application.routes.draw do
  get "/auth/:provider/callback", to: "social_logins#callback"
end
ğŸ”¹ AÃ±adir archivos al commit:
git add .
git commit -m "feat(social-login): agrega controlador para manejar autenticaciÃ³n con Google, Twitter y Discord"
ğŸ“Œ Commit 54.5: Agregar Botones para Iniciar SesiÃ³n con Redes Sociales en la UI
ğŸ”¹ Mensaje de commit:
feat(social-login): agrega botones para iniciar sesiÃ³n con Google, Twitter y Discord en la UI
ğŸ”¹ Contenido del commit:
Modificar app/views/sessions/new.html.erb
<h2>Recuperar cuenta con Redes Sociales</h2>
<a href="/auth/google_oauth2" class="btn btn-primary">Iniciar sesiÃ³n con Google</a>
<a href="/auth/twitter" class="btn btn-info">Iniciar sesiÃ³n con Twitter</a>
<a href="/auth/discord" class="btn btn-dark">Iniciar sesiÃ³n con Discord</a>
ğŸ”¹ AÃ±adir archivos al commit:
git add .
git commit -m "feat(social-login): agrega botones para iniciar sesiÃ³n con Google, Twitter y Discord en la UI"
ğŸ“ ExplicaciÃ³n y CÃ³digo Generado
Ejemplo de Inicio de SesiÃ³n con Google en API
curl -X GET "http://localhost:3000/auth/google_oauth2"
âœ… Redirige al usuario a Google para autenticarse.
Ejemplo de Callback en Rails Console
request.env["omniauth.auth"] = {
  provider: "google_oauth2",
  uid: "123456",
  info: { email: "user@example.com" }
}
SocialLoginsController.new.callback
âœ… Crea una cuenta y asocia la red social al usuario Web3.
Ejemplo de Inicio de SesiÃ³n con Google desde la UI
document.querySelector("a[href='/auth/google_oauth2']").click();
âœ… El usuario es redirigido a Google, inicia sesiÃ³n y regresa autenticado.
