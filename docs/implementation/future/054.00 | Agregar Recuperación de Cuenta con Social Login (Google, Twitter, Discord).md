# ✅ Paso 54: Agregar Recuperación de Cuenta con Social Login (Google, Twitter, Discord)

Ahora agregaremos soporte para recuperar cuentas con Social Login (Google, Twitter, Discord), permitiendo que los usuarios inicien sesión en caso de perder acceso a su wallet Web3 o Passkey.
✅ OmniAuth → Para manejar autenticación con Google, Twitter y Discord.
✅ Web3 Recovery Flow → Asociar redes sociales a cuentas Web3.
✅ Background Jobs (Sidekiq) → Para procesar autenticaciones asíncronas.
✅ Turbo Streams + Stimulus.js → Para notificaciones en la UI.
📌 Commit 54.1: Instalar OmniAuth para Autenticación con Redes Sociales
🔹 Mensaje de commit:
feat(social-login): instala OmniAuth para autenticación con Google, Twitter y Discord
🔹 Contenido del commit:
Instalar OmniAuth y los Providers
bundle add omniauth-google-oauth2 omniauth-twitter omniauth-discord
Agregar Credenciales en config/credentials.yml.enc
omniauth:
  google:
    client_id: "YOUR_GOOGLE_CLIENT_ID"
    client_secret: "YOUR_GOOGLE_CLIENT_SECRET"
  twitter:
    api_key: "YOUR_TWITTER_API_KEY"
    api_secret: "YOUR_TWITTER_API_SECRET"
  discord:
    client_id: "YOUR_DISCORD_CLIENT_ID"
    client_secret: "YOUR_DISCORD_CLIENT_SECRET"
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(social-login): instala OmniAuth para autenticación con Google, Twitter y Discord"
📌 Commit 54.2: Configurar OmniAuth en Rails
🔹 Mensaje de commit:
feat(social-login): configura OmniAuth en Rails para manejar autenticación social
🔹 Contenido del commit:
Modificar config/initializers/omniauth.rb
Rails.application.config.middleware.use OmniAuth::Builder do
  provider :google_oauth2,
           Rails.application.credentials.dig(:omniauth, :google, :client_id),
           Rails.application.credentials.dig(:omniauth, :google, :client_secret)
  provider :twitter,
           Rails.application.credentials.dig(:omniauth, :twitter, :api_key),
           Rails.application.credentials.dig(:omniauth, :twitter, :api_secret)
  provider :discord,
           Rails.application.credentials.dig(:omniauth, :discord, :client_id),
           Rails.application.credentials.dig(:omniauth, :discord, :client_secret)
end
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(social-login): configura OmniAuth en Rails para manejar autenticación social"
📌 Commit 54.3: Crear Modelo Identity para Asociar Redes Sociales a Usuarios
🔹 Mensaje de commit:
feat(social-login): agrega modelo Identity para vincular redes sociales a cuentas Web3
🔹 Contenido del commit:
Generar Modelo y Migración
rails g model Identity user:references provider:string uid:string
rails db:migrate
Modificar app/models/identity.rb
class Identity < ApplicationRecord
  belongs_to :user
  validates :provider, :uid, presence: true, uniqueness: { scope: :provider }
end
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(social-login): agrega modelo Identity para vincular redes sociales a cuentas Web3"
📌 Commit 54.4: Crear Controlador para Manejo de Autenticación Social
🔹 Mensaje de commit:
feat(social-login): agrega controlador para manejar autenticación con Google, Twitter y Discord
🔹 Contenido del commit:
Crear SocialLoginsController en app/controllers/social_logins_controller.rb
class SocialLoginsController < ApplicationController
  def callback
    auth = request.env["omniauth.auth"]
    identity = Identity.find_or_create_by(provider: auth.provider, uid: auth.uid) do |idn|
      idn.user = User.find_or_create_by(email: auth.info.email) do |user|
        user.wallet_address = SecureRandom.hex(20) # Wallet temporal
      end
    end
    sign_in identity.user
    redirect_to root_path, notice: "Autenticación exitosa con #{auth.provider.capitalize}"
  end
end
Agregar Rutas en config/routes.rb
Rails.application.routes.draw do
  get "/auth/:provider/callback", to: "social_logins#callback"
end
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(social-login): agrega controlador para manejar autenticación con Google, Twitter y Discord"
📌 Commit 54.5: Agregar Botones para Iniciar Sesión con Redes Sociales en la UI
🔹 Mensaje de commit:
feat(social-login): agrega botones para iniciar sesión con Google, Twitter y Discord en la UI
🔹 Contenido del commit:
Modificar app/views/sessions/new.html.erb
<h2>Recuperar cuenta con Redes Sociales</h2>
<a href="/auth/google_oauth2" class="btn btn-primary">Iniciar sesión con Google</a>
<a href="/auth/twitter" class="btn btn-info">Iniciar sesión con Twitter</a>
<a href="/auth/discord" class="btn btn-dark">Iniciar sesión con Discord</a>
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(social-login): agrega botones para iniciar sesión con Google, Twitter y Discord en la UI"
📝 Explicación y Código Generado
Ejemplo de Inicio de Sesión con Google en API
curl -X GET "http://localhost:3000/auth/google_oauth2"
✅ Redirige al usuario a Google para autenticarse.
Ejemplo de Callback en Rails Console
request.env["omniauth.auth"] = {
  provider: "google_oauth2",
  uid: "123456",
  info: { email: "user@example.com" }
}
SocialLoginsController.new.callback
✅ Crea una cuenta y asocia la red social al usuario Web3.
Ejemplo de Inicio de Sesión con Google desde la UI
document.querySelector("a[href='/auth/google_oauth2']").click();
✅ El usuario es redirigido a Google, inicia sesión y regresa autenticado.
