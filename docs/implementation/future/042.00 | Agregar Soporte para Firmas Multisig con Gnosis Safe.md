# ✅ Paso 42: Agregar Soporte para Firmas Multisig con Gnosis Safe

Ahora agregaremos soporte para firmas múltiples con Gnosis Safe, permitiendo que varios usuarios firmen documentos o contratos antes de ser validados en Blockchain.
✅ Gnosis Safe → Permite firmas múltiples para mayor seguridad.
✅ Transacciones On-Chain y Off-Chain → Verificación de firmas antes de ejecutarlas.
✅ Meta Transactions → Integración con Biconomy para transacciones sin gas.
✅ Soporte para MetaMask, Trezor y Ledger → Acceso desde diferentes wallets.
📌 Commit 42.1: Integrar SDK de Gnosis Safe en el Frontend
🔹 Mensaje de commit:
feat(gnosis): instala Gnosis Safe SDK para firma multisig de contratos
🔹 Contenido del commit:
Instalar Gnosis Safe SDK en app/javascript/packs/gnosis_safe.js
import Safe from "@safe-global/safe-apps-sdk";
const safe = new Safe();
export default safe;
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(gnosis): instala Gnosis Safe SDK para firma multisig de contratos"
📌 Commit 42.2: Modificar Smart Contract para Soporte Multisig
🔹 Mensaje de commit:
feat(gnosis): agrega soporte multisig en Smart Contracts con Gnosis Safe
🔹 Contenido del commit:
Modificar contracts/MultisigDocumentSigner.sol
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.0;
contract MultisigDocumentSigner {
    address[] public owners;
    uint public requiredSignatures;
    mapping(bytes32 => uint) public contractSignatures;
    mapping(bytes32 => mapping(address => bool)) public hasSigned;
    event ContractSigned(address indexed signer, bytes32 contractHash, uint signatures);
    constructor(address[] memory _owners, uint _requiredSignatures) {
        require(_owners.length >= _requiredSignatures, "Los firmantes deben ser al menos igual al número requerido.");
        owners = _owners;
        requiredSignatures = _requiredSignatures;
    }
    function signContract(bytes32 contractHash) public {
        require(isOwner(msg.sender), "No autorizado.");
        require(!hasSigned[contractHash][msg.sender], "Ya has firmado.");
        hasSigned[contractHash][msg.sender] = true;
        contractSignatures[contractHash]++;
        emit ContractSigned(msg.sender, contractHash, contractSignatures[contractHash]);
    }
    function isContractSigned(bytes32 contractHash) public view returns (bool) {
        return contractSignatures[contractHash] >= requiredSignatures;
    }
    function isOwner(address signer) internal view returns (bool) {
        for (uint i = 0; i < owners.length; i++) {
            if (owners[i] == signer) {
                return true;
            }
        }
        return false;
    }
}
✅ El contrato ahora requiere múltiples firmas antes de validarse.
Compilar y Desplegar en Testnet (Goerli/Polygon Mumbai)
npx hardhat compile
npx hardhat run scripts/deploy.js --network polygon_mumbai
✅ Guardar la dirección del contrato en config/credentials.yml.enc.
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(gnosis): agrega soporte multisig en Smart Contracts con Gnosis Safe"
📌 Commit 42.3: Agregar Función para Firmar Contratos Multisig con Gnosis Safe
🔹 Mensaje de commit:
feat(gnosis): agrega función para firmar contratos en Gnosis Safe desde el frontend
🔹 Contenido del commit:
Crear app/javascript/packs/gnosis_sign.js
import safe from "./gnosis_safe";
import Web3 from "web3";
async function signContractWithGnosis(contractAddress, contractHash) {
  const web3 = new Web3(window.ethereum);
  const accounts = await web3.eth.getAccounts();
  const userAddress = accounts[0];
  const tx = {
    to: contractAddress,
    data: web3.eth.abi.encodeFunctionCall({
      name: "signContract",
      type: "function",
      inputs: [{ type: "bytes32", name: "contractHash" }]
    }, [contractHash])
  };
  const safeTxHash = await safe.sendTransaction(tx);
  alert(`Transacción pendiente en Gnosis Safe: ${safeTxHash}`);
}
document.addEventListener("DOMContentLoaded", () => {
  document.querySelectorAll(".sign-contract-gnosis").forEach(button => {
    button.addEventListener("click", async (event) => {
      const contractHash = event.target.dataset.contractHash;
      signContractWithGnosis("0xContractAddress", contractHash);
    });
  });
});
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(gnosis): agrega función para firmar contratos en Gnosis Safe desde el frontend"
📌 Commit 42.4: Crear Endpoint para Verificar Estado del Multisig
🔹 Mensaje de commit:
feat(gnosis): agrega endpoint para verificar estado de contratos firmados en Gnosis Safe
🔹 Contenido del commit:
Modificar ContractsController para Verificación Multisig
class ContractsController < ApplicationController
  def verify_multisig
    contract_hash = params[:contract_hash]
    exists = SmartContractService.verify_multisig_contract(contract_hash)
    if exists
      render json: { message: "Contrato firmado con suficientes firmas en Gnosis Safe" }, status: :ok
    else
      render json: { error: "Contrato aún no tiene suficientes firmas" }, status: :unprocessable_entity
    end
  end
end
Agregar Ruta en config/routes.rb
Rails.application.routes.draw do
  get "/contracts/verify_multisig", to: "contracts#verify_multisig"
end
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(gnosis): agrega endpoint para verificar estado de contratos firmados en Gnosis Safe"
📝 Explicación y Código Generado
Ejemplo de Firma de Contrato Multisig con Gnosis Safe
    El usuario hace clic en "Firmar Contrato en Gnosis Safe".
    La transacción es enviada al contrato de Gnosis Safe.
    Otros firmantes aprueban la transacción.
    Cuando se alcanza el número requerido de firmas, el contrato se ejecuta.
Ejemplo de Firma de Contrato en Gnosis Safe (Web3.js)
signContractWithGnosis("0xContractAddress", "0xContratoHash");
✅ La transacción queda en espera hasta recibir suficientes firmas.
Ejemplo de Verificación de Estado Multisig en la Blockchain
curl -X GET "http://localhost:3000/contracts/verify_multisig?contract_hash=0xContratoHash"
✅ Si el contrato está firmado por suficientes personas:
{ "message": "Contrato firmado con suficientes firmas en Gnosis Safe" }
❌ Si faltan firmas:
{ "error": "Contrato aún no tiene suficientes firmas" }
Ejemplo de Confirmación de Firma en Gnosis Safe
signContractWithGnosis("0xContractAddress", "0xContratoHash");
✅ El contrato queda en espera hasta completar el número de firmas requeridas.
