# âœ… Paso 42: Agregar Soporte para Firmas Multisig con Gnosis Safe

Ahora agregaremos soporte para firmas mÃºltiples con Gnosis Safe, permitiendo que varios usuarios firmen documentos o contratos antes de ser validados en Blockchain.
âœ… Gnosis Safe â†’ Permite firmas mÃºltiples para mayor seguridad.
âœ… Transacciones On-Chain y Off-Chain â†’ VerificaciÃ³n de firmas antes de ejecutarlas.
âœ… Meta Transactions â†’ IntegraciÃ³n con Biconomy para transacciones sin gas.
âœ… Soporte para MetaMask, Trezor y Ledger â†’ Acceso desde diferentes wallets.
ğŸ“Œ Commit 42.1: Integrar SDK de Gnosis Safe en el Frontend
ğŸ”¹ Mensaje de commit:
feat(gnosis): instala Gnosis Safe SDK para firma multisig de contratos
ğŸ”¹ Contenido del commit:
Instalar Gnosis Safe SDK en app/javascript/packs/gnosis_safe.js
import Safe from "@safe-global/safe-apps-sdk";
const safe = new Safe();
export default safe;
ğŸ”¹ AÃ±adir archivos al commit:
git add .
git commit -m "feat(gnosis): instala Gnosis Safe SDK para firma multisig de contratos"
ğŸ“Œ Commit 42.2: Modificar Smart Contract para Soporte Multisig
ğŸ”¹ Mensaje de commit:
feat(gnosis): agrega soporte multisig en Smart Contracts con Gnosis Safe
ğŸ”¹ Contenido del commit:
Modificar contracts/MultisigDocumentSigner.sol
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.0;
contract MultisigDocumentSigner {
    address[] public owners;
    uint public requiredSignatures;
    mapping(bytes32 => uint) public contractSignatures;
    mapping(bytes32 => mapping(address => bool)) public hasSigned;
    event ContractSigned(address indexed signer, bytes32 contractHash, uint signatures);
    constructor(address[] memory _owners, uint _requiredSignatures) {
        require(_owners.length >= _requiredSignatures, "Los firmantes deben ser al menos igual al nÃºmero requerido.");
        owners = _owners;
        requiredSignatures = _requiredSignatures;
    }
    function signContract(bytes32 contractHash) public {
        require(isOwner(msg.sender), "No autorizado.");
        require(!hasSigned[contractHash][msg.sender], "Ya has firmado.");
        hasSigned[contractHash][msg.sender] = true;
        contractSignatures[contractHash]++;
        emit ContractSigned(msg.sender, contractHash, contractSignatures[contractHash]);
    }
    function isContractSigned(bytes32 contractHash) public view returns (bool) {
        return contractSignatures[contractHash] >= requiredSignatures;
    }
    function isOwner(address signer) internal view returns (bool) {
        for (uint i = 0; i < owners.length; i++) {
            if (owners[i] == signer) {
                return true;
            }
        }
        return false;
    }
}
âœ… El contrato ahora requiere mÃºltiples firmas antes de validarse.
Compilar y Desplegar en Testnet (Goerli/Polygon Mumbai)
npx hardhat compile
npx hardhat run scripts/deploy.js --network polygon_mumbai
âœ… Guardar la direcciÃ³n del contrato en config/credentials.yml.enc.
ğŸ”¹ AÃ±adir archivos al commit:
git add .
git commit -m "feat(gnosis): agrega soporte multisig en Smart Contracts con Gnosis Safe"
ğŸ“Œ Commit 42.3: Agregar FunciÃ³n para Firmar Contratos Multisig con Gnosis Safe
ğŸ”¹ Mensaje de commit:
feat(gnosis): agrega funciÃ³n para firmar contratos en Gnosis Safe desde el frontend
ğŸ”¹ Contenido del commit:
Crear app/javascript/packs/gnosis_sign.js
import safe from "./gnosis_safe";
import Web3 from "web3";
async function signContractWithGnosis(contractAddress, contractHash) {
  const web3 = new Web3(window.ethereum);
  const accounts = await web3.eth.getAccounts();
  const userAddress = accounts[0];
  const tx = {
    to: contractAddress,
    data: web3.eth.abi.encodeFunctionCall({
      name: "signContract",
      type: "function",
      inputs: [{ type: "bytes32", name: "contractHash" }]
    }, [contractHash])
  };
  const safeTxHash = await safe.sendTransaction(tx);
  alert(`TransacciÃ³n pendiente en Gnosis Safe: ${safeTxHash}`);
}
document.addEventListener("DOMContentLoaded", () => {
  document.querySelectorAll(".sign-contract-gnosis").forEach(button => {
    button.addEventListener("click", async (event) => {
      const contractHash = event.target.dataset.contractHash;
      signContractWithGnosis("0xContractAddress", contractHash);
    });
  });
});
ğŸ”¹ AÃ±adir archivos al commit:
git add .
git commit -m "feat(gnosis): agrega funciÃ³n para firmar contratos en Gnosis Safe desde el frontend"
ğŸ“Œ Commit 42.4: Crear Endpoint para Verificar Estado del Multisig
ğŸ”¹ Mensaje de commit:
feat(gnosis): agrega endpoint para verificar estado de contratos firmados en Gnosis Safe
ğŸ”¹ Contenido del commit:
Modificar ContractsController para VerificaciÃ³n Multisig
class ContractsController < ApplicationController
  def verify_multisig
    contract_hash = params[:contract_hash]
    exists = SmartContractService.verify_multisig_contract(contract_hash)
    if exists
      render json: { message: "Contrato firmado con suficientes firmas en Gnosis Safe" }, status: :ok
    else
      render json: { error: "Contrato aÃºn no tiene suficientes firmas" }, status: :unprocessable_entity
    end
  end
end
Agregar Ruta en config/routes.rb
Rails.application.routes.draw do
  get "/contracts/verify_multisig", to: "contracts#verify_multisig"
end
ğŸ”¹ AÃ±adir archivos al commit:
git add .
git commit -m "feat(gnosis): agrega endpoint para verificar estado de contratos firmados en Gnosis Safe"
ğŸ“ ExplicaciÃ³n y CÃ³digo Generado
Ejemplo de Firma de Contrato Multisig con Gnosis Safe
    El usuario hace clic en "Firmar Contrato en Gnosis Safe".
    La transacciÃ³n es enviada al contrato de Gnosis Safe.
    Otros firmantes aprueban la transacciÃ³n.
    Cuando se alcanza el nÃºmero requerido de firmas, el contrato se ejecuta.
Ejemplo de Firma de Contrato en Gnosis Safe (Web3.js)
signContractWithGnosis("0xContractAddress", "0xContratoHash");
âœ… La transacciÃ³n queda en espera hasta recibir suficientes firmas.
Ejemplo de VerificaciÃ³n de Estado Multisig en la Blockchain
curl -X GET "http://localhost:3000/contracts/verify_multisig?contract_hash=0xContratoHash"
âœ… Si el contrato estÃ¡ firmado por suficientes personas:
{ "message": "Contrato firmado con suficientes firmas en Gnosis Safe" }
âŒ Si faltan firmas:
{ "error": "Contrato aÃºn no tiene suficientes firmas" }
Ejemplo de ConfirmaciÃ³n de Firma en Gnosis Safe
signContractWithGnosis("0xContractAddress", "0xContratoHash");
âœ… El contrato queda en espera hasta completar el nÃºmero de firmas requeridas.
