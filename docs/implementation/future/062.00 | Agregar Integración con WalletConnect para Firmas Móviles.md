# âœ… Paso 62: Agregar IntegraciÃ³n con WalletConnect para Firmas MÃ³viles

Ahora agregaremos soporte para WalletConnect, permitiendo que los usuarios firmen transacciones con sus wallets mÃ³viles en lugar de MetaMask en desktop. Esto permite iniciar sesiÃ³n con Rainbow, Trust Wallet, Argent, y cualquier wallet compatible con WalletConnect.
âœ… WalletConnect SDK â†’ ConexiÃ³n con wallets mÃ³viles para firma de mensajes.
âœ… Compatibilidad con Web3 Sign-In (EIP-712) â†’ Firma de autenticaciÃ³n con WalletConnect.
âœ… Stimulus.js + Turbo Streams â†’ Para una UX fluida sin recargas.
âœ… IntegraciÃ³n con Gnosis Safe y Smart Contract Wallets â†’ Compatible con firmas delegadas.
ðŸ“Œ Commit 62.1: Instalar el SDK de WalletConnect en Frontend
ðŸ”¹ Mensaje de commit:
feat(walletconnect): instala SDK de WalletConnect en frontend para autenticaciÃ³n con wallets mÃ³viles
ðŸ”¹ Contenido del commit:
Instalar WalletConnect SDK en package.json
yarn add @walletconnect/client
ðŸ”¹ AÃ±adir archivos al commit:
git add .
git commit -m "feat(walletconnect): instala SDK de WalletConnect en frontend para autenticaciÃ³n con wallets mÃ³viles"
ðŸ“Œ Commit 62.2: Implementar ConexiÃ³n con WalletConnect en Stimulus.js
ðŸ”¹ Mensaje de commit:
feat(walletconnect): implementa conexiÃ³n con WalletConnect en Stimulus.js
ðŸ”¹ Contenido del commit:
Modificar app/javascript/controllers/walletconnect_controller.js
import { Controller } from "@hotwired/stimulus";
import WalletConnect from "@walletconnect/client";
import QRCodeModal from "@walletconnect/qrcode-modal";
export default class extends Controller {
  async connectWallet() {
    this.connector = new WalletConnect({
      bridge: "https://bridge.walletconnect.org"
    });
    if (!this.connector.connected) {
      this.connector.createSession().then(() => {
        QRCodeModal.open(this.connector.uri, () => {});
      });
    }
    this.connector.on("connect", (error, payload) => {
      if (error) {
        console.error(error);
        return;
      }
      QRCodeModal.close();
      this.walletAddress = payload.params[0].accounts[0];
      this.signMessage();
    });
  }
  async signMessage() {
    const nonceResponse = await fetch("/auth/eip712_nonce");
    const { nonce } = await nonceResponse.json();
    const message = `Iniciar sesiÃ³n en Web3 App.\nNonce: ${nonce}`;
    const signature = await this.connector.signPersonalMessage([message, this.walletAddress]);
    const loginResponse = await fetch("/auth/eip712_login", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ wallet_address: this.walletAddress, signature })
    });
    if (loginResponse.ok) {
      alert("AutenticaciÃ³n exitosa");
      window.location.reload();
    } else {
      alert("Error en la autenticaciÃ³n");
    }
  }
}
Modificar app/views/sessions/new.html.erb
<h2>Iniciar sesiÃ³n con WalletConnect</h2>
<button data-controller="walletconnect" data-action="click->walletconnect#connectWallet">
  Conectar con WalletConnect
</button>
ðŸ”¹ AÃ±adir archivos al commit:
git add .
git commit -m "feat(walletconnect): implementa conexiÃ³n con WalletConnect en Stimulus.js"
ðŸ“Œ Commit 62.3: Modificar Backend para Soportar WalletConnect
ðŸ”¹ Mensaje de commit:
feat(walletconnect): agrega soporte en backend para autenticaciÃ³n con WalletConnect
ðŸ”¹ Contenido del commit:
Modificar Web3AuthController para Soporte de WalletConnect
class Web3AuthController < ApplicationController
  skip_before_action :verify_authenticity_token
  def walletconnect_nonce
    session[:web3_nonce] = SecureRandom.hex(16)
    render json: { nonce: session[:web3_nonce] }
  end
  def walletconnect_login
    wallet = params[:wallet_address]
    signature = params[:signature]
    nonce = session[:web3_nonce]
    return render json: { error: "Nonce invÃ¡lido" }, status: :unauthorized unless nonce
    signer = Ethereum::EIP712.verify_signature(nonce, wallet, signature)
    if signer.downcase == wallet.downcase
      user = User.find_or_create_by(wallet_address: wallet)
      rodauth = RodauthMain.new(account_id: user.id, scope: self)
      token = rodauth.create_jwt
      render json: { message: "AutenticaciÃ³n exitosa", user: user, token: token }
    else
      render json: { error: "Firma invÃ¡lida" }, status: :unauthorized
    end
  end
end
Agregar Rutas en config/routes.rb
Rails.application.routes.draw do
  post "/auth/walletconnect_nonce", to: "web3_auth#walletconnect_nonce"
  post "/auth/walletconnect_login", to: "web3_auth#walletconnect_login"
end
ðŸ”¹ AÃ±adir archivos al commit:
git add .
git commit -m "feat(walletconnect): agrega soporte en backend para autenticaciÃ³n con WalletConnect"
ðŸ“Œ Commit 62.4: Agregar ValidaciÃ³n de Firma en Smart Contracts
ðŸ”¹ Mensaje de commit:
feat(walletconnect): agrega validaciÃ³n de firmas en Smart Contracts con WalletConnect
ðŸ”¹ Contenido del commit:
Modificar Contrato Solidity para Soportar WalletConnect
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.0;
contract WalletConnectVerifier {
    bytes32 public constant LOGIN_TYPEHASH = keccak256("Login(address wallet,string nonce)");
    bytes32 public DOMAIN_SEPARATOR;
    constructor() {
        DOMAIN_SEPARATOR = keccak256(
            abi.encode(
                keccak256("EIP712Domain(string name,string version,uint256 chainId,address verifyingContract)"),
                keccak256(bytes("Web3 App")),
                keccak256(bytes("1")),
                block.chainid,
                address(this)
            )
        );
    }
    function verify(address wallet, string memory nonce, uint8 v, bytes32 r, bytes32 s) public view returns (bool) {
        bytes32 structHash = keccak256(abi.encode(LOGIN_TYPEHASH, wallet, keccak256(bytes(nonce))));
        bytes32 digest = keccak256(abi.encodePacked("\x19\x01", DOMAIN_SEPARATOR, structHash));
        return ecrecover(digest, v, r, s) == wallet;
    }
}
Desplegar Contrato en la Blockchain
npx hardhat run scripts/deploy.js --network goerli
âœ… Guarda la direcciÃ³n del contrato para usar en el backend.
ðŸ”¹ AÃ±adir archivos al commit:
git add .
git commit -m "feat(walletconnect): agrega validaciÃ³n de firmas en Smart Contracts con WalletConnect"
ðŸ“ ExplicaciÃ³n y CÃ³digo Generado
Ejemplo de Firma en API
curl -X POST "http://localhost:3000/auth/walletconnect_login" \
  -H "Content-Type: application/json" \
  -d '{ "wallet_address": "0xUserWallet", "signature": "0xFirmaWalletConnect" }'
âœ… Si la firma es vÃ¡lida:
{ "message": "AutenticaciÃ³n exitosa", "user": { "id": 1, "wallet_address": "0xUserWallet" }, "token": "eyJhbGciOiJIUzI1NiIsInR..." }
Ejemplo de Firma en Smart Contract
WalletConnectVerifier.verify("0xUserWallet", "nonce_value", v, r, s);
âœ… Retorna true si la firma es vÃ¡lida.
