# ✅ Paso 62: Agregar Integración con WalletConnect para Firmas Móviles

Ahora agregaremos soporte para WalletConnect, permitiendo que los usuarios firmen transacciones con sus wallets móviles en lugar de MetaMask en desktop. Esto permite iniciar sesión con Rainbow, Trust Wallet, Argent, y cualquier wallet compatible con WalletConnect.
✅ WalletConnect SDK → Conexión con wallets móviles para firma de mensajes.
✅ Compatibilidad con Web3 Sign-In (EIP-712) → Firma de autenticación con WalletConnect.
✅ Stimulus.js + Turbo Streams → Para una UX fluida sin recargas.
✅ Integración con Gnosis Safe y Smart Contract Wallets → Compatible con firmas delegadas.
📌 Commit 62.1: Instalar el SDK de WalletConnect en Frontend
🔹 Mensaje de commit:
feat(walletconnect): instala SDK de WalletConnect en frontend para autenticación con wallets móviles
🔹 Contenido del commit:
Instalar WalletConnect SDK en package.json
yarn add @walletconnect/client
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(walletconnect): instala SDK de WalletConnect en frontend para autenticación con wallets móviles"
📌 Commit 62.2: Implementar Conexión con WalletConnect en Stimulus.js
🔹 Mensaje de commit:
feat(walletconnect): implementa conexión con WalletConnect en Stimulus.js
🔹 Contenido del commit:
Modificar app/javascript/controllers/walletconnect_controller.js
import { Controller } from "@hotwired/stimulus";
import WalletConnect from "@walletconnect/client";
import QRCodeModal from "@walletconnect/qrcode-modal";
export default class extends Controller {
  async connectWallet() {
    this.connector = new WalletConnect({
      bridge: "https://bridge.walletconnect.org"
    });
    if (!this.connector.connected) {
      this.connector.createSession().then(() => {
        QRCodeModal.open(this.connector.uri, () => {});
      });
    }
    this.connector.on("connect", (error, payload) => {
      if (error) {
        console.error(error);
        return;
      }
      QRCodeModal.close();
      this.walletAddress = payload.params[0].accounts[0];
      this.signMessage();
    });
  }
  async signMessage() {
    const nonceResponse = await fetch("/auth/eip712_nonce");
    const { nonce } = await nonceResponse.json();
    const message = `Iniciar sesión en Web3 App.\nNonce: ${nonce}`;
    const signature = await this.connector.signPersonalMessage([message, this.walletAddress]);
    const loginResponse = await fetch("/auth/eip712_login", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ wallet_address: this.walletAddress, signature })
    });
    if (loginResponse.ok) {
      alert("Autenticación exitosa");
      window.location.reload();
    } else {
      alert("Error en la autenticación");
    }
  }
}
Modificar app/views/sessions/new.html.erb
<h2>Iniciar sesión con WalletConnect</h2>
<button data-controller="walletconnect" data-action="click->walletconnect#connectWallet">
  Conectar con WalletConnect
</button>
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(walletconnect): implementa conexión con WalletConnect en Stimulus.js"
📌 Commit 62.3: Modificar Backend para Soportar WalletConnect
🔹 Mensaje de commit:
feat(walletconnect): agrega soporte en backend para autenticación con WalletConnect
🔹 Contenido del commit:
Modificar Web3AuthController para Soporte de WalletConnect
class Web3AuthController < ApplicationController
  skip_before_action :verify_authenticity_token
  def walletconnect_nonce
    session[:web3_nonce] = SecureRandom.hex(16)
    render json: { nonce: session[:web3_nonce] }
  end
  def walletconnect_login
    wallet = params[:wallet_address]
    signature = params[:signature]
    nonce = session[:web3_nonce]
    return render json: { error: "Nonce inválido" }, status: :unauthorized unless nonce
    signer = Ethereum::EIP712.verify_signature(nonce, wallet, signature)
    if signer.downcase == wallet.downcase
      user = User.find_or_create_by(wallet_address: wallet)
      rodauth = RodauthMain.new(account_id: user.id, scope: self)
      token = rodauth.create_jwt
      render json: { message: "Autenticación exitosa", user: user, token: token }
    else
      render json: { error: "Firma inválida" }, status: :unauthorized
    end
  end
end
Agregar Rutas en config/routes.rb
Rails.application.routes.draw do
  post "/auth/walletconnect_nonce", to: "web3_auth#walletconnect_nonce"
  post "/auth/walletconnect_login", to: "web3_auth#walletconnect_login"
end
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(walletconnect): agrega soporte en backend para autenticación con WalletConnect"
📌 Commit 62.4: Agregar Validación de Firma en Smart Contracts
🔹 Mensaje de commit:
feat(walletconnect): agrega validación de firmas en Smart Contracts con WalletConnect
🔹 Contenido del commit:
Modificar Contrato Solidity para Soportar WalletConnect
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.0;
contract WalletConnectVerifier {
    bytes32 public constant LOGIN_TYPEHASH = keccak256("Login(address wallet,string nonce)");
    bytes32 public DOMAIN_SEPARATOR;
    constructor() {
        DOMAIN_SEPARATOR = keccak256(
            abi.encode(
                keccak256("EIP712Domain(string name,string version,uint256 chainId,address verifyingContract)"),
                keccak256(bytes("Web3 App")),
                keccak256(bytes("1")),
                block.chainid,
                address(this)
            )
        );
    }
    function verify(address wallet, string memory nonce, uint8 v, bytes32 r, bytes32 s) public view returns (bool) {
        bytes32 structHash = keccak256(abi.encode(LOGIN_TYPEHASH, wallet, keccak256(bytes(nonce))));
        bytes32 digest = keccak256(abi.encodePacked("\x19\x01", DOMAIN_SEPARATOR, structHash));
        return ecrecover(digest, v, r, s) == wallet;
    }
}
Desplegar Contrato en la Blockchain
npx hardhat run scripts/deploy.js --network goerli
✅ Guarda la dirección del contrato para usar en el backend.
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(walletconnect): agrega validación de firmas en Smart Contracts con WalletConnect"
📝 Explicación y Código Generado
Ejemplo de Firma en API
curl -X POST "http://localhost:3000/auth/walletconnect_login" \
  -H "Content-Type: application/json" \
  -d '{ "wallet_address": "0xUserWallet", "signature": "0xFirmaWalletConnect" }'
✅ Si la firma es válida:
{ "message": "Autenticación exitosa", "user": { "id": 1, "wallet_address": "0xUserWallet" }, "token": "eyJhbGciOiJIUzI1NiIsInR..." }
Ejemplo de Firma en Smart Contract
WalletConnectVerifier.verify("0xUserWallet", "nonce_value", v, r, s);
✅ Retorna true si la firma es válida.
