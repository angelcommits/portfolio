# ✅ Paso 75: Integrar Compra de Tokens de Recompensa con Fiat (Onramper + Stripe Crypto)

Ahora agregaremos compra de tokens de recompensa (GOVR) con dinero fiat, permitiendo que los usuarios adquieran GOVR directamente con tarjeta de crédito, transferencia bancaria o Apple Pay.
✅ Onramper (Fiat → Crypto) → Los usuarios pueden comprar GOVR con fiat en una UI embebida.
✅ Stripe Crypto (Tarjeta → Crypto) → Alternativa para procesar pagos con tarjeta directamente en la app.
✅ Web3.js + Stimulus.js → Para gestionar compras y actualizar el balance en tiempo real.
✅ Solidity Smart Contract → Para recibir pagos en crypto y emitir GOVR.
📌 Commit 75.1: Integrar Onramper para Compra de GOVR con Fiat
🔹 Mensaje de commit:
feat(fiat-onramp): integra Onramper para compra de tokens GOVR con fiat
🔹 Contenido del commit:
Modificar app/views/fiat_onramp/index.html.erb
<h2>Compra Tokens GOVR con Tarjeta</h2>
<iframe
  src="https://widget.onramper.com?apiKey=YOUR_ONRAMPER_API_KEY&defaultCrypto=GOVR"
  height="500px"
  width="100%"
  frameborder="0"
  allow="accelerometer; autoplay; camera; gyroscope; payment"
></iframe>
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(fiat-onramp): integra Onramper para compra de tokens GOVR con fiat"
📌 Commit 75.2: Integrar Stripe Crypto Checkout para Comprar GOVR
🔹 Mensaje de commit:
feat(fiat-onramp): agrega Stripe Crypto para comprar tokens GOVR con tarjeta de crédito
🔹 Contenido del commit:
Modificar FiatPaymentsController en app/controllers/fiat_payments_controller.rb
class FiatPaymentsController < ApplicationController
  def create_checkout
    session = Stripe::Checkout::Session.create(
      payment_method_types: ["card"],
      mode: "payment",
      success_url: "#{root_url}fiat_onramp/success",
      cancel_url: "#{root_url}fiat_onramp/cancel",
      line_items: [
        {
          price_data: {
            currency: "usd",
            product_data: {
              name: "Governance Reward Token (GOVR)"
            },
            unit_amount: params[:amount].to_i * 100
          },
          quantity: 1
        }
      ]
    )
    render json: { id: session.id }
  end
  def success
    # Aquí se transferirían GOVR tokens al usuario
    render json: { message: "Compra exitosa, tokens enviados" }
  end
end
Modificar config/routes.rb
post "/fiat_onramp/checkout", to: "fiat_payments#create_checkout"
get "/fiat_onramp/success", to: "fiat_payments#success"
get "/fiat_onramp/cancel", to: "fiat_payments#cancel"
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(fiat-onramp): agrega Stripe Crypto para comprar tokens GOVR con tarjeta de crédito"
📌 Commit 75.3: Integrar UI para Comprar GOVR con Stripe
🔹 Mensaje de commit:
feat(fiat-onramp): agrega UI para comprar GOVR con Stripe Checkout
🔹 Contenido del commit:
Modificar app/javascript/controllers/stripe_checkout_controller.js
import { Controller } from "@hotwired/stimulus";
import Stripe from "stripe";
export default class extends Controller {
  static targets = ["amount"];
  async buyGOVR() {
    const stripe = Stripe("YOUR_STRIPE_PUBLIC_KEY");
    const response = await fetch("/fiat_onramp/checkout", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ amount: this.amountTarget.value })
    });
    const session = await response.json();
    await stripe.redirectToCheckout({ sessionId: session.id });
  }
}
Modificar app/views/fiat_onramp/stripe_checkout.html.erb
<h2>Compra GOVR con Stripe</h2>
<label>Monto en USD:</label>
<input type="number" data-stripe-checkout-target="amount">
<button data-controller="stripe-checkout" data-action="click->stripe-checkout#buyGOVR">
  Comprar con Tarjeta
</button>
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(fiat-onramp): agrega UI para comprar GOVR con Stripe Checkout"
📝 Explicación y Código Generado
Ejemplo de Compra con Onramper
    El usuario entra a /fiat_onramp y usa Onramper para comprar GOVR.
    Después de completar el pago, los tokens aparecen en su wallet.
Ejemplo de Compra con Stripe en API
curl -X POST "http://localhost:3000/fiat_onramp/checkout" \
  -H "Content-Type: application/json" \
  -d '{ "amount": 50 }'
✅ Respuesta esperada:
{ "id": "cs_test_12345" }
    El usuario es redirigido a Stripe para pagar $50 USD y recibir GOVR tokens.
Ejemplo de Confirmación de Compra en API
curl -X GET "http://localhost:3000/fiat_onramp/success"
✅ Respuesta esperada:
{ "message": "Compra exitosa, tokens enviados" }
