# âœ… Paso 64: Agregar FacturaciÃ³n en Cripto con Smart Contracts (ERC-20, ERC-721, ERC-1155)

Ahora implementaremos facturaciÃ³n en criptomonedas usando contratos inteligentes, permitiendo pagos directos con tokens ERC-20 (USDC, DAI), NFT (ERC-721) y activos ERC-1155.
âœ… Soporte para pagos en contratos inteligentes â†’ Los usuarios pueden pagar con tokens en la blockchain.
âœ… ERC-20, ERC-721 y ERC-1155 â†’ Pagos con stablecoins, NFTs y activos coleccionables.
âœ… Web3.js + Stimulus.js â†’ Para interacciÃ³n con contratos en frontend.
âœ… Smart Contract en Solidity â†’ Para procesar pagos y verificar transacciones en Ethereum.
ðŸ“Œ Commit 64.1: Crear Smart Contract para Manejar Pagos en Cripto
ðŸ”¹ Mensaje de commit:
feat(crypto-billing): agrega contrato inteligente para facturaciÃ³n en ERC-20, ERC-721 y ERC-1155
ðŸ”¹ Contenido del commit:
Definir BillingContract.sol en contracts/BillingContract.sol
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.0;
interface IERC20 {
    function transferFrom(address sender, address recipient, uint256 amount) external returns (bool);
}
interface IERC721 {
    function transferFrom(address from, address to, uint256 tokenId) external;
}
interface IERC1155 {
    function safeTransferFrom(address from, address to, uint256 id, uint256 amount, bytes calldata data) external;
}
contract BillingContract {
    address public owner;
    mapping(uint256 => bool) public paidInvoices;
    event PaymentReceived(address payer, uint256 invoiceId, uint256 amount, string tokenType);
    constructor() {
        owner = msg.sender;
    }
    function payWithERC20(address token, uint256 amount, uint256 invoiceId) external {
        require(!paidInvoices[invoiceId], "Invoice already paid");
        IERC20(token).transferFrom(msg.sender, owner, amount);
        paidInvoices[invoiceId] = true;
        emit PaymentReceived(msg.sender, invoiceId, amount, "ERC-20");
    }
    function payWithERC721(address token, uint256 tokenId, uint256 invoiceId) external {
        require(!paidInvoices[invoiceId], "Invoice already paid");
        IERC721(token).transferFrom(msg.sender, owner, tokenId);
        paidInvoices[invoiceId] = true;
        emit PaymentReceived(msg.sender, invoiceId, tokenId, "ERC-721");
    }
    function payWithERC1155(address token, uint256 tokenId, uint256 amount, uint256 invoiceId) external {
        require(!paidInvoices[invoiceId], "Invoice already paid");
        IERC1155(token).safeTransferFrom(msg.sender, owner, tokenId, amount, "");
        paidInvoices[invoiceId] = true;
        emit PaymentReceived(msg.sender, invoiceId, amount, "ERC-1155");
    }
}
Compilar Contrato
npx hardhat compile
Desplegar en Goerli/Testnet
npx hardhat run scripts/deploy.js --network goerli
âœ… Guardar la direcciÃ³n del contrato desplegado para el backend.
ðŸ”¹ AÃ±adir archivos al commit:
git add .
git commit -m "feat(crypto-billing): agrega contrato inteligente para facturaciÃ³n en ERC-20, ERC-721 y ERC-1155"
ðŸ“Œ Commit 64.2: Integrar Pagos en Cripto en Frontend con Web3.js
ðŸ”¹ Mensaje de commit:
feat(crypto-billing): integra pagos en criptomonedas con Web3.js y Stimulus.js
ðŸ”¹ Contenido del commit:
Modificar app/javascript/controllers/crypto_billing_controller.js
import { Controller } from "@hotwired/stimulus";
import Web3 from "web3";
export default class extends Controller {
  static targets = ["invoiceId", "amount", "tokenAddress", "tokenType"];
  async payWithCrypto() {
    if (!window.ethereum) {
      alert("Por favor instala MetaMask");
      return;
    }
    const web3 = new Web3(window.ethereum);
    await window.ethereum.request({ method: "eth_requestAccounts" });
    const invoiceId = this.invoiceIdTarget.value;
    const amount = this.amountTarget.value;
    const tokenAddress = this.tokenAddressTarget.value;
    const tokenType = this.tokenTypeTarget.value;
    const contract = new web3.eth.Contract(
      [
        { name: "payWithERC20", type: "function", inputs: [{ name: "token", type: "address" }, { name: "amount", type: "uint256" }, { name: "invoiceId", type: "uint256" }] },
        { name: "payWithERC721", type: "function", inputs: [{ name: "token", type: "address" }, { name: "tokenId", type: "uint256" }, { name: "invoiceId", type: "uint256" }] },
        { name: "payWithERC1155", type: "function", inputs: [{ name: "token", type: "address" }, { name: "tokenId", type: "uint256" }, { name: "amount", type: "uint256" }, { name: "invoiceId", type: "uint256" }] }
      ],
      "0xYourContractAddress"
    );
    if (tokenType === "ERC-20") {
      await contract.methods.payWithERC20(tokenAddress, amount, invoiceId).send({ from: window.ethereum.selectedAddress });
    } else if (tokenType === "ERC-721") {
      await contract.methods.payWithERC721(tokenAddress, amount, invoiceId).send({ from: window.ethereum.selectedAddress });
    } else if (tokenType === "ERC-1155") {
      await contract.methods.payWithERC1155(tokenAddress, amount, invoiceId).send({ from: window.ethereum.selectedAddress });
    }
    alert("Pago realizado exitosamente");
  }
}
Modificar app/views/billing/index.html.erb
<h2>Pagar Factura con Cripto</h2>
<label>Invoice ID:</label>
<input type="text" data-crypto-billing-target="invoiceId">
<label>Token Address:</label>
<input type="text" data-crypto-billing-target="tokenAddress">
<label>Cantidad:</label>
<input type="text" data-crypto-billing-target="amount">
<label>Tipo de Token:</label>
<select data-crypto-billing-target="tokenType">
  <option value="ERC-20">ERC-20 (USDC, DAI, etc.)</option>
  <option value="ERC-721">ERC-721 (NFTs)</option>
  <option value="ERC-1155">ERC-1155 (Activos Coleccionables)</option>
</select>
<button data-controller="crypto-billing" data-action="click->crypto-billing#payWithCrypto">
  Pagar con Cripto
</button>
ðŸ”¹ AÃ±adir archivos al commit:
git add .
git commit -m "feat(crypto-billing): integra pagos en criptomonedas con Web3.js y Stimulus.js"
ðŸ“Œ Commit 64.3: Almacenar Pagos en Base de Datos en Backend
ðŸ”¹ Mensaje de commit:
feat(crypto-billing): almacena pagos en criptomonedas en base de datos
ðŸ”¹ Contenido del commit:
Crear Modelo InvoicePayment para Registrar Pagos
rails g model InvoicePayment user:references invoice_id:string token_address:string token_type:string amount:decimal
rails db:migrate
Modificar CryptoPaymentsController para Guardar Pagos
class CryptoPaymentsController < ApplicationController
  def record_payment
    InvoicePayment.create!(
      user: current_user,
      invoice_id: params[:invoice_id],
      token_address: params[:token_address],
      token_type: params[:token_type],
      amount: params[:amount]
    )
    render json: { message: "Pago registrado" }
  end
end
ðŸ”¹ AÃ±adir archivos al commit:
git add .
git commit -m "feat(crypto-billing): almacena pagos en criptomonedas en base de datos"
