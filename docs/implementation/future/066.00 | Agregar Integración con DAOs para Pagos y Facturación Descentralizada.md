# ‚úÖ Paso 66: Agregar Integraci√≥n con DAOs para Pagos y Facturaci√≥n Descentralizada

Ahora agregaremos soporte para DAOs, permitiendo que las facturas sean aprobadas por votaci√≥n en contratos inteligentes de DAOs como Aragon, Gnosis Safe, y MolochDAO. Esto permitir√° que las organizaciones descentralizadas gestionen pagos sin intervenci√≥n centralizada.
‚úÖ Gnosis Safe Multi-Sig ‚Üí Aprobaciones de pagos basadas en m√∫ltiples firmas.
‚úÖ Aragon DAO Voting ‚Üí Facturaci√≥n aprobada por votaci√≥n en DAOs.
‚úÖ MolochDAO GuildBank ‚Üí Distribuci√≥n autom√°tica de fondos tras votaci√≥n.
‚úÖ Web3.js + Stimulus.js ‚Üí Interacci√≥n fluida con contratos en frontend.
‚úÖ Solidity Smart Contracts ‚Üí Para gestionar la votaci√≥n y ejecuci√≥n de pagos.
üìå Commit 66.1: Crear Smart Contract para Facturaci√≥n en DAOs
üîπ Mensaje de commit:
feat(dao-billing): agrega smart contract para facturaci√≥n y votaci√≥n en DAOs
üîπ Contenido del commit:
Definir DAOBilling.sol en contracts/DAOBilling.sol
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.0;
interface IERC20 {
    function transfer(address recipient, uint256 amount) external returns (bool);
}
contract DAOBilling {
    address public daoTreasury;
    address public token;
    uint256 public proposalCount;
    struct Invoice {
        address recipient;
        uint256 amount;
        bool approved;
    }
    mapping(uint256 => Invoice) public invoices;
    event InvoiceCreated(uint256 invoiceId, address recipient, uint256 amount);
    event InvoiceApproved(uint256 invoiceId, address recipient, uint256 amount);
    constructor(address _daoTreasury, address _token) {
        daoTreasury = _daoTreasury;
        token = _token;
    }
    function createInvoice(address recipient, uint256 amount) external returns (uint256) {
        proposalCount++;
        invoices[proposalCount] = Invoice(recipient, amount, false);
        emit InvoiceCreated(proposalCount, recipient, amount);
        return proposalCount;
    }
    function approveInvoice(uint256 invoiceId) external {
        require(msg.sender == daoTreasury, "Solo la DAO puede aprobar pagos");
        require(!invoices[invoiceId].approved, "Ya aprobado");
        invoices[invoiceId].approved = true;
        IERC20(token).transfer(invoices[invoiceId].recipient, invoices[invoiceId].amount);
        emit InvoiceApproved(invoiceId, invoices[invoiceId].recipient, invoices[invoiceId].amount);
    }
}
Compilar y Desplegar Contrato
npx hardhat compile
npx hardhat run scripts/deploy.js --network goerli
‚úÖ Guardar la direcci√≥n del contrato para el backend.
üîπ A√±adir archivos al commit:
git add .
git commit -m "feat(dao-billing): agrega smart contract para facturaci√≥n y votaci√≥n en DAOs"
üìå Commit 66.2: Integrar Generaci√≥n de Facturas en DAOs con Web3.js
üîπ Mensaje de commit:
feat(dao-billing): agrega generaci√≥n de facturas en DAOs usando Web3.js
üîπ Contenido del commit:
Modificar app/javascript/controllers/dao_billing_controller.js
import { Controller } from "@hotwired/stimulus";
import Web3 from "web3";
export default class extends Controller {
  static targets = ["recipient", "amount"];
  async createInvoice() {
    if (!window.ethereum) {
      alert("Por favor instala MetaMask");
      return;
    }
    const web3 = new Web3(window.ethereum);
    await window.ethereum.request({ method: "eth_requestAccounts" });
    const recipient = this.recipientTarget.value;
    const amount = this.amountTarget.value;
    const contract = new web3.eth.Contract(
      [
        { name: "createInvoice", type: "function", inputs: [{ name: "recipient", type: "address" }, { name: "amount", type: "uint256" }] }
      ],
      "0xYourDAOContractAddress"
    );
    await contract.methods.createInvoice(recipient, amount).send({ from: window.ethereum.selectedAddress });
    alert("Factura enviada para aprobaci√≥n en DAO");
  }
}
Modificar app/views/dao_billing/index.html.erb
<h2>Enviar Factura a la DAO</h2>
<label>Direcci√≥n del Receptor:</label>
<input type="text" data-dao-billing-target="recipient">
<label>Monto:</label>
<input type="text" data-dao-billing-target="amount">
<button data-controller="dao-billing" data-action="click->dao-billing#createInvoice">
  Enviar Factura a DAO
</button>
üîπ A√±adir archivos al commit:
git add .
git commit -m "feat(dao-billing): agrega generaci√≥n de facturas en DAOs usando Web3.js"
üìå Commit 66.3: Implementar Aprobaci√≥n de Facturas con Multi-Sig en Gnosis Safe
üîπ Mensaje de commit:
feat(dao-billing): integra aprobaci√≥n de facturas con Gnosis Safe Multi-Sig
üîπ Contenido del commit:
Modificar app/javascript/controllers/gnosis_safe_controller.js
import { Controller } from "@hotwired/stimulus";
import Web3 from "web3";
export default class extends Controller {
  static targets = ["invoiceId"];
  async approveInvoice() {
    if (!window.ethereum) {
      alert("Por favor instala MetaMask");
      return;
    }
    const web3 = new Web3(window.ethereum);
    await window.ethereum.request({ method: "eth_requestAccounts" });
    const invoiceId = this.invoiceIdTarget.value;
    const contract = new web3.eth.Contract(
      [
        { name: "approveInvoice", type: "function", inputs: [{ name: "invoiceId", type: "uint256" }] }
      ],
      "0xYourDAOContractAddress"
    );
    await contract.methods.approveInvoice(invoiceId).send({ from: window.ethereum.selectedAddress });
    alert("Factura aprobada en DAO");
  }
}
Modificar app/views/dao_billing/approve.html.erb
<h2>Aprobar Factura en DAO</h2>
<label>ID de Factura:</label>
<input type="text" data-gnosis-safe-target="invoiceId">
<button data-controller="gnosis-safe" data-action="click->gnosis-safe#approveInvoice">
  Aprobar Factura en DAO
</button>
üîπ A√±adir archivos al commit:
git add .
git commit -m "feat(dao-billing): integra aprobaci√≥n de facturas con Gnosis Safe Multi-Sig"
üìù Explicaci√≥n y C√≥digo Generado
Ejemplo de Crear Factura en DAO en API
curl -X POST "http://localhost:3000/dao_billing/create" \
  -H "Content-Type: application/json" \
  -d '{ "recipient": "0xUserWallet", "amount": 1000 }'
‚úÖ Respuesta esperada:
{ "message": "Factura enviada para aprobaci√≥n en DAO" }
Ejemplo de Aprobaci√≥n de Factura con Multi-Sig en Gnosis Safe
DAOBilling.approveInvoice(1)
‚úÖ La factura es aprobada y se transfiere el monto al receptor.
Ejemplo de Verificaci√≥n de Transacci√≥n en Etherscan
https://goerli.etherscan.io/tx/0xYourTransactionHash
‚úÖ El usuario puede verificar la transacci√≥n en la blockchain.
