# ✅ Paso 36: Integrar Notificaciones Web3 con Wallets (MetaMask / WalletConnect)

Ahora agregaremos notificaciones Web3 para que los usuarios puedan recibir alertas en sus wallets cuando un documento sea firmado en Blockchain.
✅ MetaMask & WalletConnect → Permiten notificar a usuarios con wallets Web3.
✅ Eventos on-chain → Detectar cambios en contratos inteligentes para enviar notificaciones.
✅ Push Protocol (EPNS) → Para enviar alertas descentralizadas.
✅ WebSockets con Alchemy o Infura → Para recibir eventos en tiempo real desde la blockchain.
📌 Commit 36.1: Instalar Soporte para Notificaciones Web3
🔹 Mensaje de commit:
feat(web3): instala soporte para notificaciones Web3 en MetaMask y WalletConnect
🔹 Contenido del commit:
# Añadir soporte para Alchemy y Push Protocol (EPNS)
echo "gem 'alchemy-sdk', '~> 1.0.0'" >> Gemfile
echo "gem 'epns', '~> 0.1.0'" >> Gemfile
# Instalar las gemas
bundle install
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(web3): instala soporte para notificaciones Web3 en MetaMask y WalletConnect"
📌 Commit 36.2: Crear Servicio para Escuchar Eventos Blockchain
🔹 Mensaje de commit:
feat(web3): agrega servicio para escuchar eventos de firma en Blockchain
🔹 Contenido del commit:
Definir BlockchainListenerService en app/services/blockchain_listener_service.rb
require "web3"
class BlockchainListenerService
  INFURA_URL = Rails.application.credentials.dig(:ethereum, :infura_url)
  def self.listen_for_signatures
    web3 = Web3::Eth::Rpc.new(host: INFURA_URL, port: 443, connect_options: { use_ssl: true })
    contract_address = Rails.application.credentials.dig(:ethereum, :contract_address)
    contract_abi = JSON.parse(File.read(Rails.root.join("config/contract_abi.json")))
    contract = web3.eth.contract(abi: contract_abi).at(contract_address)
    contract.on("DocumentSigned") do |event|
      document_hash = event["args"]["documentHash"]
      wallet_address = event["args"]["wallet"]
      # Enviar notificación Web3
      Web3NotifierService.send_push_notification(wallet_address, "Documento firmado: #{document_hash}")
    end
  end
end
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(web3): agrega servicio para escuchar eventos de firma en Blockchain"
📌 Commit 36.3: Agregar Servicio para Enviar Notificaciones Web3
🔹 Mensaje de commit:
feat(web3): agrega servicio para enviar notificaciones Web3 a MetaMask y WalletConnect
🔹 Contenido del commit:
Definir Web3NotifierService en app/services/web3_notifier_service.rb
require "epns"
class Web3NotifierService
  EPNS_CHANNEL_ADDRESS = Rails.application.credentials.dig(:web3, :epns_channel_address)
  EPNS_PRIVATE_KEY = Rails.application.credentials.dig(:web3, :epns_private_key)
  def self.send_push_notification(wallet_address, message)
    epns_client = EPNS::Client.new(EPNS_CHANNEL_ADDRESS, EPNS_PRIVATE_KEY)
    epns_client.send_notification(wallet_address, message, "Firma de Documento")
  end
end
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(web3): agrega servicio para enviar notificaciones Web3 a MetaMask y WalletConnect"
📌 Commit 36.4: Iniciar el Listener de Blockchain al Levantar la App
🔹 Mensaje de commit:
feat(web3): inicia el listener de eventos de firma en Blockchain al levantar la app
🔹 Contenido del commit:
Modificar config/initializers/blockchain_listener.rb
Rails.application.config.after_initialize do
  Thread.new do
    BlockchainListenerService.listen_for_signatures
  end
end
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(web3): inicia el listener de eventos de firma en Blockchain al levantar la app"
📝 Explicación y Código Generado
Ejemplo de Firma de Documento en Blockchain
    Un usuario firma un documento en la blockchain con MetaMask.
    Se emite un evento "DocumentSigned" en el contrato.
    El servicio BlockchainListenerService detecta el evento y obtiene el wallet_address.
    Web3NotifierService envía una notificación push al usuario en MetaMask o WalletConnect.
Ejemplo de Simulación de Evento de Firma en Rails Console
BlockchainListenerService.listen_for_signatures
Ejemplo de Envío de Notificación Web3 Manualmente
Web3NotifierService.send_push_notification("0xUserWalletAddress", "Tu documento ha sido firmado en la Blockchain.")
✅ El usuario recibirá la notificación en su wallet MetaMask / WalletConnect.
