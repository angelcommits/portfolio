# ‚úÖ Paso 73: Integrar Staking de NFTs para Gobernanza Activa

Ahora agregaremos staking de NFTs de gobernanza, permitiendo que los holders bloqueen sus NFTs para obtener mayor poder de voto en la DAO. Cuanto m√°s tiempo est√© bloqueado el NFT, mayor ser√° el poder de voto que otorga.
‚úÖ NFT Staking en Smart Contract ‚Üí Los usuarios pueden bloquear sus NFTs para aumentar su poder de voto.
‚úÖ Bonificaci√≥n por Tiempo en Staking ‚Üí Cuanto m√°s tiempo est√© en staking, mayor es el poder de voto.
‚úÖ Web3.js + Stimulus.js ‚Üí Para interactuar con el staking desde la UI.
‚úÖ Solidity Smart Contract ‚Üí Para gestionar el staking y bonificaciones de voto.
üìå Commit 73.1: Crear Smart Contract para Staking de NFTs
üîπ Mensaje de commit:
feat(nft-staking): agrega smart contract para staking de NFTs de gobernanza
üîπ Contenido del commit:
Definir NFTStaking.sol en contracts/NFTStaking.sol
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.0;
import "@openzeppelin/contracts/token/ERC721/IERC721.sol";
import "@openzeppelin/contracts/access/Ownable.sol";
contract NFTStaking is Ownable {
    IERC721 public nftContract;
    mapping(uint256 => address) public stakedNFTs;
    mapping(uint256 => uint256) public stakingTime;
    mapping(uint256 => uint256) public bonusMultiplier;
    event NFTStaked(address indexed user, uint256 tokenId, uint256 timestamp);
    event NFTUnstaked(address indexed user, uint256 tokenId);
    constructor(IERC721 _nftContract) {
        nftContract = _nftContract;
    }
    function stakeNFT(uint256 tokenId) external {
        require(nftContract.ownerOf(tokenId) == msg.sender, "No eres due√±o del NFT");
        nftContract.transferFrom(msg.sender, address(this), tokenId);
        stakedNFTs[tokenId] = msg.sender;
        stakingTime[tokenId] = block.timestamp;
        bonusMultiplier[tokenId] = 1;
        emit NFTStaked(msg.sender, tokenId, block.timestamp);
    }
    function unstakeNFT(uint256 tokenId) external {
        require(stakedNFTs[tokenId] == msg.sender, "No eres due√±o del NFT staked");
        nftContract.transferFrom(address(this), msg.sender, tokenId);
        delete stakedNFTs[tokenId];
        delete stakingTime[tokenId];
        delete bonusMultiplier[tokenId];
        emit NFTUnstaked(msg.sender, tokenId);
    }
    function calculateVotingPower(uint256 tokenId) public view returns (uint256) {
        if (stakingTime[tokenId] == 0) return 0;
        uint256 stakingDuration = block.timestamp - stakingTime[tokenId];
        return 1 + (stakingDuration / 30 days); // Cada mes en staking aumenta el poder en 1
    }
}
Compilar y Desplegar Contrato
npx hardhat compile
npx hardhat run scripts/deploy.js --network goerli
‚úÖ Guardar la direcci√≥n del contrato para el backend.
üîπ A√±adir archivos al commit:
git add .
git commit -m "feat(nft-staking): agrega smart contract para staking de NFTs de gobernanza"
üìå Commit 73.2: Integrar Staking de NFTs en la UI con Web3.js
üîπ Mensaje de commit:
feat(nft-staking): integra staking de NFTs en DAOs usando Web3.js
üîπ Contenido del commit:
Modificar app/javascript/controllers/nft_staking_controller.js
import { Controller } from "@hotwired/stimulus";
import Web3 from "web3";
export default class extends Controller {
  static targets = ["tokenId"];
  async stakeNFT() {
    if (!window.ethereum) {
      alert("Por favor instala MetaMask");
      return;
    }
    const web3 = new Web3(window.ethereum);
    await window.ethereum.request({ method: "eth_requestAccounts" });
    const tokenId = this.tokenIdTarget.value;
    const contract = new web3.eth.Contract(
      [
        { name: "stakeNFT", type: "function", inputs: [{ name: "tokenId", type: "uint256" }] }
      ],
      "0xYourNFTStakingContractAddress"
    );
    await contract.methods.stakeNFT(tokenId).send({ from: window.ethereum.selectedAddress });
    alert("NFT enviado a staking con √©xito");
  }
}
Modificar app/views/nft_staking/index.html.erb
<h2>Hacer Staking de NFT de Gobernanza</h2>
<label>ID del NFT:</label>
<input type="text" data-nft-staking-target="tokenId">
<button data-controller="nft-staking" data-action="click->nft-staking#stakeNFT">
  Enviar a Staking
</button>
üîπ A√±adir archivos al commit:
git add .
git commit -m "feat(nft-staking): integra staking de NFTs en DAOs usando Web3.js"
üìå Commit 73.3: Integrar Retiro de NFTs del Staking en la UI
üîπ Mensaje de commit:
feat(nft-staking): agrega UI para retirar NFTs del staking en DAOs
üîπ Contenido del commit:
Modificar app/javascript/controllers/nft_unstaking_controller.js
import { Controller } from "@hotwired/stimulus";
import Web3 from "web3";
export default class extends Controller {
  static targets = ["tokenId"];
  async unstakeNFT() {
    if (!window.ethereum) {
      alert("Por favor instala MetaMask");
      return;
    }
    const web3 = new Web3(window.ethereum);
    await window.ethereum.request({ method: "eth_requestAccounts" });
    const tokenId = this.tokenIdTarget.value;
    const contract = new web3.eth.Contract(
      [
        { name: "unstakeNFT", type: "function", inputs: [{ name: "tokenId", type: "uint256" }] }
      ],
      "0xYourNFTStakingContractAddress"
    );
    await contract.methods.unstakeNFT(tokenId).send({ from: window.ethereum.selectedAddress });
    alert("NFT retirado del staking con √©xito");
  }
}
Modificar app/views/nft_staking/unstake.html.erb
<h2>Retirar NFT del Staking</h2>
<label>ID del NFT:</label>
<input type="text" data-nft-unstaking-target="tokenId">
<button data-controller="nft-unstaking" data-action="click->nft-unstaking#unstakeNFT">
  Retirar NFT
</button>
üîπ A√±adir archivos al commit:
git add .
git commit -m "feat(nft-staking): agrega UI para retirar NFTs del staking en DAOs"
üìù Explicaci√≥n y C√≥digo Generado
Ejemplo de Enviar NFT a Staking en API
curl -X POST "http://localhost:3000/nft_staking/stake" \
  -H "Content-Type: application/json" \
  -d '{ "tokenId": 1 }'
‚úÖ El NFT es enviado a staking y empieza a generar bonificaciones de voto.
Ejemplo de Retirar NFT de Staking en API
curl -X POST "http://localhost:3000/nft_staking/unstake" \
  -H "Content-Type: application/json" \
  -d '{ "tokenId": 1 }'
‚úÖ El NFT es retirado del staking y vuelve a la wallet del usuario.
Ejemplo de Consulta de Poder de Voto con Staking
https://voice.aragon.org/#/yourdao.eth
‚úÖ Los usuarios pueden ver su poder de voto incrementado en la DAO.
