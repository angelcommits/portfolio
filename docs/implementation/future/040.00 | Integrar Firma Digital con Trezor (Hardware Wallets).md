# ✅ Paso 40: Integrar Firma Digital con Trezor (Hardware Wallets)

Ahora agregaremos soporte para firma digital con dispositivos físicos como Trezor, permitiendo a los usuarios firmar transacciones con máxima seguridad sin exponer sus claves privadas.
✅ Trezor Connect SDK → Librería oficial para interactuar con dispositivos Trezor.
✅ Firma EIP-712 → Para transacciones seguras sin riesgo de phishing.
✅ Soporte en Web3.js → Integración nativa con MetaMask y dApps.
✅ Autenticación por Hardware → Protección avanzada contra hackeos.
📌 Commit 40.1: Instalar Trezor Connect SDK en el Frontend
🔹 Mensaje de commit:
feat(trezor): instala Trezor Connect SDK para permitir firma digital segura
🔹 Contenido del commit:
Instalar Trezor Connect en app/javascript/packs/trezor.js
import TrezorConnect from "@trezor/connect-web";
TrezorConnect.init({
  manifest: {
    email: "soporte@example.com",
    appUrl: "http://localhost:3000"
  }
});
export default TrezorConnect;
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(trezor): instala Trezor Connect SDK para permitir firma digital segura"
📌 Commit 40.2: Agregar Función para Firmar Contratos con Trezor
🔹 Mensaje de commit:
feat(trezor): agrega función para firmar contratos en la blockchain usando Trezor
🔹 Contenido del commit:
Crear app/javascript/packs/trezor_sign.js
import TrezorConnect from "./trezor";
import Web3 from "web3";
async function signContractWithTrezor(contractHash) {
  const response = await TrezorConnect.ethereumSignMessage({
    path: "m/44'/60'/0'/0/0",
    message: contractHash,
    hex: false
  });
  if (response.success) {
    const signature = response.payload.signature;
    const userAddress = response.payload.address;
    fetch("/contracts/sign_trezor", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ contract_hash: contractHash, user_address: userAddress, signature: signature })
    })
      .then(response => response.json())
      .then(data => alert(`Contrato firmado exitosamente: ${data.transaction_hash}`))
      .catch(error => console.error("Error firmando contrato con Trezor:", error));
  } else {
    alert("Firma fallida: " + response.payload.error);
  }
}
document.addEventListener("DOMContentLoaded", () => {
  document.querySelectorAll(".sign-contract-trezor").forEach(button => {
    button.addEventListener("click", async (event) => {
      const contractHash = event.target.dataset.contractHash;
      signContractWithTrezor(contractHash);
    });
  });
});
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(trezor): agrega función para firmar contratos en la blockchain usando Trezor"
📌 Commit 40.3: Crear Endpoint para Verificar Firma con Trezor
🔹 Mensaje de commit:
feat(trezor): agrega endpoint para firmar contratos con Trezor y verificar autenticidad
🔹 Contenido del commit:
Modificar ContractsController para Integrar Firma con Trezor
class ContractsController < ApplicationController
  def sign_trezor
    contract_hash = params[:contract_hash]
    user_address = params[:user_address]
    signature = params[:signature]
    # Verificar firma con Web3.js
    valid = SmartContractService.verify_trezor_signature(contract_hash, user_address, signature)
    if valid
      tx_hash = SmartContractService.sign_contract(user_address, contract_hash, signature)
      render json: { message: "Contrato firmado en Blockchain con Trezor", transaction_hash: tx_hash }
    else
      render json: { error: "Firma inválida" }, status: :unauthorized
    end
  end
end
Agregar Ruta en config/routes.rb
Rails.application.routes.draw do
  post "/contracts/sign_trezor", to: "contracts#sign_trezor"
end
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(trezor): agrega endpoint para firmar contratos con Trezor y verificar autenticidad"
📌 Commit 40.4: Modificar Servicio de Smart Contracts para Verificar Firmas de Trezor
🔹 Mensaje de commit:
feat(trezor): agrega verificación de firmas con Trezor en el servicio de Smart Contracts
🔹 Contenido del commit:
Modificar SmartContractService en app/services/smart_contract_service.rb
require "web3"
class SmartContractService
  INFURA_URL = Rails.application.credentials.dig(:ethereum, :infura_url)
  CONTRACT_ADDRESS = Rails.application.credentials.dig(:ethereum, :contract_address)
  def self.sign_contract(user_address, contract_hash, signature)
    web3 = Web3::Eth::Rpc.new(host: INFURA_URL, port: 443, connect_options: { use_ssl: true })
    contract_abi = JSON.parse(File.read(Rails.root.join("config/contract_abi.json")))
    contract = web3.eth.contract(abi: contract_abi).at(CONTRACT_ADDRESS)
    tx = contract.transact_and_wait.signContract(contract_hash, from: user_address, gas: 200_000)
    tx.transaction_hash
  end
  def self.verify_trezor_signature(contract_hash, user_address, signature)
    web3 = Web3::Eth::Rpc.new(host: INFURA_URL, port: 443, connect_options: { use_ssl: true })
    recovered_address = web3.eth.personal.ec_recover(contract_hash, signature)
    recovered_address.downcase == user_address.downcase
  end
end
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(trezor): agrega verificación de firmas con Trezor en el servicio de Smart Contracts"
📝 Explicación y Código Generado
Ejemplo de Firma de Contrato con Trezor
    El usuario hace clic en "Firmar Contrato con Trezor".
    Trezor Connect solicita la firma del contrato en el hardware wallet.
    El usuario confirma la firma en su dispositivo.
    El backend verifica la firma y la registra en la blockchain.
Ejemplo de Firma de Contrato en Rails Console
SmartContractService.sign_contract("0xUserWallet", "0xContratoHash", "0xFirmaDigital")
Ejemplo de Verificación de Firma con Trezor
curl -X POST "http://localhost:3000/contracts/sign_trezor" \
  -H "Content-Type: application/json" \
  -d '{ "contract_hash": "0xContratoHash", "user_address": "0xUserWallet", "signature": "0xFirmaDigital" }'
✅ Si la firma es válida:
{ "message": "Contrato firmado en Blockchain con Trezor", "transaction_hash": "0xabc123..." }
❌ Si la firma es inválida:
{ "error": "Firma inválida" }
Ejemplo de Confirmación de Firma en MetaMask
signContractWithTrezor("0xContratoHash");
✅ El usuario firma directamente desde su dispositivo.
