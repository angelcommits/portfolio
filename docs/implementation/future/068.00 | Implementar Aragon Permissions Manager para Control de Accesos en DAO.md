# âœ… Paso 68: Implementar Aragon Permissions Manager para Control de Accesos en DAO

Ahora agregaremos Aragon Permissions Manager, permitiendo que los permisos en la DAO sean administrados dinÃ¡micamente, asegurando que solo ciertos roles puedan proponer y aprobar pagos.
âœ… Aragon Permissions (ACL) â†’ Control granular sobre quiÃ©n puede hacer quÃ© en la DAO.
âœ… Roles DinÃ¡micos en Smart Contract â†’ Los permisos pueden cambiarse sin actualizar el contrato.
âœ… Gnosis Safe + Aragon â†’ GestiÃ³n de permisos multi-firma para seguridad.
âœ… Web3.js + Stimulus.js â†’ Para interacciÃ³n con permisos en frontend.
ðŸ“Œ Commit 68.1: Agregar GestiÃ³n de Permisos en Smart Contract DAO
ðŸ”¹ Mensaje de commit:
feat(aragon-permissions): agrega gestiÃ³n de permisos en la DAO con Aragon ACL
ðŸ”¹ Contenido del commit:
Modificar AragonDAO.sol para Usar ACL en Permisos
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.0;
import "@aragon/os/contracts/apps/AragonApp.sol";
import "@openzeppelin/contracts/token/ERC20/IERC20.sol";
contract AragonDAO is AragonApp {
    IERC20 public token;
    address public treasury;
    bytes32 public constant CREATE_PAYMENT_ROLE = keccak256("CREATE_PAYMENT_ROLE");
    bytes32 public constant APPROVE_PAYMENT_ROLE = keccak256("APPROVE_PAYMENT_ROLE");
    struct Proposal {
        address recipient;
        uint256 amount;
        bool approved;
    }
    mapping(uint256 => Proposal) public proposals;
    uint256 public proposalCount;
    event PaymentProposed(uint256 proposalId, address recipient, uint256 amount);
    event PaymentApproved(uint256 proposalId);
    function initialize(IERC20 _token, address _treasury) public onlyInit {
        initialized();
        token = _token;
        treasury = _treasury;
    }
    function proposePayment(address recipient, uint256 amount) external auth(CREATE_PAYMENT_ROLE) returns (uint256) {
        proposalCount++;
        proposals[proposalCount] = Proposal(recipient, amount, false);
        emit PaymentProposed(proposalCount, recipient, amount);
        return proposalCount;
    }
    function approvePayment(uint256 proposalId) external auth(APPROVE_PAYMENT_ROLE) {
        require(!proposals[proposalId].approved, "Pago ya aprobado");
        proposals[proposalId].approved = true;
        token.transferFrom(treasury, proposals[proposalId].recipient, proposals[proposalId].amount);
        emit PaymentApproved(proposalId);
    }
}
Compilar y Desplegar Contrato
npx hardhat compile
npx hardhat run scripts/deploy.js --network goerli
âœ… Guardar la direcciÃ³n del contrato para el backend.
ðŸ”¹ AÃ±adir archivos al commit:
git add .
git commit -m "feat(aragon-permissions): agrega gestiÃ³n de permisos en la DAO con Aragon ACL"
ðŸ“Œ Commit 68.2: Integrar AdministraciÃ³n de Permisos en Frontend con Web3.js
ðŸ”¹ Mensaje de commit:
feat(aragon-permissions): integra administraciÃ³n de permisos en DAOs usando Web3.js
ðŸ”¹ Contenido del commit:
Modificar app/javascript/controllers/aragon_permissions_controller.js
import { Controller } from "@hotwired/stimulus";
import Web3 from "web3";
export default class extends Controller {
  static targets = ["role", "userAddress"];
  async grantPermission() {
    if (!window.ethereum) {
      alert("Por favor instala MetaMask");
      return;
    }
    const web3 = new Web3(window.ethereum);
    await window.ethereum.request({ method: "eth_requestAccounts" });
    const role = this.roleTarget.value;
    const userAddress = this.userAddressTarget.value;
    const contract = new web3.eth.Contract(
      [
        { name: "grantPermission", type: "function", inputs: [{ name: "role", type: "bytes32" }, { name: "user", type: "address" }] }
      ],
      "0xYourAragonDAOContractAddress"
    );
    await contract.methods.grantPermission(role, userAddress).send({ from: window.ethereum.selectedAddress });
    alert("Permiso otorgado en la DAO");
  }
}
Modificar app/views/aragon_permissions/index.html.erb
<h2>Administrar Permisos en la DAO</h2>
<label>DirecciÃ³n del Usuario:</label>
<input type="text" data-aragon-permissions-target="userAddress">
<label>Rol:</label>
<select data-aragon-permissions-target="role">
  <option value="0x5A8C...">Proponer Pagos</option>
  <option value="0x9D8F...">Aprobar Pagos</option>
</select>
<button data-controller="aragon-permissions" data-action="click->aragon-permissions#grantPermission">
  Otorgar Permiso
</button>
ðŸ”¹ AÃ±adir archivos al commit:
git add .
git commit -m "feat(aragon-permissions): integra administraciÃ³n de permisos en DAOs usando Web3.js"
ðŸ“Œ Commit 68.3: Agregar VerificaciÃ³n de Permisos en Backend
ðŸ”¹ Mensaje de commit:
feat(aragon-permissions): agrega verificaciÃ³n de permisos en backend para gestiÃ³n de DAOs
ðŸ”¹ Contenido del commit:
Modificar AragonPermissionsController en app/controllers/aragon_permissions_controller.rb
class AragonPermissionsController < ApplicationController
  def check_permission
    user = params[:user_address]
    role = params[:role]
    contract = Web3::Contract.new("0xYourAragonDAOContractAddress", abi: [
      { name: "hasPermission", type: "function", inputs: [{ name: "role", type: "bytes32" }, { name: "user", type: "address" }], outputs: [{ type: "bool" }] }
    ])
    has_permission = contract.call("hasPermission", role, user)
    render json: { user: user, role: role, has_permission: has_permission }
  end
end
Agregar Ruta para VerificaciÃ³n de Permisos en config/routes.rb
get "/aragon_permissions/check", to: "aragon_permissions#check_permission"
ðŸ”¹ AÃ±adir archivos al commit:
git add .
git commit -m "feat(aragon-permissions): agrega verificaciÃ³n de permisos en backend para gestiÃ³n de DAOs"
ðŸ“ ExplicaciÃ³n y CÃ³digo Generado
Ejemplo de Otorgar Permiso en DAO en API
curl -X POST "http://localhost:3000/aragon_permissions/grant" \
  -H "Content-Type: application/json" \
  -d '{ "role": "CREATE_PAYMENT_ROLE", "user_address": "0xUserWallet" }'
âœ… Respuesta esperada:
{ "message": "Permiso otorgado en la DAO" }
Ejemplo de Verificar Permiso en DAO en API
curl -X GET "http://localhost:3000/aragon_permissions/check?role=CREATE_PAYMENT_ROLE&user_address=0xUserWallet"
âœ… Si el usuario tiene el permiso:
{ "user": "0xUserWallet", "role": "CREATE_PAYMENT_ROLE", "has_permission": true }
âŒ Si el usuario no tiene el permiso:
{ "user": "0xUserWallet", "role": "CREATE_PAYMENT_ROLE", "has_permission": false }
Ejemplo de GestiÃ³n de Permisos en Aragon Client
https://client.aragon.org/#/yourdao.eth
âœ… Los administradores pueden gestionar roles en la DAO.
