# ✅ Paso 68: Implementar Aragon Permissions Manager para Control de Accesos en DAO

Ahora agregaremos Aragon Permissions Manager, permitiendo que los permisos en la DAO sean administrados dinámicamente, asegurando que solo ciertos roles puedan proponer y aprobar pagos.
✅ Aragon Permissions (ACL) → Control granular sobre quién puede hacer qué en la DAO.
✅ Roles Dinámicos en Smart Contract → Los permisos pueden cambiarse sin actualizar el contrato.
✅ Gnosis Safe + Aragon → Gestión de permisos multi-firma para seguridad.
✅ Web3.js + Stimulus.js → Para interacción con permisos en frontend.
📌 Commit 68.1: Agregar Gestión de Permisos en Smart Contract DAO
🔹 Mensaje de commit:
feat(aragon-permissions): agrega gestión de permisos en la DAO con Aragon ACL
🔹 Contenido del commit:
Modificar AragonDAO.sol para Usar ACL en Permisos
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.0;
import "@aragon/os/contracts/apps/AragonApp.sol";
import "@openzeppelin/contracts/token/ERC20/IERC20.sol";
contract AragonDAO is AragonApp {
    IERC20 public token;
    address public treasury;
    bytes32 public constant CREATE_PAYMENT_ROLE = keccak256("CREATE_PAYMENT_ROLE");
    bytes32 public constant APPROVE_PAYMENT_ROLE = keccak256("APPROVE_PAYMENT_ROLE");
    struct Proposal {
        address recipient;
        uint256 amount;
        bool approved;
    }
    mapping(uint256 => Proposal) public proposals;
    uint256 public proposalCount;
    event PaymentProposed(uint256 proposalId, address recipient, uint256 amount);
    event PaymentApproved(uint256 proposalId);
    function initialize(IERC20 _token, address _treasury) public onlyInit {
        initialized();
        token = _token;
        treasury = _treasury;
    }
    function proposePayment(address recipient, uint256 amount) external auth(CREATE_PAYMENT_ROLE) returns (uint256) {
        proposalCount++;
        proposals[proposalCount] = Proposal(recipient, amount, false);
        emit PaymentProposed(proposalCount, recipient, amount);
        return proposalCount;
    }
    function approvePayment(uint256 proposalId) external auth(APPROVE_PAYMENT_ROLE) {
        require(!proposals[proposalId].approved, "Pago ya aprobado");
        proposals[proposalId].approved = true;
        token.transferFrom(treasury, proposals[proposalId].recipient, proposals[proposalId].amount);
        emit PaymentApproved(proposalId);
    }
}
Compilar y Desplegar Contrato
npx hardhat compile
npx hardhat run scripts/deploy.js --network goerli
✅ Guardar la dirección del contrato para el backend.
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(aragon-permissions): agrega gestión de permisos en la DAO con Aragon ACL"
📌 Commit 68.2: Integrar Administración de Permisos en Frontend con Web3.js
🔹 Mensaje de commit:
feat(aragon-permissions): integra administración de permisos en DAOs usando Web3.js
🔹 Contenido del commit:
Modificar app/javascript/controllers/aragon_permissions_controller.js
import { Controller } from "@hotwired/stimulus";
import Web3 from "web3";
export default class extends Controller {
  static targets = ["role", "userAddress"];
  async grantPermission() {
    if (!window.ethereum) {
      alert("Por favor instala MetaMask");
      return;
    }
    const web3 = new Web3(window.ethereum);
    await window.ethereum.request({ method: "eth_requestAccounts" });
    const role = this.roleTarget.value;
    const userAddress = this.userAddressTarget.value;
    const contract = new web3.eth.Contract(
      [
        { name: "grantPermission", type: "function", inputs: [{ name: "role", type: "bytes32" }, { name: "user", type: "address" }] }
      ],
      "0xYourAragonDAOContractAddress"
    );
    await contract.methods.grantPermission(role, userAddress).send({ from: window.ethereum.selectedAddress });
    alert("Permiso otorgado en la DAO");
  }
}
Modificar app/views/aragon_permissions/index.html.erb
<h2>Administrar Permisos en la DAO</h2>
<label>Dirección del Usuario:</label>
<input type="text" data-aragon-permissions-target="userAddress">
<label>Rol:</label>
<select data-aragon-permissions-target="role">
  <option value="0x5A8C...">Proponer Pagos</option>
  <option value="0x9D8F...">Aprobar Pagos</option>
</select>
<button data-controller="aragon-permissions" data-action="click->aragon-permissions#grantPermission">
  Otorgar Permiso
</button>
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(aragon-permissions): integra administración de permisos en DAOs usando Web3.js"
📌 Commit 68.3: Agregar Verificación de Permisos en Backend
🔹 Mensaje de commit:
feat(aragon-permissions): agrega verificación de permisos en backend para gestión de DAOs
🔹 Contenido del commit:
Modificar AragonPermissionsController en app/controllers/aragon_permissions_controller.rb
class AragonPermissionsController < ApplicationController
  def check_permission
    user = params[:user_address]
    role = params[:role]
    contract = Web3::Contract.new("0xYourAragonDAOContractAddress", abi: [
      { name: "hasPermission", type: "function", inputs: [{ name: "role", type: "bytes32" }, { name: "user", type: "address" }], outputs: [{ type: "bool" }] }
    ])
    has_permission = contract.call("hasPermission", role, user)
    render json: { user: user, role: role, has_permission: has_permission }
  end
end
Agregar Ruta para Verificación de Permisos en config/routes.rb
get "/aragon_permissions/check", to: "aragon_permissions#check_permission"
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(aragon-permissions): agrega verificación de permisos en backend para gestión de DAOs"
📝 Explicación y Código Generado
Ejemplo de Otorgar Permiso en DAO en API
curl -X POST "http://localhost:3000/aragon_permissions/grant" \
  -H "Content-Type: application/json" \
  -d '{ "role": "CREATE_PAYMENT_ROLE", "user_address": "0xUserWallet" }'
✅ Respuesta esperada:
{ "message": "Permiso otorgado en la DAO" }
Ejemplo de Verificar Permiso en DAO en API
curl -X GET "http://localhost:3000/aragon_permissions/check?role=CREATE_PAYMENT_ROLE&user_address=0xUserWallet"
✅ Si el usuario tiene el permiso:
{ "user": "0xUserWallet", "role": "CREATE_PAYMENT_ROLE", "has_permission": true }
❌ Si el usuario no tiene el permiso:
{ "user": "0xUserWallet", "role": "CREATE_PAYMENT_ROLE", "has_permission": false }
Ejemplo de Gestión de Permisos en Aragon Client
https://client.aragon.org/#/yourdao.eth
✅ Los administradores pueden gestionar roles en la DAO.
