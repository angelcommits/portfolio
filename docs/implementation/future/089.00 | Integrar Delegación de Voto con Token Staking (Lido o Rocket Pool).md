# ‚úÖ Paso 89: Integrar Delegaci√≥n de Voto con Token Staking (Lido o Rocket Pool)

Ahora agregaremos staking de tokens en la DAO, permitiendo que los usuarios deleguen su poder de voto a otros miembros a cambio de recompensas en GOVR.
‚úÖ Delegaci√≥n de Voto On-Chain ‚Üí Los holders pueden delegar su poder de voto a otros miembros.
‚úÖ Recompensas por Staking ‚Üí Se generan incentivos para quienes mantienen sus tokens bloqueados.
‚úÖ Integraci√≥n con Lido o Rocket Pool ‚Üí Para aprovechar staking l√≠quido y recompensas autom√°ticas.
‚úÖ Web3.js + Stimulus.js ‚Üí Para gestionar el staking y la delegaci√≥n desde la UI.
‚úÖ Smart Contract en Solidity ‚Üí Para manejar la l√≥gica de staking y delegaci√≥n.
üìå Commit 89.1: Crear Smart Contract de Staking y Delegaci√≥n de Voto
üîπ Mensaje de commit:
feat(staking-delegation): agrega smart contract para staking y delegaci√≥n de voto en la DAO
üîπ Contenido del commit:
Definir StakingDelegation.sol en contracts/StakingDelegation.sol
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.0;
import "@openzeppelin/contracts/token/ERC20/IERC20.sol";
import "@openzeppelin/contracts/governance/IVotes.sol";
import "@openzeppelin/contracts/access/Ownable.sol";
contract StakingDelegation is Ownable {
    IVotes public govrToken;
    IERC20 public stakedGovr;
    uint256 public stakingRewardRate = 10; // 10% de APR
    struct Stake {
        uint256 amount;
        uint256 startTime;
    }
    mapping(address => Stake) public stakes;
    event Staked(address indexed user, uint256 amount);
    event Unstaked(address indexed user, uint256 amount);
    event Delegated(address indexed user, address indexed delegatee);
    constructor(IVotes _govrToken, IERC20 _stakedGovr) {
        govrToken = _govrToken;
        stakedGovr = _stakedGovr;
    }
    function stake(uint256 amount) external {
        require(amount > 0, "Debes depositar tokens");
        govrToken.transferFrom(msg.sender, address(this), amount);
        stakes[msg.sender] = Stake(amount, block.timestamp);
        stakedGovr.mint(msg.sender, amount);
        emit Staked(msg.sender, amount);
    }
    function unstake() external {
        Stake memory userStake = stakes[msg.sender];
        require(userStake.amount > 0, "No tienes tokens en staking");
        uint256 reward = ((block.timestamp - userStake.startTime) * stakingRewardRate * userStake.amount) / 31536000; // APR proporcional al tiempo
        govrToken.transfer(msg.sender, userStake.amount + reward);
        stakedGovr.burn(msg.sender, userStake.amount);
        delete stakes[msg.sender];
        emit Unstaked(msg.sender, userStake.amount);
    }
    function delegateVote(address delegatee) external {
        govrToken.delegate(delegatee);
        emit Delegated(msg.sender, delegatee);
    }
}
Compilar y Desplegar Contrato
npx hardhat compile
npx hardhat run scripts/deploy.js --network goerli
‚úÖ Guardar la direcci√≥n del contrato para integraci√≥n en la UI.
üîπ A√±adir archivos al commit:
git add .
git commit -m "feat(staking-delegation): agrega smart contract para staking y delegaci√≥n de voto en la DAO"
üìå Commit 89.2: Integrar UI para Staking y Delegaci√≥n de Voto
üîπ Mensaje de commit:
feat(staking-delegation): agrega UI para staking y delegaci√≥n de voto en la DAO
üîπ Contenido del commit:
Modificar app/javascript/controllers/staking_controller.js
import { Controller } from "@hotwired/stimulus";
import Web3 from "web3";
export default class extends Controller {
  static targets = ["amount", "delegatee"];
  async stakeTokens() {
    if (!window.ethereum) {
      alert("Por favor instala MetaMask");
      return;
    }
    const web3 = new Web3(window.ethereum);
    await window.ethereum.request({ method: "eth_requestAccounts" });
    const amount = Web3.utils.toWei(this.amountTarget.value, "ether");
    const contract = new web3.eth.Contract(
      [{ name: "stake", type: "function", inputs: [{ name: "amount", type: "uint256" }] }],
      "0xYourStakingDelegationContractAddress"
    );
    await contract.methods.stake(amount).send({ from: window.ethereum.selectedAddress });
    alert("Tokens en staking con √©xito");
  }
  async delegateVote() {
    if (!window.ethereum) {
      alert("Por favor instala MetaMask");
      return;
    }
    const web3 = new Web3(window.ethereum);
    await window.ethereum.request({ method: "eth_requestAccounts" });
    const delegatee = this.delegateeTarget.value;
    const contract = new web3.eth.Contract(
      [{ name: "delegateVote", type: "function", inputs: [{ name: "delegatee", type: "address" }] }],
      "0xYourStakingDelegationContractAddress"
    );
    await contract.methods.delegateVote(delegatee).send({ from: window.ethereum.selectedAddress });
    alert("Voto delegado con √©xito");
  }
}
Modificar app/views/staking/index.html.erb
<h2>Staking y Delegaci√≥n de Voto</h2>
<label>Monto en GOVR:</label>
<input type="text" data-staking-target="amount">
<button data-controller="staking" data-action="click->staking#stakeTokens">
  Depositar en Staking
</button>
<br><br>
<label>Delegar Voto a:</label>
<input type="text" data-staking-target="delegatee">
<button data-controller="staking" data-action="click->staking#delegateVote">
  Delegar Voto
</button>
üîπ A√±adir archivos al commit:
git add .
git commit -m "feat(staking-delegation): agrega UI para staking y delegaci√≥n de voto en la DAO"
üìù Explicaci√≥n y C√≥digo Generado
Ejemplo de Depositar Tokens en Staking en API
curl -X POST "http://localhost:3000/staking/deposit" \
  -H "Content-Type: application/json" \
  -d '{ "amount": 1000 }'
‚úÖ El usuario deposita 1000 GOVR en staking.
Ejemplo de Delegaci√≥n de Voto en API
curl -X POST "http://localhost:3000/staking/delegate" \
  -H "Content-Type: application/json" \
  -d '{ "delegatee": "0xDelegateWallet" }'
‚úÖ El usuario delega su poder de voto a otro miembro.
Ejemplo de Retiro de Staking en API
curl -X POST "http://localhost:3000/staking/withdraw"
‚úÖ El usuario recupera sus tokens junto con recompensas por staking.
Ejemplo de Panel de Staking en Web
https://app.lido.fi/
https://rocketpool.net/
‚úÖ Los usuarios pueden ver sus posiciones en staking en plataformas descentralizadas.
