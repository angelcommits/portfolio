# ✅ Paso 51: Agregar Verificación de Identidad con Web3 ID (Ethereum Sign-In)

Ahora agregaremos verificación de identidad con Web3 ID (Ethereum Sign-In), permitiendo que los usuarios se autentiquen firmando un mensaje en la Blockchain en lugar de usar contraseñas.
✅ Sign-In with Ethereum (SIWE) → Permite autenticación segura sin contraseñas.
✅ EIP-4361 → Estándar de autenticación con firma digital.
✅ Web3.js + Stimulus.js → Para manejar la autenticación en la UI.
✅ Devise Custom Strategy → Para integrar la autenticación con Rails.
📌 Commit 51.1: Instalar la Librería SIWE para Web3 ID
🔹 Mensaje de commit:
feat(web3id): instala sign-in with Ethereum (SIWE) para autenticación con Web3 ID
🔹 Contenido del commit:
Instalar la gema ethereum.rb para manejar firmas
bundle add ethereum.rb
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(web3id): instala sign-in with Ethereum (SIWE) para autenticación con Web3 ID"
📌 Commit 51.2: Agregar Estrategia de Autenticación con Web3 en Devise
🔹 Mensaje de commit:
feat(web3id): agrega estrategia de autenticación Web3 en Devise usando SIWE
🔹 Contenido del commit:
Modificar config/initializers/devise.rb para Añadir Web3 Strategy
require "ethereum"
Warden::Strategies.add(:web3_auth) do
  def valid?
    params["wallet_address"].present? && params["signature"].present?
  end
  def authenticate!
    wallet_address = params["wallet_address"]
    signature = params["signature"]
    nonce = session[:web3_nonce]
    # Validar firma con Ethereum
    message = "Bienvenido a nuestra plataforma. Nonce: #{nonce}"
    signer_address = Ethereum::Message.verify_signature(message, signature)
    if signer_address.downcase == wallet_address.downcase
      user = User.find_or_create_by(wallet_address: wallet_address)
      success!(user)
    else
      fail!("Firma inválida")
    end
  end
end
Devise.setup do |config|
  config.warden do |manager|
    manager.default_strategies(scope: :user).unshift :web3_auth
  end
end
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(web3id): agrega estrategia de autenticación Web3 en Devise usando SIWE"
📌 Commit 51.3: Agregar Endpoint para Generar Nonce para Firma
🔹 Mensaje de commit:
feat(web3id): agrega endpoint para generar nonce de autenticación Web3
🔹 Contenido del commit:
Modificar SessionsController para Manejar Web3 ID
class SessionsController < Devise::SessionsController
  def web3_nonce
    nonce = SecureRandom.hex(16)
    session[:web3_nonce] = nonce
    render json: { nonce: nonce }
  end
  def web3_sign_in
    self.resource = warden.authenticate!(scope: resource_name)
    sign_in(resource_name, resource)
    render json: { message: "Autenticación exitosa", user: current_user }
  end
end
Agregar Rutas en config/routes.rb
Rails.application.routes.draw do
  devise_scope :user do
    get "/users/web3_nonce", to: "sessions#web3_nonce"
    post "/users/web3_sign_in", to: "sessions#web3_sign_in"
  end
end
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(web3id): agrega endpoint para generar nonce de autenticación Web3"
📌 Commit 51.4: Agregar Frontend con Web3.js y Stimulus para Autenticación
🔹 Mensaje de commit:
feat(web3id): integra Web3.js y Stimulus para autenticación con Ethereum
🔹 Contenido del commit:
Crear app/javascript/controllers/web3_auth_controller.js
import { Controller } from "@hotwired/stimulus";
import Web3 from "web3";
export default class extends Controller {
  async connectWallet() {
    if (window.ethereum) {
      const web3 = new Web3(window.ethereum);
      await window.ethereum.request({ method: "eth_requestAccounts" });
      this.walletAddress = (await web3.eth.getAccounts())[0];
      const nonceResponse = await fetch("/users/web3_nonce");
      const { nonce } = await nonceResponse.json();
      const signature = await web3.eth.personal.sign(nonce, this.walletAddress);
      const loginResponse = await fetch("/users/web3_sign_in", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ wallet_address: this.walletAddress, signature })
      });
      if (loginResponse.ok) {
        alert("Autenticación exitosa");
        window.location.reload();
      } else {
        alert("Error al autenticar");
      }
    } else {
      alert("MetaMask no está instalado");
    }
  }
}
Modificar app/views/devise/sessions/new.html.erb
<h2>Iniciar sesión con Web3</h2>
<button data-controller="web3-auth" data-action="click->web3-auth#connectWallet">
  Conectar con MetaMask
</button>
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(web3id): integra Web3.js y Stimulus para autenticación con Ethereum"
📝 Explicación y Código Generado
Ejemplo de Autenticación con Web3 en Rails Console
warden.authenticate!(scope: :user, params: { wallet_address: "0xUserWallet", signature: "0xFirma" })
✅ Autentica al usuario con su billetera Web3 sin contraseña.
Ejemplo de Generación de Nonce en API
curl -X GET "http://localhost:3000/users/web3_nonce"
✅ Respuesta esperada:
{ "nonce": "a1b2c3d4e5f6g7h8" }
Ejemplo de Inicio de Sesión con Firma Digital
curl -X POST "http://localhost:3000/users/web3_sign_in" \
  -H "Content-Type: application/json" \
  -d '{ "wallet_address": "0xUserWallet", "signature": "0xFirma" }'
✅ Si la firma es válida:
{ "message": "Autenticación exitosa", "user": { "id": 1, "wallet_address": "0xUserWallet" } }
❌ Si la firma es inválida:
{ "error": "Firma inválida" }
Ejemplo de Inicio de Sesión con MetaMask
document.querySelector("button").click();
✅ El usuario firma un mensaje y se autentica sin contraseña.
