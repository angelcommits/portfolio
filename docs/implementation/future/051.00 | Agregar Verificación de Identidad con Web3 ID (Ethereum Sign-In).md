# âœ… Paso 51: Agregar VerificaciÃ³n de Identidad con Web3 ID (Ethereum Sign-In)

Ahora agregaremos verificaciÃ³n de identidad con Web3 ID (Ethereum Sign-In), permitiendo que los usuarios se autentiquen firmando un mensaje en la Blockchain en lugar de usar contraseÃ±as.
âœ… Sign-In with Ethereum (SIWE) â†’ Permite autenticaciÃ³n segura sin contraseÃ±as.
âœ… EIP-4361 â†’ EstÃ¡ndar de autenticaciÃ³n con firma digital.
âœ… Web3.js + Stimulus.js â†’ Para manejar la autenticaciÃ³n en la UI.
âœ… Devise Custom Strategy â†’ Para integrar la autenticaciÃ³n con Rails.
ğŸ“Œ Commit 51.1: Instalar la LibrerÃ­a SIWE para Web3 ID
ğŸ”¹ Mensaje de commit:
feat(web3id): instala sign-in with Ethereum (SIWE) para autenticaciÃ³n con Web3 ID
ğŸ”¹ Contenido del commit:
Instalar la gema ethereum.rb para manejar firmas
bundle add ethereum.rb
ğŸ”¹ AÃ±adir archivos al commit:
git add .
git commit -m "feat(web3id): instala sign-in with Ethereum (SIWE) para autenticaciÃ³n con Web3 ID"
ğŸ“Œ Commit 51.2: Agregar Estrategia de AutenticaciÃ³n con Web3 en Devise
ğŸ”¹ Mensaje de commit:
feat(web3id): agrega estrategia de autenticaciÃ³n Web3 en Devise usando SIWE
ğŸ”¹ Contenido del commit:
Modificar config/initializers/devise.rb para AÃ±adir Web3 Strategy
require "ethereum"
Warden::Strategies.add(:web3_auth) do
  def valid?
    params["wallet_address"].present? && params["signature"].present?
  end
  def authenticate!
    wallet_address = params["wallet_address"]
    signature = params["signature"]
    nonce = session[:web3_nonce]
    # Validar firma con Ethereum
    message = "Bienvenido a nuestra plataforma. Nonce: #{nonce}"
    signer_address = Ethereum::Message.verify_signature(message, signature)
    if signer_address.downcase == wallet_address.downcase
      user = User.find_or_create_by(wallet_address: wallet_address)
      success!(user)
    else
      fail!("Firma invÃ¡lida")
    end
  end
end
Devise.setup do |config|
  config.warden do |manager|
    manager.default_strategies(scope: :user).unshift :web3_auth
  end
end
ğŸ”¹ AÃ±adir archivos al commit:
git add .
git commit -m "feat(web3id): agrega estrategia de autenticaciÃ³n Web3 en Devise usando SIWE"
ğŸ“Œ Commit 51.3: Agregar Endpoint para Generar Nonce para Firma
ğŸ”¹ Mensaje de commit:
feat(web3id): agrega endpoint para generar nonce de autenticaciÃ³n Web3
ğŸ”¹ Contenido del commit:
Modificar SessionsController para Manejar Web3 ID
class SessionsController < Devise::SessionsController
  def web3_nonce
    nonce = SecureRandom.hex(16)
    session[:web3_nonce] = nonce
    render json: { nonce: nonce }
  end
  def web3_sign_in
    self.resource = warden.authenticate!(scope: resource_name)
    sign_in(resource_name, resource)
    render json: { message: "AutenticaciÃ³n exitosa", user: current_user }
  end
end
Agregar Rutas en config/routes.rb
Rails.application.routes.draw do
  devise_scope :user do
    get "/users/web3_nonce", to: "sessions#web3_nonce"
    post "/users/web3_sign_in", to: "sessions#web3_sign_in"
  end
end
ğŸ”¹ AÃ±adir archivos al commit:
git add .
git commit -m "feat(web3id): agrega endpoint para generar nonce de autenticaciÃ³n Web3"
ğŸ“Œ Commit 51.4: Agregar Frontend con Web3.js y Stimulus para AutenticaciÃ³n
ğŸ”¹ Mensaje de commit:
feat(web3id): integra Web3.js y Stimulus para autenticaciÃ³n con Ethereum
ğŸ”¹ Contenido del commit:
Crear app/javascript/controllers/web3_auth_controller.js
import { Controller } from "@hotwired/stimulus";
import Web3 from "web3";
export default class extends Controller {
  async connectWallet() {
    if (window.ethereum) {
      const web3 = new Web3(window.ethereum);
      await window.ethereum.request({ method: "eth_requestAccounts" });
      this.walletAddress = (await web3.eth.getAccounts())[0];
      const nonceResponse = await fetch("/users/web3_nonce");
      const { nonce } = await nonceResponse.json();
      const signature = await web3.eth.personal.sign(nonce, this.walletAddress);
      const loginResponse = await fetch("/users/web3_sign_in", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ wallet_address: this.walletAddress, signature })
      });
      if (loginResponse.ok) {
        alert("AutenticaciÃ³n exitosa");
        window.location.reload();
      } else {
        alert("Error al autenticar");
      }
    } else {
      alert("MetaMask no estÃ¡ instalado");
    }
  }
}
Modificar app/views/devise/sessions/new.html.erb
<h2>Iniciar sesiÃ³n con Web3</h2>
<button data-controller="web3-auth" data-action="click->web3-auth#connectWallet">
  Conectar con MetaMask
</button>
ğŸ”¹ AÃ±adir archivos al commit:
git add .
git commit -m "feat(web3id): integra Web3.js y Stimulus para autenticaciÃ³n con Ethereum"
ğŸ“ ExplicaciÃ³n y CÃ³digo Generado
Ejemplo de AutenticaciÃ³n con Web3 en Rails Console
warden.authenticate!(scope: :user, params: { wallet_address: "0xUserWallet", signature: "0xFirma" })
âœ… Autentica al usuario con su billetera Web3 sin contraseÃ±a.
Ejemplo de GeneraciÃ³n de Nonce en API
curl -X GET "http://localhost:3000/users/web3_nonce"
âœ… Respuesta esperada:
{ "nonce": "a1b2c3d4e5f6g7h8" }
Ejemplo de Inicio de SesiÃ³n con Firma Digital
curl -X POST "http://localhost:3000/users/web3_sign_in" \
  -H "Content-Type: application/json" \
  -d '{ "wallet_address": "0xUserWallet", "signature": "0xFirma" }'
âœ… Si la firma es vÃ¡lida:
{ "message": "AutenticaciÃ³n exitosa", "user": { "id": 1, "wallet_address": "0xUserWallet" } }
âŒ Si la firma es invÃ¡lida:
{ "error": "Firma invÃ¡lida" }
Ejemplo de Inicio de SesiÃ³n con MetaMask
document.querySelector("button").click();
âœ… El usuario firma un mensaje y se autentica sin contraseÃ±a.
