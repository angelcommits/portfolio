# ‚úÖ Paso 84: Integrar Mecanismo de Pago Autom√°tico en la DAO (Streaming con Superfluid)

Ahora agregaremos Superfluid, permitiendo que la DAO realice pagos autom√°ticos a colaboradores en tiempo real mediante streaming de tokens.
‚úÖ Pagos Continuos en GOVR ‚Üí Los colaboradores reciben pagos en tiempo real.
‚úÖ Superfluid Super Tokens ‚Üí Se usa la tecnolog√≠a de streaming sin transacciones recurrentes.
‚úÖ Web3.js + Stimulus.js ‚Üí Para gestionar y visualizar pagos desde la UI.
‚úÖ Contrato de Superfluid ‚Üí Se configura en Solidity para administrar flujos de pago.
üìå Commit 84.1: Crear Contrato de Pago Autom√°tico con Superfluid
üîπ Mensaje de commit:
feat(superfluid-payments): agrega smart contract para pagos autom√°ticos en la DAO con Superfluid
üîπ Contenido del commit:
Definir SuperfluidPayments.sol en contracts/SuperfluidPayments.sol
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.0;
import "@superfluid-finance/ethereum-contracts/contracts/interfaces/superfluid/ISuperfluid.sol";
import "@superfluid-finance/ethereum-contracts/contracts/interfaces/agreements/IConstantFlowAgreementV1.sol";
import "@openzeppelin/contracts/access/Ownable.sol";
contract SuperfluidPayments is Ownable {
    ISuperfluid private superfluid;
    IConstantFlowAgreementV1 private cfa;
    ISuperToken private govrToken;
    mapping(address => bool) public activePayments;
    event PaymentStarted(address indexed recipient, int96 flowRate);
    event PaymentStopped(address indexed recipient);
    constructor(ISuperfluid _superfluid, IConstantFlowAgreementV1 _cfa, ISuperToken _govrToken) {
        superfluid = _superfluid;
        cfa = _cfa;
        govrToken = _govrToken;
    }
    function startPayment(address recipient, int96 flowRate) external onlyOwner {
        require(!activePayments[recipient], "El pago ya est√° activo");
        bytes memory callData = abi.encodeWithSelector(
            cfa.createFlow.selector,
            govrToken,
            recipient,
            flowRate,
            new bytes(0)
        );
        superfluid.callAgreement(address(cfa), callData, "0x");
        activePayments[recipient] = true;
        emit PaymentStarted(recipient, flowRate);
    }
    function stopPayment(address recipient) external onlyOwner {
        require(activePayments[recipient], "No hay pagos activos para este usuario");
        bytes memory callData = abi.encodeWithSelector(
            cfa.deleteFlow.selector,
            govrToken,
            recipient,
            address(this),
            new bytes(0)
        );
        superfluid.callAgreement(address(cfa), callData, "0x");
        activePayments[recipient] = false;
        emit PaymentStopped(recipient);
    }
}
Compilar y Desplegar Contrato
npx hardhat compile
npx hardhat run scripts/deploy.js --network goerli
‚úÖ Guardar la direcci√≥n del contrato para la integraci√≥n con la UI.
üîπ A√±adir archivos al commit:
git add .
git commit -m "feat(superfluid-payments): agrega smart contract para pagos autom√°ticos en la DAO con Superfluid"
üìå Commit 84.2: Integrar UI para Iniciar y Detener Pagos Autom√°ticos
üîπ Mensaje de commit:
feat(superfluid-payments): integra UI para iniciar y detener pagos autom√°ticos en la DAO
üîπ Contenido del commit:
Modificar app/javascript/controllers/superfluid_payments_controller.js
import { Controller } from "@hotwired/stimulus";
import Web3 from "web3";
export default class extends Controller {
  static targets = ["recipient", "flowRate"];
  async startPayment() {
    if (!window.ethereum) {
      alert("Por favor instala MetaMask");
      return;
    }
    const web3 = new Web3(window.ethereum);
    await window.ethereum.request({ method: "eth_requestAccounts" });
    const recipient = this.recipientTarget.value;
    const flowRate = this.flowRateTarget.value;
    const contract = new web3.eth.Contract(
      [
        { name: "startPayment", type: "function", inputs: [{ name: "recipient", type: "address" }, { name: "flowRate", type: "int96" }] }
      ],
      "0xYourSuperfluidPaymentsContractAddress"
    );
    await contract.methods.startPayment(recipient, flowRate).send({ from: window.ethereum.selectedAddress });
    alert("Pago autom√°tico iniciado");
  }
  async stopPayment() {
    if (!window.ethereum) {
      alert("Por favor instala MetaMask");
      return;
    }
    const web3 = new Web3(window.ethereum);
    await window.ethereum.request({ method: "eth_requestAccounts" });
    const recipient = this.recipientTarget.value;
    const contract = new web3.eth.Contract(
      [{ name: "stopPayment", type: "function", inputs: [{ name: "recipient", type: "address" }] }],
      "0xYourSuperfluidPaymentsContractAddress"
    );
    await contract.methods.stopPayment(recipient).send({ from: window.ethereum.selectedAddress });
    alert("Pago autom√°tico detenido");
  }
}
Modificar app/views/superfluid_payments/index.html.erb
<h2>Gesti√≥n de Pagos Autom√°ticos</h2>
<label>Direcci√≥n del Destinatario:</label>
<input type="text" data-superfluid-payments-target="recipient">
<label>Flujo de Pago (tokens por segundo):</label>
<input type="text" data-superfluid-payments-target="flowRate">
<button data-controller="superfluid-payments" data-action="click->superfluid-payments#startPayment">
  Iniciar Pago
</button>
<button data-controller="superfluid-payments" data-action="click->superfluid-payments#stopPayment">
  Detener Pago
</button>
üîπ A√±adir archivos al commit:
git add .
git commit -m "feat(superfluid-payments): integra UI para iniciar y detener pagos autom√°ticos en la DAO"
üìù Explicaci√≥n y C√≥digo Generado
Ejemplo de Iniciar Pago Autom√°tico en API
curl -X POST "http://localhost:3000/superfluid_payments/start" \
  -H "Content-Type: application/json" \
  -d '{ "recipient": "0xUserWallet", "flowRate": "1000000000000000" }'
‚úÖ El usuario comienza a recibir pagos en GOVR en tiempo real.
Ejemplo de Detener Pago Autom√°tico en API
curl -X POST "http://localhost:3000/superfluid_payments/stop" \
  -H "Content-Type: application/json" \
  -d '{ "recipient": "0xUserWallet" }'
‚úÖ El pago autom√°tico es detenido.
Ejemplo de Ver Balance en Superfluid
https://app.superfluid.finance/dashboard
‚úÖ El usuario puede ver los pagos en GOVR en su dashboard.
