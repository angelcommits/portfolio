# âœ… Paso 55: Reemplazar Devise por Rodauth con SQLite en desarrollo y PostgreSQL en producciÃ³n

Ahora reemplazaremos Devise por Rodauth, manteniendo la compatibilidad con Web3 Sign-In, Passkeys (WebAuthn) y Social Login (Google, Twitter, Discord).
âœ… Rodauth (AutenticaciÃ³n sobre Sequel) â†’ MÃ¡s flexible y seguro que Devise.
âœ… SQLite en desarrollo y test, PostgreSQL en staging y producciÃ³n â†’ OptimizaciÃ³n segÃºn entorno.
âœ… IntegraciÃ³n con Web3 ID (Ethereum Sign-In) â†’ Compatible con Gnosis Safe y Argent.
âœ… Compatibilidad con Passkeys (WebAuthn) y Social Login â†’ MÃ©todos alternativos de autenticaciÃ³n.
âœ… Turbo Streams + Stimulus.js â†’ Para una experiencia de usuario fluida.
ðŸ“Œ Commit 55.1: Instalar Rodauth y Configurar Base de Datos con Sequel
ðŸ”¹ Mensaje de commit:
feat(auth): instala Rodauth y configura Sequel con SQLite en desarrollo y PostgreSQL en producciÃ³n
ðŸ”¹ Contenido del commit:
Instalar Rodauth y Sequel
bundle add roda rodauth-sequel sequel sqlite3 pg
Configurar Base de Datos en config/database.yml
default: &default
  adapter: <%= ENV.fetch("DB_ADAPTER") { "sqlite3" } %>
  encoding: utf8
  pool: 5
  timeout: 5000
development:
  <<: *default
  database: db/development.sqlite3
test:
  <<: *default
  database: db/test.sqlite3
staging:
  <<: *default
  adapter: postgresql
  database: myapp_staging
  username: myapp
  password: <%= ENV['DATABASE_PASSWORD'] %>
production:
  <<: *default
  adapter: postgresql
  database: myapp_production
  username: myapp
  password: <%= ENV['DATABASE_PASSWORD'] %>
ðŸ”¹ AÃ±adir archivos al commit:
git add .
git commit -m "feat(auth): instala Rodauth y configura Sequel con SQLite en desarrollo y PostgreSQL en producciÃ³n"
ðŸ“Œ Commit 55.2: Configurar Rodauth en Rails
ðŸ”¹ Mensaje de commit:
feat(auth): configura Rodauth como sistema de autenticaciÃ³n principal en Rails
ðŸ”¹ Contenido del commit:
Generar ConfiguraciÃ³n de Rodauth
rails generate rodauth:install
Modificar config/initializers/rodauth.rb
require "roda"
require "rodauth"
require "sequel"
DB = Sequel.connect(ENV.fetch("DATABASE_URL") { "sqlite://db/development.sqlite3" })
class RodauthMain < Rodauth::Auth
  configure do
    enable :login, :logout, :create_account, :reset_password
    account_password_hash_column :password_digest
    login_column :wallet_address # Usaremos la wallet como identificador en Web3
  end
end
ðŸ”¹ AÃ±adir archivos al commit:
git add .
git commit -m "feat(auth): configura Rodauth como sistema de autenticaciÃ³n principal en Rails"
ðŸ“Œ Commit 55.3: Crear Migraciones para Rodauth
ðŸ”¹ Mensaje de commit:
feat(auth): agrega migraciones de Rodauth para manejo de usuarios
ðŸ”¹ Contenido del commit:
Generar Migraciones
rails generate rodauth:migration
rails db:migrate
ðŸ”¹ AÃ±adir archivos al commit:
git add .
git commit -m "feat(auth): agrega migraciones de Rodauth para manejo de usuarios"
ðŸ“Œ Commit 55.4: Integrar Web3 Sign-In en Rodauth
ðŸ”¹ Mensaje de commit:
feat(web3id): integra Web3 Sign-In con Rodauth para autenticaciÃ³n con Ethereum
ðŸ”¹ Contenido del commit:
Modificar config/initializers/rodauth.rb para Soporte Web3
RodauthMain.configure do
  enable :login, :logout, :create_account, :reset_password
  login_column :wallet_address
  require_bcrypt
  # AutenticaciÃ³n con Web3 (Ethereum Sign-In)
  login_methods do
    def authenticate_login
      wallet = param("wallet_address")
      signature = param("signature")
      nonce = session[:web3_nonce]
      return unless account = account_ds.where(wallet_address: wallet).first
      return unless Ethereum::Message.verify_signature("Nonce: #{nonce}", signature) == wallet
      session[:account_id] = account[:id]
    end
  end
end
ðŸ”¹ AÃ±adir archivos al commit:
git add .
git commit -m "feat(web3id): integra Web3 Sign-In con Rodauth para autenticaciÃ³n con Ethereum"
ðŸ“Œ Commit 55.5: Modificar UI para Usar Rodauth en Lugar de Devise
ðŸ”¹ Mensaje de commit:
feat(auth): actualiza la UI para autenticaciÃ³n con Rodauth en lugar de Devise
ðŸ”¹ Contenido del commit:
Modificar app/views/sessions/new.html.erb
<h2>Iniciar sesiÃ³n con Web3</h2>
<form action="/login" method="post">
  <input type="text" name="wallet_address" placeholder="DirecciÃ³n de Wallet" required>
  <input type="hidden" name="signature" id="signature">
  <button type="submit" onclick="signMessage()">Iniciar sesiÃ³n</button>
</form>
<script>
  async function signMessage() {
    if (window.ethereum) {
      const accounts = await ethereum.request({ method: "eth_requestAccounts" });
      const wallet = accounts[0];
      const nonceResponse = await fetch("/web3_nonce");
      const { nonce } = await nonceResponse.json();
      const signature = await ethereum.request({
        method: "personal_sign",
        params: [nonce, wallet]
      });
      document.getElementById("signature").value = signature;
    } else {
      alert("Por favor instala MetaMask");
    }
  }
</script>
ðŸ”¹ AÃ±adir archivos al commit:
git add .
git commit -m "feat(auth): actualiza la UI para autenticaciÃ³n con Rodauth en lugar de Devise"
ðŸ“Œ Commit 55.6: Eliminar Devise y Limpiar CÃ³digo
ðŸ”¹ Mensaje de commit:
chore(auth): elimina Devise y limpia cÃ³digo no utilizado
ðŸ”¹ Contenido del commit:
Eliminar Devise del Gemfile
bundle remove devise
Eliminar Rutas de Devise en config/routes.rb
Rails.application.routes.draw do
  rodauth_routes
end
Eliminar Controladores de Devise
rm -rf app/controllers/devise
ðŸ”¹ AÃ±adir archivos al commit:
git add .
git commit -m "chore(auth): elimina Devise y limpia cÃ³digo no utilizado"
