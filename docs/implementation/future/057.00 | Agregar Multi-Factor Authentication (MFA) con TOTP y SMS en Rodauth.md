# ✅ Paso 57: Agregar Multi-Factor Authentication (MFA) con TOTP y SMS en Rodauth

Ahora agregaremos MFA con TOTP (Google Authenticator) y SMS, permitiendo doble factor de autenticación (2FA) para mejorar la seguridad.
✅ Rodauth MFA (Multi-Factor Authentication) → Seguridad adicional con OTP/SMS.
✅ TOTP (Google Authenticator, Authy) → Códigos temporales basados en tiempo.
✅ Twilio SMS API → Para enviar códigos de verificación por SMS.
✅ Turbo Streams + Stimulus.js → Para UX fluida sin recargas.
📌 Commit 57.1: Configurar MFA en Rodauth
🔹 Mensaje de commit:
feat(mfa): agrega configuración de Multi-Factor Authentication (TOTP + SMS) en Rodauth
🔹 Contenido del commit:
Modificar config/initializers/rodauth.rb
RodauthMain.configure do
  enable :two_factor_base, :otp, :sms_codes
  # Configurar OTP con Google Authenticator
  otp_drift 30
  otp_digits 6
  otp_label "My Web3 App"
  otp_issuer "Web3 App"
  # Configurar SMS con Twilio
  sms_send do |phone, message|
    TwilioSmsService.send_sms(phone, message)
  end
end
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(mfa): agrega configuración de Multi-Factor Authentication (TOTP + SMS) en Rodauth"
📌 Commit 57.2: Crear Migraciones para MFA en Rodauth
🔹 Mensaje de commit:
feat(mfa): agrega migraciones para almacenar datos de MFA en Rodauth
🔹 Contenido del commit:
Generar Migraciones
rails generate rodauth:migration otp sms_codes
rails db:migrate
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(mfa): agrega migraciones para almacenar datos de MFA en Rodauth"
📌 Commit 57.3: Integrar Google Authenticator (TOTP) en Rodauth
🔹 Mensaje de commit:
feat(mfa): agrega soporte para Google Authenticator en Rodauth
🔹 Contenido del commit:
Modificar app/views/mfa/setup.html.erb
<h2>Configurar Autenticación de Dos Factores</h2>
<p>Escanea este código QR en Google Authenticator o Authy:</p>
<img src="<%= rodauth.otp_provisioning_uri_qr_code_url %>" alt="QR Code">
<p>Introduce el código generado:</p>
<form action="/mfa/verify" method="post">
  <input type="text" name="otp" placeholder="Código OTP" required>
  <button type="submit">Verificar</button>
</form>
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(mfa): agrega soporte para Google Authenticator en Rodauth"
📌 Commit 57.4: Integrar SMS 2FA con Twilio en Rodauth
🔹 Mensaje de commit:
feat(mfa): agrega autenticación de dos factores con SMS usando Twilio
🔹 Contenido del commit:
Definir TwilioSmsService en app/services/twilio_sms_service.rb
require "twilio-ruby"
class TwilioSmsService
  def self.send_sms(phone_number, message)
    client = Twilio::REST::Client.new(
      Rails.application.credentials.dig(:twilio, :account_sid),
      Rails.application.credentials.dig(:twilio, :auth_token)
    )
    client.messages.create(
      from: Rails.application.credentials.dig(:twilio, :phone_number),
      to: phone_number,
      body: message
    )
  end
end
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(mfa): agrega autenticación de dos factores con SMS usando Twilio"
📌 Commit 57.5: Agregar UI para Configurar MFA (TOTP + SMS)
🔹 Mensaje de commit:
feat(mfa): agrega UI para configurar Multi-Factor Authentication (TOTP + SMS)
🔹 Contenido del commit:
Modificar app/views/mfa/setup.html.erb
<h2>Configurar MFA</h2>
<p>Escanea este código QR en Google Authenticator:</p>
<img src="<%= rodauth.otp_provisioning_uri_qr_code_url %>" alt="QR Code">
<form action="/mfa/verify" method="post">
  <input type="text" name="otp" placeholder="Código OTP" required>
  <button type="submit">Verificar OTP</button>
</form>
<h2>Configurar SMS 2FA</h2>
<form action="/mfa/setup_sms" method="post">
  <input type="text" name="phone_number" placeholder="Número de Teléfono" required>
  <button type="submit">Enviar Código SMS</button>
</form>
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(mfa): agrega UI para configurar Multi-Factor Authentication (TOTP + SMS)"
📌 Commit 57.6: Agregar Soporte para Verificación de SMS en UI
🔹 Mensaje de commit:
feat(mfa): agrega UI para verificar códigos de SMS en Multi-Factor Authentication
🔹 Contenido del commit:
Modificar app/views/mfa/verify_sms.html.erb
<h2>Verificar Código SMS</h2>
<form action="/mfa/verify_sms" method="post">
  <input type="text" name="sms_code" placeholder="Código SMS" required>
  <button type="submit">Verificar Código</button>
</form>
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(mfa): agrega UI para verificar códigos de SMS en Multi-Factor Authentication"
📌 Commit 57.7: Integrar SMS MFA en Rodauth Flow
🔹 Mensaje de commit:
feat(mfa): integra SMS 2FA en el flujo de autenticación de Rodauth
🔹 Contenido del commit:
Modificar config/initializers/rodauth.rb para Incluir SMS MFA
RodauthMain.configure do
  enable :two_factor_base, :otp, :sms_codes
  sms_send do |phone, message|
    TwilioSmsService.send_sms(phone, message)
  end
end
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(mfa): integra SMS 2FA en el flujo de autenticación de Rodauth"
📝 Explicación y Código Generado
Ejemplo de Configuración de TOTP en Rails Console
rodauth.otp_provisioning_uri
✅ Devuelve una URL para generar el código QR en Google Authenticator.
Ejemplo de Envío de Código SMS en Rails Console
TwilioSmsService.send_sms("+1234567890", "Tu código de verificación es 123456")
✅ Envía el código por SMS a Twilio.
Ejemplo de Verificación de Código OTP en API
curl -X POST "http://localhost:3000/mfa/verify" \
  -H "Content-Type: application/json" \
  -d '{ "otp": "123456" }'
✅ Si el código es válido:
{ "message": "MFA activado con éxito" }
