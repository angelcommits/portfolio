# âœ… Paso 57: Agregar Multi-Factor Authentication (MFA) con TOTP y SMS en Rodauth

Ahora agregaremos MFA con TOTP (Google Authenticator) y SMS, permitiendo doble factor de autenticaciÃ³n (2FA) para mejorar la seguridad.
âœ… Rodauth MFA (Multi-Factor Authentication) â†’ Seguridad adicional con OTP/SMS.
âœ… TOTP (Google Authenticator, Authy) â†’ CÃ³digos temporales basados en tiempo.
âœ… Twilio SMS API â†’ Para enviar cÃ³digos de verificaciÃ³n por SMS.
âœ… Turbo Streams + Stimulus.js â†’ Para UX fluida sin recargas.
ğŸ“Œ Commit 57.1: Configurar MFA en Rodauth
ğŸ”¹ Mensaje de commit:
feat(mfa): agrega configuraciÃ³n de Multi-Factor Authentication (TOTP + SMS) en Rodauth
ğŸ”¹ Contenido del commit:
Modificar config/initializers/rodauth.rb
RodauthMain.configure do
  enable :two_factor_base, :otp, :sms_codes
  # Configurar OTP con Google Authenticator
  otp_drift 30
  otp_digits 6
  otp_label "My Web3 App"
  otp_issuer "Web3 App"
  # Configurar SMS con Twilio
  sms_send do |phone, message|
    TwilioSmsService.send_sms(phone, message)
  end
end
ğŸ”¹ AÃ±adir archivos al commit:
git add .
git commit -m "feat(mfa): agrega configuraciÃ³n de Multi-Factor Authentication (TOTP + SMS) en Rodauth"
ğŸ“Œ Commit 57.2: Crear Migraciones para MFA en Rodauth
ğŸ”¹ Mensaje de commit:
feat(mfa): agrega migraciones para almacenar datos de MFA en Rodauth
ğŸ”¹ Contenido del commit:
Generar Migraciones
rails generate rodauth:migration otp sms_codes
rails db:migrate
ğŸ”¹ AÃ±adir archivos al commit:
git add .
git commit -m "feat(mfa): agrega migraciones para almacenar datos de MFA en Rodauth"
ğŸ“Œ Commit 57.3: Integrar Google Authenticator (TOTP) en Rodauth
ğŸ”¹ Mensaje de commit:
feat(mfa): agrega soporte para Google Authenticator en Rodauth
ğŸ”¹ Contenido del commit:
Modificar app/views/mfa/setup.html.erb
<h2>Configurar AutenticaciÃ³n de Dos Factores</h2>
<p>Escanea este cÃ³digo QR en Google Authenticator o Authy:</p>
<img src="<%= rodauth.otp_provisioning_uri_qr_code_url %>" alt="QR Code">
<p>Introduce el cÃ³digo generado:</p>
<form action="/mfa/verify" method="post">
  <input type="text" name="otp" placeholder="CÃ³digo OTP" required>
  <button type="submit">Verificar</button>
</form>
ğŸ”¹ AÃ±adir archivos al commit:
git add .
git commit -m "feat(mfa): agrega soporte para Google Authenticator en Rodauth"
ğŸ“Œ Commit 57.4: Integrar SMS 2FA con Twilio en Rodauth
ğŸ”¹ Mensaje de commit:
feat(mfa): agrega autenticaciÃ³n de dos factores con SMS usando Twilio
ğŸ”¹ Contenido del commit:
Definir TwilioSmsService en app/services/twilio_sms_service.rb
require "twilio-ruby"
class TwilioSmsService
  def self.send_sms(phone_number, message)
    client = Twilio::REST::Client.new(
      Rails.application.credentials.dig(:twilio, :account_sid),
      Rails.application.credentials.dig(:twilio, :auth_token)
    )
    client.messages.create(
      from: Rails.application.credentials.dig(:twilio, :phone_number),
      to: phone_number,
      body: message
    )
  end
end
ğŸ”¹ AÃ±adir archivos al commit:
git add .
git commit -m "feat(mfa): agrega autenticaciÃ³n de dos factores con SMS usando Twilio"
ğŸ“Œ Commit 57.5: Agregar UI para Configurar MFA (TOTP + SMS)
ğŸ”¹ Mensaje de commit:
feat(mfa): agrega UI para configurar Multi-Factor Authentication (TOTP + SMS)
ğŸ”¹ Contenido del commit:
Modificar app/views/mfa/setup.html.erb
<h2>Configurar MFA</h2>
<p>Escanea este cÃ³digo QR en Google Authenticator:</p>
<img src="<%= rodauth.otp_provisioning_uri_qr_code_url %>" alt="QR Code">
<form action="/mfa/verify" method="post">
  <input type="text" name="otp" placeholder="CÃ³digo OTP" required>
  <button type="submit">Verificar OTP</button>
</form>
<h2>Configurar SMS 2FA</h2>
<form action="/mfa/setup_sms" method="post">
  <input type="text" name="phone_number" placeholder="NÃºmero de TelÃ©fono" required>
  <button type="submit">Enviar CÃ³digo SMS</button>
</form>
ğŸ”¹ AÃ±adir archivos al commit:
git add .
git commit -m "feat(mfa): agrega UI para configurar Multi-Factor Authentication (TOTP + SMS)"
ğŸ“Œ Commit 57.6: Agregar Soporte para VerificaciÃ³n de SMS en UI
ğŸ”¹ Mensaje de commit:
feat(mfa): agrega UI para verificar cÃ³digos de SMS en Multi-Factor Authentication
ğŸ”¹ Contenido del commit:
Modificar app/views/mfa/verify_sms.html.erb
<h2>Verificar CÃ³digo SMS</h2>
<form action="/mfa/verify_sms" method="post">
  <input type="text" name="sms_code" placeholder="CÃ³digo SMS" required>
  <button type="submit">Verificar CÃ³digo</button>
</form>
ğŸ”¹ AÃ±adir archivos al commit:
git add .
git commit -m "feat(mfa): agrega UI para verificar cÃ³digos de SMS en Multi-Factor Authentication"
ğŸ“Œ Commit 57.7: Integrar SMS MFA en Rodauth Flow
ğŸ”¹ Mensaje de commit:
feat(mfa): integra SMS 2FA en el flujo de autenticaciÃ³n de Rodauth
ğŸ”¹ Contenido del commit:
Modificar config/initializers/rodauth.rb para Incluir SMS MFA
RodauthMain.configure do
  enable :two_factor_base, :otp, :sms_codes
  sms_send do |phone, message|
    TwilioSmsService.send_sms(phone, message)
  end
end
ğŸ”¹ AÃ±adir archivos al commit:
git add .
git commit -m "feat(mfa): integra SMS 2FA en el flujo de autenticaciÃ³n de Rodauth"
ğŸ“ ExplicaciÃ³n y CÃ³digo Generado
Ejemplo de ConfiguraciÃ³n de TOTP en Rails Console
rodauth.otp_provisioning_uri
âœ… Devuelve una URL para generar el cÃ³digo QR en Google Authenticator.
Ejemplo de EnvÃ­o de CÃ³digo SMS en Rails Console
TwilioSmsService.send_sms("+1234567890", "Tu cÃ³digo de verificaciÃ³n es 123456")
âœ… EnvÃ­a el cÃ³digo por SMS a Twilio.
Ejemplo de VerificaciÃ³n de CÃ³digo OTP en API
curl -X POST "http://localhost:3000/mfa/verify" \
  -H "Content-Type: application/json" \
  -d '{ "otp": "123456" }'
âœ… Si el cÃ³digo es vÃ¡lido:
{ "message": "MFA activado con Ã©xito" }
