# âœ… Paso 85: Integrar Gobernanza con Tally para Propuestas Ejecutables On-Chain

Ahora agregaremos Tally, permitiendo que la DAO tenga un sistema de gobernanza ejecutable on-chain, donde las decisiones votadas se convierten en acciones automÃ¡ticas en la blockchain.
âœ… Votaciones Ejecutables â†’ Las decisiones en la DAO afectan contratos en Ethereum.
âœ… Tally + OpenZeppelin Governor â†’ ImplementaciÃ³n estÃ¡ndar y segura de gobernanza.
âœ… Web3.js + Stimulus.js â†’ Para crear y votar propuestas desde la UI.
âœ… Contrato de Gobernanza en Solidity â†’ Para gestionar votaciones y ejecutar cambios.
ðŸ“Œ Commit 85.1: Crear Smart Contract de Gobernanza con OpenZeppelin Governor
ðŸ”¹ Mensaje de commit:
feat(tally-governance): agrega smart contract para gobernanza on-chain en la DAO con Tally
ðŸ”¹ Contenido del commit:
Definir TallyGovernor.sol en contracts/TallyGovernor.sol
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.0;
import "@openzeppelin/contracts/governance/Governor.sol";
import "@openzeppelin/contracts/governance/extensions/GovernorCountingSimple.sol";
import "@openzeppelin/contracts/governance/extensions/GovernorVotes.sol";
import "@openzeppelin/contracts/governance/extensions/GovernorVotesQuorumFraction.sol";
import "@openzeppelin/contracts/governance/extensions/GovernorTimelockControl.sol";
import "@openzeppelin/contracts/token/ERC20/extensions/ERC20Votes.sol";
contract TallyGovernor is
    Governor,
    GovernorCountingSimple,
    GovernorVotes,
    GovernorVotesQuorumFraction,
    GovernorTimelockControl
{
    constructor(ERC20Votes _token, TimelockController _timelock)
        Governor("TallyGovernor")
        GovernorVotes(_token)
        GovernorVotesQuorumFraction(4) // 4% del supply debe votar para aprobar
        GovernorTimelockControl(_timelock)
    {}
    function votingDelay() public pure override returns (uint256) {
        return 1; // 1 bloque de retraso
    }
    function votingPeriod() public pure override returns (uint256) {
        return 6570; // ~1 dÃ­a de votaciÃ³n
    }
    function proposalThreshold() public pure override returns (uint256) {
        return 1e18; // 1 GOVR mÃ­nimo para proponer
    }
    function _execute(uint256 proposalId) internal override(Governor, GovernorTimelockControl) {
        super._execute(proposalId);
    }
    function _cancel(uint256 proposalId) internal override(Governor, GovernorTimelockControl) {
        super._cancel(proposalId);
    }
    function _executor() internal view override returns (address) {
        return address(this);
    }
}
Compilar y Desplegar Contrato
npx hardhat compile
npx hardhat run scripts/deploy.js --network goerli
âœ… Guardar la direcciÃ³n del contrato para integraciÃ³n con la UI.
ðŸ”¹ AÃ±adir archivos al commit:
git add .
git commit -m "feat(tally-governance): agrega smart contract para gobernanza on-chain en la DAO con Tally"
ðŸ“Œ Commit 85.2: Integrar CreaciÃ³n de Propuestas en Tally desde la UI
ðŸ”¹ Mensaje de commit:
feat(tally-governance): integra UI para crear propuestas ejecutables en la DAO con Tally
ðŸ”¹ Contenido del commit:
Modificar app/javascript/controllers/tally_proposals_controller.js
import { Controller } from "@hotwired/stimulus";
import Web3 from "web3";
export default class extends Controller {
  static targets = ["title", "description", "action"];
  async createProposal() {
    if (!window.ethereum) {
      alert("Por favor instala MetaMask");
      return;
    }
    const web3 = new Web3(window.ethereum);
    await window.ethereum.request({ method: "eth_requestAccounts" });
    const title = this.titleTarget.value;
    const description = this.descriptionTarget.value;
    const action = this.actionTarget.value;
    const contract = new web3.eth.Contract(
      [
        { name: "propose", type: "function", inputs: [{ name: "targets", type: "address[]" }, { name: "values", type: "uint256[]" }, { name: "calldatas", type: "bytes[]" }, { name: "description", type: "string" }] }
      ],
      "0xYourTallyGovernorContractAddress"
    );
    await contract.methods
      .propose([action], [0], ["0x"], description)
      .send({ from: window.ethereum.selectedAddress });
    alert("Propuesta creada en Tally");
  }
}
Modificar app/views/tally_proposals/index.html.erb
<h2>Crear Propuesta en la DAO</h2>
<label>TÃ­tulo:</label>
<input type="text" data-tally-proposals-target="title">
<label>DescripciÃ³n:</label>
<textarea data-tally-proposals-target="description"></textarea>
<label>AcciÃ³n a Ejecutar (direcciÃ³n del contrato):</label>
<input type="text" data-tally-proposals-target="action">
<button data-controller="tally-proposals" data-action="click->tally-proposals#createProposal">
  Crear Propuesta
</button>
ðŸ”¹ AÃ±adir archivos al commit:
git add .
git commit -m "feat(tally-governance): integra UI para crear propuestas ejecutables en la DAO con Tally"
ðŸ“Œ Commit 85.3: Implementar VotaciÃ³n On-Chain en Tally desde la UI
ðŸ”¹ Mensaje de commit:
feat(tally-governance): agrega UI para votar en propuestas ejecutables en la DAO con Tally
ðŸ”¹ Contenido del commit:
Modificar app/javascript/controllers/tally_voting_controller.js
import { Controller } from "@hotwired/stimulus";
import Web3 from "web3";
export default class extends Controller {
  static targets = ["proposalId", "vote"];
  async vote() {
    if (!window.ethereum) {
      alert("Por favor instala MetaMask");
      return;
    }
    const web3 = new Web3(window.ethereum);
    await window.ethereum.request({ method: "eth_requestAccounts" });
    const proposalId = this.proposalIdTarget.value;
    const voteChoice = parseInt(this.voteTarget.value, 10);
    const contract = new web3.eth.Contract(
      [
        { name: "castVote", type: "function", inputs: [{ name: "proposalId", type: "uint256" }, { name: "support", type: "uint8" }] }
      ],
      "0xYourTallyGovernorContractAddress"
    );
    await contract.methods.castVote(proposalId, voteChoice).send({ from: window.ethereum.selectedAddress });
    alert("Voto registrado en Tally");
  }
}
Modificar app/views/tally_voting/index.html.erb
<h2>Votar en Tally</h2>
<label>ID de la Propuesta:</label>
<input type="text" data-tally-voting-target="proposalId">
<label>Tu Voto (0 = No, 1 = SÃ­, 2 = Abstenerse):</label>
<input type="number" data-tally-voting-target="vote">
<button data-controller="tally-voting" data-action="click->tally-voting#vote">
  Votar en Tally
</button>
ðŸ”¹ AÃ±adir archivos al commit:
git add .
git commit -m "feat(tally-governance): agrega UI para votar en propuestas ejecutables en la DAO con Tally"
