# ✅ Paso 63: Integrar Pago con Criptomonedas usando Stripe Crypto & Onramper

Ahora agregaremos pagos con criptomonedas en la plataforma utilizando Stripe Crypto y Onramper, permitiendo a los usuarios pagar con Bitcoin, Ethereum, USDC y otras stablecoins.
✅ Stripe Crypto → Para pagos con criptomonedas de forma nativa.
✅ Onramper → Para convertir fiat a cripto de forma fácil.
✅ Webhooks de Stripe → Para manejar transacciones y confirmaciones de pago.
✅ Stimulus.js + Turbo Streams → UX fluida y sin recargas.
📌 Commit 63.1: Instalar Stripe y Configurar API Keys
🔹 Mensaje de commit:
feat(crypto-payments): instala Stripe y configura API Keys para pagos con criptomonedas
🔹 Contenido del commit:
Instalar Gema stripe
bundle add stripe
Agregar Credenciales en config/credentials.yml.enc
stripe:
  secret_key: "sk_live_YOUR_SECRET_KEY"
  publishable_key: "pk_live_YOUR_PUBLISHABLE_KEY"
  webhook_secret: "whsec_YOUR_WEBHOOK_SECRET"
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(crypto-payments): instala Stripe y configura API Keys para pagos con criptomonedas"
📌 Commit 63.2: Crear API para Iniciar Pago con Criptomonedas en Stripe
🔹 Mensaje de commit:
feat(crypto-payments): agrega API para iniciar pagos con criptomonedas usando Stripe
🔹 Contenido del commit:
Definir CryptoPaymentsController en app/controllers/crypto_payments_controller.rb
class CryptoPaymentsController < ApplicationController
  skip_before_action :verify_authenticity_token
  def create
    session = Stripe::Checkout::Session.create(
      payment_method_types: ["crypto"],
      mode: "payment",
      success_url: "#{root_url}payments/success",
      cancel_url: "#{root_url}payments/cancel",
      line_items: [{
        price_data: {
          currency: "usd",
          product_data: { name: "Suscripción Premium" },
          unit_amount: 1000_00, # $1000 USD en centavos
        },
        quantity: 1
      }]
    )
    render json: { url: session.url }
  end
end
Agregar Rutas en config/routes.rb
Rails.application.routes.draw do
  post "/crypto_payments", to: "crypto_payments#create"
end
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(crypto-payments): agrega API para iniciar pagos con criptomonedas usando Stripe"
📌 Commit 63.3: Integrar Onramper para Compra de Cripto con Fiat
🔹 Mensaje de commit:
feat(crypto-payments): integra Onramper para convertir fiat a criptomonedas
🔹 Contenido del commit:
Modificar app/views/payments/index.html.erb
<h2>Comprar Criptomonedas</h2>
<iframe
  src="https://widget.onramper.com?apiKey=YOUR_ONRAMPER_API_KEY"
  width="400"
  height="600"
  frameborder="0"
  allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture"
></iframe>
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(crypto-payments): integra Onramper para convertir fiat a criptomonedas"
📌 Commit 63.4: Manejar Webhooks de Stripe para Confirmar Pagos
🔹 Mensaje de commit:
feat(crypto-payments): maneja webhooks de Stripe para confirmar pagos con criptomonedas
🔹 Contenido del commit:
Definir StripeWebhooksController en app/controllers/stripe_webhooks_controller.rb
require "stripe"
class StripeWebhooksController < ApplicationController
  skip_before_action :verify_authenticity_token
  def create
    payload = request.body.read
    sig_header = request.env["HTTP_STRIPE_SIGNATURE"]
    event = nil
    begin
      event = Stripe::Webhook.construct_event(
        payload, sig_header, Rails.application.credentials.dig(:stripe, :webhook_secret)
      )
    rescue JSON::ParserError, Stripe::SignatureVerificationError => e
      render json: { error: e.message }, status: :bad_request
      return
    end
    case event["type"]
    when "checkout.session.completed"
      handle_success(event["data"]["object"])
    end
    render json: { message: "Webhook recibido" }
  end
  private
  def handle_success(session)
    # Aquí puedes actualizar la base de datos con la información del pago exitoso
    user = User.find_by(email: session["customer_email"])
    user.update(subscription_status: "active") if user
  end
end
Agregar Ruta para Webhooks en config/routes.rb
post "/stripe_webhooks", to: "stripe_webhooks#create"
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(crypto-payments): maneja webhooks de Stripe para confirmar pagos con criptomonedas"
📌 Commit 63.5: Agregar Botón para Pagar con Cripto en la UI
🔹 Mensaje de commit:
feat(crypto-payments): agrega botón para iniciar pago con criptomonedas en la UI
🔹 Contenido del commit:
Modificar app/javascript/controllers/payments_controller.js
import { Controller } from "@hotwired/stimulus";
export default class extends Controller {
  async payWithCrypto() {
    const response = await fetch("/crypto_payments", { method: "POST" });
    const data = await response.json();
    window.location.href = data.url;
  }
}
Modificar app/views/payments/index.html.erb
<h2>Pagar con Criptomonedas</h2>
<button data-controller="payments" data-action="click->payments#payWithCrypto">
  Pagar con Crypto
</button>
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(crypto-payments): agrega botón para iniciar pago con criptomonedas en la UI"
📝 Explicación y Código Generado
Ejemplo de Iniciar Pago con Cripto en API
curl -X POST "http://localhost:3000/crypto_payments"
✅ Respuesta esperada:
{ "url": "https://checkout.stripe.com/pay/cs_test_..." }
👉 El usuario es redirigido a Stripe para pagar con criptomonedas.
Ejemplo de Webhook de Stripe Recibido
{
  "type": "checkout.session.completed",
  "data": {
    "object": {
      "customer_email": "user@example.com",
      "amount_total": 100000
    }
  }
}
✅ El backend confirma el pago y activa la suscripción del usuario.
Ejemplo de Conversión Fiat → Cripto con Onramper
<iframe src="https://widget.onramper.com?apiKey=YOUR_ONRAMPER_API_KEY" width="400" height="600"></iframe>
✅ El usuario compra cripto con tarjeta de crédito o transferencia bancaria.
