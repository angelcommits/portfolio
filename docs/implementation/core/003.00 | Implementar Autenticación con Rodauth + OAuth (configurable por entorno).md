# Paso 3: Implementar AutenticaciÃ³n con Rodauth + OAuth (configurable por entorno)

Vamos a configurar Rodauth como sistema de autenticaciÃ³n, con la opciÃ³n de habilitar OAuth mediante una variable de entorno.

- âœ… Rodauth â†’ Manejo de autenticaciÃ³n, recuperaciÃ³n de contraseÃ±a, verificaciÃ³n de email, etc.
- âœ… OAuth â†’ Habilitable o deshabilitable segÃºn la variable de entorno ENABLE_OAUTH.
- âœ… PostgreSQL como backend â†’ Para almacenar credenciales de usuario.
- âœ… Autoregistro deshabilitado â†’ Los usuarios se crean solo a travÃ©s de tareas.

ğŸ“Œ Commit 3: Agrega Rodauth como sistema de autenticaciÃ³n
ğŸ”¹ Mensaje de commit:

> feat(auth): integra Rodauth con autenticaciÃ³n y soporte opcional de OAuth

ğŸ”¹ Contenido del commit:

```sh
echo "gem 'rodauth-rails', '~> 1.7'" >> Gemfile
bundle install
rails g rodauth:install
rails g rodauth:migration
rails db:migrate
mkdir -p app/lib
touch app/lib/rodauth_app.rb
```

ğŸ“ ExplicaciÃ³n y CÃ³digo Generado

```rb
# app/lib/rodauth_app.rb
class RodauthApp < Rodauth::Rails::App
  configure do
    enable :login, :logout, :reset_password, :verify_account, :change_password # ConfiguraciÃ³n de autenticaciÃ³n
    account_table :users
    account_primary_key :id
    login_column :email
    password_column :password_digest # Deshabilitar el autoregistro
    create_account_route nil # Habilitar OAuth solo si la variable de entorno lo permite
    enable :oauth if ENV["ENABLE_OAUTH"] == "true"
  end
end
```

```rb
# app/models/company/business/user.rb
module Company
  module Business
    class User < ApplicationRecord
      has_secure_password # Necesario para Rodauth

      has_many :platforms, foreign_key: :owner_id, class_name: "Business::Platform"
    end
  end
end
```

Ejemplo de Uso en Rails Console

```rb
# Crear un usuario manualmente (porque el autoregistro estÃ¡ deshabilitado)
user = Company::Business::User.create!(email: "admin@example.com", name: "Admin", password: "secure123")

# Iniciar sesiÃ³n con Rodauth
rodauth = RodauthApp.new(account: user)
rodauth.login("admin@example.com", "secure123")

# Comprobar si OAuth estÃ¡ habilitado
ENV["ENABLE_OAUTH"] = "true"
rodauth.oauth? # => true
```
