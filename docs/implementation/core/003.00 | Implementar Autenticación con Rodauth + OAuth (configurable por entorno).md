# Paso 3: Implementar Autenticación con Rodauth + OAuth (configurable por entorno)

Vamos a configurar Rodauth como sistema de autenticación, con la opción de habilitar OAuth mediante una variable de entorno.

- ✅ Rodauth → Manejo de autenticación, recuperación de contraseña, verificación de email, etc.
- ✅ OAuth → Habilitable o deshabilitable según la variable de entorno ENABLE_OAUTH.
- ✅ PostgreSQL como backend → Para almacenar credenciales de usuario.
- ✅ Autoregistro deshabilitado → Los usuarios se crean solo a través de tareas.

📌 Commit 3: Agrega Rodauth como sistema de autenticación
🔹 Mensaje de commit:

> feat(auth): integra Rodauth con autenticación y soporte opcional de OAuth

🔹 Contenido del commit:

```sh
echo "gem 'rodauth-rails', '~> 1.7'" >> Gemfile
bundle install
rails g rodauth:install
rails g rodauth:migration
rails db:migrate
mkdir -p app/lib
touch app/lib/rodauth_app.rb
```

📝 Explicación y Código Generado

```rb
# app/lib/rodauth_app.rb
class RodauthApp < Rodauth::Rails::App
  configure do
    enable :login, :logout, :reset_password, :verify_account, :change_password # Configuración de autenticación
    account_table :users
    account_primary_key :id
    login_column :email
    password_column :password_digest # Deshabilitar el autoregistro
    create_account_route nil # Habilitar OAuth solo si la variable de entorno lo permite
    enable :oauth if ENV["ENABLE_OAUTH"] == "true"
  end
end
```

```rb
# app/models/company/business/user.rb
module Company
  module Business
    class User < ApplicationRecord
      has_secure_password # Necesario para Rodauth

      has_many :platforms, foreign_key: :owner_id, class_name: "Business::Platform"
    end
  end
end
```

Ejemplo de Uso en Rails Console

```rb
# Crear un usuario manualmente (porque el autoregistro está deshabilitado)
user = Company::Business::User.create!(email: "admin@example.com", name: "Admin", password: "secure123")

# Iniciar sesión con Rodauth
rodauth = RodauthApp.new(account: user)
rodauth.login("admin@example.com", "secure123")

# Comprobar si OAuth está habilitado
ENV["ENABLE_OAUTH"] = "true"
rodauth.oauth? # => true
```
