# ✅ Paso 29: Implementar Soporte para Webhooks en GraphQL Subscriptions

Ahora agregaremos GraphQL Subscriptions para permitir que los clientes escuchen eventos de webhooks en tiempo real sin necesidad de WebSockets tradicionales.
✅ GraphQL Subscriptions → Permite recibir eventos en tiempo real desde el backend.
✅ Soporte para WebSockets o Server-Sent Events (SSE) → Mayor flexibilidad.
✅ Optimización con Redis para manejo eficiente de eventos.
📌 Commit 29.1: Instalar graphql-subscriptions y Configurar Soporte en el Esquema
🔹 Mensaje de commit:
feat(graphql): instala graphql-subscriptions y agrega configuración inicial para WebSockets
🔹 Contenido del commit:
# Añadir la gema graphql-subscriptions al Gemfile
echo "gem 'graphql', '~> 2.0'" >> Gemfile
echo "gem 'redis', '~> 4.8'" >> Gemfile
# Instalar las gemas
bundle install
Modificar app/graphql/company_app_schema.rb para Agregar Soporte a Subscriptions
require "graphql/subscriptions/redis"
CompanyAppSchema = GraphQL::Schema.define do
use GraphQL::Subscriptions::Redis, redis: Redis.new(url: ENV.fetch("REDIS_URL", "redis://localhost:6379/1"))
end
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(graphql): instala graphql-subscriptions y agrega configuración inicial para WebSockets"
📌 Commit 29.2: Crear GraphQL Subscription para Webhooks
🔹 Mensaje de commit:
feat(graphql): agrega Subscription para recibir eventos de Webhooks en tiempo real
🔹 Contenido del commit:
Definir WebhookEventType en app/graphql/types/webhook_event_type.rb
module Types
class WebhookEventType < Types::BaseObject
field :id, ID, null: false
field :event_name, String, null: false
field :payload, GraphQL::Types::JSON, null: false
field :processed_at, GraphQL::Types::ISO8601DateTime, null: true
end
end
Definir SubscriptionType en app/graphql/types/subscription_type.rb
module Types
class SubscriptionType < Types::BaseObject
field :webhook_event, Types::WebhookEventType, null: false, description: "Recibe eventos de Webhooks en tiempo real" do
argument :event_name, String, required: true
end
    def webhook_event(event_name:)
      WebhookEvent.where(event_name: event_name).order(processed_at: :desc).first
    end
end
end
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(graphql): agrega Subscription para recibir eventos de Webhooks en tiempo real"
📌 Commit 29.3: Integrar Subscriptions en WebhookNotifier
🔹 Mensaje de commit:
feat(graphql): agrega transmisión de Webhooks a GraphQL Subscriptions
🔹 Contenido del commit:
Modificar WebhookNotifier para Publicar en GraphQL Subscriptions
class WebhookNotifier
SECRET_KEY = Rails.application.credentials.dig(:webhooks, :secret) || "default_secret"
def self.call(event_name, payload)
WebhookSubscription.where(event_name: event_name, active: true).find_each do |subscription|
signature = generate_signature(payload)
WebhookJob.perform_later(event_name, payload, subscription.url, signature)
end
    # Publicar evento en GraphQL Subscriptions
    CompanyAppSchema.subscriptions.trigger("webhook_event", { event_name: event_name }, WebhookEvent.create!(
      event_name: event_name,
      payload: payload,
      processed_at: Time.current
    ))
    # También transmitir por WebSockets
    ActionCable.server.broadcast("webhooks", { event: event_name, payload: payload })
end
private
def self.generate_signature(payload)
digest = OpenSSL::Digest.new("sha256")
hmac = OpenSSL::HMAC.digest(digest, SECRET_KEY, payload.to_json)
Base64.strict_encode64(hmac)
end
end
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(graphql): agrega transmisión de Webhooks a GraphQL Subscriptions"
📌 Commit 29.4: Agregar Soporte para SSE en GraphQL Subscriptions
🔹 Mensaje de commit:
feat(graphql): permite recibir eventos Webhook en tiempo real usando Server-Sent Events (SSE)
🔹 Contenido del commit:
Modificar GraphqlController para Soporte de SSE
class GraphqlController < ApplicationController
include ActionController::Live
def execute
if params[:subscription].present?
response.headers["Content-Type"] = "text/event-stream"
sse = SSE.new(response.stream, retry: 300, event: "graphql_subscription")
      begin
        CompanyAppSchema.subscriptions.execute(params[:subscription], {}, current_user)
        sse.write({ message: "Suscripción iniciada" })
      ensure
        sse.close
      end
    else
      variables = ensure_hash(params[:variables])
      query = params[:query]
      operation_name = params[:operationName]
      context = { current_user: current_user }
      result = CompanyAppSchema.execute(query, variables: variables, context: context, operation_name: operation_name)
      render json: result
    end
end
end
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(graphql): permite recibir eventos Webhook en tiempo real usando Server-Sent Events (SSE)"
📝 Explicación y Código Generado
Ejemplo de Suscripción a Webhooks en GraphQL con WebSockets
subscription {
webhookEvent(eventName: "order.completed") {
id
eventName
payload
processedAt
}
}
Ejemplo de Suscripción a Webhooks con Server-Sent Events (SSE)
curl -N "http://localhost:3000/graphql?subscription=webhookEvent(eventName:\"order.completed\")"
Ejemplo de Publicación de un Webhook en Rails Console
WebhookNotifier.call("order.completed", { order_id: 123, status: "completed" })
Ejemplo de Recepción de Webhook en el Cliente Web
const eventSource = new EventSource("http://localhost:3000/graphql?subscription=webhookEvent(eventName:\"order.completed\")");
eventSource.onmessage = function(event) {
console.log("Evento recibido:", JSON.parse(event.data));
};
