# ✅ Paso 35: Implementar Almacenamiento en Blockchain para Certificación de Documentos

Ahora agregaremos almacenamiento en Blockchain para garantizar la integridad y trazabilidad de los documentos firmados.
✅ Blockchain (Ethereum, Polygon o Bitcoin) → Inmutabilidad y seguridad.
✅ IPFS → Almacenamiento descentralizado de los documentos firmados.
✅ Hashing con SHA-256 → Para verificar autenticidad sin exponer datos sensibles.
✅ Smart Contracts (Opcional) → Para registrar la trazabilidad en la cadena de bloques.
📌 Commit 35.1: Instalar Soporte para Ethereum y IPFS
🔹 Mensaje de commit:
feat(blockchain): instala soporte para Ethereum y IPFS en Rails
🔹 Contenido del commit:
# Añadir web3 para interactuar con Ethereum y ethereum.rb para firmar transacciones
echo "gem 'web3', '~> 0.3.1'" >> Gemfile
echo "gem 'ethereum.rb', '~> 2.5.2'" >> Gemfile
echo "gem 'ipfs-api', '~> 0.2.2'" >> Gemfile
# Instalar las gemas
bundle install
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(blockchain): instala soporte para Ethereum y IPFS en Rails"
📌 Commit 35.2: Crear Servicio para Subir Documentos a IPFS
🔹 Mensaje de commit:
feat(blockchain): agrega servicio para subir documentos firmados a IPFS
🔹 Contenido del commit:
Definir IpfsService en app/services/ipfs_service.rb
require "ipfs-api"
class IpfsService
  IPFS_NODE = "https://ipfs.infura.io:5001"
  def self.upload_file(file_path)
    ipfs = IPFS::Connection.new(IPFS_NODE)
    response = ipfs.add(file_path)
    response["Hash"] # Retorna el hash CID de IPFS
  end
end
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(blockchain): agrega servicio para subir documentos firmados a IPFS"
📌 Commit 35.3: Crear Servicio para Registrar Hash en Blockchain
🔹 Mensaje de commit:
feat(blockchain): agrega servicio para registrar hash de documentos en Ethereum
🔹 Contenido del commit:
Definir BlockchainService en app/services/blockchain_service.rb
require "web3"
class BlockchainService
  INFURA_URL = Rails.application.credentials.dig(:ethereum, :infura_url)
  PRIVATE_KEY = Rails.application.credentials.dig(:ethereum, :private_key)
  def self.register_hash_on_blockchain(document_hash)
    web3 = Web3::Eth::Rpc.new(host: INFURA_URL, port: 443, connect_options: { use_ssl: true })
    account = web3.personal.list_accounts.first
    contract_abi = JSON.parse(File.read(Rails.root.join("config/contract_abi.json")))
    contract_address = Rails.application.credentials.dig(:ethereum, :contract_address)
    contract = web3.eth.contract(abi: contract_abi).at(contract_address)
    tx = contract.transact_and_wait.registerDocument(document_hash, from: account, gas: 200_000)
    tx.transaction_hash
  end
end
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(blockchain): agrega servicio para registrar hash de documentos en Ethereum"
📌 Commit 35.4: Modificar DocumentsController para Subir a Blockchain
🔹 Mensaje de commit:
feat(blockchain): integra IPFS y Ethereum en la gestión de documentos firmados
🔹 Contenido del commit:
Modificar DocumentsController para Subir Documentos a IPFS y Blockchain
class DocumentsController < ApplicationController
  def store_on_blockchain
    user = Company::Business::User.find(params[:user_id])
    pdf_path = ActiveStorage::Blob.service.path_for(user.signed_pdf.key)
    # Subir a IPFS
    ipfs_hash = IpfsService.upload_file(pdf_path)
    # Registrar hash en Blockchain
    blockchain_hash = BlockchainService.register_hash_on_blockchain(ipfs_hash)
    render json: { message: "Documento registrado en Blockchain", ipfs_hash: ipfs_hash, transaction_hash: blockchain_hash }
  end
end
Agregar Ruta en config/routes.rb
Rails.application.routes.draw do
  post "/documents/store_on_blockchain", to: "documents#store_on_blockchain"
end
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(blockchain): integra IPFS y Ethereum en la gestión de documentos firmados"
📌 Commit 35.5: Agregar Validación de Documentos con Blockchain
🔹 Mensaje de commit:
feat(blockchain): agrega verificación de documentos usando Blockchain
🔹 Contenido del commit:
Modificar BlockchainService para Consultar Registro en Blockchain
class BlockchainService
  def self.verify_document(document_hash)
    web3 = Web3::Eth::Rpc.new(host: INFURA_URL, port: 443, connect_options: { use_ssl: true })
    contract_address = Rails.application.credentials.dig(:ethereum, :contract_address)
    contract_abi = JSON.parse(File.read(Rails.root.join("config/contract_abi.json")))
    contract = web3.eth.contract(abi: contract_abi).at(contract_address)
    contract.call.documentExists(document_hash)
  end
end
Modificar DocumentsController para Verificar Documento
class DocumentsController < ApplicationController
  def verify_document
    document_hash = params[:hash]
    exists = BlockchainService.verify_document(document_hash)
    if exists
      render json: { message: "Documento válido en Blockchain" }, status: :ok
    else
      render json: { error: "Documento no registrado en Blockchain" }, status: :not_found
    end
  end
end
Agregar Ruta para Verificación
Rails.application.routes.draw do
  get "/documents/verify", to: "documents#verify_document"
end
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(blockchain): agrega verificación de documentos usando Blockchain"
📝 Explicación y Código Generado
Ejemplo de Subida de Documento a IPFS y Blockchain
curl -X POST "http://localhost:3000/documents/store_on_blockchain" \
  -H "Content-Type: application/json" \
  -d '{ "user_id": 1 }'
✅ Salida esperada:
{
  "message": "Documento registrado en Blockchain",
  "ipfs_hash": "QmXYZ123...",
  "transaction_hash": "0xabc123..."
}
Ejemplo de Verificación de Documento en Blockchain
curl -X GET "http://localhost:3000/documents/verify?hash=QmXYZ123..."
✅ Si el documento existe en Blockchain:
{ "message": "Documento válido en Blockchain" }
❌ Si el documento no existe:
{ "error": "Documento no registrado en Blockchain" }
Ejemplo de Consulta de Documentos en IPFS
curl "https://ipfs.io/ipfs/QmXYZ123..."
✅ Devuelve el PDF almacenado en la red descentralizada.
