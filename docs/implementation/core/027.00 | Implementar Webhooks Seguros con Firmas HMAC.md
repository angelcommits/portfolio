# ✅ Paso 27: Implementar Webhooks Seguros con Firmas HMAC

Ahora agregaremos firmas HMAC para validar la autenticidad de los webhooks y evitar ataques de suplantación.
✅ HMAC-SHA256 → Para firmar los payloads de los webhooks con una clave secreta.
✅ Validación en el receptor → Permitir que los servicios externos verifiquen la autenticidad del evento.
✅ Configuración de clave secreta → Cada servicio puede tener su propia clave.
📌 Commit 27.1: Agregar Firma HMAC en WebhookNotifier
🔹 Mensaje de commit:
feat(webhooks): agrega firma HMAC-SHA256 en los webhooks para mayor seguridad
🔹 Contenido del commit:
Modificar WebhookNotifier en app/services/webhook_notifier.rb
require "openssl"
require "base64"
class WebhookNotifier
SECRET_KEY = Rails.application.credentials.dig(:webhooks, :secret) || "default_secret"
def self.call(event_name, payload)
WebhookSubscription.where(event_name: event_name, active: true).find_each do |subscription|
signature = generate_signature(payload)
WebhookJob.perform_later(event_name, payload, subscription.url, signature)
end
    # Transmitir por WebSockets
    ActionCable.server.broadcast("webhooks", { event: event_name, payload: payload })
end
private
def self.generate_signature(payload)
digest = OpenSSL::Digest.new("sha256")
hmac = OpenSSL::HMAC.digest(digest, SECRET_KEY, payload.to_json)
Base64.strict_encode64(hmac)
end
end
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(webhooks): agrega firma HMAC-SHA256 en los webhooks para mayor seguridad"
📌 Commit 27.2: Modificar WebhookJob para Incluir la Firma en el Header
🔹 Mensaje de commit:
feat(webhooks): envía firma HMAC en los headers de los webhooks
🔹 Contenido del commit:
Modificar WebhookJob en app/jobs/webhook_job.rb
class WebhookJob < ApplicationJob
queue_as :default
def perform(event_name, payload, url, signature)
uri = URI.parse(url)
http = Net::HTTP.new(uri.host, uri.port)
http.use_ssl = uri.scheme == "https"
    request = Net::HTTP::Post.new(uri.path, {
      "Content-Type" => "application/json",
      "X-Webhook-Signature" => signature
    })
    request.body = payload.to_json
    response = http.request(request)
    unless response.is_a?(Net::HTTPSuccess)
      Rails.logger.error("Webhook failed: #{response.code} - #{response.body}")
      raise "Webhook delivery failed"
    end
end
end
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(webhooks): envía firma HMAC en los headers de los webhooks"
📌 Commit 27.3: Agregar Validación de Firma en WebhooksController
🔹 Mensaje de commit:
feat(webhooks): valida la firma HMAC en los webhooks entrantes
🔹 Contenido del commit:
Modificar WebhooksController en app/controllers/webhooks_controller.rb
class WebhooksController < ApplicationController
skip_before_action :verify_authenticity_token
def receive
signature = request.headers["X-Webhook-Signature"]
payload = request.body.read
    if valid_signature?(payload, signature)
      Rails.logger.info("Webhook autenticado correctamente")
      head :ok
    else
      Rails.logger.warn("Firma inválida en webhook recibido")
      head :unauthorized
    end
end
private
def valid_signature?(payload, signature)
expected_signature = WebhookNotifier.send(:generate_signature, JSON.parse(payload))
ActiveSupport::SecurityUtils.secure_compare(expected_signature, signature)
end
end
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(webhooks): valida la firma HMAC en los webhooks entrantes"
📝 Explicación y Código Generado
Ejemplo de Webhook Firmado con HMAC
curl -X POST "http://localhost:3000/webhooks" \
 -H "Content-Type: application/json" \
 -H "X-Webhook-Signature: <FIRMA_GENERADA>" \
 -d '{ "event": "order.completed", "order_id": 123 }'
Ejemplo de Validación en Rails Console
payload = { event: "order.completed", order_id: 123 }
signature = WebhookNotifier.send(:generate_signature, payload)
valid = WebhooksController.new.send(:valid_signature?, payload.to_json, signature)
puts valid # true o false
Ejemplo de Simulación de Recepción de Webhook con Firma
nc -l -p 8080
Luego, en Rails Console:
WebhookSubscription.create!(event_name: "user.created", url: "http://localhost:8080")
WebhookNotifier.call("user.created", { id: 1, email: "test@example.com" })
