# ✅ Paso 20: Implementar Webhooks con Rails Nativo + Karafka + Redpanda

Ahora configuraremos Webhooks en Rails para recibir eventos externos y usaremos Karafka con Redpanda para procesarlos asíncronamente.
✅ Rails Webhooks → Endpoint para recibir eventos externos.
✅ Karafka → Cliente de Kafka para procesar los eventos de los webhooks.
✅ Redpanda → Reemplazo ligero de Kafka sin dependencias en Zookeeper.
✅ Procesamiento en segundo plano → Para evitar bloquear la aplicación principal.
📌 Commit 20.1: Instalar Karafka y Configurar Redpanda
🔹 Mensaje de commit:
feat(webhooks): instala Karafka y configura Redpanda para procesamiento de eventos asíncronos
🔹 Contenido del commit:
# Añadir Karafka al Gemfile
echo "gem 'karafka', '~> 2.2'" >> Gemfile
# Instalar la gema
bundle install
# Inicializar Karafka
bundle exec karafka install
# Configurar Redpanda en Docker
mkdir -p infra/redpanda
touch infra/redpanda/docker-compose.yml
Definir infra/redpanda/docker-compose.yml
version: '3.8'
services:
redpanda:
image: redpandadata/redpanda:latest
container_name: redpanda
ports: - "9092:9092"
command: - redpanda start --smp 1 --memory 1G --reserve-memory 0M --overprovisioned --node-id 0 --check=false
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(webhooks): instala Karafka y configura Redpanda para procesamiento de eventos asíncronos"
📌 Commit 20.2: Configurar Endpoint para Recibir Webhooks
🔹 Mensaje de commit:
feat(webhooks): agrega endpoint en WebhooksController para recibir eventos externos
🔹 Contenido del commit:
Crear WebhooksController
class WebhooksController < ApplicationController
skip_before_action :verify_authenticity_token
def receive
event_type = request.headers["X-Event-Type"]
payload = request.body.read
    Karafka.producer.produce_async(
      topic: "webhooks",
      payload: payload,
      key: event_type
    )
    head :ok
end
end
Definir Ruta en config/routes.rb
Rails.application.routes.draw do
post "/webhooks", to: "webhooks#receive"
end
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(webhooks): agrega endpoint en WebhooksController para recibir eventos externos"
📌 Commit 20.3: Configurar Karafka para Consumir Webhooks
🔹 Mensaje de commit:
feat(webhooks): agrega consumidor de eventos para procesar webhooks con Karafka
🔹 Contenido del commit:
Definir Consumidor en app/consumers/webhook_consumer.rb
class WebhookConsumer < Karafka::BaseConsumer
def consume
event_type = params[:key]
payload = JSON.parse(params[:payload])
    Rails.logger.info("Procesando webhook: #{event_type}")
    case event_type
    when "user.created"
      handle_user_created(payload)
    when "order.completed"
      handle_order_completed(payload)
    else
      Rails.logger.warn("Evento no reconocido: #{event_type}")
    end
end
private
def handle_user_created(payload)
User.create!(
email: payload["email"],
name: payload["name"]
)
end
def handle_order_completed(payload)
Order.find_by(id: payload["order_id"])&.update(status: "completed")
end
end
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(webhooks): agrega consumidor de eventos para procesar webhooks con Karafka"
📝 Explicación y Código Generado
Ejemplo de Uso en Rails Console
# Enviar un evento manualmente
Karafka.producer.produce_async(
topic: "webhooks",
payload: { email: "test@example.com", name: "Test User" }.to_json,
key: "user.created"
)
Ejemplo de Recepción de Webhook en API
curl -X POST "http://localhost:3000/webhooks" \
 -H "X-Event-Type: user.created" \
 -H "Content-Type: application/json" \
 -d '{ "email": "newuser@example.com", "name": "New User" }'
Ejemplo de Procesamiento de Webhooks en Karafka
bundle exec karafka server
