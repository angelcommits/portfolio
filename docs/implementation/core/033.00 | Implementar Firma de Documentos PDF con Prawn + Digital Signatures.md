# ✅ Paso 33: Implementar Firma de Documentos PDF con Prawn + Digital Signatures

Ahora agregaremos firma digital en PDFs con Prawn para garantizar la autenticidad de los documentos generados.
✅ Prawn → Generación de documentos PDF en Rails.
✅ prawn-digital_signatures → Firma digital de PDFs con claves privadas.
✅ Integración con Active Storage → Guardar y administrar PDFs firmados.
✅ Compatibilidad con OpenSSL → Validación de firmas en lectores PDF estándar.
📌 Commit 33.1: Instalar Prawn y Soporte para Firmas Digitales
🔹 Mensaje de commit:
feat(pdf): instala Prawn y agrega soporte para firma digital de documentos PDF
🔹 Contenido del commit:
# Añadir Prawn y prawn-digital_signatures al Gemfile
echo "gem 'prawn', '~> 2.4'" >> Gemfile
echo "gem 'prawn-digital_signatures', '~> 0.5.0'" >> Gemfile
# Instalar las gemas
bundle install
# Crear carpeta para certificados
mkdir -p config/certificates
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(pdf): instala Prawn y agrega soporte para firma digital de documentos PDF"
📌 Commit 33.2: Crear Servicio para Generar PDFs Firmados
🔹 Mensaje de commit:
feat(pdf): agrega servicio PdfSigner para firmar documentos digitalmente
🔹 Contenido del commit:
Definir PdfSigner en app/services/pdf_signer.rb
require "prawn"
require "prawn-digital_signatures"
class PdfSigner
  CERT_PATH = Rails.root.join("config/certificates/cert.pem")
  KEY_PATH = Rails.root.join("config/certificates/key.pem")
  def self.generate_signed_pdf(user, content)
    Prawn::Document.generate("signed_document.pdf") do |pdf|
      pdf.text "Documento firmado para #{user.name}"
      pdf.text content
    end
    sign_pdf("signed_document.pdf")
  end
  def self.sign_pdf(file_path)
    signed_file = "#{file_path.gsub('.pdf', '')}_signed.pdf"
    Prawn::DigitalSignatures.sign(file_path, signed_file,
      certificate: CERT_PATH.to_s,
      key: KEY_PATH.to_s,
      location: "Oficina Central",
      contact: "soporte@example.com",
      reason: "Autenticidad garantizada"
    )
    signed_file
  end
end
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(pdf): agrega servicio PdfSigner para firmar documentos digitalmente"
📌 Commit 33.3: Agregar Endpoint para Generar PDFs Firmados
🔹 Mensaje de commit:
feat(pdf): expone endpoint para generar y descargar PDFs firmados
🔹 Contenido del commit:
Modificar DocumentsController para Generar PDFs Firmados
class DocumentsController < ApplicationController
  def generate_signed_pdf
    user = Company::Business::User.find(params[:user_id])
    content = params[:content]
    signed_pdf_path = PdfSigner.generate_signed_pdf(user, content)
    send_file signed_pdf_path, type: "application/pdf", filename: "signed_document.pdf"
  end
end
Agregar Ruta en config/routes.rb
Rails.application.routes.draw do
  post "/documents/signed_pdf", to: "documents#generate_signed_pdf"
end
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(pdf): expone endpoint para generar y descargar PDFs firmados"
📌 Commit 33.4: Configurar Active Storage para Guardar PDFs Firmados
🔹 Mensaje de commit:
feat(pdf): agrega Active Storage para guardar PDFs firmados
🔹 Contenido del commit:
# Crear migración para adjuntar PDFs a usuarios
rails active_storage:install
rails db:migrate
Modificar User para Relacionar PDFs Firmados
class Company::Business::User < ApplicationRecord
  has_one_attached :signed_pdf
end
Modificar DocumentsController para Guardar PDF Firmado
class DocumentsController < ApplicationController
  def generate_signed_pdf
    user = Company::Business::User.find(params[:user_id])
    content = params[:content]
    signed_pdf_path = PdfSigner.generate_signed_pdf(user, content)
    user.signed_pdf.attach(io: File.open(signed_pdf_path), filename: "signed_document.pdf", content_type: "application/pdf")
    render json: { message: "PDF firmado y almacenado correctamente", url: rails_blob_url(user.signed_pdf) }
  end
end
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(pdf): agrega Active Storage para guardar PDFs firmados"
📝 Explicación y Código Generado
Ejemplo de Generación de PDF Firmado en API
curl -X POST "http://localhost:3000/documents/signed_pdf" \
  -H "Content-Type: application/json" \
  -d '{ "user_id": 1, "content": "Este es un documento oficial firmado." }'
Ejemplo de Firma de PDF en Rails Console
user = Company::Business::User.first
signed_pdf = PdfSigner.generate_signed_pdf(user, "Contrato oficial firmado")
puts "Documento firmado: #{signed_pdf}"
Ejemplo de Descarga de PDF Firmado desde Active Storage
curl -O "http://localhost:3000/rails/active_storage/blobs/redirect/signed_document.pdf"
Validación de Firma Digital en Adobe Acrobat Reader
    Abrir PDF firmado en Adobe Acrobat Reader.
    Verificar firma digital en la pestaña "Firmas".
    Confirmar que la firma es válida y no ha sido alterada.
