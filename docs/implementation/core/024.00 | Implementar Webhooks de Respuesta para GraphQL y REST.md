# ✅ Paso 24: Implementar Webhooks de Respuesta para GraphQL y REST

Ahora configuraremos Webhooks de Respuesta, lo que permitirá notificar a servicios externos cuando ocurran ciertos eventos en la aplicación.
✅ Webhooks para REST y GraphQL → Enviar eventos a URLs externas.
✅ Procesamiento asíncrono → Usar Solid Queue para evitar bloqueos en la API.
✅ Configuración flexible → Permitir definir webhooks para distintos eventos.
📌 Commit 24.1: Crear Modelo WebhookSubscription para Registrar URLs
🔹 Mensaje de commit:
feat(webhooks): agrega modelo WebhookSubscription para registrar endpoints de terceros
🔹 Contenido del commit:
# Generar modelo WebhookSubscription
rails g model WebhookSubscription event_name:string url:string active:boolean default: true
# Ejecutar migraciones
rails db:migrate
Definir Modelo WebhookSubscription en app/models/webhook_subscription.rb
class WebhookSubscription < ApplicationRecord
validates :event_name, :url, presence: true
end
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(webhooks): agrega modelo WebhookSubscription para registrar endpoints de terceros"
📌 Commit 24.2: Crear Servicio WebhookNotifier para Enviar Eventos
🔹 Mensaje de commit:
feat(webhooks): agrega servicio WebhookNotifier para enviar eventos a servicios externos
🔹 Contenido del commit:
Definir Servicio WebhookNotifier en app/services/webhook_notifier.rb
require "net/http"
require "uri"
class WebhookNotifier
def self.call(event_name, payload)
WebhookSubscription.where(event_name: event_name, active: true).find_each do |subscription|
send_request(subscription.url, payload)
end
end
private
def self.send_request(url, payload)
uri = URI.parse(url)
http = Net::HTTP.new(uri.host, uri.port)
http.use_ssl = uri.scheme == "https"
    request = Net::HTTP::Post.new(uri.path, { "Content-Type" => "application/json" })
    request.body = payload.to_json
    http.request(request)
end
end
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(webhooks): agrega servicio WebhookNotifier para enviar eventos a servicios externos"
📌 Commit 24.3: Integrar Webhooks en la API REST (Usuarios y Plataformas)
🔹 Mensaje de commit:
feat(webhooks): integra WebhookNotifier en UsersController y PlatformsController
🔹 Contenido del commit:
Modificar UsersController para Enviar Webhooks
class UsersController < ApplicationController
def create
@user = Company::Business::User.new(user_params)
    if @user.save
      WebhookNotifier.call("user.created", { id: @user.id, email: @user.email })
      render json: @user, status: :created
    else
      render json: @user.errors, status: :unprocessable_entity
    end
end
private
def user_params
params.require(:user).permit(:name, :email)
end
end
Modificar PlatformsController para Enviar Webhooks
class PlatformsController < ApplicationController
def create
@platform = Company::Business::Platform.new(platform_params)
    if @platform.save
      WebhookNotifier.call("platform.created", { id: @platform.id, name: @platform.name })
      render json: @platform, status: :created
    else
      render json: @platform.errors, status: :unprocessable_entity
    end
end
private
def platform_params
params.require(:platform).permit(:name, :code, :owner_id)
end
end
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(webhooks): integra WebhookNotifier en UsersController y PlatformsController"
📌 Commit 24.4: Integrar Webhooks en GraphQL
🔹 Mensaje de commit:
feat(webhooks): integra WebhookNotifier en Mutations de GraphQL
🔹 Contenido del commit:
Modificar Mutations::CreateUser para Enviar Webhooks
module Mutations
class CreateUser < Mutations::BaseMutation
argument :name, String, required: true
argument :email, String, required: true
    type Types::UserType
    def resolve(name:, email:)
      user = Company::Business::User.create!(name: name, email: email)
      WebhookNotifier.call("user.created", { id: user.id, email: user.email })
      user
    end
end
end
Modificar Mutations::CreatePlatform para Enviar Webhooks
module Mutations
class CreatePlatform < Mutations::BaseMutation
argument :name, String, required: true
argument :code, String, required: true
argument :owner_id, ID, required: true
    type Types::PlatformType
    def resolve(name:, code:, owner_id:)
      platform = Company::Business::Platform.create!(name: name, code: code, owner_id: owner_id)
      WebhookNotifier.call("platform.created", { id: platform.id, name: platform.name })
      platform
    end
end
end
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(webhooks): integra WebhookNotifier en Mutations de GraphQL"
📝 Explicación y Código Generado
Ejemplo de Creación de una Suscripción de Webhook en Rails Console
WebhookSubscription.create!(event_name: "user.created", url: "https://example.com/webhook")
Ejemplo de Prueba Manual en Rails Console
WebhookNotifier.call("user.created", { id: 1, email: "test@example.com" })
Ejemplo de Webhook en la API REST
curl -X POST "http://localhost:3000/users" \
 -H "Content-Type: application/json" \
 -d '{ "name": "John Doe", "email": "john@example.com" }'
Ejemplo de Webhook en la API GraphQL
mutation {
createUser(name: "Jane Doe", email: "jane@example.com") {
id
name
email
}
}
Ejemplo de Simulación de Recepción de Webhook
nc -l -p 8080
Luego, en Rails Console:
WebhookSubscription.create!(event_name: "user.created", url: "http://localhost:8080")
WebhookNotifier.call("user.created", { id: 1, email: "test@example.com" })
