# ✅ Paso 18: Implementar Métricas y Monitoreo con Grafana + Prometheus

Ahora configuraremos Grafana y Prometheus para monitoreo y visualización de métricas en tiempo real.
✅ Prometheus → Almacena métricas de la aplicación y servidores.
✅ Grafana → Visualiza y genera dashboards de métricas.
✅ Exporters → Para monitorear PostgreSQL, Redis, y la aplicación Rails.
📌 Commit 18.1: Configurar Prometheus en Docker Compose
🔹 Mensaje de commit:
infra(monitoring): agrega configuración de Prometheus en Docker Compose
🔹 Contenido del commit:
Definir docker-compose.override.yml para Prometheus
version: '3.8'
services:
prometheus:
image: prom/prometheus:latest
container_name: prometheus
volumes: - ./infra/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
ports: - "9090:9090"
Crear Configuración de Prometheus (infra/prometheus/prometheus.yml)
global:
scrape_interval: 15s
scrape_configs:
- job_name: "rails_app"
  static_configs:
  - targets: ["host.docker.internal:3000"]
🔹 Añadir archivos al commit:
git add .
git commit -m "infra(monitoring): agrega configuración de Prometheus en Docker Compose"
📌 Commit 18.2: Configurar Grafana en Docker Compose
🔹 Mensaje de commit:
infra(monitoring): agrega configuración de Grafana en Docker Compose
🔹 Contenido del commit:
Definir docker-compose.override.yml para Grafana
services:
grafana:
image: grafana/grafana:latest
container_name: grafana
ports: - "3001:3000"
environment: - GF_SECURITY_ADMIN_PASSWORD=admin
depends_on: - prometheus
🔹 Añadir archivos al commit:
git add .
git commit -m "infra(monitoring): agrega configuración de Grafana en Docker Compose"
📌 Commit 18.3: Configurar Exporter para Métricas de Rails
🔹 Mensaje de commit:
feat(monitoring): agrega Exporter para monitoreo de métricas de Rails con Prometheus
🔹 Contenido del commit:
Instalar prometheus_exporter en el Gemfile
echo "gem 'prometheus_exporter', '~> 1.0'" >> Gemfile
bundle install
Configurar Exporter en config/initializers/prometheus.rb
require "prometheus_exporter/middleware"
require "prometheus_exporter/instrumentation"
Rails.application.middleware.use PrometheusExporter::Middleware
PrometheusExporter::Instrumentation::Process.start(type: "web")
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(monitoring): agrega Exporter para monitoreo de métricas de Rails con Prometheus"
📌 Commit 18.4: Agregar Endpoints de Métricas en Rails
🔹 Mensaje de commit:
feat(monitoring): expone endpoint /metrics para Prometheus
🔹 Contenido del commit:
Crear un controlador para métricas en app/controllers/metrics_controller.rb
class MetricsController < ApplicationController
def index
render plain: PrometheusExporter::Metric::Base.default.registry.prometheus_metrics_text
end
end
Agregar ruta en config/routes.rb
Rails.application.routes.draw do
get "/metrics", to: "metrics#index"
end
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(monitoring): expone endpoint /metrics para Prometheus"
📝 Explicación y Código Generado
Cómo Acceder a las Métricas
    Prometheus UI: http://localhost:9090
    Grafana UI: http://localhost:3001
    Endpoint de métricas de Rails: http://localhost:3000/metrics
Ejemplo de Métrica en Prometheus
curl http://localhost:3000/metrics
Ejemplo de Query en Prometheus UI
rate(rails_requests_total[5m])
