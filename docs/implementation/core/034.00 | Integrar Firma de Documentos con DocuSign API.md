# ✅ Paso 34: Integrar Firma de Documentos con DocuSign API

Ahora agregaremos integración con DocuSign API para permitir firma electrónica legalmente vinculante en documentos generados en la aplicación.
✅ DocuSign API → Permite enviar documentos para firma digitalmente certificada.
✅ Autenticación OAuth 2.0 → Requerida para interactuar con la API de DocuSign.
✅ Webhooks de DocuSign → Para recibir actualizaciones del estado de firma.
✅ Integración con Active Storage → Guardar documentos firmados.
📌 Commit 34.1: Instalar SDK de DocuSign y Configurar OAuth 2.0
🔹 Mensaje de commit:
feat(docusign): instala SDK de DocuSign y configura autenticación OAuth 2.0
🔹 Contenido del commit:
# Añadir SDK de DocuSign al Gemfile
echo "gem 'docusign_esign', '~> 3.14'" >> Gemfile
# Instalar la gema
bundle install
Configurar Credenciales de DocuSign en config/credentials.yml.enc
docusign:
  client_id: "YOUR_CLIENT_ID"
  client_secret: "YOUR_CLIENT_SECRET"
  account_id: "YOUR_ACCOUNT_ID"
  redirect_uri: "http://localhost:3000/docusign/callback"
  api_base_path: "https://demo.docusign.net/restapi"
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(docusign): instala SDK de DocuSign y configura autenticación OAuth 2.0"
📌 Commit 34.2: Crear Servicio para Enviar Documentos a Firma con DocuSign
🔹 Mensaje de commit:
feat(docusign): agrega servicio para enviar documentos a firma con DocuSign API
🔹 Contenido del commit:
Definir DocuSignService en app/services/docusign_service.rb
require "docusign_esign"
require "base64"
class DocuSignService
  API_BASE_PATH = Rails.application.credentials.docusign[:api_base_path]
  def self.send_document_for_signature(user, pdf_path)
    client = DocusignEsign::ApiClient.new
    client.configure_oauth(Rails.application.credentials.docusign[:client_id], Rails.application.credentials.docusign[:client_secret])
    envelopes_api = DocusignEsign::EnvelopesApi.new(client)
    envelope_definition = create_envelope(user, pdf_path)
    response = envelopes_api.create_envelope(Rails.application.credentials.docusign[:account_id], envelope_definition)
    response.envelope_id
  end
  def self.create_envelope(user, pdf_path)
    doc = DocusignEsign::Document.new(
      documentBase64: Base64.encode64(File.read(pdf_path)),
      name: "Contrato de #{user.name}",
      fileExtension: "pdf",
      documentId: "1"
    )
    signer = DocusignEsign::Signer.new(
      email: user.email,
      name: user.name,
      recipientId: "1",
      routingOrder: "1"
    )
    sign_here = DocusignEsign::SignHere.new(
      anchorString: "Firma aquí",
      anchorXOffset: "0",
      anchorYOffset: "-10"
    )
    tabs = DocusignEsign::Tabs.new(signHereTabs: [sign_here])
    signer.tabs = tabs
    recipients = DocusignEsign::Recipients.new(signers: [signer])
    envelope_definition = DocusignEsign::EnvelopeDefinition.new(
      emailSubject: "Por favor firme este documento",
      documents: [doc],
      recipients: recipients,
      status: "sent"
    )
    envelope_definition
  end
end
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(docusign): agrega servicio para enviar documentos a firma con DocuSign API"
📌 Commit 34.3: Agregar Endpoint para Enviar Documentos a Firma con DocuSign
🔹 Mensaje de commit:
feat(docusign): expone endpoint para enviar documentos a firma con DocuSign
🔹 Contenido del commit:
Modificar DocumentsController para Integrar DocuSign
class DocumentsController < ApplicationController
  def send_to_docusign
    user = Company::Business::User.find(params[:user_id])
    pdf_path = ActiveStorage::Blob.service.path_for(user.signed_pdf.key)
    envelope_id = DocuSignService.send_document_for_signature(user, pdf_path)
    render json: { message: "Documento enviado a DocuSign", envelope_id: envelope_id }
  end
end
Agregar Ruta en config/routes.rb
Rails.application.routes.draw do
  post "/documents/send_to_docusign", to: "documents#send_to_docusign"
end
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(docusign): expone endpoint para enviar documentos a firma con DocuSign"
📌 Commit 34.4: Configurar Webhooks para Recibir Estado de Firma
🔹 Mensaje de commit:
feat(docusign): agrega webhook para recibir estado de firma de documentos
🔹 Contenido del commit:
Crear DocuSignWebhooksController en app/controllers/docusign_webhooks_controller.rb
class DocusignWebhooksController < ApplicationController
  skip_before_action :verify_authenticity_token
  def receive
    payload = JSON.parse(request.body.read)
    envelope_id = payload["envelopeId"]
    status = payload["status"]
    event = WebhookEvent.create!(
      event_name: "docusign.signature_status",
      payload: payload,
      processed_at: Time.current
    )
    Rails.logger.info("Firma actualizada: #{envelope_id} - Estado: #{status}")
    head :ok
  end
end
Agregar Ruta para Webhooks de DocuSign
Rails.application.routes.draw do
  post "/docusign/webhooks", to: "docusign_webhooks#receive"
end
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(docusign): agrega webhook para recibir estado de firma de documentos"
📝 Explicación y Código Generado
Ejemplo de Envío de Documento a Firma con DocuSign
curl -X POST "http://localhost:3000/documents/send_to_docusign" \
  -H "Content-Type: application/json" \
  -d '{ "user_id": 1 }'
✅ DocuSign enviará el documento para firma.
Ejemplo de Recepción de Webhook de Firma
Cuando el usuario firme el documento, DocuSign enviará una notificación al webhook:
curl -X POST "http://localhost:3000/docusign/webhooks" \
  -H "Content-Type: application/json" \
  -d '{ "envelopeId": "abc123", "status": "completed" }'
✅ El sistema registrará el estado de firma en la base de datos.
Ejemplo de Verificación del Estado de Firma en Rails Console
WebhookEvent.where(event_name: "docusign.signature_status").each do |event|
  puts "Firma: #{event.payload['envelopeId']} - Estado: #{event.payload['status']}"
end
