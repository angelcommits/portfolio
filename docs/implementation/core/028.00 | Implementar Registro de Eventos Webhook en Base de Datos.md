# ✅ Paso 28: Implementar Registro de Eventos Webhook en Base de Datos

Ahora agregaremos registro de eventos webhook para permitir auditoría y debugging, lo que nos permitirá:
✅ Registrar cada evento enviado y recibido para análisis posterior.
✅ Guardar el estado de cada intento para debugging en caso de fallos.
✅ Permitir reintentos manuales en caso de error.
📌 Commit 28.1: Crear Modelo WebhookEvent para Registrar Eventos
🔹 Mensaje de commit:
feat(webhooks): agrega modelo WebhookEvent para registrar eventos enviados y recibidos
🔹 Contenido del commit:
# Generar modelo WebhookEvent
rails g model WebhookEvent event_name:string url:string status:string payload:text response_code:string response_body:text processed_at:datetime
# Ejecutar migraciones
rails db:migrate
Definir Modelo WebhookEvent en app/models/webhook_event.rb
class WebhookEvent < ApplicationRecord
validates :event_name, :url, :status, :payload, presence: true
end
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(webhooks): agrega modelo WebhookEvent para registrar eventos enviados y recibidos"
📌 Commit 28.2: Modificar WebhookJob para Registrar Eventos
🔹 Mensaje de commit:
feat(webhooks): registra cada webhook enviado en la base de datos
🔹 Contenido del commit:
Modificar WebhookJob en app/jobs/webhook_job.rb
class WebhookJob < ApplicationJob
queue_as :default
def perform(event_name, payload, url, signature)
webhook_event = WebhookEvent.create!(
event_name: event_name,
url: url,
status: "pending",
payload: payload.to_json
)
    uri = URI.parse(url)
    http = Net::HTTP.new(uri.host, uri.port)
    http.use_ssl = uri.scheme == "https"
    request = Net::HTTP::Post.new(uri.path, {
      "Content-Type" => "application/json",
      "X-Webhook-Signature" => signature
    })
    request.body = payload.to_json
    response = http.request(request)
    webhook_event.update!(
      status: response.is_a?(Net::HTTPSuccess) ? "success" : "failed",
      response_code: response.code,
      response_body: response.body,
      processed_at: Time.current
    )
    raise "Webhook delivery failed" unless response.is_a?(Net::HTTPSuccess)
end
end
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(webhooks): registra cada webhook enviado en la base de datos"
📌 Commit 28.3: Agregar Endpoint para Ver el Historial de Webhooks
🔹 Mensaje de commit:
feat(webhooks): agrega endpoint para consultar historial de webhooks en la API
🔹 Contenido del commit:
Definir WebhookEventsController en app/controllers/webhook_events_controller.rb
class WebhookEventsController < ApplicationController
def index
@events = WebhookEvent.order(processed_at: :desc)
render json: @events
end
end
Agregar Ruta en config/routes.rb
Rails.application.routes.draw do
get "/webhooks/events", to: "webhook_events#index"
end
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(webhooks): agrega endpoint para consultar historial de webhooks en la API"
📌 Commit 28.4: Agregar Soporte para Reintentos Manuales de Webhooks Fallidos
🔹 Mensaje de commit:
feat(webhooks): permite reintentar manualmente webhooks fallidos desde la API
🔹 Contenido del commit:
Modificar WebhookEventsController para Agregar Reintentos
class WebhookEventsController < ApplicationController
def retry
event = WebhookEvent.find(params[:id])
    if event.status == "failed"
      WebhookJob.perform_later(event.event_name, JSON.parse(event.payload), event.url, WebhookNotifier.send(:generate_signature, JSON.parse(event.payload)))
      event.update!(status: "retrying")
      render json: { message: "Reintentando webhook..." }, status: :ok
    else
      render json: { error: "Solo se pueden reintentar webhooks fallidos" }, status: :unprocessable_entity
    end
end
end
Agregar Ruta para Reintentar Webhooks
Rails.application.routes.draw do
post "/webhooks/events/:id/retry", to: "webhook_events#retry"
end
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(webhooks): permite reintentar manualmente webhooks fallidos desde la API"
📝 Explicación y Código Generado
Ejemplo de Consulta de Historial de Webhooks
curl -X GET "http://localhost:3000/webhooks/events"
Ejemplo de Reintento Manual de Webhook Fallido
curl -X POST "http://localhost:3000/webhooks/events/1/retry"
Ejemplo de Revisión de Webhooks en Rails Console
WebhookEvent.where(status: "failed").each do |event|
puts "Fallo en #{event.url}: #{event.response_body}"
end
Ejemplo de Simulación de Recepción de Webhook y Verificación en Base de Datos
nc -l -p 8080
Luego, en Rails Console:
WebhookSubscription.create!(event_name: "user.created", url: "http://localhost:8080")
WebhookNotifier.call("user.created", { id: 1, email: "test@example.com" })
# Consultar historial
WebhookEvent.all.each do |event|
puts "#{event.event_name}: #{event.status} (#{event.response_code})"
end
