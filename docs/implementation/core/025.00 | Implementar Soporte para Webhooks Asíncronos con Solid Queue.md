# ✅ Paso 25: Implementar Soporte para Webhooks Asíncronos con Solid Queue

Ahora configuraremos Solid Queue para procesar webhooks en segundo plano, evitando bloqueos en la API y mejorando la escalabilidad.
✅ Solid Queue → Maneja los webhooks como Jobs en segundo plano.
✅ Ejecución asincrónica → Permite procesar eventos sin ralentizar la API.
✅ Retrys automáticos → Reintenta fallos de entrega automáticamente.
📌 Commit 25.1: Crear Job para Enviar Webhooks en Segundo Plano
🔹 Mensaje de commit:
feat(webhooks): agrega WebhookJob para procesar webhooks asíncronamente con Solid Queue
🔹 Contenido del commit:
# Generar un Job para enviar webhooks en segundo plano
rails g job webhook
Modificar WebhookJob en app/jobs/webhook_job.rb
class WebhookJob < ApplicationJob
queue_as :default
def perform(event_name, payload, url)
uri = URI.parse(url)
http = Net::HTTP.new(uri.host, uri.port)
http.use_ssl = uri.scheme == "https"
    request = Net::HTTP::Post.new(uri.path, { "Content-Type" => "application/json" })
    request.body = payload.to_json
    response = http.request(request)
    unless response.is_a?(Net::HTTPSuccess)
      Rails.logger.error("Webhook failed: #{response.code} - #{response.body}")
      raise "Webhook delivery failed"
    end
end
end
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(webhooks): agrega WebhookJob para procesar webhooks asíncronamente con Solid Queue"
📌 Commit 25.2: Integrar WebhookJob en WebhookNotifier
🔹 Mensaje de commit:
feat(webhooks): modifica WebhookNotifier para usar WebhookJob en procesamiento asíncrono
🔹 Contenido del commit:
Modificar WebhookNotifier en app/services/webhook_notifier.rb
class WebhookNotifier
def self.call(event_name, payload)
WebhookSubscription.where(event_name: event_name, active: true).find_each do |subscription|
WebhookJob.perform_later(event_name, payload, subscription.url)
end
end
end
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(webhooks): modifica WebhookNotifier para usar WebhookJob en procesamiento asíncrono"
📌 Commit 25.3: Configurar Solid Queue en config/application.rb
🔹 Mensaje de commit:
feat(queue): configura Solid Queue como backend de Active Job
🔹 Contenido del commit:
Modificar config/application.rb
Rails.application.configure do
config.active_job.queue_adapter = :solid_queue
end
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(queue): configura Solid Queue como backend de Active Job"
📝 Explicación y Código Generado
Ejemplo de Creación de una Suscripción de Webhook en Rails Console
WebhookSubscription.create!(event_name: "user.created", url: "https://example.com/webhook")
Ejemplo de Envío de Webhook en Segundo Plano
WebhookNotifier.call("user.created", { id: 1, email: "test@example.com" })
Ejemplo de Simulación de Recepción de Webhook
nc -l -p 8080
Luego, en Rails Console:
WebhookSubscription.create!(event_name: "user.created", url: "http://localhost:8080")
WebhookNotifier.call("user.created", { id: 1, email: "test@example.com" })
