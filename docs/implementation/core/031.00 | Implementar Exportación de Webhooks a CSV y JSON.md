# ✅ Paso 31: Implementar Exportación de Webhooks a CSV y JSON

Ahora agregaremos descarga de Webhooks en CSV y JSON para facilitar la exportación y análisis de datos.
✅ Exportación en CSV → Para análisis en Excel o Google Sheets.
✅ Exportación en JSON → Para integraciones con otras herramientas.
✅ Optimización con Streams → Para manejar grandes volúmenes de datos sin sobrecargar la memoria.
📌 Commit 31.1: Agregar Soporte para Exportación en CSV
🔹 Mensaje de commit:
feat(webhooks): agrega exportación de eventos a CSV
🔹 Contenido del commit:
Modificar WebhookEventsController para Soporte CSV
require "csv"
class WebhookEventsController < ApplicationController
def index
@events = WebhookEvent.order(processed_at: :desc)
    respond_to do |format|
      format.html
      format.json { render json: @events }
      format.csv { send_data generate_csv(@events), filename: "webhook_events.csv" }
    end
end
private
def generate_csv(events)
CSV.generate(headers: true) do |csv|
csv << ["ID", "Evento", "Estado", "Procesado", "Payload"]
      events.find_each do |event|
        csv << [event.id, event.event_name, event.status, event.processed_at, event.payload]
      end
    end
end
end
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(webhooks): agrega exportación de eventos a CSV"
📌 Commit 31.2: Agregar Botones de Descarga en la Vista
🔹 Mensaje de commit:
feat(webhooks): agrega botones de descarga para exportación en CSV y JSON
🔹 Contenido del commit:
Modificar app/views/webhook_events/index.html.erb
<h1 class="text-2xl font-bold mb-4 text-center">Eventos Webhooks en Tiempo Real</h1>
<div class="flex justify-end space-x-2 mb-4">
  <a href="<%= webhook_events_path(format: :csv) %>" class="px-4 py-2 bg-blue-500 text-white rounded">Descargar CSV</a>
  <a href="<%= webhook_events_path(format: :json) %>" class="px-4 py-2 bg-green-500 text-white rounded">Descargar JSON</a>
</div>
<div id="webhooks_dashboard" class="max-w-4xl mx-auto bg-white p-4 shadow-md rounded-lg">
  <%= turbo_stream_from "webhooks" %>
  <table class="table-auto w-full border-collapse border border-gray-300">
    <thead>
      <tr class="bg-blue-500 text-white">
        <th class="border px-4 py-2">Evento</th>
        <th class="border px-4 py-2">Estado</th>
        <th class="border px-4 py-2">Procesado</th>
      </tr>
    </thead>
    <tbody>
      <%= render @events %>
    </tbody>
  </table>
</div>
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(webhooks): agrega botones de descarga para exportación en CSV y JSON"
📌 Commit 31.3: Optimizar Exportación de CSV con Streams
🔹 Mensaje de commit:
perf(webhooks): optimiza exportación de CSV con streams para mejorar rendimiento
🔹 Contenido del commit:
Modificar WebhookEventsController para Usar Streams
def generate_csv(events)
Enumerator.new do |csv|
csv << CSV.generate_line(["ID", "Evento", "Estado", "Procesado", "Payload"])
    events.find_each do |event|
      csv << CSV.generate_line([event.id, event.event_name, event.status, event.processed_at, event.payload])
    end
end
end
🔹 Añadir archivos al commit:
git add .
git commit -m "perf(webhooks): optimiza exportación de CSV con streams para mejorar rendimiento"
📝 Explicación y Código Generado
Ejemplo de Descarga de Webhooks en CSV
curl -X GET "http://localhost:3000/webhooks/events.csv" -o webhook_events.csv
Ejemplo de Descarga de Webhooks en JSON
curl -X GET "http://localhost:3000/webhooks/events.json" -o webhook_events.json
Ejemplo de Apertura de CSV en Rails Console
require "csv"
csv_content = File.read("webhook_events.csv")
csv_data = CSV.parse(csv_content, headers: true)
puts csv_data.first["Evento"]
