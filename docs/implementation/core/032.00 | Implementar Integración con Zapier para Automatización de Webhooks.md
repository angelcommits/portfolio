# ✅ Paso 32: Implementar Integración con Zapier para Automatización de Webhooks

Ahora configuraremos Zapier como una integración nativa para conectar los Webhooks con herramientas externas como Slack, Google Sheets, Notion, Trello y más, sin necesidad de escribir código adicional.
✅ Zapier Webhooks → Permite conectar eventos de nuestra aplicación con cientos de servicios.
✅ Configuración sencilla → No requiere cambios en el código de los clientes.
✅ Manejo de errores y reintentos → Zapier gestiona automáticamente los fallos de entrega.
📌 Commit 32.1: Agregar Configuración de Webhooks para Zapier
🔹 Mensaje de commit:
feat(integration): agrega configuración de Webhooks para integración con Zapier
🔹 Contenido del commit:
Modificar WebhookSubscription para Soporte de Zapier
class WebhookSubscription < ApplicationRecord
validates :event_name, :url, presence: true
before_create :mark_as_zapier_if_needed
private
def mark_as_zapier_if_needed
self.zapier = url.include?("hooks.zapier.com")
end
end
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(integration): agrega configuración de Webhooks para integración con Zapier"
📌 Commit 32.2: Exponer Endpoint en Zapier para Suscribir Webhooks
🔹 Mensaje de commit:
feat(integration): expone endpoint en la API para suscribir Webhooks con Zapier
🔹 Contenido del commit:
Definir ZapierWebhooksController en app/controllers/zapier_webhooks_controller.rb
class ZapierWebhooksController < ApplicationController
def create
subscription = WebhookSubscription.create!(
event_name: params[:event_name],
url: params[:url],
active: true
)
render json: { message: "Zapier Webhook registrado", id: subscription.id }, status: :created
end
end
Agregar Ruta en config/routes.rb
Rails.application.routes.draw do
post "/zapier/webhooks", to: "zapier_webhooks#create"
end
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(integration): expone endpoint en la API para suscribir Webhooks con Zapier"
📌 Commit 32.3: Modificar WebhookNotifier para Enviar Eventos a Zapier
🔹 Mensaje de commit:
feat(integration): agrega compatibilidad con Zapier en WebhookNotifier
🔹 Contenido del commit:
Modificar WebhookNotifier en app/services/webhook_notifier.rb
class WebhookNotifier
SECRET_KEY = Rails.application.credentials.dig(:webhooks, :secret) || "default_secret"
def self.call(event_name, payload)
WebhookSubscription.where(event_name: event_name, active: true).find_each do |subscription|
if subscription.zapier?
send_to_zapier(subscription.url, payload)
else
signature = generate_signature(payload)
WebhookJob.perform_later(event_name, payload, subscription.url, signature)
end
end
    # También transmitir por WebSockets y GraphQL Subscriptions
    ActionCable.server.broadcast("webhooks", { event: event_name, payload: payload })
    CompanyAppSchema.subscriptions.trigger("webhook_event", { event_name: event_name }, { event_name: event_name, payload: payload })
end
private
def self.send_to_zapier(url, payload)
uri = URI.parse(url)
http = Net::HTTP.new(uri.host, uri.port)
http.use_ssl = uri.scheme == "https"
    request = Net::HTTP::Post.new(uri.path, { "Content-Type" => "application/json" })
    request.body = payload.to_json
    http.request(request)
end
def self.generate_signature(payload)
digest = OpenSSL::Digest.new("sha256")
hmac = OpenSSL::HMAC.digest(digest, SECRET_KEY, payload.to_json)
Base64.strict_encode64(hmac)
end
end
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(integration): agrega compatibilidad con Zapier en WebhookNotifier"
📌 Commit 32.4: Agregar Documentación para Integración con Zapier
🔹 Mensaje de commit:
docs(integration): agrega documentación para conectar Webhooks con Zapier
🔹 Contenido del commit:
Crear docs/integracion_zapier.md
# Integración con Zapier
## 1️⃣ Crear un Trigger en Zapier
- Ir a [Zapier Webhooks](https://zapier.com/app/editor/)
- Seleccionar **Webhook → Catch Hook**
- Copiar la URL generada
## 2️⃣ Registrar Webhook en Rails
Ejecutar el siguiente comando en la API para suscribirse:
````sh
curl -X POST "http://localhost:3000/zapier/webhooks" \
  -H "Content-Type: application/json" \
  -d '{ "event_name": "user.created", "url": "https://hooks.zapier.com/hooks/catch/123456/" }'
3️⃣ Probar Evento
Ejecutar en Rails Console:
WebhookNotifier.call("user.created", { id: 1, email: "user@example.com" })
El evento aparecerá en Zapier y podrá conectarse con Google Sheets, Slack u otros servicios.
🔹 **Añadir archivos al commit:**
```sh
git add .
git commit -m "docs(integration): agrega documentación para conectar Webhooks con Zapier"
📝 Explicación y Código Generado
Ejemplo de Registro de Webhook en Zapier
curl -X POST "http://localhost:3000/zapier/webhooks" \
  -H "Content-Type: application/json" \
  -d '{ "event_name": "order.completed", "url": "https://hooks.zapier.com/hooks/catch/123456/" }'
Ejemplo de Disparo de Evento Webhook a Zapier
WebhookNotifier.call("order.completed", { order_id: 123, status: "completed" })
Ejemplo de Zapier Enviando Evento a Google Sheets
    Crear Zap en Zapier
    Trigger: Webhook → Catch Hook
    Action: Google Sheets → Add Row
    Ejecutar Webhook desde Rails Console
WebhookNotifier.call("user.created", { id: 10, email: "user@example.com" })
    Se agrega automáticamente un nuevo usuario en Google Sheets 🚀
