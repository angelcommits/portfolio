# ✅ Paso 22: Configurar Seguridad Adicional con JWT y Rate Limiting

Ahora mejoraremos la seguridad con autenticación JWT para la API y Rate Limiting para evitar abusos en las solicitudes.
✅ JWT (JSON Web Token) → Para autenticar usuarios en API de forma segura.
✅ Rack::Attack → Para limitar el número de solicitudes y prevenir ataques de fuerza bruta.
✅ Configuración flexible → Permitir múltiples estrategias de autenticación.
📌 Commit 22.1: Instalar JWT y Configurar Autenticación en la API
🔹 Mensaje de commit:
feat(auth): instala JWT y agrega autenticación para la API
🔹 Contenido del commit:
# Añadir la gema JWT al Gemfile
echo "gem 'jwt', '~> 2.7'" >> Gemfile
# Instalar la gema
bundle install
# Crear servicio para manejar JWT
mkdir -p app/services
touch app/services/json_web_token.rb
Definir el Servicio JsonWebToken
require "jwt"
class JsonWebToken
SECRET_KEY = Rails.application.secrets.secret_key_base
def self.encode(payload, exp = 24.hours.from_now)
payload[:exp] = exp.to_i
JWT.encode(payload, SECRET_KEY)
end
def self.decode(token)
body, = JWT.decode(token, SECRET_KEY)
HashWithIndifferentAccess.new(body)
rescue
nil
end
end
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(auth): instala JWT y agrega autenticación para la API"
📌 Commit 22.2: Proteger Endpoints con JWT en la API
🔹 Mensaje de commit:
feat(auth): agrega middleware de autenticación con JWT en la API
🔹 Contenido del commit:
Crear Middleware JwtAuthentication
class JwtAuthentication
def initialize(app)
@app = app
end
def call(env)
request = Rack::Request.new(env)
token = request.get_header("HTTP_AUTHORIZATION")&.split(" ")&.last
user = JsonWebToken.decode(token)&.fetch("user_id", nil)
    if user && (env["warden"].user || Company::Business::User.find_by(id: user))
      env["current_user"] = Company::Business::User.find(user)
      @app.call(env)
    else
      [401, { "Content-Type" => "application/json" }, [{ error: "Unauthorized" }.to_json]]
    end
end
end
Agregar el Middleware en config/application.rb
config.middleware.use JwtAuthentication
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(auth): agrega middleware de autenticación con JWT en la API"
📌 Commit 22.3: Implementar Rate Limiting con Rack::Attack
🔹 Mensaje de commit:
feat(security): instala Rack::Attack para limitar solicitudes y prevenir abusos
🔹 Contenido del commit:
# Añadir Rack::Attack al Gemfile
echo "gem 'rack-attack', '~> 6.6'" >> Gemfile
# Instalar la gema
bundle install
# Crear la configuración en `config/initializers/rack_attack.rb`
touch config/initializers/rack_attack.rb
Definir Configuración de Rack::Attack
class Rack::Attack
throttle("requests/ip", limit: 100, period: 60.seconds) do |request|
request.ip
end
throttle("logins/email", limit: 5, period: 20.seconds) do |request|
if request.path == "/login" && request.post?
request.params["email"].presence
end
end
self.throttled_response = lambda do |env|
[429, { "Content-Type" => "application/json" }, [{ error: "Too many requests" }.to_json]]
end
end
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(security): instala Rack::Attack para limitar solicitudes y prevenir abusos"
📝 Explicación y Código Generado
Generar un Token JWT en Rails Console
user = Company::Business::User.first
token = JsonWebToken.encode(user_id: user.id)
puts token
Ejemplo de Petición Autenticada a la API
curl -X GET "http://localhost:3000/users" -H "Authorization: Bearer <TOKEN>"
Ejemplo de Rate Limiting con Rack::Attack
# Enviar más de 5 solicitudes a /login en menos de 20 segundos
for i in {1..6}; do curl -X POST "http://localhost:3000/login" -d '{"email":"test@example.com"}'; done
