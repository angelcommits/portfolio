# ✅ Paso 26: Agregar Soporte para WebSockets en Webhooks (Tiempo Real)

Ahora configuraremos WebSockets en Webhooks para permitir que los clientes escuchen eventos en tiempo real sin necesidad de realizar peticiones repetitivas (polling).
✅ ActionCable → Permite manejar WebSockets de forma nativa en Rails.
✅ Webhook Streaming → Enviar eventos en vivo a los clientes conectados.
✅ Persistencia de eventos → Registrar eventos en la base de datos para consulta histórica.
📌 Commit 26.1: Crear Canal WebhookChannel para Transmitir Eventos en Tiempo Real
🔹 Mensaje de commit:
feat(webhooks): agrega WebSocket WebhookChannel para transmitir eventos en tiempo real
🔹 Contenido del commit:
Definir WebhookChannel en app/channels/webhook_channel.rb
class WebhookChannel < ApplicationCable::Channel
def subscribed
stream_from "webhooks"
end
end
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(webhooks): agrega WebSocket WebhookChannel para transmitir eventos en tiempo real"
📌 Commit 26.2: Modificar WebhookNotifier para Transmitir Vía WebSockets
🔹 Mensaje de commit:
feat(webhooks): agrega transmisión WebSocket en WebhookNotifier
🔹 Contenido del commit:
Modificar WebhookNotifier en app/services/webhook_notifier.rb
class WebhookNotifier
def self.call(event_name, payload)
WebhookSubscription.where(event_name: event_name, active: true).find_each do |subscription|
WebhookJob.perform_later(event_name, payload, subscription.url)
end
    # Transmitir el evento en WebSocket
    ActionCable.server.broadcast("webhooks", { event: event_name, payload: payload })
end
end
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(webhooks): agrega transmisión WebSocket en WebhookNotifier"
📌 Commit 26.3: Agregar Frontend para Escuchar WebSockets en Webhooks
🔹 Mensaje de commit:
feat(webhooks): agrega frontend para recibir eventos en vivo desde WebSockets
🔹 Contenido del commit:
Modificar app/javascript/channels/webhook_channel.js
import consumer from "./consumer"
consumer.subscriptions.create("WebhookChannel", {
received(data) {
console.log("Evento recibido:", data);
alert(`Nuevo evento: ${data.event}`);
}
});
🔹 Añadir archivos al commit:
git add .
git commit -m "feat(webhooks): agrega frontend para recibir eventos en vivo desde WebSockets"
📝 Explicación y Código Generado
Ejemplo de Suscripción a Webhooks en WebSockets (JavaScript)
const socket = new WebSocket("ws://localhost:3000/cable");
socket.onopen = function() {
console.log("Conectado a WebSocket");
socket.send(JSON.stringify({ command: "subscribe", identifier: JSON.stringify({ channel: "WebhookChannel" }) }));
};
socket.onmessage = function(event) {
console.log("Evento WebSocket recibido:", event.data);
};
Ejemplo de Simulación de Envío de Webhook en Rails Console
WebhookNotifier.call("order.completed", { order_id: 123, status: "completed" })
Ejemplo de Recepción de Webhook en el Cliente
    Se mostrará en la consola del navegador:
    Evento recibido: { event: "order.completed", payload: { order_id: 123, status: "completed" } }
