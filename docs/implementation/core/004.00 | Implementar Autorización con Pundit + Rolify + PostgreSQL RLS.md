âœ… Paso 4: Implementar AutorizaciÃ³n con Pundit + Rolify + PostgreSQL RLS

Ahora agregaremos Pundit y Rolify para manejar los permisos dentro de la aplicaciÃ³n y PostgreSQL RLS (Row-Level Security) para garantizar que los usuarios solo accedan a los datos que les corresponden.

- âœ… Pundit â†’ Define polÃ­ticas de acceso a nivel de controladores y modelos.
- âœ… Rolify â†’ Maneja la asignaciÃ³n de roles dinÃ¡micos a los usuarios.
- âœ… PostgreSQL RLS â†’ Implementa restricciones en la base de datos para reforzar la seguridad.

ğŸ“Œ Commit 4.1: Agregar Pundit y Rolify

> feat(auth): integra Pundit y Rolify para autorizaciÃ³n basada en roles

ğŸ”¹ Contenido del commit:

```sh
echo "gem 'pundit', '~> 2.3'" >> Gemfile
echo "gem 'rolify', '~> 5.3'" >> Gemfile
bundle install
rails g pundit:install
rails g rolify Role Company::Business::User
rails db:migrate
```

ğŸ“Œ Commit 4.2: Configurar PostgreSQL RLS

> feat(security): implementa Row-Level Security (RLS) en PostgreSQL para control de acceso a datos

ğŸ”¹ Contenido del commit:

```sh
rails g migration EnableRLS
```

```rb
# Editar la migraciÃ³n generada para incluir las reglas de seguridad

echo "class EnableRLS < ActiveRecord::Migration[7.1]
  def up
    execute \"ALTER TABLE users ENABLE ROW LEVEL SECURITY;\"
    execute \"CREATE POLICY user_isolation ON users USING (id = current_setting('app.current_user')::integer);\"
  end
  def down
    execute \"ALTER TABLE users DISABLE ROW LEVEL SECURITY;\"
    execute \"DROP POLICY user_isolation ON users;\"
  end
end" > db/migrate/\*\_enable_rls.rb
```

```sh
# Ejecutar migraciones
rails db:migrate
```

ğŸ“ ExplicaciÃ³n y CÃ³digo Generado
Pundit: DefiniciÃ³n de PolÃ­ticas

```rb app/policies/application_policy.rb
class ApplicationPolicy
  attr_reader :user, :record

  def initialize(user, record)
    @user = user
    @record = record
  end

  def index? = false
  def show? = false
  def create? = false
  def update? = false
  def destroy? = false
end
```

```rb app/policies/platform_policy.rb
class PlatformPolicy < ApplicationPolicy
  def show? = user.has_role?(:owner, record) || user.has_role?(:admin, record)
  def update? = user.has_role?(:owner, record)
end
```

Rolify: AsignaciÃ³n de Roles

```rb app/models/company/business/user.rb
module Company
  module Business
    class User < ApplicationRecord
      rolify
    end
  end
end
```

Asignar un rol a un usuario

```rb
user = Company::Business::User.first
platform = Company::Business::Platform.first
user.add_role(:owner, platform)
```
