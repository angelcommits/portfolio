# ‚úÖ Paso 45: Integrar Multisig Contracts con Meta Transactions y Safe Apps

Implementaremos una soluci√≥n integral de contratos multisig que combina Meta Transactions (gasless) con Safe Apps embebidos, ofreciendo m√°xima flexibilidad y experiencia de usuario.

## üéØ Tecnolog√≠as Integradas

‚úÖ **Meta Transactions (Gasless)** ‚Üí Los firmantes no pagan gas, se usa un relayer  
‚úÖ **Safe Apps embebidos** ‚Üí iFrame integrado para usar Gnosis Safe UI nativo  
‚úÖ **Gnosis Safe API** ‚Üí Para consultar y confirmar transacciones multisig  
‚úÖ **Biconomy / Gelato Relay** ‚Üí Manejo de transacciones sin gas  
‚úÖ **Web3.js + Stimulus.js** ‚Üí Firma de contratos directamente en la UI Rails  

## üìå Implementaci√≥n Principal: Meta Transactions

### Commit 45.1: Integrar Meta Transactions con Biconomy

üîπ **Mensaje de commit:**
```
feat(gasless): integra Biconomy para firma de contratos en Gnosis Safe sin gas
```

üîπ **Contenido del commit:**

**Instalar SDK de Biconomy** en `app/javascript/packs/biconomy.js`:
```javascript
import { Biconomy } from "@biconomy/mexa";
import Web3 from "web3";

const provider = new Web3.providers.HttpProvider("https://polygon-mumbai.infura.io/v3/YOUR_INFURA_KEY");
const biconomy = new Biconomy(provider, { 
  apiKey: "YOUR_BICONOMY_API_KEY", 
  debug: true 
});
const web3 = new Web3(biconomy);

biconomy.onEvent(biconomy.READY, () => {
  console.log("Biconomy listo para transacciones sin gas.");
}).onEvent(biconomy.ERROR, (error) => {
  console.error("Error en Biconomy:", error);
});

export { web3, biconomy };
```

### Commit 45.2: Modificar Web3.js para Firmar Contratos Sin Gas

üîπ **Mensaje de commit:**
```
feat(gasless): agrega Web3.js para firmar contratos en Gnosis Safe sin gas usando Meta Transactions
```

**Modificar** `app/javascript/controllers/gnosis_safe_controller.js`:
```javascript
import { Controller } from "@hotwired/stimulus";
import { web3, biconomy } from "../packs/biconomy";

export default class extends Controller {
  connect() {
    console.log("Stimulus conectado con Biconomy para firma sin gas.");
  }
  
  async sign(event) {
    const contractHash = event.target.dataset.contractHash;
    const accounts = await web3.eth.getAccounts();
    const userAddress = accounts[0];
    
    const txParams = {
      from: userAddress,
      to: "0xContractAddress",
      data: web3.eth.abi.encodeFunctionCall({
        name: "signContract",
        type: "function",
        inputs: [{ type: "bytes32", name: "contractHash" }]
      }, [contractHash]),
      signatureType: biconomy.EIP712_SIGN
    };
    
    biconomy.sendTransaction(txParams)
      .then(tx => alert(`Contrato firmado sin gas: ${tx.transactionHash}`))
      .catch(error => console.error("Error enviando meta transaction:", error));
  }
}
```

### Commit 45.3: Agregar Endpoint para Verificar Meta Transactions

üîπ **Mensaje de commit:**
```
feat(gasless): agrega endpoint para verificar contratos firmados en Gnosis Safe sin gas
```

**Modificar ContractsController** para Verificaci√≥n Multisig Sin Gas:
```ruby
class ContractsController < ApplicationController
  def verify_multisig_gasless
    contract_hash = params[:contract_hash]
    exists = SmartContractService.verify_multisig_contract(contract_hash)
    
    if exists
      render json: { message: "Contrato firmado sin gas en Gnosis Safe" }, status: :ok
    else
      render json: { error: "Contrato a√∫n no tiene suficientes firmas" }, status: :unprocessable_entity
    end
  end
end
```

**Agregar Ruta** en `config/routes.rb`:
```ruby
Rails.application.routes.draw do
  get "/contracts/verify_multisig_gasless", to: "contracts#verify_multisig_gasless"
end
```

## üìå Implementaci√≥n Alternativa: Safe Apps Embebidos

### Commit 45.4: Integrar Safe Apps con iFrame Embebido

üîπ **Mensaje de commit:**
```
feat(safe-apps): integra Safe Apps en la plataforma con iFrame embebido
```

**Crear** `app/views/safe_apps/embed.html.erb`:
```erb
<div class="safe-app-container">
  <h2>Firma de Contratos - Gnosis Safe</h2>
  
  <iframe 
    id="safe-app-frame"
    src="https://gnosis-safe.io/app/eth:<%= @safe_address %>/transactions/queue"
    width="100%" 
    height="600px"
    frameborder="0"
    data-controller="safe-iframe"
    data-safe-iframe-address-value="<%= @safe_address %>"
  ></iframe>
  
  <div class="safe-controls mt-4">
    <button 
      class="btn btn-primary"
      data-action="click->safe-iframe#refreshTransactions"
    >
      Actualizar Transacciones
    </button>
  </div>
</div>
```

**Crear Stimulus Controller** `app/javascript/controllers/safe_iframe_controller.js`:
```javascript
import { Controller } from "@hotwired/stimulus";

export default class extends Controller {
  static values = { address: String }
  
  connect() {
    this.setupMessageListener();
  }
  
  setupMessageListener() {
    window.addEventListener('message', (event) => {
      if (event.origin !== 'https://gnosis-safe.io') return;
      
      if (event.data.type === 'TRANSACTION_CONFIRMED') {
        this.handleTransactionConfirmed(event.data);
      }
    });
  }
  
  handleTransactionConfirmed(data) {
    // Notify backend of transaction confirmation
    fetch('/contracts/safe_transaction_confirmed', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
      },
      body: JSON.stringify({
        transaction_hash: data.transactionHash,
        safe_address: this.addressValue
      })
    });
  }
  
  refreshTransactions() {
    const iframe = this.element.querySelector('#safe-app-frame');
    iframe.contentWindow.postMessage({ type: 'REFRESH_TRANSACTIONS' }, '*');
  }
}
```

### Commit 45.5: Implementar Detecci√≥n Autom√°tica de M√©todo

üîπ **Mensaje de commit:**
```
feat(smart-routing): agrega detecci√≥n autom√°tica entre Meta Transactions y Safe Apps
```

**Crear** `app/javascript/controllers/multisig_router_controller.js`:
```javascript
import { Controller } from "@hotwired/stimulus";

export default class extends Controller {
  static targets = ["metaTransactionView", "safeAppView"]
  
  connect() {
    this.detectOptimalMethod();
  }
  
  async detectOptimalMethod() {
    try {
      // Check if user is on Gnosis Safe app
      if (window.parent !== window) {
        this.showSafeAppView();
        return;
      }
      
      // Check if Biconomy is available and funded
      const biconomyAvailable = await this.checkBiconomyStatus();
      
      if (biconomyAvailable) {
        this.showMetaTransactionView();
      } else {
        this.showSafeAppView();
      }
    } catch (error) {
      console.warn("Falling back to Safe Apps:", error);
      this.showSafeAppView();
    }
  }
  
  async checkBiconomyStatus() {
    // Implementation to check Biconomy relayer status
    // Return true if relayer has funds and is operational
    return true; // Simplified for example
  }
  
  showMetaTransactionView() {
    this.metaTransactionViewTarget.classList.remove('hidden');
    this.safeAppViewTarget.classList.add('hidden');
  }
  
  showSafeAppView() {
    this.safeAppViewTarget.classList.remove('hidden');
    this.metaTransactionViewTarget.classList.add('hidden');
  }
}
```

## üìå Integraci√≥n Backend

### Commit 45.6: Crear Servicio Unificado para Ambos M√©todos

üîπ **Mensaje de commit:**
```
feat(multisig-service): agrega servicio unificado para Meta Transactions y Safe Apps
```

**Crear** `app/services/unified_multisig_service.rb`:
```ruby
class UnifiedMultisigService
  include HTTParty
  
  GNOSIS_SAFE_API = "https://safe-transaction.gnosis.io/api/v1"
  
  def self.verify_multisig_contract(contract_hash, method: :auto)
    case method
    when :meta_transaction
      verify_biconomy_transaction(contract_hash)
    when :safe_app
      verify_safe_transaction(contract_hash)
    when :auto
      verify_biconomy_transaction(contract_hash) || verify_safe_transaction(contract_hash)
    end
  end
  
  private
  
  def self.verify_biconomy_transaction(contract_hash)
    # Check if transaction was processed via Biconomy
    response = HTTParty.get("https://api.biconomy.io/api/v1/meta-tx/#{contract_hash}")
    response.code == 200 && response.parsed_response["status"] == "confirmed"
  end
  
  def self.verify_safe_transaction(contract_hash)
    # Check if transaction was processed via Gnosis Safe
    safe_address = Rails.application.credentials.dig(:gnosis, :safe_address)
    response = HTTParty.get("#{GNOSIS_SAFE_API}/safes/#{safe_address}/multisig-transactions/")
    
    transactions = response.parsed_response["results"]
    transaction = transactions.find { |tx| tx["safeTxHash"] == contract_hash }
    
    transaction && transaction["isExecuted"]
  end
end
```

## üìù Explicaci√≥n y Flujo de Trabajo

### Ejemplo de Firma de Contrato con Detecci√≥n Autom√°tica

1. **Usuario abre el Dashboard** en Rails
2. **Sistema detecta autom√°ticamente** el mejor m√©todo disponible:
   - Si est√° en Gnosis Safe App ‚Üí Usa Safe Apps embebido
   - Si Biconomy est√° disponible ‚Üí Usa Meta Transactions
   - Fallback ‚Üí Safe Apps embebido
3. **Usuario firma** usando el m√©todo seleccionado
4. **Transacci√≥n se procesa** seg√∫n el m√©todo elegido
5. **Sistema verifica** en ambos servicios autom√°ticamente

### Ejemplo de Verificaci√≥n Unificada

```bash
curl -X GET "http://localhost:3000/contracts/verify_multisig_gasless?contract_hash=0xContratoHash"
```

**‚úÖ Si el contrato est√° firmado:**
```json
{ "message": "Contrato firmado sin gas en Gnosis Safe" }
```

**‚ùå Si faltan firmas:**
```json
{ "error": "Contrato a√∫n no tiene suficientes firmas" }
```

## üéØ Ventajas de la Implementaci√≥n Combinada

1. **Flexibilidad M√°xima**: Usuarios pueden elegir su m√©todo preferido
2. **Experiencia Sin Fricci√≥n**: Gasless transactions cuando es posible
3. **Compatibilidad Total**: Funciona dentro y fuera de Gnosis Safe
4. **Fallback Robusto**: Siempre hay una alternativa funcional
5. **Integraci√≥n Nativa**: Safe Apps para usuarios de Gnosis Safe UI

## üîß Configuraci√≥n de Entornos

### Variables de Entorno Requeridas

```bash
# Biconomy (Meta Transactions)
BICONOMY_API_KEY=your_biconomy_api_key
BICONOMY_DApp_ID=your_dapp_id

# Gnosis Safe
GNOSIS_SAFE_ADDRESS=0xYourSafeAddress
GNOSIS_SAFE_API_URL=https://safe-transaction.gnosis.io/api/v1

# Ethereum Network
INFURA_PROJECT_ID=your_infura_project_id
NETWORK=goerli # or mainnet
```

Esta implementaci√≥n combinada ofrece la m√°xima flexibilidad y mejor experiencia de usuario para firmas multisig, adapt√°ndose autom√°ticamente al contexto del usuario.