# ✅ Paso 44: Integrar Dashboard de Firmas Multisig con React + Safe Apps SDK

> **ARCHIVO CONSOLIDADO** - Implementación con React + Safe Apps SDK como opción principal, con alternativa Hotwire para menor complejidad

Ahora agregaremos un Dashboard de Firmas Multisig con React + Safe Apps SDK, permitiendo a los usuarios gestionar y firmar contratos directamente dentro de Gnosis Safe UI.
✅ React + Safe Apps SDK → Para interactuar con contratos en Gnosis Safe.
✅ Web3.js + ethers.js → Manejo de firmas y transacciones on-chain.
✅ Safe Transaction Service API → Para obtener datos de contratos pendientes.
✅ UX optimizada para multisig → Permite visualizar, aprobar y ejecutar transacciones.
✅ Alternativa con Hotwire → Opción sin React para menor complejidad.

## 📌 Commit 44.1: Configurar Proyecto React + Safe Apps SDK
🔹 **Mensaje de commit:**
```
feat(safe-app): configura React con Safe Apps SDK para Dashboard de Firmas Multisig
```

🔹 **Contenido del commit:**

### Crear la App con Vite + React
```bash
npx create-vite safe-app-dashboard --template react
cd safe-app-dashboard
yarn
```

### Instalar Safe Apps SDK y Dependencias Web3
```bash
yarn add @safe-global/safe-apps-react-sdk ethers web3 axios
yarn add @safe-global/safe-apps-sdk @safe-global/safe-core-sdk
yarn add tailwindcss @headlessui/react @heroicons/react
```

### Modificar src/main.jsx para Inicializar Safe Apps SDK
```javascript
import React from "react";
import ReactDOM from "react-dom/client";
import { SafeProvider } from "@safe-global/safe-apps-react-sdk";
import App from "./App";
import "./index.css";

ReactDOM.createRoot(document.getElementById("root")).render(
  <React.StrictMode>
    <SafeProvider>
      <App />
    </SafeProvider>
  </React.StrictMode>
);
```

### Configurar Tailwind CSS
```javascript
// tailwind.config.js
module.exports = {
  content: ["./src/**/*.{js,jsx,ts,tsx}"],
  theme: {
    extend: {},
  },
  plugins: [],
};
```

🔹 **Añadir archivos al commit:**
```bash
git add .
git commit -m "feat(safe-app): configura React con Safe Apps SDK para Dashboard de Firmas Multisig"
```

## 📌 Commit 44.2: Crear Dashboard para Mostrar Firmas Pendientes
🔹 **Mensaje de commit:**
```
feat(safe-app): agrega dashboard para visualizar contratos pendientes en Gnosis Safe
```

🔹 **Contenido del commit:**

### Crear src/components/Dashboard.jsx
```javascript
import { useEffect, useState } from "react";
import { useSafeAppsSDK } from "@safe-global/safe-apps-react-sdk";
import axios from "axios";
import TransactionCard from "./TransactionCard";
import LoadingSpinner from "./LoadingSpinner";

const SAFE_TX_SERVICE = "https://safe-transaction-mainnet.safe.global/api/v1";

const Dashboard = () => {
  const { sdk, safe } = useSafeAppsSDK();
  const [pendingTransactions, setPendingTransactions] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);

  useEffect(() => {
    if (safe.safeAddress) {
      fetchPendingTransactions();
    }
  }, [safe.safeAddress]);

  const fetchPendingTransactions = async () => {
    try {
      setLoading(true);
      const response = await axios.get(
        `${SAFE_TX_SERVICE}/safes/${safe.safeAddress}/multisig-transactions/`,
        {
          params: {
            executed: false,
            limit: 50
          }
        }
      );
      
      const pendingTxs = response.data.results.filter(tx => !tx.isExecuted);
      setPendingTransactions(pendingTxs);
    } catch (err) {
      setError("Error al cargar transacciones pendientes");
      console.error("Error fetching transactions:", err);
    } finally {
      setLoading(false);
    }
  };

  const signTransaction = async (txHash) => {
    try {
      const txDetails = await sdk.txs.getBySafeTxHash(txHash);
      const result = await sdk.txs.signTransaction(txDetails);
      
      if (result) {
        alert(`Transacción firmada exitosamente: ${result.safeTxHash}`);
        await fetchPendingTransactions(); // Refrescar la lista
      }
    } catch (err) {
      console.error("Error signing transaction:", err);
      alert("Error al firmar la transacción: " + err.message);
    }
  };

  if (loading) return <LoadingSpinner />;
  if (error) return <div className="text-red-600 text-center p-4">{error}</div>;

  return (
    <div className="max-w-4xl mx-auto p-6">
      <div className="mb-6">
        <h1 className="text-3xl font-bold text-gray-900 mb-2">
          Contratos Pendientes en Gnosis Safe
        </h1>
        <p className="text-gray-600">
          Safe Address: <span className="font-mono text-sm">{safe.safeAddress}</span>
        </p>
        <p className="text-gray-600">
          Umbral de firmas: {safe.threshold} de {safe.owners.length}
        </p>
      </div>

      {pendingTransactions.length > 0 ? (
        <div className="grid gap-4">
          {pendingTransactions.map(tx => (
            <TransactionCard
              key={tx.safeTxHash}
              transaction={tx}
              onSign={() => signTransaction(tx.safeTxHash)}
              currentUserAddress={safe.owners[0]} // Simplificado
            />
          ))}
        </div>
      ) : (
        <div className="text-center py-12">
          <div className="text-gray-400 mb-4">
            <svg className="mx-auto h-16 w-16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
          </div>
          <h3 className="text-lg font-medium text-gray-900 mb-2">No hay contratos pendientes</h3>
          <p className="text-gray-500">Todas las transacciones han sido ejecutadas o no hay transacciones pendientes.</p>
        </div>
      )}
    </div>
  );
};

export default Dashboard;
```

### Crear src/components/TransactionCard.jsx
```javascript
import { useState } from "react";
import { CheckCircleIcon, ClockIcon, UserGroupIcon } from "@heroicons/react/24/outline";

const TransactionCard = ({ transaction, onSign, currentUserAddress }) => {
  const [signing, setSigning] = useState(false);
  
  const handleSign = async () => {
    setSigning(true);
    try {
      await onSign();
    } finally {
      setSigning(false);
    }
  };

  const isSignedByCurrentUser = transaction.confirmations.some(
    conf => conf.owner.toLowerCase() === currentUserAddress.toLowerCase()
  );

  const progressPercentage = (transaction.confirmations.length / transaction.confirmationsRequired) * 100;

  return (
    <div className="bg-white rounded-lg border border-gray-200 p-6 shadow-sm hover:shadow-md transition-shadow">
      <div className="flex items-start justify-between mb-4">
        <div className="flex-1">
          <h3 className="text-lg font-medium text-gray-900 mb-2">
            Transacción Multisig
          </h3>
          <p className="text-sm text-gray-600 font-mono break-all">
            {transaction.safeTxHash}
          </p>
        </div>
        <div className="ml-4">
          {transaction.confirmations.length >= transaction.confirmationsRequired ? (
            <span className="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
              <CheckCircleIcon className="w-4 h-4 mr-1" />
              Listo para ejecutar
            </span>
          ) : (
            <span className="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
              <ClockIcon className="w-4 h-4 mr-1" />
              Pendiente
            </span>
          )}
        </div>
      </div>

      <div className="mb-4">
        <div className="flex items-center justify-between text-sm text-gray-600 mb-2">
          <span className="flex items-center">
            <UserGroupIcon className="w-4 h-4 mr-1" />
            Firmas: {transaction.confirmations.length} de {transaction.confirmationsRequired}
          </span>
          <span>{Math.round(progressPercentage)}%</span>
        </div>
        <div className="w-full bg-gray-200 rounded-full h-2">
          <div 
            className="bg-blue-600 h-2 rounded-full transition-all duration-300"
            style={{ width: `${progressPercentage}%` }}
          />
        </div>
      </div>

      <div className="mb-4">
        <h4 className="text-sm font-medium text-gray-900 mb-2">Detalles de la Transacción:</h4>
        <div className="bg-gray-50 rounded p-3 text-sm">
          <div className="grid grid-cols-2 gap-2">
            <div>
              <span className="font-medium">Para:</span>
              <p className="font-mono text-xs break-all">{transaction.to}</p>
            </div>
            <div>
              <span className="font-medium">Valor:</span>
              <p>{transaction.value || '0'} ETH</p>
            </div>
          </div>
          {transaction.data && (
            <div className="mt-2">
              <span className="font-medium">Data:</span>
              <p className="font-mono text-xs break-all bg-white p-2 rounded mt-1">
                {transaction.data.slice(0, 100)}...
              </p>
            </div>
          )}
        </div>
      </div>

      <div className="mb-4">
        <h4 className="text-sm font-medium text-gray-900 mb-2">Firmantes:</h4>
        <div className="space-y-1">
          {transaction.confirmations.map((confirmation, index) => (
            <div key={index} className="flex items-center text-sm">
              <CheckCircleIcon className="w-4 h-4 text-green-500 mr-2" />
              <span className="font-mono text-xs">{confirmation.owner}</span>
            </div>
          ))}
        </div>
      </div>

      <div className="flex justify-end space-x-3">
        {!isSignedByCurrentUser && (
          <button
            onClick={handleSign}
            disabled={signing}
            className="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed"
          >
            {signing ? (
              <>
                <svg className="animate-spin -ml-1 mr-2 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                  <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                  <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Firmando...
              </>
            ) : (
              'Firmar Transacción'
            )}
          </button>
        )}
        
        {isSignedByCurrentUser && (
          <span className="inline-flex items-center px-4 py-2 text-sm font-medium text-green-700 bg-green-100 rounded-md">
            <CheckCircleIcon className="w-4 h-4 mr-2" />
            Ya firmaste
          </span>
        )}
      </div>
    </div>
  );
};

export default TransactionCard;
```

### Crear src/components/LoadingSpinner.jsx
```javascript
const LoadingSpinner = () => {
  return (
    <div className="flex items-center justify-center p-8">
      <svg className="animate-spin -ml-1 mr-3 h-8 w-8 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
        <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
      </svg>
      <span className="text-gray-600">Cargando transacciones...</span>
    </div>
  );
};

export default LoadingSpinner;
```

### Modificar src/App.jsx para Mostrar Dashboard
```javascript
import { useSafeAppsSDK } from "@safe-global/safe-apps-react-sdk";
import Dashboard from "./components/Dashboard";

function App() {
  const { sdk, safe, connected } = useSafeAppsSDK();

  if (!connected) {
    return (
      <div className="min-h-screen bg-gray-50 flex items-center justify-center">
        <div className="text-center">
          <div className="text-gray-400 mb-4">
            <svg className="mx-auto h-16 w-16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
            </svg>
          </div>
          <h3 className="text-lg font-medium text-gray-900 mb-2">Conectando con Gnosis Safe</h3>
          <p className="text-gray-500">Esta aplicación debe ejecutarse dentro de Gnosis Safe.</p>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gray-50">
      <Dashboard />
    </div>
  );
}

export default App;
```

🔹 **Añadir archivos al commit:**
```bash
git add .
git commit -m "feat(safe-app): agrega dashboard para visualizar contratos pendientes en Gnosis Safe"
```

## 📌 Commit 44.3: Agregar Firma de Contratos desde Safe Apps
🔹 **Mensaje de commit:**
```
feat(safe-app): agrega funcionalidad para firmar contratos pendientes desde Safe Apps
```

🔹 **Contenido del commit:**

### Crear src/services/SafeService.js
```javascript
import { SafeFactory } from '@safe-global/safe-core-sdk';
import EthersAdapter from '@safe-global/safe-ethers-lib';
import { ethers } from 'ethers';

class SafeService {
  constructor(sdk) {
    this.sdk = sdk;
    this.ethAdapter = null;
    this.safeSdk = null;
  }

  async initialize() {
    try {
      // Inicializar el adapter de ethers
      const provider = new ethers.providers.Web3Provider(window.ethereum);
      const signer = provider.getSigner();
      this.ethAdapter = new EthersAdapter({
        ethers,
        signerOrProvider: signer
      });

      // Crear instancia de Safe SDK
      this.safeSdk = await SafeFactory.create({
        ethAdapter: this.ethAdapter,
        safeAddress: this.sdk.safe.safeAddress
      });

      return true;
    } catch (error) {
      console.error('Error inicializando SafeService:', error);
      return false;
    }
  }

  async signTransaction(safeTxHash) {
    try {
      if (!this.safeSdk) {
        const initialized = await this.initialize();
        if (!initialized) {
          throw new Error('No se pudo inicializar SafeService');
        }
      }

      // Obtener la transacción pendiente
      const pendingTx = await this.safeSdk.getTransaction(safeTxHash);
      
      // Firmar la transacción
      const signedTx = await this.safeSdk.signTransaction(pendingTx);
      
      // Enviar la firma al servicio de transacciones de Safe
      const result = await this.sdk.txs.confirmTransaction({
        safeTxHash: safeTxHash,
        signature: signedTx.signatures
      });

      return result;
    } catch (error) {
      console.error('Error firmando transacción:', error);
      throw error;
    }
  }

  async executeTransaction(safeTxHash) {
    try {
      if (!this.safeSdk) {
        await this.initialize();
      }

      const pendingTx = await this.safeSdk.getTransaction(safeTxHash);
      const executeTxResponse = await this.safeSdk.executeTransaction(pendingTx);
      
      return executeTxResponse;
    } catch (error) {
      console.error('Error ejecutando transacción:', error);
      throw error;
    }
  }

  async isTransactionExecutable(safeTxHash) {
    try {
      const transaction = await this.safeSdk.getTransaction(safeTxHash);
      return transaction.confirmations.length >= this.sdk.safe.threshold;
    } catch (error) {
      console.error('Error verificando si la transacción es ejecutable:', error);
      return false;
    }
  }
}

export default SafeService;
```

### Integrar SafeService en Dashboard.jsx
```javascript
// Añadir al inicio del archivo Dashboard.jsx
import SafeService from '../services/SafeService';

// Dentro del componente Dashboard, agregar:
const [safeService, setSafeService] = useState(null);

useEffect(() => {
  if (sdk && safe.safeAddress) {
    const service = new SafeService(sdk);
    setSafeService(service);
  }
}, [sdk, safe.safeAddress]);

// Modificar la función signTransaction:
const signTransaction = async (txHash) => {
  try {
    if (!safeService) {
      throw new Error('SafeService no inicializado');
    }

    const result = await safeService.signTransaction(txHash);
    
    if (result) {
      alert(`Transacción firmada exitosamente: ${txHash}`);
      await fetchPendingTransactions();
      
      // Verificar si la transacción puede ser ejecutada
      const canExecute = await safeService.isTransactionExecutable(txHash);
      if (canExecute) {
        const shouldExecute = confirm('La transacción tiene suficientes firmas. ¿Quieres ejecutarla ahora?');
        if (shouldExecute) {
          await executeTransaction(txHash);
        }
      }
    }
  } catch (err) {
    console.error('Error signing transaction:', err);
    alert('Error al firmar la transacción: ' + err.message);
  }
};

// Agregar función para ejecutar transacción:
const executeTransaction = async (txHash) => {
  try {
    const result = await safeService.executeTransaction(txHash);
    alert(`Transacción ejecutada exitosamente: ${result.hash}`);
    await fetchPendingTransactions();
  } catch (err) {
    console.error('Error executing transaction:', err);
    alert('Error al ejecutar la transacción: ' + err.message);
  }
};
```

🔹 **Añadir archivos al commit:**
```bash
git add .
git commit -m "feat(safe-app): agrega funcionalidad para firmar contratos pendientes desde Safe Apps"
```

## 📝 Explicación y Código Generado

### Ejemplo de Firma de Contrato en Safe Apps
1. El usuario abre el Safe App dentro de Gnosis Safe.
2. El Dashboard muestra los contratos pendientes de firma.
3. El usuario selecciona un contrato y firma la transacción.
4. La firma se registra en Gnosis Safe y se transmite a la Blockchain.

### Ejemplo de Uso del Safe SDK en React
```javascript
// Firmar una transacción
const signTransaction = async (safeTxHash) => {
  const safeService = new SafeService(sdk);
  await safeService.initialize();
  const result = await safeService.signTransaction(safeTxHash);
  return result;
};
```

### Ejemplo de Verificación de Firma con Safe API
```bash
curl -X GET "https://safe-transaction-mainnet.safe.global/api/v1/safes/0xSafeAddress/multisig-transactions/"
```

## 🔄 Alternativa con Hotwire (Opción sin React)

### Para equipos que prefieren menor complejidad:

```ruby
# app/controllers/safe_dashboard_controller.rb
class SafeDashboardController < ApplicationController
  def index
    @pending_transactions = fetch_pending_transactions
  end

  def sign
    # Lógica de firmado con Hotwire
    respond_to do |format|
      format.turbo_stream
    end
  end

  private

  def fetch_pending_transactions
    # Llamada a Safe Transaction Service API
  end
end
```

```erb
<!-- app/views/safe_dashboard/index.html.erb -->
<div data-controller="safe-dashboard">
  <h1>Contratos Pendientes en Gnosis Safe</h1>
  
  <% @pending_transactions.each do |tx| %>
    <div class="transaction-card">
      <!-- HTML con ViewComponents y Stimulus.js -->
      <button data-action="click->safe-dashboard#signTransaction" 
              data-tx-hash="<%= tx.hash %>">
        Firmar
      </button>
    </div>
  <% end %>
</div>
```

## 🔧 Configuración de Deployment

### Variables de Entorno
```bash
# Safe Configuration
SAFE_APP_URL=https://your-safe-app.com
SAFE_TRANSACTION_SERVICE_URL=https://safe-transaction-mainnet.safe.global

# Network Configuration  
ETHEREUM_NETWORK=mainnet
INFURA_PROJECT_ID=your_infura_project_id
```

### Manifest para Safe Apps
```json
{
  "name": "Portfolio Multisig Dashboard",
  "description": "Dashboard para gestionar firmas multisig en contratos",
  "iconPath": "logo.svg",
  "website": "https://your-website.com",
  "version": "1.0.0"
}
```