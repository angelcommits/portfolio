# ‚úÖ Paso 55: Reemplazar Devise por Rodauth con SQLite en desarrollo y PostgreSQL en producci√≥n

Implementaremos una migraci√≥n completa de Devise a Rodauth, manteniendo compatibilidad con Web3 Sign-In, Passkeys (WebAuthn) y Social Login, con configuraci√≥n optimizada de base de datos por entorno.

## üéØ Tecnolog√≠as Integradas

‚úÖ **Rodauth (Autenticaci√≥n sobre Sequel)** ‚Üí M√°s flexible y seguro que Devise  
‚úÖ **SQLite en desarrollo y test, PostgreSQL en staging y producci√≥n** ‚Üí Optimizaci√≥n seg√∫n entorno  
‚úÖ **Integraci√≥n con Web3 ID (Ethereum Sign-In)** ‚Üí Compatible con Gnosis Safe y Argent  
‚úÖ **Compatibilidad con Passkeys (WebAuthn) y Social Login** ‚Üí M√©todos alternativos de autenticaci√≥n  
‚úÖ **Turbo Streams + Stimulus.js** ‚Üí Para una experiencia de usuario fluida  
‚úÖ **Migraci√≥n completa desde Devise** ‚Üí Proceso paso a paso sin p√©rdida de datos  

## üìå Commit 55.1: Instalar Rodauth y Configurar Base de Datos con Sequel

üîπ **Mensaje de commit:**
```
feat(auth): instala Rodauth y configura Sequel con SQLite en desarrollo y PostgreSQL en producci√≥n
```

üîπ **Contenido del commit:**

**Instalar Rodauth y dependencias:**
```bash
bundle add rodauth sequel roda bcrypt
bundle add sqlite3 --group development,test
bundle add pg --group staging,production
```

**Configurar Base de Datos** en `config/database.yml`:
```yaml
default: &default
  encoding: utf8
  pool: <%= ENV.fetch("RAILS_MAX_THREADS") { 5 } %>
  timeout: 5000

development:
  <<: *default
  adapter: sqlite3
  database: db/development.sqlite3

test:
  <<: *default
  adapter: sqlite3
  database: db/test.sqlite3

staging:
  <<: *default
  adapter: postgresql
  database: <%= ENV.fetch("DATABASE_NAME") { "myapp_staging" } %>
  username: <%= ENV.fetch("DATABASE_USERNAME") { "postgres" } %>
  password: <%= ENV["DATABASE_PASSWORD"] %>
  host: <%= ENV.fetch("DATABASE_HOST") { "localhost" } %>
  port: <%= ENV.fetch("DATABASE_PORT") { 5432 } %>

production:
  <<: *default
  adapter: postgresql
  database: <%= ENV.fetch("DATABASE_NAME") { "myapp_production" } %>
  username: <%= ENV.fetch("DATABASE_USERNAME") { "postgres" } %>
  password: <%= ENV["DATABASE_PASSWORD"] %>
  host: <%= ENV.fetch("DATABASE_HOST") { "localhost" } %>
  port: <%= ENV.fetch("DATABASE_PORT") { 5432 } %>
  pool: <%= ENV.fetch("RAILS_MAX_THREADS") { 20 } %>
```

**Crear configuraci√≥n de Sequel** en `config/sequel.rb`:
```ruby
require 'sequel'

# Database connection with environment-specific configuration
database_config = Rails.application.config.database_configuration[Rails.env]

case Rails.env
when 'development', 'test'
  DB = Sequel.sqlite(database_config['database'])
when 'staging', 'production'
  DB = Sequel.connect(
    adapter: 'postgres',
    host: database_config['host'],
    port: database_config['port'],
    database: database_config['database'],
    user: database_config['username'],
    password: database_config['password'],
    max_connections: database_config['pool']
  )
end

# Configure Sequel for Rails integration
DB.extension :pg_json if Rails.env.production? || Rails.env.staging?
DB.extension :pg_inet if Rails.env.production? || Rails.env.staging?

# Log SQL queries in development
if Rails.env.development?
  DB.loggers << Logger.new($stdout)
end
```

## üìå Commit 55.2: Generar y Configurar Rodauth

üîπ **Mensaje de commit:**
```
feat(auth): configura Rodauth como sistema de autenticaci√≥n principal en Rails
```

**Generar instalaci√≥n de Rodauth:**
```bash
rails generate rodauth:install --name=main
```

**Configurar** `app/misc/rodauth_main.rb`:
```ruby
require 'rodauth'
require 'sequel/core'

class RodauthMain < Rodauth::Auth
  configure do
    # Enable required features
    enable :login, :logout, :create_account, :verify_account, :reset_password, 
           :change_password, :change_login, :remember, :lockout,
           :otp, :webauthn, :jwt, :active_sessions

    # Database configuration
    db DB
    accounts_table :users
    
    # Authentication columns
    login_column :email
    account_password_hash_column :password_digest
    
    # Additional columns for Web3 support
    account_select_additional_columns :wallet_address, :wallet_type, :wallet_provider
    
    # Session configuration
    session_key_prefix 'rodauth_'
    remember_cookie_key '_remember_token'
    
    # Security settings
    password_minimum_length 8
    max_invalid_logins 5
    account_lockouts_deadline_interval 60 * 60 # 1 hour
    
    # JWT configuration for API
    jwt_secret Rails.application.credentials.secret_key_base
    jwt_access_token_period 60 * 60 # 1 hour
    
    # Email configuration (using ActionMailer)
    create_reset_password_email do
      UserMailer.reset_password_email(email_to, reset_password_key_value)
    end
    
    create_verify_account_email do
      UserMailer.verify_account_email(email_to, verify_account_key_value)
    end
    
    create_unlock_account_email do
      UserMailer.unlock_account_email(email_to, unlock_account_key_value)
    end
    
    # Web3 authentication support
    auth_class_eval do
      def authenticate_login_password(given_password)
        # Handle traditional password authentication
        if account && password_hash_match?(given_password)
          return true
        end

        # Handle Web3 signature authentication
        if params['signature'].present? && params['nonce'].present?
          return authenticate_web3_signature
        end

        false
      end

      def account_from_login(login)
        # Try email first
        account = super(login)
        return account if account

        # Try wallet address if email not found
        account_ds.where(wallet_address: login.downcase).first
      end

      private

      def authenticate_web3_signature
        wallet_address = login_param
        signature = param('signature')
        nonce = param('nonce')
        
        return false unless wallet_address && signature && nonce

        message = build_web3_message(nonce)

        # Handle Smart Contract Wallets and EOA
        if verify_web3_signature(wallet_address, message, signature)
          # Find or create account
          account = account_ds.where(wallet_address: wallet_address.downcase).first
          
          unless account
            # Auto-create account for Web3 users
            account_id = create_web3_account(wallet_address)
            @account = account_ds.where(id: account_id).first
          else
            @account = account
          end
          
          return true
        end

        false
      end

      def verify_web3_signature(wallet_address, message, signature)
        # Try EOA verification first
        begin
          signer_address = Ethereum::Message.verify_signature(message, signature)
          return true if signer_address.downcase == wallet_address.downcase
        rescue
          # Ignore EOA verification errors, try Smart Contract Wallet
        end

        # Try Smart Contract Wallet verification
        SmartContractWalletService.verify_signature(wallet_address, message, signature)
      end

      def build_web3_message(nonce)
        timestamp = Time.current.to_i
        "Welcome to #{Rails.application.class.module_parent_name}.\n\nNonce: #{nonce}\nTimestamp: #{timestamp}"
      end

      def create_web3_account(wallet_address)
        # Detect wallet type
        wallet_info = detect_wallet_type(wallet_address)
        
        account_ds.insert(
          email: "#{wallet_address.downcase}@web3.local", # Placeholder email
          wallet_address: wallet_address.downcase,
          wallet_type: wallet_info[:type],
          wallet_provider: wallet_info[:provider],
          status: account_open_status_value, # Account is open by default for Web3
          created_at: Time.current,
          updated_at: Time.current
        )
      end

      def detect_wallet_type(wallet_address)
        # Simple wallet type detection (can be enhanced)
        begin
          # This would integrate with the WalletDetector service
          code = Rails.cache.fetch("wallet_code_#{wallet_address}", expires_in: 1.hour) do
            web3 = Web3::Eth::Rpc.new(host: Rails.application.credentials.dig(:ethereum, :rpc_url))
            web3.eth.get_code(wallet_address)
          end
          
          if code != "0x" && code != "0x0"
            { type: 'smart_contract', provider: 'unknown' }
          else
            { type: 'eoa', provider: 'metamask' }
          end
        rescue
          { type: 'eoa', provider: 'unknown' }
        end
      end
    end

    # Redirect configuration
    login_redirect '/'
    logout_redirect '/auth/login'
    create_account_redirect '/auth/verify-account'
    
    # Template configuration
    prefix '/auth'
    login_route 'login'
    logout_route 'logout'
    create_account_route 'register'
  end
end
```

## üìå Commit 55.3: Crear Migraciones para Rodauth

üîπ **Mensaje de commit:**
```
feat(auth): agrega migraciones de Rodauth para manejo de usuarios y autenticaci√≥n
```

**Generar migraciones base:**
```bash
rails generate rodauth:migration
```

**Crear migraci√≥n personalizada** para Web3 support:
```bash
rails generate migration AddWeb3SupportToUsers wallet_address:string:uniq wallet_type:string wallet_provider:string wallet_metadata:json
```

**Modificar migraci√≥n** `db/migrate/[timestamp]_add_web3_support_to_users.rb`:
```ruby
class AddWeb3SupportToUsers < ActiveRecord::Migration[7.0]
  def change
    add_column :users, :wallet_address, :string
    add_column :users, :wallet_type, :string, default: 'eoa'
    add_column :users, :wallet_provider, :string
    add_column :users, :wallet_metadata, :json, default: {}
    add_column :users, :supports_eip1271, :boolean, default: false
    
    # Indexes for performance
    add_index :users, :wallet_address, unique: true
    add_index :users, :wallet_type
    add_index :users, :wallet_provider
    
    # Make email nullable for Web3-only accounts
    change_column_null :users, :email, true
    
    # Add constraint to ensure either email or wallet_address is present
    execute <<-SQL
      ALTER TABLE users ADD CONSTRAINT email_or_wallet_required 
      CHECK (email IS NOT NULL OR wallet_address IS NOT NULL)
    SQL
  end
end
```

**Ejecutar migraciones:**
```bash
rails db:migrate
```

## üìå Commit 55.4: Integrar Web3 Sign-In en Rodauth

üîπ **Mensaje de commit:**
```
feat(web3id): integra Web3 Sign-In con Rodauth para autenticaci√≥n con Ethereum
```

**Crear controlador** para Web3 authentication `app/controllers/web3_auth_controller.rb`:
```ruby
class Web3AuthController < ApplicationController
  skip_before_action :verify_authenticity_token, only: [:nonce, :login]
  
  def nonce
    # Generate secure nonce for Web3 authentication
    nonce = SecureRandom.hex(16)
    session[:web3_nonce] = nonce
    session[:web3_nonce_expires] = 5.minutes.from_now
    
    render json: { 
      nonce: nonce,
      expires_at: session[:web3_nonce_expires].to_i,
      message_template: "Welcome to #{Rails.application.class.module_parent_name}.\n\nNonce: {nonce}\nTimestamp: {timestamp}"
    }
  end

  def login
    nonce = session[:web3_nonce]
    expires_at = session[:web3_nonce_expires]
    
    if !nonce || !expires_at || Time.current > expires_at
      return render json: { error: "Invalid or expired nonce" }, status: :unauthorized
    end

    wallet_address = params[:wallet_address]&.downcase
    signature = params[:signature]
    
    if !wallet_address || !signature
      return render json: { error: "Missing wallet_address or signature" }, status: :bad_request
    end

    # Use Rodauth for authentication
    rodauth = RodauthMain.allocate
    rodauth.instance_variable_set(:@scope, self)
    
    # Set parameters for Rodauth
    rodauth.instance_variable_set(:@params, {
      'login' => wallet_address,
      'signature' => signature,
      'nonce' => nonce
    })

    if rodauth.authenticate_login_password(nil) # Web3 auth doesn't use password
      # Clear nonce after successful authentication
      session.delete(:web3_nonce)
      session.delete(:web3_nonce_expires)
      
      # Set Rodauth session
      session[:rodauth_user_id] = rodauth.account[:id]
      
      user_data = {
        id: rodauth.account[:id],
        email: rodauth.account[:email],
        wallet_address: rodauth.account[:wallet_address],
        wallet_type: rodauth.account[:wallet_type],
        wallet_provider: rodauth.account[:wallet_provider]
      }

      render json: { 
        message: "Authentication successful", 
        user: user_data,
        redirect_to: rodauth.login_redirect
      }
    else
      render json: { error: "Invalid signature" }, status: :unauthorized
    end
  end

  def logout
    rodauth = RodauthMain.allocate
    rodauth.instance_variable_set(:@scope, self)
    
    rodauth.logout
    
    render json: { message: "Logged out successfully" }
  end
end
```

**Agregar rutas** en `config/routes.rb`:
```ruby
Rails.application.routes.draw do
  # Rodauth routes
  mount RodauthApp, at: "/auth"
  
  # Web3 authentication routes
  namespace :auth do
    get :web3_nonce, to: 'web3_auth#nonce'
    post :web3_login, to: 'web3_auth#login'
    delete :web3_logout, to: 'web3_auth#logout'
  end
  
  # Your other routes...
end
```

## üìå Commit 55.5: Crear UI para Autenticaci√≥n H√≠brida

üîπ **Mensaje de commit:**
```
feat(auth): agrega UI para autenticaci√≥n h√≠brida (email/password y Web3)
```

**Crear** `app/views/rodauth/login.html.erb`:
```erb
<div class="min-h-screen bg-gray-50 flex flex-col justify-center py-12 sm:px-6 lg:px-8">
  <div class="sm:mx-auto sm:w-full sm:max-w-md">
    <h2 class="mt-6 text-center text-3xl font-extrabold text-gray-900">
      Sign in to your account
    </h2>
    <p class="mt-2 text-center text-sm text-gray-600">
      Choose your preferred authentication method
    </p>
  </div>

  <div class="mt-8 sm:mx-auto sm:w-full sm:max-w-md">
    <div class="bg-white py-8 px-4 shadow sm:rounded-lg sm:px-10">
      
      <!-- Web3 Authentication Section -->
      <div class="mb-8" data-controller="web3-auth">
        <h3 class="text-lg font-medium text-gray-900 mb-4">Web3 Authentication</h3>
        
        <button type="button"
                class="w-full flex justify-center items-center py-3 px-4 border border-orange-300 rounded-md shadow-sm bg-orange-50 text-sm font-medium text-orange-700 hover:bg-orange-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-orange-500 transition-colors"
                data-action="click->web3-auth#connectWallet">
          <svg class="w-5 h-5 mr-2" viewBox="0 0 24 24" fill="currentColor">
            <path d="M3.06 13.94L5.81 16.69C7.35 18.23 9.64 18.23 11.18 16.69L13.94 13.94C15.48 12.4 15.48 10.11 13.94 8.57L11.18 5.81C9.64 4.27 7.35 4.27 5.81 5.81L3.06 8.57C1.52 10.11 1.52 12.4 3.06 13.94Z"/>
          </svg>
          Connect Wallet
        </button>
        
        <div data-web3-auth-target="status" class="mt-3 hidden"></div>
        <div data-web3-auth-target="walletInfo" class="mt-3 hidden"></div>
        
        <button type="button"
                class="w-full mt-3 flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors opacity-50"
                data-action="click->web3-auth#signMessage"
                data-web3-auth-target="signButton"
                disabled>
          Sign with Wallet
        </button>
      </div>

      <!-- Divider -->
      <div class="relative">
        <div class="absolute inset-0 flex items-center">
          <div class="w-full border-t border-gray-300" />
        </div>
        <div class="relative flex justify-center text-sm">
          <span class="px-2 bg-white text-gray-500">Or continue with email</span>
        </div>
      </div>

      <!-- Traditional Email/Password Authentication -->
      <form class="mt-8 space-y-6" action="<%= rodauth.login_path %>" method="post">
        <%= csrf_tag %>
        
        <div>
          <label for="email" class="block text-sm font-medium text-gray-700">
            Email address
          </label>
          <div class="mt-1">
            <input id="email" 
                   name="<%= rodauth.login_param %>" 
                   type="email" 
                   autocomplete="email" 
                   required 
                   class="appearance-none block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                   placeholder="Enter your email">
          </div>
        </div>

        <div>
          <label for="password" class="block text-sm font-medium text-gray-700">
            Password
          </label>
          <div class="mt-1">
            <input id="password" 
                   name="<%= rodauth.password_param %>" 
                   type="password" 
                   autocomplete="current-password" 
                   required 
                   class="appearance-none block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                   placeholder="Enter your password">
          </div>
        </div>

        <div class="flex items-center justify-between">
          <div class="flex items-center">
            <input id="remember" 
                   name="<%= rodauth.remember_param %>" 
                   type="checkbox" 
                   class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
            <label for="remember" class="ml-2 block text-sm text-gray-900">
              Remember me
            </label>
          </div>

          <div class="text-sm">
            <a href="<%= rodauth.reset_password_request_path %>" 
               class="font-medium text-blue-600 hover:text-blue-500">
              Forgot your password?
            </a>
          </div>
        </div>

        <div>
          <button type="submit"
                  class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
            Sign in
          </button>
        </div>
      </form>

      <!-- Create Account Link -->
      <div class="mt-6 text-center">
        <p class="text-sm text-gray-600">
          Don't have an account?
          <a href="<%= rodauth.create_account_path %>" 
             class="font-medium text-blue-600 hover:text-blue-500">
            Create one here
          </a>
        </p>
      </div>

      <!-- Social Login Section (if enabled) -->
      <% if defined?(OmniAuth) %>
        <div class="mt-6">
          <div class="relative">
            <div class="absolute inset-0 flex items-center">
              <div class="w-full border-t border-gray-300" />
            </div>
            <div class="relative flex justify-center text-sm">
              <span class="px-2 bg-white text-gray-500">Or continue with</span>
            </div>
          </div>

          <div class="mt-6 grid grid-cols-3 gap-3">
            <a href="/auth/google_oauth2"
               class="w-full inline-flex justify-center py-2 px-4 border border-gray-300 rounded-md shadow-sm bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
              <svg class="w-5 h-5" viewBox="0 0 24 24">
                <path fill="currentColor" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                <path fill="currentColor" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                <path fill="currentColor" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                <path fill="currentColor" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
              </svg>
            </a>

            <a href="/auth/twitter"
               class="w-full inline-flex justify-center py-2 px-4 border border-gray-300 rounded-md shadow-sm bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
              <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                <path d="M23.953 4.57a10 10 0 01-2.825.775 4.958 4.958 0 002.163-2.723c-.951.555-2.005.959-3.127 1.184a4.92 4.92 0 00-8.384 4.482C7.69 8.095 4.067 6.13 1.64 3.162a4.822 4.822 0 00-.666 2.475c0 1.71.87 3.213 2.188 4.096a4.904 4.904 0 01-2.228-.616v.06a4.923 4.923 0 003.946 4.827 4.996 4.996 0 01-2.212.085 4.936 4.936 0 004.604 3.417 9.867 9.867 0 01-6.102 2.105c-.39 0-.779-.023-1.17-.067a13.995 13.995 0 007.557 2.209c9.053 0 13.998-7.496 13.998-13.985 0-.21 0-.42-.015-.63A9.935 9.935 0 0024 4.59z"/>
              </svg>
            </a>

            <a href="/auth/discord"
               class="w-full inline-flex justify-center py-2 px-4 border border-gray-300 rounded-md shadow-sm bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
              <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                <path d="M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515a.074.074 0 0 0-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 0 0-5.487 0a12.64 12.64 0 0 0-.617-1.25a.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.677 4.37a.07.07 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 0 0 .031.057a19.9 19.9 0 0 0 5.993 3.03a.078.078 0 0 0 .084-.028a14.09 14.09 0 0 0 1.226-1.994a.076.076 0 0 0-.041-.106a13.107 13.107 0 0 1-1.872-.892a.077.077 0 0 1-.008-.128a10.2 10.2 0 0 0 .372-.292a.074.074 0 0 1 .077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.12.098.246.198.373.292a.077.077 0 0 1-.006.127a12.299 12.299 0 0 1-1.873.892a.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028a19.839 19.839 0 0 0 6.002-3.03a.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03z"/>
              </svg>
            </a>
          </div>
        </div>
      <% end %>
    </div>
  </div>
</div>
```

## üìå Commit 55.6: Migrar Datos Existentes de Devise

üîπ **Mensaje de commit:**
```
feat(migration): agrega tarea Rake para migrar datos de Devise a Rodauth
```

**Crear tarea Rake** `lib/tasks/migrate_devise_to_rodauth.rake`:
```ruby
namespace :auth do
  desc "Migrate user data from Devise to Rodauth"
  task migrate_devise_to_rodauth: :environment do
    puts "Starting migration from Devise to Rodauth..."
    
    migrated_count = 0
    error_count = 0
    
    User.find_each do |user|
      begin
        # Migrate basic user data
        user_data = {
          id: user.id,
          email: user.email,
          password_digest: user.encrypted_password, # Devise uses encrypted_password
          status: user.confirmed_at ? 2 : 1, # 2 = verified, 1 = unverified
          created_at: user.created_at,
          updated_at: user.updated_at
        }

        # Add Web3 data if present
        if user.respond_to?(:wallet_address) && user.wallet_address.present?
          user_data.merge!(
            wallet_address: user.wallet_address.downcase,
            wallet_type: user.wallet_type || 'eoa',
            wallet_provider: user.wallet_provider || 'unknown'
          )
        end

        # Insert into Rodauth tables using Sequel
        DB[:users].insert(user_data)
        
        # Migrate remember tokens if present
        if user.respond_to?(:remember_token) && user.remember_token.present?
          DB[:account_remember_keys].insert(
            id: user.id,
            key: user.remember_token,
            deadline: user.remember_created_at + 2.weeks
          )
        end

        # Migrate email verification if not confirmed
        unless user.confirmed_at
          DB[:account_verification_keys].insert(
            id: user.id,
            key: SecureRandom.urlsafe_base64(32),
            requested_at: user.created_at,
            email: user.email
          )
        end

        migrated_count += 1
        puts "‚úì Migrated user: #{user.email}"
        
      rescue => e
        error_count += 1
        puts "‚úó Error migrating user #{user.id}: #{e.message}"
      end
    end
    
    puts "\nMigration completed!"
    puts "Successfully migrated: #{migrated_count} users"
    puts "Errors: #{error_count} users"
    
    if error_count > 0
      puts "\nPlease review the errors above and fix any issues before proceeding."
    else
      puts "\nYou can now safely remove Devise from your application."
    end
  end

  desc "Cleanup Devise data after successful migration"
  task cleanup_devise: :environment do
    puts "Cleaning up Devise data..."
    
    devise_tables = %w[
      devise_users
      devise_confirmations  
      devise_reset_passwords
      devise_unlock_tokens
    ]
    
    devise_tables.each do |table|
      if ActiveRecord::Base.connection.table_exists?(table)
        ActiveRecord::Base.connection.drop_table(table)
        puts "‚úì Dropped table: #{table}"
      end
    end
    
    puts "Devise cleanup completed!"
  end
end
```

## üìå Commit 55.7: Eliminar Devise y Limpiar C√≥digo

üîπ **Mensaje de commit:**
```
chore(auth): elimina Devise y limpia configuraci√≥n no utilizada
```

**Eliminar Devise del Gemfile:**
```bash
bundle remove devise
```

**Limpiar configuraci√≥n** en `config/application.rb`:
```ruby
# Remove Devise configuration
# config.filter_parameters += [:password]

# Add Rodauth configuration
config.filter_parameters += [:password, :signature, :private_key]
```

**Eliminar configuraci√≥n Devise** `config/initializers/devise.rb`:
```bash
rm config/initializers/devise.rb
```

**Actualizar** `config/routes.rb`:
```ruby
Rails.application.routes.draw do
  # Remove Devise routes
  # devise_for :users
  
  # Add Rodauth routes
  mount RodauthApp, at: "/auth"
  
  # Web3 authentication routes
  namespace :auth do
    get :web3_nonce, to: 'web3_auth#nonce'
    post :web3_login, to: 'web3_auth#login'
    delete :web3_logout, to: 'web3_auth#logout'
  end
  
  # Your application routes
  root 'home#index'
end
```

## üìù Proceso de Migraci√≥n y Testing

### Pasos para Migraci√≥n Segura

1. **Backup de Base de Datos**:
```bash
# Para SQLite (development)
cp db/development.sqlite3 db/development.sqlite3.backup

# Para PostgreSQL (production)
pg_dump myapp_production > backup_before_rodauth.sql
```

2. **Ejecutar Migraci√≥n**:
```bash
rails auth:migrate_devise_to_rodauth
```

3. **Verificar Datos**:
```bash
rails console
# Verificar que los usuarios existen en Rodauth
DB[:users].count
DB[:users].where(email: 'test@example.com').first
```

4. **Testing de Autenticaci√≥n**:
```bash
# Test Web3 auth
curl -X GET "http://localhost:3000/auth/web3_nonce"
curl -X POST "http://localhost:3000/auth/web3_login" \
  -H "Content-Type: application/json" \
  -d '{"wallet_address": "0x123...", "signature": "0xabc..."}'

# Test traditional auth
curl -X POST "http://localhost:3000/auth/login" \
  -F "email=test@example.com" \
  -F "password=password123"
```

### Ejemplo de Configuraci√≥n por Entorno

**Development (.env.development):**
```bash
DATABASE_URL=sqlite://db/development.sqlite3
RODAUTH_SESSION_SECRET=development_secret_key
```

**Production (.env.production):**
```bash
DATABASE_URL=postgres://user:pass@localhost/myapp_production
DATABASE_NAME=myapp_production
DATABASE_USERNAME=postgres
DATABASE_PASSWORD=secure_password
DATABASE_HOST=db.example.com
DATABASE_PORT=5432
RODAUTH_SESSION_SECRET=production_secret_key_from_credentials
```

## üéØ Ventajas de la Migraci√≥n a Rodauth

1. **üîß Mayor Flexibilidad**: Control total sobre el flujo de autenticaci√≥n
2. **üõ°Ô∏è Mejor Seguridad**: Configuraci√≥n de seguridad m√°s granular  
3. **üåê Web3 Native**: Soporte nativo para autenticaci√≥n blockchain
4. **üìä Multi-Database**: Configuraci√≥n optimizada por entorno
5. **üéØ Menos Magia**: C√≥digo m√°s expl√≠cito y mantenible
6. **‚ö° Mejor Performance**: Sequel es m√°s eficiente que ActiveRecord para auth

Esta implementaci√≥n proporciona una migraci√≥n completa y segura de Devise a Rodauth, manteniendo toda la funcionalidad existente mientras agrega capacidades Web3 avanzadas.