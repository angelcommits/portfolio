# ‚úÖ Paso 57: Agregar Multi-Factor Authentication (MFA) con TOTP y SMS en Rodauth

Implementaremos un sistema completo de Multi-Factor Authentication (MFA) integrado con Rodauth, soportando TOTP (Google Authenticator, Authy) y SMS, con interfaz moderna y flujo de usuario optimizado.

## üéØ Tecnolog√≠as Integradas

‚úÖ **Rodauth MFA (Multi-Factor Authentication)** ‚Üí Seguridad adicional con OTP/SMS integrado nativamente  
‚úÖ **TOTP (Google Authenticator, Authy)** ‚Üí C√≥digos temporales basados en tiempo (RFC 6238)  
‚úÖ **Twilio SMS API** ‚Üí Para enviar c√≥digos de verificaci√≥n por SMS  
‚úÖ **QR Code Generation** ‚Üí Para facilitar configuraci√≥n de TOTP  
‚úÖ **Turbo Streams + Stimulus.js** ‚Üí Para UX fluida sin recargas  
‚úÖ **Backup Codes** ‚Üí C√≥digos de recuperaci√≥n para acceso de emergencia  

## üìå Commit 57.1: Configurar MFA en Rodauth

üîπ **Mensaje de commit:**
```
feat(mfa): agrega configuraci√≥n de Multi-Factor Authentication (TOTP + SMS) en Rodauth
```

üîπ **Contenido del commit:**

**Instalar gems requeridas:**
```bash
bundle add rotp qrcode twilio-ruby
```

**Modificar** `app/misc/rodauth_main.rb`:
```ruby
class RodauthMain < Rodauth::Auth
  configure do
    # Enable MFA features
    enable :login, :logout, :create_account, :verify_account, :reset_password,
           :change_password, :change_login, :remember, :lockout,
           :otp, :sms_codes, :recovery_codes, :webauthn,
           :two_factor_base, :two_factor_manage

    # Database configuration
    db DB
    accounts_table :users
    
    # MFA Configuration
    otp_drift 30 # Allow 30 seconds drift for TOTP
    otp_digits 6 # 6-digit codes
    otp_interval 30 # 30-second intervals
    otp_issuer Rails.application.class.module_parent_name
    otp_label { account[:email] || account[:wallet_address] }
    
    # SMS Configuration
    sms_send do |phone, message|
      TwilioSmsService.send_sms(phone, message)
    end
    
    sms_phone :phone_number # Column name for phone number
    
    # Recovery codes configuration
    recovery_codes_count 10 # Generate 10 backup codes
    
    # Two-factor authentication flow
    two_factor_auth_required_redirect { two_factor_auth_path }
    two_factor_setup_redirect { two_factor_manage_path }
    
    # Customize MFA challenge based on user preferences
    two_factor_auth_return_to_requested_location? true
    
    # Custom logic for determining which 2FA method to use
    auth_class_eval do
      def two_factor_authentication_setup?
        otp_exists? || sms_exists? || recovery_codes_exist?
      end

      def primary_two_factor_method
        return 'otp' if otp_exists?
        return 'sms' if sms_exists?
        nil
      end

      def available_two_factor_methods
        methods = []
        methods << 'otp' if otp_exists?
        methods << 'sms' if sms_exists?
        methods << 'recovery_codes' if recovery_codes_exist?
        methods
      end

      def require_two_factor_setup?
        # Require 2FA for admin users or after certain time
        return true if account[:role] == 'admin'
        return true if account[:force_mfa]
        
        # Optional: Require 2FA after 30 days for all users
        # return account[:created_at] < 30.days.ago && !two_factor_authentication_setup?
        
        false
      end
    end

    # Email configuration for MFA
    create_otp_setup_email do
      UserMailer.otp_setup_email(email_to, otp_provisioning_uri)
    end

    create_sms_setup_email do
      UserMailer.sms_setup_email(email_to, formatted_phone_number)
    end
    
    # Redirect after MFA actions
    otp_setup_redirect { two_factor_manage_path }
    otp_auth_redirect { login_redirect }
    sms_setup_redirect { two_factor_manage_path }
    sms_request_redirect { sms_auth_path }
    sms_auth_redirect { login_redirect }
    
    # Template configuration
    prefix '/auth'
    two_factor_manage_route 'mfa'
    two_factor_auth_route 'mfa/authenticate'
    otp_setup_route 'mfa/totp/setup'
    otp_auth_route 'mfa/totp/verify'
    sms_setup_route 'mfa/sms/setup'
    sms_request_route 'mfa/sms/request'
    sms_auth_route 'mfa/sms/verify'
    recovery_codes_route 'mfa/recovery-codes'
  end
end
```

## üìå Commit 57.2: Crear Migraciones para MFA

üîπ **Mensaje de commit:**
```
feat(mfa): agrega migraciones para almacenar datos de MFA en Rodauth
```

**Generar migraciones MFA:**
```bash
rails generate migration AddMfaToUsers phone_number:string force_mfa:boolean:default(false)
rails generate rodauth:migration otp sms_codes recovery_codes
```

**Modificar migraci√≥n** `db/migrate/[timestamp]_add_mfa_to_users.rb`:
```ruby
class AddMfaToUsers < ActiveRecord::Migration[7.0]
  def change
    add_column :users, :phone_number, :string
    add_column :users, :force_mfa, :boolean, default: false, null: false
    add_column :users, :mfa_preference, :string, default: 'none' # 'none', 'otp', 'sms'
    add_column :users, :last_mfa_at, :datetime
    add_column :users, :phone_verified_at, :datetime
    
    add_index :users, :phone_number
    add_index :users, :force_mfa
    add_index :users, :mfa_preference
  end
end
```

**Ejecutar migraciones:**
```bash
rails db:migrate
```

## üìå Commit 57.3: Crear Servicio SMS con Twilio

üîπ **Mensaje de commit:**
```
feat(mfa): agrega servicio SMS con Twilio para c√≥digos de verificaci√≥n MFA
```

**Crear** `app/services/twilio_sms_service.rb`:
```ruby
require 'twilio-ruby'

class TwilioSmsService
  class << self
    def send_sms(phone_number, message)
      return false unless phone_number.present? && message.present?
      
      begin
        client = twilio_client
        
        response = client.messages.create(
          from: twilio_phone_number,
          to: format_phone_number(phone_number),
          body: message
        )
        
        Rails.logger.info "SMS sent successfully to #{phone_number}: #{response.sid}"
        
        # Store SMS log for debugging/analytics
        SmsLog.create!(
          phone_number: phone_number,
          message: message,
          twilio_sid: response.sid,
          status: 'sent',
          sent_at: Time.current
        ) if defined?(SmsLog)
        
        true
      rescue Twilio::REST::RestError => e
        Rails.logger.error "Twilio SMS Error: #{e.message}"
        
        SmsLog.create!(
          phone_number: phone_number,
          message: message,
          status: 'failed',
          error_message: e.message,
          sent_at: Time.current
        ) if defined?(SmsLog)
        
        false
      rescue => e
        Rails.logger.error "SMS Service Error: #{e.message}"
        false
      end
    end

    def send_verification_code(phone_number, code)
      message = build_verification_message(code)
      send_sms(phone_number, message)
    end

    def verify_phone_number(phone_number)
      # Send a verification code to verify phone ownership
      code = generate_verification_code
      
      if send_verification_code(phone_number, code)
        # Store verification code temporarily (you might want to use Redis)
        Rails.cache.write(
          "phone_verification_#{phone_number}", 
          code, 
          expires_in: 10.minutes
        )
        true
      else
        false
      end
    end

    def verify_phone_code(phone_number, provided_code)
      stored_code = Rails.cache.read("phone_verification_#{phone_number}")
      return false unless stored_code

      if stored_code == provided_code
        Rails.cache.delete("phone_verification_#{phone_number}")
        true
      else
        false
      end
    end

    private

    def twilio_client
      @twilio_client ||= Twilio::REST::Client.new(
        account_sid,
        auth_token
      )
    end

    def account_sid
      Rails.application.credentials.dig(:twilio, :account_sid) || 
      ENV['TWILIO_ACCOUNT_SID']
    end

    def auth_token
      Rails.application.credentials.dig(:twilio, :auth_token) || 
      ENV['TWILIO_AUTH_TOKEN']
    end

    def twilio_phone_number
      Rails.application.credentials.dig(:twilio, :phone_number) || 
      ENV['TWILIO_PHONE_NUMBER']
    end

    def format_phone_number(phone)
      # Ensure phone number is in E.164 format
      phone = phone.gsub(/\D/, '') # Remove non-digits
      phone = "+1#{phone}" if phone.length == 10 && !phone.start_with?('+')
      phone = "+#{phone}" unless phone.start_with?('+')
      phone
    end

    def build_verification_message(code)
      app_name = Rails.application.class.module_parent_name
      "Your #{app_name} verification code is: #{code}. This code expires in 10 minutes. Do not share this code with anyone."
    end

    def generate_verification_code
      rand(100_000..999_999).to_s
    end
  end
end
```

## üìå Commit 57.4: Crear UI para Configuraci√≥n de MFA

üîπ **Mensaje de commit:**
```
feat(mfa): agrega UI moderna para configurar Multi-Factor Authentication
```

**Crear** `app/views/rodauth/two_factor_manage.html.erb`:
```erb
<div class="min-h-screen bg-gray-50 py-12" data-controller="mfa-manager">
  <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
    
    <!-- Header -->
    <div class="mb-8">
      <h1 class="text-3xl font-bold text-gray-900 mb-2">
        Multi-Factor Authentication
      </h1>
      <p class="text-gray-600">
        Secure your account with additional authentication methods
      </p>
    </div>

    <!-- Security Status Overview -->
    <div class="bg-white shadow rounded-lg p-6 mb-8">
      <div class="flex items-center justify-between">
        <div>
          <h2 class="text-xl font-semibold text-gray-900 mb-2">Security Status</h2>
          <p class="text-gray-600">
            <% if two_factor_authentication_setup? %>
              <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                ‚úì Multi-Factor Authentication Enabled
              </span>
            <% else %>
              <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                ‚ö† Multi-Factor Authentication Disabled
              </span>
            <% end %>
          </p>
        </div>
        
        <% if require_two_factor_setup? %>
          <div class="bg-red-50 border border-red-200 rounded-lg p-3">
            <p class="text-sm text-red-800">
              <strong>Required:</strong> Please set up 2FA to continue using your account.
            </p>
          </div>
        <% end %>
      </div>
    </div>

    <!-- MFA Methods Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
      
      <!-- TOTP Authentication -->
      <div class="bg-white shadow rounded-lg">
        <div class="p-6">
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center">
              <div class="flex-shrink-0">
                <svg class="h-8 w-8 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
                </svg>
              </div>
              <div class="ml-4">
                <h3 class="text-lg font-medium text-gray-900">Authenticator App</h3>
                <p class="text-sm text-gray-500">Use Google Authenticator, Authy, or similar apps</p>
              </div>
            </div>
            
            <% if otp_exists? %>
              <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                ‚úì Enabled
              </span>
            <% else %>
              <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                Not Set Up
              </span>
            <% end %>
          </div>
          
          <p class="text-gray-600 mb-4 text-sm">
            Authenticator apps generate secure codes that change every 30 seconds. This is the most secure 2FA method.
          </p>
          
          <div class="flex gap-2">
            <% if otp_exists? %>
              <button type="button"
                      class="btn-secondary text-sm"
                      data-action="click->mfa-manager#disableOtp">
                Disable TOTP
              </button>
              <button type="button"
                      class="btn-primary text-sm"
                      data-action="click->mfa-manager#showOtpQr">
                View QR Code
              </button>
            <% else %>
              <a href="<%= rodauth.otp_setup_path %>" 
                 class="btn-primary text-sm">
                Set Up Authenticator
              </a>
            <% end %>
          </div>
        </div>
      </div>

      <!-- SMS Authentication -->
      <div class="bg-white shadow rounded-lg">
        <div class="p-6">
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center">
              <div class="flex-shrink-0">
                <svg class="h-8 w-8 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                </svg>
              </div>
              <div class="ml-4">
                <h3 class="text-lg font-medium text-gray-900">SMS Authentication</h3>
                <p class="text-sm text-gray-500">Receive codes via text message</p>
              </div>
            </div>
            
            <% if sms_exists? %>
              <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                ‚úì Enabled
              </span>
            <% else %>
              <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                Not Set Up
              </span>
            <% end %>
          </div>
          
          <p class="text-gray-600 mb-4 text-sm">
            Get verification codes sent to your phone. Make sure you have reliable cell service.
          </p>
          
          <% if sms_exists? %>
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4">
              <p class="text-sm text-blue-800">
                <strong>Phone:</strong> <%= mask_phone_number(account[:phone_number]) %>
              </p>
            </div>
          <% end %>
          
          <div class="flex gap-2">
            <% if sms_exists? %>
              <button type="button"
                      class="btn-secondary text-sm"
                      data-action="click->mfa-manager#disableSms">
                Disable SMS
              </button>
              <a href="<%= rodauth.sms_setup_path %>" 
                 class="btn-primary text-sm">
                Change Phone
              </a>
            <% else %>
              <a href="<%= rodauth.sms_setup_path %>" 
                 class="btn-primary text-sm">
                Set Up SMS
              </a>
            <% end %>
          </div>
        </div>
      </div>
    </div>

    <!-- Recovery Codes Section -->
    <div class="bg-white shadow rounded-lg">
      <div class="p-6">
        <div class="flex items-center justify-between mb-4">
          <div class="flex items-center">
            <div class="flex-shrink-0">
              <svg class="h-8 w-8 text-yellow-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
              </svg>
            </div>
            <div class="ml-4">
              <h3 class="text-lg font-medium text-gray-900">Recovery Codes</h3>
              <p class="text-sm text-gray-500">One-time backup codes for emergency access</p>
            </div>
          </div>
          
          <% if recovery_codes_exist? %>
            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
              ‚úì Generated
            </span>
          <% else %>
            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
              Not Generated
            </span>
          <% end %>
        </div>
        
        <p class="text-gray-600 mb-4 text-sm">
          Recovery codes allow you to access your account if you lose your phone or authenticator app. 
          Store them safely and don't share them with anyone.
        </p>
        
        <% if recovery_codes_exist? %>
          <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3 mb-4">
            <p class="text-sm text-yellow-800">
              <strong>Warning:</strong> You have <%= unused_recovery_codes_count %> unused recovery codes remaining.
              <% if unused_recovery_codes_count < 3 %>
                Consider generating new codes soon.
              <% end %>
            </p>
          </div>
        <% end %>
        
        <div class="flex gap-2">
          <% if recovery_codes_exist? %>
            <a href="<%= rodauth.recovery_codes_path %>" 
               class="btn-secondary text-sm">
              View Codes
            </a>
            <button type="button"
                    class="btn-primary text-sm"
                    data-action="click->mfa-manager#regenerateRecoveryCodes">
              Generate New Codes
            </button>
          <% else %>
            <a href="<%= rodauth.recovery_codes_path %>" 
               class="btn-primary text-sm">
              Generate Recovery Codes
            </a>
          <% end %>
        </div>
      </div>
    </div>

    <!-- Back to Account -->
    <div class="mt-8 text-center">
      <a href="/" class="text-blue-600 hover:text-blue-500 text-sm">
        ‚Üê Back to Account
      </a>
    </div>
  </div>
</div>
```

## üìå Commit 57.5: Crear UI para Configuraci√≥n de TOTP

üîπ **Mensaje de commit:**
```
feat(mfa): agrega UI para configurar Google Authenticator con QR Code
```

**Crear** `app/views/rodauth/otp_setup.html.erb`:
```erb
<div class="min-h-screen bg-gray-50 py-12">
  <div class="max-w-2xl mx-auto px-4 sm:px-6 lg:px-8">
    
    <!-- Header -->
    <div class="mb-8 text-center">
      <h1 class="text-3xl font-bold text-gray-900 mb-2">
        Set Up Authenticator App
      </h1>
      <p class="text-gray-600">
        Scan the QR code with your authenticator app to set up two-factor authentication
      </p>
    </div>

    <div class="bg-white shadow rounded-lg">
      <div class="p-6" data-controller="otp-setup">
        
        <!-- Step 1: Download App -->
        <div class="mb-8">
          <h2 class="text-lg font-semibold text-gray-900 mb-4">
            Step 1: Download an Authenticator App
          </h2>
          
          <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-4">
            <div class="text-center p-4 border rounded-lg">
              <div class="w-12 h-12 mx-auto mb-2 bg-blue-100 rounded-lg flex items-center justify-center">
                <svg class="w-6 h-6 text-blue-600" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.94-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/>
                </svg>
              </div>
              <h3 class="font-medium text-gray-900">Google Authenticator</h3>
              <p class="text-sm text-gray-500 mt-1">Free, widely supported</p>
            </div>
            
            <div class="text-center p-4 border rounded-lg">
              <div class="w-12 h-12 mx-auto mb-2 bg-orange-100 rounded-lg flex items-center justify-center">
                <svg class="w-6 h-6 text-orange-600" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/>
                </svg>
              </div>
              <h3 class="font-medium text-gray-900">Authy</h3>
              <p class="text-sm text-gray-500 mt-1">Cloud backup, multi-device</p>
            </div>
            
            <div class="text-center p-4 border rounded-lg">
              <div class="w-12 h-12 mx-auto mb-2 bg-green-100 rounded-lg flex items-center justify-center">
                <svg class="w-6 h-6 text-green-600" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                </svg>
              </div>
              <h3 class="font-medium text-gray-900">Microsoft Authenticator</h3>
              <p class="text-sm text-gray-500 mt-1">Push notifications</p>
            </div>
          </div>
        </div>

        <!-- Step 2: Scan QR Code -->
        <div class="mb-8">
          <h2 class="text-lg font-semibold text-gray-900 mb-4">
            Step 2: Scan QR Code
          </h2>
          
          <div class="flex flex-col md:flex-row gap-6 items-center">
            <!-- QR Code -->
            <div class="flex-shrink-0">
              <div class="bg-white p-4 border-2 border-gray-200 rounded-lg">
                <%= image_tag otp_qr_code_url, alt: "TOTP QR Code", class: "w-48 h-48" %>
              </div>
              
              <div class="mt-2 text-center">
                <button type="button"
                        class="text-sm text-blue-600 hover:text-blue-500"
                        data-action="click->otp-setup#showManualEntry">
                  Can't scan? Enter manually
                </button>
              </div>
            </div>
            
            <!-- Instructions -->
            <div class="flex-1">
              <ol class="list-decimal list-inside space-y-2 text-gray-700">
                <li>Open your authenticator app</li>
                <li>Tap the "+" or "Add account" button</li>
                <li>Choose "Scan QR code" or "Scan barcode"</li>
                <li>Point your camera at the QR code</li>
                <li>Enter the verification code below</li>
              </ol>
            </div>
          </div>
          
          <!-- Manual Entry (Hidden by default) -->
          <div data-otp-setup-target="manualEntry" class="hidden mt-6 p-4 bg-gray-50 rounded-lg">
            <h3 class="font-medium text-gray-900 mb-2">Manual Entry</h3>
            <p class="text-sm text-gray-600 mb-3">
              If you can't scan the QR code, enter this secret key manually:
            </p>
            <div class="bg-white p-3 border rounded font-mono text-sm break-all">
              <%= otp_secret %>
            </div>
            <button type="button"
                    class="mt-2 text-sm text-blue-600 hover:text-blue-500"
                    data-action="click->otp-setup#copySecret">
              Copy Secret Key
            </button>
          </div>
        </div>

        <!-- Step 3: Verify -->
        <div>
          <h2 class="text-lg font-semibold text-gray-900 mb-4">
            Step 3: Enter Verification Code
          </h2>
          
          <%= form_tag rodauth.otp_setup_path, local: true, class: "space-y-4" do %>
            <div>
              <label for="auth_code" class="block text-sm font-medium text-gray-700 mb-1">
                Enter the 6-digit code from your authenticator app:
              </label>
              <input type="text" 
                     id="auth_code"
                     name="<%= rodauth.otp_auth_param %>" 
                     class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-center text-lg font-mono"
                     placeholder="123456"
                     maxlength="6"
                     pattern="[0-9]{6}"
                     autocomplete="one-time-code"
                     data-otp-setup-target="codeInput"
                     data-action="input->otp-setup#validateCode"
                     required>
            </div>
            
            <div class="flex items-center justify-between">
              <a href="<%= rodauth.two_factor_manage_path %>" 
                 class="text-sm text-gray-600 hover:text-gray-500">
                ‚Üê Back to MFA Settings
              </a>
              
              <button type="submit"
                      class="btn-primary"
                      data-otp-setup-target="submitButton"
                      disabled>
                Enable TOTP Authentication
              </button>
            </div>
          <% end %>
        </div>

        <!-- Security Notice -->
        <div class="mt-8 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
          <div class="flex">
            <div class="flex-shrink-0">
              <svg class="h-5 w-5 text-yellow-400" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
              </svg>
            </div>
            <div class="ml-3">
              <h3 class="text-sm font-medium text-yellow-800">Security Notice</h3>
              <div class="mt-2 text-sm text-yellow-700">
                <ul class="list-disc list-inside space-y-1">
                  <li>Keep your phone secure and protected with a passcode</li>
                  <li>Don't share your authenticator app with others</li>
                  <li>Generate recovery codes after setting up TOTP</li>
                  <li>If you lose your phone, use recovery codes to regain access</li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
```

## üìå Commit 57.6: Crear Stimulus Controller para TOTP Setup

üîπ **Mensaje de commit:**
```
feat(mfa): agrega controlador Stimulus para configuraci√≥n interactiva de TOTP
```

**Crear** `app/javascript/controllers/otp_setup_controller.js`:
```javascript
import { Controller } from "@hotwired/stimulus";

export default class extends Controller {
  static targets = ["manualEntry", "codeInput", "submitButton"];

  connect() {
    this.codeInput = this.codeInputTarget;
    this.submitButton = this.submitButtonTarget;
  }

  showManualEntry() {
    this.manualEntryTarget.classList.remove('hidden');
  }

  validateCode() {
    const code = this.codeInput.value;
    const isValid = /^\d{6}$/.test(code);
    
    this.submitButton.disabled = !isValid;
    
    if (isValid) {
      this.submitButton.classList.remove('opacity-50');
      this.codeInput.classList.remove('border-red-300');
      this.codeInput.classList.add('border-green-300');
    } else {
      this.submitButton.classList.add('opacity-50');
      this.codeInput.classList.remove('border-green-300');
      
      if (code.length > 0) {
        this.codeInput.classList.add('border-red-300');
      } else {
        this.codeInput.classList.remove('border-red-300');
      }
    }
  }

  async copySecret() {
    const secretElement = this.element.querySelector('[data-secret]');
    const secret = secretElement.textContent;
    
    try {
      await navigator.clipboard.writeText(secret);
      this.showToast('Secret key copied to clipboard!', 'success');
    } catch (err) {
      console.error('Failed to copy secret:', err);
      this.showToast('Failed to copy secret key', 'error');
    }
  }

  showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 transition-all duration-300 transform translate-x-full ${this.getToastClasses(type)}`;
    toast.textContent = message;
    
    document.body.appendChild(toast);
    
    // Animate in
    setTimeout(() => toast.classList.remove('translate-x-full'), 10);
    
    // Remove after 3 seconds
    setTimeout(() => {
      toast.classList.add('translate-x-full');
      setTimeout(() => document.body.removeChild(toast), 300);
    }, 3000);
  }

  getToastClasses(type) {
    switch (type) {
      case 'success':
        return 'bg-green-500 text-white';
      case 'error':
        return 'bg-red-500 text-white';
      case 'info':
      default:
        return 'bg-blue-500 text-white';
    }
  }
}
```

## üìå Commit 57.7: Crear UI para SMS Setup

üîπ **Mensaje de commit:**
```
feat(mfa): agrega UI para configurar autenticaci√≥n SMS con verificaci√≥n de tel√©fono
```

**Crear** `app/views/rodauth/sms_setup.html.erb`:
```erb
<div class="min-h-screen bg-gray-50 py-12">
  <div class="max-w-2xl mx-auto px-4 sm:px-6 lg:px-8">
    
    <!-- Header -->
    <div class="mb-8 text-center">
      <h1 class="text-3xl font-bold text-gray-900 mb-2">
        Set Up SMS Authentication
      </h1>
      <p class="text-gray-600">
        Add your phone number to receive verification codes via text message
      </p>
    </div>

    <div class="bg-white shadow rounded-lg">
      <div class="p-6" data-controller="sms-setup">
        
        <!-- Current Phone (if exists) -->
        <% if account[:phone_number].present? %>
          <div class="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
            <h3 class="font-medium text-blue-900 mb-1">Current Phone Number</h3>
            <p class="text-blue-800"><%= mask_phone_number(account[:phone_number]) %></p>
            <% if account[:phone_verified_at] %>
              <p class="text-sm text-blue-600 mt-1">‚úì Verified on <%= account[:phone_verified_at].strftime("%B %d, %Y") %></p>
            <% else %>
              <p class="text-sm text-yellow-600 mt-1">‚ö† Not verified</p>
            <% end %>
          </div>
        <% end %>

        <!-- Phone Number Form -->
        <%= form_tag rodauth.sms_setup_path, local: true, class: "space-y-6", data: { sms_setup_target: "form" } do %>
          
          <!-- Step 1: Enter Phone Number -->
          <div>
            <label for="phone" class="block text-sm font-medium text-gray-700 mb-1">
              Phone Number
            </label>
            <div class="relative">
              <div class="absolute inset-y-0 left-0 flex items-center">
                <select class="h-full rounded-md border-0 bg-transparent py-0 pl-3 pr-7 text-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500 sm:text-sm"
                        data-sms-setup-target="countryCode">
                  <option value="+1">üá∫üá∏ +1</option>
                  <option value="+44">üá¨üáß +44</option>
                  <option value="+33">üá´üá∑ +33</option>
                  <option value="+49">üá©üá™ +49</option>
                  <option value="+81">üáØüáµ +81</option>
                  <!-- Add more country codes as needed -->
                </select>
              </div>
              <input type="tel" 
                     id="phone"
                     name="<%= rodauth.sms_phone_param %>" 
                     class="w-full pl-20 pr-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                     placeholder="(555) 123-4567"
                     value="<%= param(rodauth.sms_phone_param) || account[:phone_number] %>"
                     data-sms-setup-target="phoneInput"
                     data-action="input->sms-setup#formatPhone"
                     required>
            </div>
            <p class="mt-1 text-sm text-gray-500">
              We'll send a verification code to this number
            </p>
          </div>

          <!-- Terms and Conditions -->
          <div class="flex items-start">
            <div class="flex items-center h-5">
              <input id="terms" 
                     type="checkbox" 
                     class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
                     data-sms-setup-target="termsCheckbox"
                     data-action="change->sms-setup#validateForm"
                     required>
            </div>
            <div class="ml-3 text-sm">
              <label for="terms" class="text-gray-700">
                I agree to receive SMS messages for account security. 
                Standard message and data rates may apply.
                <a href="/privacy" class="text-blue-600 hover:text-blue-500">Privacy Policy</a>
              </label>
            </div>
          </div>

          <!-- Submit Button -->
          <div class="flex items-center justify-between">
            <a href="<%= rodauth.two_factor_manage_path %>" 
               class="text-sm text-gray-600 hover:text-gray-500">
              ‚Üê Back to MFA Settings
            </a>
            
            <button type="submit"
                    class="btn-primary"
                    data-sms-setup-target="submitButton"
                    data-action="click->sms-setup#sendVerification"
                    disabled>
              Send Verification Code
            </button>
          </div>
        <% end %>

        <!-- Verification Step (hidden initially) -->
        <div data-sms-setup-target="verificationStep" class="hidden">
          <div class="border-t border-gray-200 pt-6 mt-6">
            <h3 class="text-lg font-medium text-gray-900 mb-4">
              Enter Verification Code
            </h3>
            
            <p class="text-gray-600 mb-4">
              We sent a 6-digit code to <span data-sms-setup-target="displayPhone" class="font-medium"></span>
            </p>

            <%= form_tag rodauth.sms_auth_path, local: true, class: "space-y-4" do %>
              <div>
                <label for="sms_code" class="block text-sm font-medium text-gray-700 mb-1">
                  Verification Code
                </label>
                <input type="text" 
                       id="sms_code"
                       name="<%= rodauth.sms_code_param %>" 
                       class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-center text-lg font-mono"
                       placeholder="123456"
                       maxlength="6"
                       pattern="[0-9]{6}"
                       autocomplete="one-time-code"
                       data-sms-setup-target="codeInput"
                       data-action="input->sms-setup#validateCode"
                       required>
              </div>
              
              <div class="flex items-center justify-between">
                <button type="button"
                        class="text-sm text-blue-600 hover:text-blue-500"
                        data-action="click->sms-setup#resendCode"
                        data-sms-setup-target="resendButton">
                  Didn't receive code? Resend
                </button>
                
                <button type="submit"
                        class="btn-primary"
                        data-sms-setup-target="verifyButton"
                        disabled>
                  Verify and Enable SMS
                </button>
              </div>
            <% end %>
          </div>
        </div>

        <!-- Security Notice -->
        <div class="mt-8 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
          <div class="flex">
            <div class="flex-shrink-0">
              <svg class="h-5 w-5 text-yellow-400" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
              </svg>
            </div>
            <div class="ml-3">
              <h3 class="text-sm font-medium text-yellow-800">SMS Security Notice</h3>
              <div class="mt-2 text-sm text-yellow-700">
                <ul class="list-disc list-inside space-y-1">
                  <li>SMS is less secure than authenticator apps</li>
                  <li>Keep your phone number up to date</li>
                  <li>Don't share verification codes with anyone</li>
                  <li>Consider using TOTP as your primary 2FA method</li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
```

## üìù Ejemplos de Uso y Testing

### Ejemplo de Configuraci√≥n MFA en Rails Console

```ruby
# Check if user has MFA enabled
user = User.find_by(email: 'test@example.com')
rodauth = RodauthMain.new(account_id: user.id)
rodauth.two_factor_authentication_setup?
# => true/false

# Generate OTP secret for user
rodauth.new_otp_secret
# => "JBSWY3DPEHPK3PXP"

# Verify OTP code
rodauth.otp_valid?("123456")
# => true/false

# Send SMS code
TwilioSmsService.send_verification_code("+1234567890", "123456")
# => true/false
```

### Ejemplo de API Testing

```bash
# Setup TOTP
curl -X POST "http://localhost:3000/auth/mfa/totp/setup" \
  -F "auth_code=123456"

# Setup SMS  
curl -X POST "http://localhost:3000/auth/mfa/sms/setup" \
  -F "phone=+1234567890"

# Authenticate with TOTP
curl -X POST "http://localhost:3000/auth/mfa/totp/verify" \
  -F "auth_code=123456"

# Authenticate with SMS
curl -X POST "http://localhost:3000/auth/mfa/sms/verify" \
  -F "sms_code=123456"
```

## üéØ Ventajas de la Implementaci√≥n MFA

1. **üîí Seguridad M√∫ltiple**: TOTP, SMS y c√≥digos de recuperaci√≥n
2. **üé® UX Moderna**: Interfaz intuitiva con gu√≠as paso a paso
3. **üì± Compatibilidad Universal**: Funciona con cualquier app autenticadora
4. **üîÑ Recuperaci√≥n Robusta**: M√∫ltiples m√©todos de acceso de emergencia
5. **‚öôÔ∏è Configuraci√≥n Flexible**: Los usuarios eligen su m√©todo preferido
6. **üõ°Ô∏è Integraci√≥n Nativa**: Completamente integrado con Rodauth

Esta implementaci√≥n proporciona un sistema MFA completo, seguro y f√°cil de usar que mejora significativamente la seguridad de la aplicaci√≥n mientras mantiene una excelente experiencia de usuario.