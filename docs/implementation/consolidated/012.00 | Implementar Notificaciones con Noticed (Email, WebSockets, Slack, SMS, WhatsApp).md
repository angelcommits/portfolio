# ✅ Paso 12: Implementar Notificaciones con Noticed (Email, WebSockets, Slack, SMS, WhatsApp)

> **ARCHIVO CONSOLIDADO** - Combina funcionalidades de SMS y WhatsApp para cobertura completa de notificaciones

Ahora configuraremos Noticed para manejar notificaciones en múltiples canales:
✅ Email → A través de Action Mailer.
✅ WebSockets → Integrado con ActionCable.
✅ Slack → Usando Webhooks de Slack.
✅ SMS → A través de Twilio.
✅ WhatsApp → También a través de Twilio.

## 📌 Commit 12.1: Instalar Noticed y Configurar los Canales de Notificación
🔹 **Mensaje de commit:**
```
feat(notifications): instala Noticed y configura canales de email, WebSockets, Slack, SMS y WhatsApp
```

🔹 **Contenido del commit:**
```bash
# Añadir Noticed al Gemfile
echo "gem 'noticed', '~> 1.6'" >> Gemfile
# Instalar la gema
bundle install
# Generar la clase de notificación base
rails g noticed:notification UserNotification
# Añadir archivos al commit
git add .
git commit -m "feat(notifications): instala Noticed y configura canales de email, WebSockets, Slack, SMS y WhatsApp"
```

## 📌 Commit 12.2: Implementar Notificación en Múltiples Canales
🔹 **Mensaje de commit:**
```
feat(notifications): agrega soporte para notificaciones en Email, WebSockets, Slack, SMS y WhatsApp
```

🔹 **Contenido del commit:**

### Modificar la Notificación UserNotification
```ruby
class UserNotification < Noticed::Base
  # Canales de entrega
  deliver_by :database
  deliver_by :email, mailer: "UserMailer", method: :notification_email
  deliver_by :websocket, stream: ->(user) { "notifications_#{user.id}" }
  deliver_by :slack, webhook_url: ENV["SLACK_WEBHOOK_URL"]
  deliver_by :twilio, url: ENV["TWILIO_SMS_URL"], recipients: :user_phone
  deliver_by :twilio, url: ENV["TWILIO_WHATSAPP_URL"], recipients: :user_phone

  param :message

  def message
    params[:message]
  end

  def user_phone
    recipient.phone_number
  end
end
```

### Configurar Action Mailer para Emails (app/mailers/user_mailer.rb)
```ruby
class UserMailer < ApplicationMailer
  def notification_email(user, message)
    @message = message
    mail(to: user.email, subject: "Nueva Notificación")
  end
end
```

### Integrar WebSockets con Noticed
```ruby
class WebsocketDeliveryMethod < Noticed::DeliveryMethods::Base
  def deliver
    ActionCable.server.broadcast("notifications_#{recipient.id}", message: notification.params[:message])
  end
end
```

### Enviar Notificaciones en Rails Console
```ruby
user = Company::Business::User.first
UserNotification.with(message: "Tienes una nueva tarea").deliver(user)
```

🔹 **Añadir archivos al commit:**
```bash
git add .
git commit -m "feat(notifications): agrega soporte para notificaciones en Email, WebSockets, Slack, SMS y WhatsApp"
```

## 📝 Explicación y Código Generado

### Ejemplo de Uso en Rails Console
```ruby
# Enviar una notificación a un usuario por todos los canales
UserNotification.with(message: "Tienes una nueva actualización").deliver(user)
```

### Ejemplo de Recepción en WebSockets (JavaScript)
```javascript
import consumer from "./consumer"

consumer.subscriptions.create({ channel: "NotificationChannel", user_id: CURRENT_USER_ID }, {
  received(data) {
    alert(data.message);
  }
});
```

### Ejemplo de Notificación en Slack
```bash
curl -X POST -H 'Content-type: application/json' --data '{"text":"Notificación de prueba"}' $SLACK_WEBHOOK_URL
```

### Ejemplo de Notificación por SMS (Twilio API)
```bash
curl -X POST "https://api.twilio.com/2010-04-01/Accounts/$TWILIO_ACCOUNT_SID/Messages.json" \
  --data-urlencode "Body=Notificación de prueba" \
  --data-urlencode "From=$TWILIO_PHONE_NUMBER" \
  --data-urlencode "To=$USER_PHONE" \
  -u $TWILIO_ACCOUNT_SID:$TWILIO_AUTH_TOKEN
```

### Ejemplo de Notificación por WhatsApp (Twilio API)
```bash
curl -X POST "https://api.twilio.com/2010-04-01/Accounts/$TWILIO_ACCOUNT_SID/Messages.json" \
  --data-urlencode "Body=Notificación de WhatsApp" \
  --data-urlencode "From=whatsapp:$TWILIO_WHATSAPP_NUMBER" \
  --data-urlencode "To=whatsapp:$USER_PHONE" \
  -u $TWILIO_ACCOUNT_SID:$TWILIO_AUTH_TOKEN
```

## 🔧 Configuración Adicional

### Variables de Entorno Requeridas
```bash
# Twilio Configuration
TWILIO_ACCOUNT_SID=your_account_sid
TWILIO_AUTH_TOKEN=your_auth_token
TWILIO_PHONE_NUMBER=+1234567890
TWILIO_WHATSAPP_NUMBER=whatsapp:+14155238886

# Slack Configuration
SLACK_WEBHOOK_URL=https://hooks.slack.com/services/YOUR/WEBHOOK/URL
```

### Validación de Configuración
```ruby
# En Rails Console - Verificar configuración
UserNotification.delivery_methods
# => [:database, :email, :websocket, :slack, :twilio]

# Verificar que todos los canales están configurados
UserNotification.with(message: "Test de configuración").deliver(User.first)
```