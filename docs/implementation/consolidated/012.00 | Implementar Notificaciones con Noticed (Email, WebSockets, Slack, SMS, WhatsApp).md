# âœ… Paso 12: Implementar Notificaciones con Noticed (Email, WebSockets, Slack, SMS, WhatsApp)

> **ARCHIVO CONSOLIDADO** - Combina funcionalidades de SMS y WhatsApp para cobertura completa de notificaciones

Ahora configuraremos Noticed para manejar notificaciones en mÃºltiples canales:
âœ… Email â†’ A travÃ©s de Action Mailer.
âœ… WebSockets â†’ Integrado con ActionCable.
âœ… Slack â†’ Usando Webhooks de Slack.
âœ… SMS â†’ A travÃ©s de Twilio.
âœ… WhatsApp â†’ TambiÃ©n a travÃ©s de Twilio.

## ðŸ“Œ Commit 12.1: Instalar Noticed y Configurar los Canales de NotificaciÃ³n
ðŸ”¹ **Mensaje de commit:**
```
feat(notifications): instala Noticed y configura canales de email, WebSockets, Slack, SMS y WhatsApp
```

ðŸ”¹ **Contenido del commit:**
```bash
# AÃ±adir Noticed al Gemfile
echo "gem 'noticed', '~> 1.6'" >> Gemfile
# Instalar la gema
bundle install
# Generar la clase de notificaciÃ³n base
rails g noticed:notification UserNotification
# AÃ±adir archivos al commit
git add .
git commit -m "feat(notifications): instala Noticed y configura canales de email, WebSockets, Slack, SMS y WhatsApp"
```

## ðŸ“Œ Commit 12.2: Implementar NotificaciÃ³n en MÃºltiples Canales
ðŸ”¹ **Mensaje de commit:**
```
feat(notifications): agrega soporte para notificaciones en Email, WebSockets, Slack, SMS y WhatsApp
```

ðŸ”¹ **Contenido del commit:**

### Modificar la NotificaciÃ³n UserNotification
```ruby
class UserNotification < Noticed::Base
  # Canales de entrega
  deliver_by :database
  deliver_by :email, mailer: "UserMailer", method: :notification_email
  deliver_by :websocket, stream: ->(user) { "notifications_#{user.id}" }
  deliver_by :slack, webhook_url: ENV["SLACK_WEBHOOK_URL"]
  deliver_by :twilio, url: ENV["TWILIO_SMS_URL"], recipients: :user_phone
  deliver_by :twilio, url: ENV["TWILIO_WHATSAPP_URL"], recipients: :user_phone

  param :message

  def message
    params[:message]
  end

  def user_phone
    recipient.phone_number
  end
end
```

### Configurar Action Mailer para Emails (app/mailers/user_mailer.rb)
```ruby
class UserMailer < ApplicationMailer
  def notification_email(user, message)
    @message = message
    mail(to: user.email, subject: "Nueva NotificaciÃ³n")
  end
end
```

### Integrar WebSockets con Noticed
```ruby
class WebsocketDeliveryMethod < Noticed::DeliveryMethods::Base
  def deliver
    ActionCable.server.broadcast("notifications_#{recipient.id}", message: notification.params[:message])
  end
end
```

### Enviar Notificaciones en Rails Console
```ruby
user = Company::Business::User.first
UserNotification.with(message: "Tienes una nueva tarea").deliver(user)
```

ðŸ”¹ **AÃ±adir archivos al commit:**
```bash
git add .
git commit -m "feat(notifications): agrega soporte para notificaciones en Email, WebSockets, Slack, SMS y WhatsApp"
```

## ðŸ“ ExplicaciÃ³n y CÃ³digo Generado

### Ejemplo de Uso en Rails Console
```ruby
# Enviar una notificaciÃ³n a un usuario por todos los canales
UserNotification.with(message: "Tienes una nueva actualizaciÃ³n").deliver(user)
```

### Ejemplo de RecepciÃ³n en WebSockets (JavaScript)
```javascript
import consumer from "./consumer"

consumer.subscriptions.create({ channel: "NotificationChannel", user_id: CURRENT_USER_ID }, {
  received(data) {
    alert(data.message);
  }
});
```

### Ejemplo de NotificaciÃ³n en Slack
```bash
curl -X POST -H 'Content-type: application/json' --data '{"text":"NotificaciÃ³n de prueba"}' $SLACK_WEBHOOK_URL
```

### Ejemplo de NotificaciÃ³n por SMS (Twilio API)
```bash
curl -X POST "https://api.twilio.com/2010-04-01/Accounts/$TWILIO_ACCOUNT_SID/Messages.json" \
  --data-urlencode "Body=NotificaciÃ³n de prueba" \
  --data-urlencode "From=$TWILIO_PHONE_NUMBER" \
  --data-urlencode "To=$USER_PHONE" \
  -u $TWILIO_ACCOUNT_SID:$TWILIO_AUTH_TOKEN
```

### Ejemplo de NotificaciÃ³n por WhatsApp (Twilio API)
```bash
curl -X POST "https://api.twilio.com/2010-04-01/Accounts/$TWILIO_ACCOUNT_SID/Messages.json" \
  --data-urlencode "Body=NotificaciÃ³n de WhatsApp" \
  --data-urlencode "From=whatsapp:$TWILIO_WHATSAPP_NUMBER" \
  --data-urlencode "To=whatsapp:$USER_PHONE" \
  -u $TWILIO_ACCOUNT_SID:$TWILIO_AUTH_TOKEN
```

## ðŸ”§ ConfiguraciÃ³n Adicional

### Variables de Entorno Requeridas
```bash
# Twilio Configuration
TWILIO_ACCOUNT_SID=your_account_sid
TWILIO_AUTH_TOKEN=your_auth_token
TWILIO_PHONE_NUMBER=+1234567890
TWILIO_WHATSAPP_NUMBER=whatsapp:+14155238886

# Slack Configuration
SLACK_WEBHOOK_URL=https://hooks.slack.com/services/YOUR/WEBHOOK/URL
```

### ValidaciÃ³n de ConfiguraciÃ³n
```ruby
# En Rails Console - Verificar configuraciÃ³n
UserNotification.delivery_methods
# => [:database, :email, :websocket, :slack, :twilio]

# Verificar que todos los canales estÃ¡n configurados
UserNotification.with(message: "Test de configuraciÃ³n").deliver(User.first)
```